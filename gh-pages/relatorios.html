<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Relatórios - Sistema</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/auth-guard.js"></script>
  <script src="js/branding.js"></script>
  <script src="js/sidebar.js"></script>
  <script src="js/datetime-utils.js"></script>
  <style>
    .reports-container { padding: 24px; overflow-y: auto; flex: 1; }
    .category-section { margin-bottom: 32px; }
    .category-header { 
      display: flex; align-items: center; gap: 12px; 
      margin-bottom: 16px; padding-bottom: 12px;
      border-bottom: 2px solid var(--gray-200);
    }
    .category-icon {
      width: 42px; height: 42px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: #fff;
    }
    .category-title { font-size: 18px; font-weight: 700; color: var(--gray-800); margin: 0; }
    .category-desc { font-size: 13px; color: var(--gray-500); margin: 0; }
    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .report-card {
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .report-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border-color: var(--brand);
    }
    .report-card-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
    .report-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; flex-shrink: 0;
    }
    .report-title { font-size: 15px; font-weight: 600; color: var(--gray-800); margin: 0; }
    .report-desc { font-size: 12px; color: var(--gray-500); margin: 4px 0 0; line-height: 1.4; }
    .report-actions {
      display: flex; gap: 8px; margin-top: 16px;
      padding-top: 12px; border-top: 1px solid var(--gray-100);
    }
    .report-btn {
      flex: 1; padding: 8px 12px;
      border: 1px solid var(--gray-300);
      background: #fff; border-radius: 6px;
      font-size: 12px; font-weight: 500;
      color: var(--gray-600);
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .report-btn:hover { border-color: var(--brand); color: var(--brand); }
    .report-btn.primary { background: var(--brand); color: #fff; border-color: var(--brand); }
    .report-btn.primary:hover { opacity: 0.9; }
    .global-filters {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid var(--gray-200);
    }
    .filters-row { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
    .filter-group { min-width: 160px; }
    .filter-group label { 
      display: block; font-size: 12px; font-weight: 600; 
      color: var(--gray-600); margin-bottom: 6px; 
    }
    .filter-group input, .filter-group select {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px; font-size: 14px;
    }
    .filter-group input:focus, .filter-group select:focus {
      outline: none; border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .quick-stat {
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      border: 1px solid var(--gray-200);
    }
    .quick-stat-value { font-size: 24px; font-weight: 700; color: var(--gray-800); }
    .quick-stat-label { font-size: 12px; color: var(--gray-500); margin-top: 4px; }
    .report-modal .modal-content { border-radius: 16px; }
    .report-modal .modal-header { 
      background: linear-gradient(135deg, var(--brand), #818cf8);
      color: #fff; border-radius: 16px 16px 0 0;
    }
    .report-modal .close { color: #fff; opacity: 0.8; }
    .report-result { 
      max-height: 60vh; overflow-y: auto;
      background: var(--gray-50); border-radius: 8px;
      padding: 16px;
    }
    .report-table { 
      width: 100%; border-collapse: collapse; 
      background: #fff; border-radius: 8px; overflow: hidden;
    }
    .report-table th { 
      background: var(--gray-100); 
      padding: 12px; text-align: left;
      font-size: 12px; font-weight: 600;
      color: var(--gray-600); text-transform: uppercase;
    }
    .report-table td { 
      padding: 12px; border-bottom: 1px solid var(--gray-100);
      font-size: 14px;
    }
    .report-table tr:hover { background: var(--gray-50); }
    .spinner { 
      width: 40px; height: 40px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .badge-new { 
      position: absolute; top: 10px; right: 10px;
      background: #10b981; color: #fff;
      font-size: 10px; padding: 2px 8px;
      border-radius: 10px; font-weight: 600;
    }
    @media (max-width: 768px) {
      .reports-grid { grid-template-columns: 1fr; }
      .filters-row { flex-direction: column; }
      .filter-group { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="sidebar">
      <h4>SISTEMA</h4>
      <ul class="sidebar-menu">
        <li><a href="index.html"><span class="menu-icon"><i class="fa fa-home"></i></span><span class="menu-label">Início</span></a></li>
        <li><a href="pdv.html"><span class="menu-icon"><i class="fa fa-cash-register"></i></span><span class="menu-label">PDV</span></a></li>
        <li><a href="dashboard.html"><span class="menu-icon"><i class="fa fa-chart-pie"></i></span><span class="menu-label">Painel</span></a></li>
        <li><a href="nfe-emissao.html"><span class="menu-icon"><i class="fa fa-file-invoice"></i></span><span class="menu-label">Notas Fiscais</span></a></li>
        <li><a href="movimentos.html"><span class="menu-icon"><i class="fa fa-exchange-alt"></i></span><span class="menu-label">Movimentos</span></a></li>
        <li><a href="relatorios.html" class="active"><span class="menu-icon"><i class="fa fa-chart-bar"></i></span><span class="menu-label">Relatórios</span></a></li>
        <li><a href="pessoas.html"><span class="menu-icon"><i class="fa fa-users"></i></span><span class="menu-label">Clientes</span></a></li>
        <li><a href="produtos.html"><span class="menu-icon"><i class="fa fa-boxes"></i></span><span class="menu-label">Produtos</span></a></li>
        <li><a href="agenda.html"><span class="menu-icon"><i class="fa fa-calendar"></i></span><span class="menu-label">Agenda</span></a></li>
        <li><a href="admin.html"><span class="menu-icon"><i class="fa fa-cogs"></i></span><span class="menu-label">Admin</span></a></li>
      </ul>
    </div>

    <div class="main-content">
      <div class="main-header">
        <h3><i class="fa fa-chart-bar"></i> Central de Relatórios</h3>
        <div class="header-info">
          <span><i class="fa fa-calendar mr-2"></i><span id="currentDate">--</span></span>
          <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
            <i class="fa fa-print mr-1"></i> Imprimir
          </button>
        </div>
      </div>

      <div class="reports-container">
        <!-- Filtros Globais -->
        <div class="global-filters">
          <div class="filters-row">
            <div class="filter-group">
              <label><i class="fa fa-calendar-alt mr-1"></i> Data Inicial</label>
              <input type="date" id="filterDateFrom">
            </div>
            <div class="filter-group">
              <label><i class="fa fa-calendar-alt mr-1"></i> Data Final</label>
              <input type="date" id="filterDateTo">
            </div>
            <div class="filter-group">
              <label><i class="fa fa-filter mr-1"></i> Período Rápido</label>
              <select id="quickPeriod" onchange="setQuickPeriod()">
                <option value="">Personalizado</option>
                <option value="today">Hoje</option>
                <option value="yesterday">Ontem</option>
                <option value="week">Esta Semana</option>
                <option value="month" selected>Este Mês</option>
                <option value="quarter">Este Trimestre</option>
                <option value="year">Este Ano</option>
              </select>
            </div>
            <div class="filter-group" style="margin-left: auto;">
              <label>&nbsp;</label>
              <button class="btn btn-primary" onclick="refreshAll()">
                <i class="fa fa-sync-alt mr-1"></i> Atualizar
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="quick-stat">
            <div class="quick-stat-value" id="statVendas">R$ 0,00</div>
            <div class="quick-stat-label"><i class="fa fa-shopping-cart text-success mr-1"></i> Vendas no Período</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="statTicket">R$ 0,00</div>
            <div class="quick-stat-label"><i class="fa fa-receipt text-primary mr-1"></i> Ticket Médio</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="statProdutos">0</div>
            <div class="quick-stat-label"><i class="fa fa-box text-warning mr-1"></i> Produtos</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="statClientes">0</div>
            <div class="quick-stat-label"><i class="fa fa-users text-info mr-1"></i> Clientes</div>
          </div>
        </div>

        <!-- VENDAS E PDV -->
        <div class="category-section">
          <div class="category-header">
            <div class="category-icon" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fa fa-shopping-cart"></i></div>
            <div>
              <h4 class="category-title">Vendas e PDV</h4>
              <p class="category-desc">Relatórios de vendas, faturamento e operações do PDV</p>
            </div>
          </div>
          <div class="reports-grid">
            <div class="report-card" onclick="openReport('vendas-periodo')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(16,185,129,0.1); color: #10b981;"><i class="fa fa-chart-line"></i></div>
                <div>
                  <h5 class="report-title">Vendas por Período</h5>
                  <p class="report-desc">Faturamento diário, semanal e mensal</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn" onclick="event.stopPropagation(); exportReportToPDF('vendas-periodo')"><i class="fa fa-file-pdf"></i> PDF</button>
                <button class="report-btn" onclick="event.stopPropagation(); exportReport('vendas-periodo', 'csv')"><i class="fa fa-file-csv"></i> CSV</button>
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>

            <div class="report-card" onclick="openReport('vendas-produto')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(16,185,129,0.1); color: #10b981;"><i class="fa fa-box"></i></div>
                <div>
                  <h5 class="report-title">Vendas por Produto</h5>
                  <p class="report-desc">Ranking de produtos mais vendidos</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn" onclick="event.stopPropagation(); exportReportToPDF('vendas-produto')"><i class="fa fa-file-pdf"></i> PDF</button>
                <button class="report-btn" onclick="event.stopPropagation(); exportReport('vendas-produto', 'csv')"><i class="fa fa-file-csv"></i> CSV</button>
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>

            <div class="report-card" onclick="openReport('vendas-pagamento')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(16,185,129,0.1); color: #10b981;"><i class="fa fa-credit-card"></i></div>
                <div>
                  <h5 class="report-title">Por Forma de Pagamento</h5>
                  <p class="report-desc">Dinheiro, cartão, PIX, etc.</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>

            <div class="report-card" onclick="openReport('vendas-cliente')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(16,185,129,0.1); color: #10b981;"><i class="fa fa-users"></i></div>
                <div>
                  <h5 class="report-title">Vendas por Cliente</h5>
                  <p class="report-desc">Histórico de compras por cliente</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ESTOQUE -->
        <div class="category-section">
          <div class="category-header">
            <div class="category-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);"><i class="fa fa-boxes"></i></div>
            <div>
              <h4 class="category-title">Estoque e Produtos</h4>
              <p class="category-desc">Controle de estoque e inventário</p>
            </div>
          </div>
          <div class="reports-grid">
            <div class="report-card" onclick="openReport('estoque-atual')">
              <span class="badge-new">Essencial</span>
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(245,158,11,0.1); color: #f59e0b;"><i class="fa fa-warehouse"></i></div>
                <div>
                  <h5 class="report-title">Posição de Estoque</h5>
                  <p class="report-desc">Estoque atual de todos os produtos</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn" onclick="event.stopPropagation(); exportReportToPDF('estoque-atual')"><i class="fa fa-file-pdf"></i> PDF</button>
                <button class="report-btn" onclick="event.stopPropagation(); exportReport('estoque-atual', 'csv')"><i class="fa fa-file-csv"></i> CSV</button>
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>

            <div class="report-card" onclick="openReport('estoque-baixo')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(239,68,68,0.1); color: #ef4444;"><i class="fa fa-exclamation-triangle"></i></div>
                <div>
                  <h5 class="report-title">Estoque Baixo</h5>
                  <p class="report-desc">Produtos abaixo do mínimo</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn" onclick="event.stopPropagation(); exportReportToPDF('estoque-baixo')"><i class="fa fa-file-pdf"></i> PDF</button>
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>

            <div class="report-card" onclick="openReport('lista-precos')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(245,158,11,0.1); color: #f59e0b;"><i class="fa fa-tags"></i></div>
                <div>
                  <h5 class="report-title">Lista de Preços</h5>
                  <p class="report-desc">Catálogo com preços de venda</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn" onclick="event.stopPropagation(); exportReportToPDF('lista-precos')"><i class="fa fa-file-pdf"></i> PDF</button>
                <button class="report-btn" onclick="event.stopPropagation(); exportReport('lista-precos', 'csv')"><i class="fa fa-file-csv"></i> CSV</button>
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>
          </div>
        </div>

        <!-- FINANCEIRO -->
        <div class="category-section">
          <div class="category-header">
            <div class="category-icon" style="background: linear-gradient(135deg, #6366f1, #4f46e5);"><i class="fa fa-dollar-sign"></i></div>
            <div>
              <h4 class="category-title">Financeiro</h4>
              <p class="category-desc">Fluxo de caixa e contas</p>
            </div>
          </div>
          <div class="reports-grid">
            <div class="report-card" onclick="openReport('fluxo-caixa')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(99,102,241,0.1); color: #6366f1;"><i class="fa fa-money-bill-wave"></i></div>
                <div>
                  <h5 class="report-title">Fluxo de Caixa</h5>
                  <p class="report-desc">Entradas e saídas</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>

            <div class="report-card" onclick="openReport('contas-receber')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(16,185,129,0.1); color: #10b981;"><i class="fa fa-hand-holding-usd"></i></div>
                <div>
                  <h5 class="report-title">Contas a Receber</h5>
                  <p class="report-desc">Valores pendentes de clientes</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>

            <div class="report-card" onclick="openReport('contas-pagar')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(239,68,68,0.1); color: #ef4444;"><i class="fa fa-file-invoice-dollar"></i></div>
                <div>
                  <h5 class="report-title">Contas a Pagar</h5>
                  <p class="report-desc">Compromissos com fornecedores</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>
          </div>
        </div>

        <!-- CADASTROS -->
        <div class="category-section">
          <div class="category-header">
            <div class="category-icon" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);"><i class="fa fa-database"></i></div>
            <div>
              <h4 class="category-title">Cadastros</h4>
              <p class="category-desc">Listagens e exportações</p>
            </div>
          </div>
          <div class="reports-grid">
            <div class="report-card" onclick="openReport('lista-clientes')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(14,165,233,0.1); color: #0ea5e9;"><i class="fa fa-users"></i></div>
                <div>
                  <h5 class="report-title">Lista de Clientes</h5>
                  <p class="report-desc">Cadastro completo</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn" onclick="event.stopPropagation(); exportReportToPDF('lista-clientes')"><i class="fa fa-file-pdf"></i> PDF</button>
                <button class="report-btn" onclick="event.stopPropagation(); exportReport('lista-clientes', 'csv')"><i class="fa fa-file-csv"></i> CSV</button>
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>

            <div class="report-card" onclick="openReport('lista-produtos')">
              <div class="report-card-header">
                <div class="report-icon" style="background: rgba(14,165,233,0.1); color: #0ea5e9;"><i class="fa fa-barcode"></i></div>
                <div>
                  <h5 class="report-title">Lista de Produtos</h5>
                  <p class="report-desc">Catálogo completo</p>
                </div>
              </div>
              <div class="report-actions">
                <button class="report-btn" onclick="event.stopPropagation(); exportReportToPDF('lista-produtos')"><i class="fa fa-file-pdf"></i> PDF</button>
                <button class="report-btn" onclick="event.stopPropagation(); exportReport('lista-produtos', 'csv')"><i class="fa fa-file-csv"></i> CSV</button>
                <button class="report-btn primary"><i class="fa fa-eye"></i> Ver</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Relatório -->
  <div class="modal fade report-modal" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-chart-bar mr-2"></i> <span id="reportModalTitle">Relatório</span></h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <div id="reportLoading" class="text-center py-5">
            <div class="spinner mx-auto mb-3"></div>
            <p class="text-muted">Carregando dados...</p>
          </div>
          <div id="reportContent" class="report-result" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" onclick="exportToPDF()">
            <i class="fa fa-file-pdf mr-1"></i> Exportar PDF
          </button>
          <button type="button" class="btn btn-outline-secondary" onclick="exportCurrentReport()">
            <i class="fa fa-file-csv mr-1"></i> Exportar CSV
          </button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- jsPDF para geração de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <!-- Sistema de Toasts Elegantes -->
  <script src="js/toast.js"></script>
  <script>
    const API_BASE = '/api';
    let currentReport = null;
    let currentReportData = [];

    axios.interceptors.request.use(config => {
      const token = localStorage.getItem('authToken');
      if (token) config.headers.Authorization = `Bearer ${token}`;
      return config;
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('currentDate').textContent = DateTimeUtils.formatDate(new Date());
      setQuickPeriod();
      refreshAll();
    });

    function setQuickPeriod() {
      const period = document.getElementById('quickPeriod').value;
      const today = new Date();
      let from = new Date(), to = new Date();

      switch(period) {
        case 'today': from = to = today; break;
        case 'yesterday': from = to = DateTimeUtils.addDays(today, -1); break;
        case 'week': from = DateTimeUtils.addDays(today, -today.getDay()); to = new Date(); break;
        case 'month': from = new Date(today.getFullYear(), today.getMonth(), 1); to = new Date(); break;
        case 'quarter': from = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1); to = new Date(); break;
        case 'year': from = new Date(today.getFullYear(), 0, 1); to = new Date(); break;
      }

      document.getElementById('filterDateFrom').value = DateTimeUtils.formatDateISO(from);
      document.getElementById('filterDateTo').value = DateTimeUtils.formatDateISO(to);
    }

    function getFilters() {
      return {
        from: document.getElementById('filterDateFrom').value,
        to: document.getElementById('filterDateTo').value
      };
    }

    function formatMoney(v) {
      return (Number(v) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    async function refreshAll() {
      try {
        const [prodResp, pessoasResp] = await Promise.all([
          axios.get(`${API_BASE}/products`),
          axios.get(`${API_BASE}/people`)
        ]);
        
        const produtos = prodResp.data.data || prodResp.data || [];
        const pessoas = pessoasResp.data.data || pessoasResp.data || [];
        
        document.getElementById('statProdutos').textContent = produtos.length;
        document.getElementById('statClientes').textContent = pessoas.filter(p => (p.type || '').toLowerCase().includes('cliente')).length;

        try {
          const { from, to } = getFilters();
          const vendasResp = await axios.get(`${API_BASE}/vendas?from=${from}&to=${to}`);
          const vendas = vendasResp.data.data || vendasResp.data || [];
          const totalVendas = vendas.reduce((s, v) => s + (Number(v.total) || 0), 0);
          
          document.getElementById('statVendas').textContent = formatMoney(totalVendas);
          document.getElementById('statTicket').textContent = formatMoney(vendas.length ? totalVendas / vendas.length : 0);
        } catch(e) {
          document.getElementById('statVendas').textContent = 'R$ 0,00';
          document.getElementById('statTicket').textContent = 'R$ 0,00';
        }
      } catch (err) {
        console.error('Erro ao carregar estatísticas:', err);
      }
    }

    const reportTitles = {
      'vendas-periodo': 'Vendas por Período',
      'vendas-produto': 'Vendas por Produto',
      'vendas-pagamento': 'Vendas por Forma de Pagamento',
      'vendas-cliente': 'Vendas por Cliente',
      'estoque-atual': 'Posição de Estoque',
      'estoque-baixo': 'Estoque Baixo',
      'lista-precos': 'Lista de Preços',
      'fluxo-caixa': 'Fluxo de Caixa',
      'contas-receber': 'Contas a Receber',
      'contas-pagar': 'Contas a Pagar',
      'lista-clientes': 'Lista de Clientes',
      'lista-produtos': 'Lista de Produtos'
    };

    async function openReport(reportId) {
      currentReport = reportId;
      const { from, to } = getFilters();
      
      document.getElementById('reportModalTitle').textContent = reportTitles[reportId] || 'Relatório';
      document.getElementById('reportLoading').style.display = 'block';
      document.getElementById('reportContent').style.display = 'none';
      
      $('#reportModal').modal('show');

      try {
        let html = '', data = [];

        switch(reportId) {
          case 'vendas-periodo':
            const vendasResp = await axios.get(`${API_BASE}/vendas?from=${from}&to=${to}`);
            data = vendasResp.data.data || vendasResp.data || [];
            html = renderVendasPeriodo(data);
            break;

          case 'vendas-produto':
            const topResp = await axios.get(`${API_BASE}/dashboard/top-products?from=${from}&to=${to}&limit=50`);
            data = topResp.data.data || topResp.data || [];
            html = renderVendasProduto(data);
            break;

          case 'vendas-pagamento':
            const pagResp = await axios.get(`${API_BASE}/vendas?from=${from}&to=${to}`);
            data = pagResp.data.data || pagResp.data || [];
            html = renderVendasPagamento(data);
            break;

          case 'estoque-atual':
            const estResp = await axios.get(`${API_BASE}/products`);
            data = estResp.data.data || estResp.data || [];
            html = renderEstoqueAtual(data);
            break;

          case 'estoque-baixo':
            const estBResp = await axios.get(`${API_BASE}/products`);
            data = (estBResp.data.data || estBResp.data || []).filter(p => (Number(p.stock) || 0) <= (Number(p.minStock) || 5));
            html = renderEstoqueBaixo(data);
            break;

          case 'lista-precos':
            const precosResp = await axios.get(`${API_BASE}/products`);
            data = precosResp.data.data || precosResp.data || [];
            html = renderListaPrecos(data);
            break;

          case 'lista-clientes':
            const cliResp = await axios.get(`${API_BASE}/people?type=cliente`);
            data = cliResp.data.data || cliResp.data || [];
            html = renderListaPessoas(data);
            break;

          case 'lista-produtos':
            const prodResp = await axios.get(`${API_BASE}/products`);
            data = prodResp.data.data || prodResp.data || [];
            html = renderListaProdutos(data);
            break;

          case 'fluxo-caixa':
            const fluxoResp = await axios.get(`${API_BASE}/transactions?from=${from}&to=${to}`);
            data = fluxoResp.data.data || fluxoResp.data || [];
            html = renderFluxoCaixa(data);
            break;

          case 'contas-receber':
            const recResp = await axios.get(`${API_BASE}/transactions?type=receita&status=pendente`);
            data = recResp.data.data || recResp.data || [];
            html = renderContas(data, 'receber');
            break;

          case 'contas-pagar':
            const pagaResp = await axios.get(`${API_BASE}/transactions?type=despesa&status=pendente`);
            data = pagaResp.data.data || pagaResp.data || [];
            html = renderContas(data, 'pagar');
            break;

          default:
            html = '<div class="alert alert-info">Relatório em desenvolvimento</div>';
        }

        currentReportData = data;
        document.getElementById('reportContent').innerHTML = html;
        document.getElementById('reportLoading').style.display = 'none';
        document.getElementById('reportContent').style.display = 'block';

      } catch (err) {
        console.error('Erro:', err);
        document.getElementById('reportContent').innerHTML = `<div class="alert alert-danger">Erro: ${err.message}</div>`;
        document.getElementById('reportLoading').style.display = 'none';
        document.getElementById('reportContent').style.display = 'block';
      }
    }

    function renderVendasPeriodo(data) {
      const total = data.reduce((s, v) => s + (Number(v.total) || 0), 0);
      return `<div class="mb-3"><strong>Total:</strong> ${formatMoney(total)} | <strong>Vendas:</strong> ${data.length}</div>
        <table class="report-table"><thead><tr><th>#</th><th>Data</th><th>Cliente</th><th>Pagamento</th><th>Valor</th></tr></thead>
        <tbody>${data.map((v, i) => `<tr><td>${i + 1}</td><td>${DateTimeUtils.formatDate(v.created_at || v.date)}</td><td>${v.client_name || '-'}</td><td>${v.payment_method || '-'}</td><td><strong>${formatMoney(v.total)}</strong></td></tr>`).join('')}</tbody></table>`;
    }

    function renderVendasProduto(data) {
      return `<table class="report-table"><thead><tr><th>#</th><th>Produto</th><th>Qtd</th><th>Total</th></tr></thead>
        <tbody>${data.map((p, i) => `<tr><td>${i + 1}</td><td>${p.product_name || p.name}</td><td>${p.total_quantity || p.qty || 0}</td><td>${formatMoney(p.total_value || p.total)}</td></tr>`).join('')}</tbody></table>`;
    }

    function renderVendasPagamento(data) {
      const grouped = {};
      data.forEach(v => {
        const m = v.payment_method || 'Outros';
        if (!grouped[m]) grouped[m] = { count: 0, total: 0 };
        grouped[m].count++;
        grouped[m].total += Number(v.total) || 0;
      });
      const grandTotal = Object.values(grouped).reduce((s, g) => s + g.total, 0);
      return `<table class="report-table"><thead><tr><th>Forma</th><th>Qtd</th><th>Total</th><th>%</th></tr></thead>
        <tbody>${Object.entries(grouped).map(([m, g]) => `<tr><td>${m}</td><td>${g.count}</td><td>${formatMoney(g.total)}</td><td>${grandTotal ? ((g.total / grandTotal) * 100).toFixed(1) : 0}%</td></tr>`).join('')}</tbody></table>`;
    }

    function renderEstoqueAtual(data) {
      const total = data.reduce((s, p) => s + ((Number(p.stock) || 0) * (Number(p.cost) || 0)), 0);
      return `<div class="mb-3"><strong>Valor em Estoque:</strong> ${formatMoney(total)}</div>
        <table class="report-table"><thead><tr><th>Código</th><th>Produto</th><th>Estoque</th><th>Custo</th><th>Total</th></tr></thead>
        <tbody>${data.map(p => `<tr><td>${p.code || '-'}</td><td>${p.name}</td><td class="${(Number(p.stock) || 0) <= 5 ? 'text-danger font-weight-bold' : ''}">${p.stock || 0}</td><td>${formatMoney(p.cost)}</td><td>${formatMoney((Number(p.stock) || 0) * (Number(p.cost) || 0))}</td></tr>`).join('')}</tbody></table>`;
    }

    function renderEstoqueBaixo(data) {
      if (!data.length) return '<div class="alert alert-success"><i class="fa fa-check mr-2"></i>Nenhum produto com estoque baixo!</div>';
      return `<div class="alert alert-warning mb-3">${data.length} produto(s) com estoque crítico</div>
        <table class="report-table"><thead><tr><th>Código</th><th>Produto</th><th>Atual</th><th>Mínimo</th></tr></thead>
        <tbody>${data.map(p => `<tr><td>${p.code || '-'}</td><td>${p.name}</td><td class="text-danger font-weight-bold">${p.stock || 0}</td><td>${p.minStock || 5}</td></tr>`).join('')}</tbody></table>`;
    }

    function renderListaPrecos(data) {
      return `<table class="report-table"><thead><tr><th>Código</th><th>Produto</th><th>Custo</th><th>Preço</th><th>Margem</th></tr></thead>
        <tbody>${data.map(p => `<tr><td>${p.code || '-'}</td><td>${p.name}</td><td>${formatMoney(p.cost)}</td><td><strong>${formatMoney(p.price)}</strong></td><td>${p.cost ? (((p.price - p.cost) / p.cost) * 100).toFixed(1) : '-'}%</td></tr>`).join('')}</tbody></table>`;
    }

    function renderListaPessoas(data) {
      return `<div class="mb-3"><strong>Total:</strong> ${data.length}</div>
        <table class="report-table"><thead><tr><th>Código</th><th>Nome</th><th>CPF/CNPJ</th><th>Telefone</th><th>Cidade</th></tr></thead>
        <tbody>${data.map(p => `<tr><td>${p.code || '-'}</td><td>${p.name}</td><td>${p.cpf_cnpj || p.cpf || '-'}</td><td>${p.phone || '-'}</td><td>${p.city || '-'}</td></tr>`).join('')}</tbody></table>`;
    }

    function renderListaProdutos(data) {
      return `<div class="mb-3"><strong>Total:</strong> ${data.length}</div>
        <table class="report-table"><thead><tr><th>Código</th><th>Nome</th><th>Categoria</th><th>Estoque</th><th>Preço</th></tr></thead>
        <tbody>${data.map(p => `<tr><td>${p.code || '-'}</td><td>${p.name}</td><td>${p.category || '-'}</td><td>${p.stock || 0}</td><td>${formatMoney(p.price)}</td></tr>`).join('')}</tbody></table>`;
    }

    function renderFluxoCaixa(data) {
      const receitas = data.filter(t => (t.type || t.tipo) === 'receita').reduce((s, t) => s + (Number(t.value || t.valor) || 0), 0);
      const despesas = data.filter(t => (t.type || t.tipo) === 'despesa').reduce((s, t) => s + (Number(t.value || t.valor) || 0), 0);
      return `<div class="row mb-3">
        <div class="col-4"><div class="alert alert-success mb-0">Entradas: ${formatMoney(receitas)}</div></div>
        <div class="col-4"><div class="alert alert-danger mb-0">Saídas: ${formatMoney(despesas)}</div></div>
        <div class="col-4"><div class="alert alert-primary mb-0">Saldo: ${formatMoney(receitas - despesas)}</div></div>
      </div>
      <table class="report-table"><thead><tr><th>Data</th><th>Descrição</th><th>Tipo</th><th>Valor</th></tr></thead>
      <tbody>${data.map(t => `<tr><td>${DateTimeUtils.formatDate(t.date || t.created_at)}</td><td>${t.description || '-'}</td><td><span class="badge badge-${(t.type || t.tipo) === 'receita' ? 'success' : 'danger'}">${(t.type || t.tipo) === 'receita' ? 'Entrada' : 'Saída'}</span></td><td>${formatMoney(t.value || t.valor)}</td></tr>`).join('')}</tbody></table>`;
    }

    function renderContas(data, tipo) {
      const total = data.reduce((s, t) => s + (Number(t.value || t.valor) || 0), 0);
      return `<div class="mb-3"><strong>Total a ${tipo === 'receber' ? 'Receber' : 'Pagar'}:</strong> ${formatMoney(total)}</div>
        <table class="report-table"><thead><tr><th>Vencimento</th><th>Descrição</th><th>Pessoa</th><th>Valor</th></tr></thead>
        <tbody>${data.map(t => `<tr><td>${DateTimeUtils.formatDate(t.due_date || t.vencimento)}</td><td>${t.description || '-'}</td><td>${t.person_name || '-'}</td><td>${formatMoney(t.value || t.valor)}</td></tr>`).join('')}</tbody></table>`;
    }

    function exportReport(reportId, format) {
      openReport(reportId).then(() => setTimeout(exportCurrentReport, 1000));
    }

    // Exportar relatório diretamente para PDF (sem abrir modal)
    async function exportReportToPDF(reportId) {
      try {
        // Abre o relatório primeiro para carregar os dados
        await openReport(reportId);
        // Aguarda a tabela ser renderizada
        setTimeout(() => {
          exportToPDF();
          $('#reportModal').modal('hide');
        }, 500);
      } catch(err) {
        console.error('Erro ao exportar PDF:', err);
        Toast.error('Erro ao gerar PDF');
      }
    }

    function exportCurrentReport() {
      const table = document.querySelector('#reportContent table');
      if (!table) { Toast.warning('Tabela não encontrada'); return; }
      
      // Usar ponto e vírgula como separador (padrão brasileiro/Excel)
      const separator = ';';
      let csv = '';
      
      table.querySelectorAll('tr').forEach(row => {
        const cols = [];
        row.querySelectorAll('th, td').forEach(cell => {
          // Limpar texto: remover quebras de linha, tabs, e espaços extras
          let text = cell.textContent
            .replace(/[\r\n\t]+/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
          
          // Escapar aspas duplas
          text = text.replace(/"/g, '""');
          
          // Envolver em aspas para garantir que cada campo fique em sua coluna
          cols.push('"' + text + '"');
        });
        csv += cols.join(separator) + '\r\n';
      });
      
      // BOM para UTF-8 (Excel reconhecer acentos)
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${currentReport || 'relatorio'}_${DateTimeUtils.todayISO()}.csv`;
      link.click();
    }

    // Função para gerar PDF do relatório
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const table = document.querySelector('#reportContent table');
      
      if (!table) {
        Toast.warning('Nenhuma tabela encontrada para exportar');
        return;
      }

      try {
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // Obter dados da empresa
        const companySettings = getCompanySettingsForPDF();
        const operatorName = localStorage.getItem('userName') || 'Operador';
        const reportTitle = reportTitles[currentReport] || 'Relatório';
        const { from, to } = getFilters();
        
        // Cabeçalho da empresa
        let yPos = 15;
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text(companySettings.name, pageWidth / 2, yPos, { align: 'center' });
        
        yPos += 6;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        if (companySettings.cnpj) {
          doc.text('CNPJ: ' + companySettings.cnpj, pageWidth / 2, yPos, { align: 'center' });
          yPos += 4;
        }
        if (companySettings.address) {
          doc.text(companySettings.address, pageWidth / 2, yPos, { align: 'center' });
          yPos += 4;
        }
        if (companySettings.phone) {
          doc.text('Tel: ' + companySettings.phone, pageWidth / 2, yPos, { align: 'center' });
          yPos += 4;
        }
        
        // Linha separadora
        yPos += 3;
        doc.setDrawColor(100);
        doc.line(15, yPos, pageWidth - 15, yPos);
        yPos += 8;
        
        // Título do relatório
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(reportTitle, pageWidth / 2, yPos, { align: 'center' });
        yPos += 7;
        
        // Período e operador
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        const fromDate = from ? DateTimeUtils.formatDate(from) : '-';
        const toDate = to ? DateTimeUtils.formatDate(to) : '-';
        doc.text(`Período: ${fromDate} a ${toDate}`, 15, yPos);
        doc.text(`Emitido por: ${operatorName}`, pageWidth - 15, yPos, { align: 'right' });
        yPos += 4;
        doc.text(`Data de emissão: ${DateTimeUtils.formatDate(new Date())} às ${DateTimeUtils.formatTime(new Date())}`, 15, yPos);
        yPos += 8;
        
        // Extrair dados da tabela
        const headers = [];
        const rows = [];
        
        table.querySelectorAll('thead th').forEach(th => {
          headers.push(th.textContent.trim());
        });
        
        table.querySelectorAll('tbody tr').forEach(tr => {
          const row = [];
          tr.querySelectorAll('td').forEach(td => {
            row.push(td.textContent.trim());
          });
          if (row.length > 0) rows.push(row);
        });

        if (headers.length === 0 || rows.length === 0) {
          Toast.warning('Não há dados para exportar');
          return;
        }

        // Adicionar tabela com autoTable
        doc.autoTable({
          head: [headers],
          body: rows,
          startY: yPos,
          theme: 'grid',
          styles: {
            fontSize: 8,
            cellPadding: 2,
            overflow: 'linebreak',
            halign: 'left'
          },
          headStyles: {
            fillColor: [99, 102, 241],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
          },
          alternateRowStyles: {
            fillColor: [245, 247, 250]
          },
          margin: { left: 10, right: 10 },
          didDrawPage: function(data) {
            // Rodapé em cada página
            const pageNum = doc.internal.getNumberOfPages();
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`Página ${data.pageNumber} de ${pageNum}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
          }
        });
        
        // Adicionar resumo se existir
        const summaryEl = document.querySelector('#reportContent .mb-3 strong, #reportContent .alert');
        if (summaryEl) {
          const finalY = doc.lastAutoTable.finalY + 8;
          doc.setFontSize(9);
          doc.setFont('helvetica', 'bold');
          // Limpar HTML tags
          const summaryText = summaryEl.parentElement ? summaryEl.parentElement.textContent : summaryEl.textContent;
          if (summaryText) {
            doc.text(summaryText.trim(), 15, finalY);
          }
        }
        
        // Salvar PDF
        const fileName = `${currentReport || 'relatorio'}_${DateTimeUtils.todayISO()}.pdf`;
        doc.save(fileName);
        
      } catch (err) {
        console.error('Erro ao gerar PDF:', err);
        Toast.error('Erro ao gerar PDF: ' + err.message);
      }
    }

    // Obter configurações da empresa para o PDF
    function getCompanySettingsForPDF() {
      try {
        const saved = localStorage.getItem('companySettings');
        if (saved) {
          const data = JSON.parse(saved);
          return {
            name: data.fantasyName || data.companyName || data.name || 'MINHA EMPRESA',
            cnpj: data.cnpj || '',
            address: (data.street || '') + (data.number ? ', ' + data.number : '') + (data.city ? ' - ' + data.city : '') + (data.state ? '/' + data.state : ''),
            phone: data.phone || ''
          };
        }
      } catch(e) {}
      return { name: 'MINHA EMPRESA', cnpj: '', address: '', phone: '' };
    }
  </script>
</body>
</html>
