<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda - Sistema</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <!-- Auth Guard - Proteção de acesso -->
  <script src="js/auth-guard.js"></script>
  <script src="js/branding.js"></script>
  <script src="js/sidebar.js"></script>
  <style>
    /* Estilos específicos da Agenda */
    .agenda-container { display: flex; flex-grow: 1; padding: 20px; gap: 20px; overflow-y: auto; flex-direction: column; }
    .agenda-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
    .calendar-container { padding: 20px; min-height: 500px; }
    .agenda-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px 20px; background: var(--gray-50); border-radius: 12px; box-shadow: var(--shadow-sm); }
    .view-selector { display: flex; gap: 8px; align-items: center; }
    .view-selector span { font-weight: 600; color: var(--gray-600); margin-right: 8px; }
    .view-btn { padding: 8px 16px; border: 2px solid var(--gray-200); background: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .view-btn:hover { border-color: var(--brand); color: var(--brand); transform: translateY(-2px); }
    .view-btn.active { background: var(--brand-gradient); color: white; border-color: var(--brand); box-shadow: var(--shadow-md); }
    .upcoming-events { padding: 16px; max-height: 400px; overflow-y: auto; }
    .event-item { display: flex; align-items: flex-start; padding: 14px; margin-bottom: 12px; background: var(--gray-50); border-radius: 10px; cursor: pointer; transition: all 0.3s; border-left: 4px solid var(--brand); }
    .event-item:hover { background: var(--gray-100); transform: translateX(4px); box-shadow: var(--shadow-sm); }
    .event-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 14px; color: white; font-size: 16px; }
    .event-content { flex: 1; }
    .event-title { font-weight: 700; color: var(--gray-800); font-size: 14px; }
    .event-time { font-size: 12px; color: var(--gray-500); margin-top: 2px; }
    .event-desc { font-size: 12px; color: var(--gray-600); margin-top: 4px; }
    .stat-value { font-size: 28px; font-weight: 800; color: var(--brand); }
    .stat-label { font-size: 13px; color: var(--gray-500); font-weight: 600; }
    .stats-mini { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .stats-mini .stat-card { background: rgba(99, 102, 241, 0.08); border: none; box-shadow: none; transition: all 0.3s; }
    .stats-mini .stat-card:hover { background: rgba(99, 102, 241, 0.15); transform: translateY(-2px); }
    .refresh-btn { background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); color: var(--brand); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
    .refresh-btn:hover { background: var(--brand); color: white; }
    .fc { font-family: 'Inter', sans-serif; }
    .fc .fc-toolbar-title { font-size: 20px; font-weight: 700; color: var(--gray-800); }
    .fc .fc-button { background: var(--brand); border: none; border-radius: 8px; font-weight: 600; transition: all 0.3s; }
    .fc .fc-button:hover { background: var(--brand-dark); transform: translateY(-1px); }
    .fc .fc-button-primary:not(:disabled).fc-button-active { background: var(--brand-dark); }
    .fc-daygrid-day-number { font-weight: 600; color: var(--gray-700); }
    .fc-event { border-radius: 6px; padding: 2px 6px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
    .fc-event:hover { transform: scale(1.02); box-shadow: var(--shadow-sm); }
    .fc-day-today { background: rgba(99, 102, 241, 0.08) !important; }
    @media (max-width: 992px) { .agenda-grid { grid-template-columns: 1fr; } .stats-mini { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 480px) { .stats-mini { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="sidebar">
      <h4>SISTEMA</h4>
      <ul class="sidebar-menu">
        <li><a href="index.html"><span class="menu-icon"><i class="fa fa-home"></i></span><span class="menu-label">Início</span></a></li>
        <li><a href="pdv.html"><span class="menu-icon"><i class="fa fa-cash-register"></i></span><span class="menu-label">PDV</span></a></li>
        <li><a href="dashboard.html"><span class="menu-icon"><i class="fa fa-chart-pie"></i></span><span class="menu-label">Painel</span></a></li>
        <li><a href="nfe-emissao.html"><span class="menu-icon"><i class="fa fa-file-invoice"></i></span><span class="menu-label">Notas Fiscais</span></a></li>
        <li><a href="movimentos.html"><span class="menu-icon"><i class="fa fa-exchange-alt"></i></span><span class="menu-label">Movimentos</span></a></li>
        <li><a href="relatorios.html"><span class="menu-icon"><i class="fa fa-chart-bar"></i></span><span class="menu-label">Relatórios</span></a></li>
        <li><a href="pessoas.html"><span class="menu-icon"><i class="fa fa-users"></i></span><span class="menu-label">Clientes</span></a></li>
        <li><a href="produtos.html"><span class="menu-icon"><i class="fa fa-boxes"></i></span><span class="menu-label">Produtos</span></a></li>
        <li><a href="agenda.html" class="active"><span class="menu-icon"><i class="fa fa-calendar"></i></span><span class="menu-label">Agenda</span></a></li>
        <li><a href="admin.html"><span class="menu-icon"><i class="fa fa-cogs"></i></span><span class="menu-label">Admin</span></a></li>
      </ul>
    </div>

    <div class="main-content">
      <div class="main-header">
        <h3><i class="fa fa-calendar-alt"></i> Agenda</h3>
        <div class="header-info">
          <span><i class="fa fa-user-circle mr-2"></i>Admin</span>
          <span><i class="fa fa-clock mr-2"></i><span id="currentTime">--:--:--</span></span>
          <button id="refreshBtn" class="refresh-btn"><i class="fa fa-sync-alt"></i> Atualizar</button>
        </div>
      </div>

      <div class="agenda-container">
        <!-- Controles -->
        <div class="agenda-controls">
          <div class="view-selector">
            <span>Visualização:</span>
            <button class="view-btn active" data-view="month">Mês</button>
            <button class="view-btn" data-view="week">Semana</button>
            <button class="view-btn" data-view="day">Dia</button>
          </div>
          <button class="btn btn-primary" data-toggle="modal" data-target="#eventModal">
            <i class="fa fa-plus mr-1"></i>Novo Evento
          </button>
        </div>

        <!-- Grid -->
        <div class="agenda-grid">
          <div class="card">
            <div class="card-header"><i class="fa fa-calendar"></i> Calendário</div>
            <div class="calendar-container"><div id="calendar"></div></div>
          </div>
          <div class="card">
            <div class="card-header"><i class="fa fa-clock"></i> Próximos Eventos <span id="upcomingCount" class="badge badge-light float-right">0</span></div>
            <div class="upcoming-events" id="upcomingEvents"></div>
          </div>
        </div>

        <!-- Estatísticas -->
        <div class="card">
          <div class="card-header"><i class="fa fa-chart-bar"></i> Estatísticas</div>
          <div class="p-4">
            <div class="row">
              <div class="col-md-3">
                <div class="stat-card text-center p-3" style="background: rgba(99, 102, 241, 0.1); border-radius: 12px;">
                  <div class="stat-value" id="totalEvents">0</div>
                  <div class="stat-label">Total de Eventos</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center p-3" style="background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                  <div class="stat-value" id="todayEvents">0</div>
                  <div class="stat-label">Eventos Hoje</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center p-3" style="background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                  <div class="stat-value" id="weekEvents">0</div>
                  <div class="stat-label">Esta Semana</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center p-3" style="background: rgba(239, 68, 68, 0.1); border-radius: 12px;">
                  <div class="stat-value" id="overdueEvents">0</div>
                  <div class="stat-label">Atrasados</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Novo Evento -->
  <div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Novo Evento</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Título *</label>
            <input id="evtTitle" class="form-control" placeholder="Digite o título">
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label>Data *</label>
                <input id="evtDate" type="date" class="form-control">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Hora</label>
                <input id="evtTime" type="time" class="form-control">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Descrição</label>
            <textarea id="evtDesc" class="form-control" rows="3" placeholder="Descrição do evento"></textarea>
          </div>
          <div class="form-group">
            <label>Tipo</label>
            <select id="evtType" class="form-control">
              <option value="meeting">Reunião</option>
              <option value="appointment">Compromisso</option>
              <option value="task">Tarefa</option>
              <option value="reminder">Lembrete</option>
              <option value="other">Outro</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" id="saveEvt" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detalhes -->
  <div class="modal fade" id="eventDetailsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detalhes do Evento</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body" id="eventDetailsContent"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-danger" id="deleteEventBtn">Excluir</button>
          <button type="button" class="btn btn-primary" id="editEventBtn">Editar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Módulo centralizado de data/hora (Brasília) -->
  <script src="/js/datetime-utils.js"></script>
  <!-- Sistema de Toasts Elegantes -->
  <script src="js/toast.js"></script>
  <script>
    const API_BASE = 'http://localhost:3000/api';
    let agendaData = { events: [], calendar: null, currentView: 'month', selectedEvent: null };

    // Relógio (usando módulo centralizado)
    setInterval(() => {
      const el = document.getElementById('currentTime');
      if (el) el.textContent = DateTimeUtils.formatTime(new Date());
    }, 1000);

    // Carregar eventos
    async function loadEvents() {
      try {
        const res = await axios.get(`${API_BASE}/agenda`);
        const apiEvents = res.data.data || res.data || [];
        agendaData.events = apiEvents.map(e => ({
          id: e.id, title: e.title, start: e.start || e.startDate || e.start_date, end: e.end || e.endDate || e.end_date,
          description: e.description, type: e.type || 'other', color: e.color || '#6366f1'
        }));
        updateAgenda();
      } catch (err) {
        console.error('Erro ao carregar eventos:', err);
        agendaData.events = [];
        updateAgenda();
      }
    }

    // Salvar evento
    async function saveEvent(eventData) {
      try {
        // Enviar como 'start'/'end' pois a API usa 'event.start'
        const payload = { title: eventData.title, description: eventData.description || '', start: eventData.start, end: eventData.end || eventData.start, allDay: false, color: '#6366f1', status: 'agendado' };
        const res = await axios.post(`${API_BASE}/agenda`, payload);
        // API retorna 201 e objeto com id; aceitar tanto 'success' quanto status 201/id
        if (res.status === 201 || (res.data && (res.data.success || res.data.id))) { Toast.success('Evento salvo com sucesso!'); await loadEvents(); return true; }
      } catch (err) { console.error('Erro ao salvar:', err); Toast.error('Erro ao salvar evento: ' + (err.message || 'Ver console para detalhes')); }
      return false;
    }

    // Excluir evento
    async function deleteEvent(eventId) {
      try {
        const res = await axios.delete(`${API_BASE}/agenda/${eventId}`);
        // Sucesso quando retorna 204 No Content
        if (res.status === 204) { Toast.success('Evento excluído com sucesso!'); await loadEvents(); return true; }
        // Alguns adaptadores podem retornar um body
        if (res.data && (res.data.success || res.data.id)) { Toast.success('Evento excluído com sucesso!'); await loadEvents(); return true; }
      } catch (err) {
        console.error('Erro ao excluir:', err);
        if (err.response && err.response.status === 404) {
          Toast.warning('Evento não encontrado ou já foi removido. A lista será atualizada.');
          await loadEvents();
          return false;
        }
        Toast.error('Erro ao excluir evento. Veja o console para detalhes.');
      }
      return false;
    }

    // Inicializar calendário
    function initCalendar() {
      const calEl = document.getElementById('calendar');
      if (!calEl || typeof FullCalendar === 'undefined') return;
      agendaData.calendar = new FullCalendar.Calendar(calEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
        events: agendaData.events,
        eventClick: function(info) { showEventDetails(info.event.id); },
        dateClick: function(info) {
          document.getElementById('evtDate').value = info.dateStr;
          $('#eventModal').modal('show');
        }
      });
      agendaData.calendar.render();
    }

    // Atualizar agenda
    function updateAgenda() {
      if (agendaData.calendar) {
        agendaData.calendar.removeAllEvents();
        agendaData.events.forEach(e => agendaData.calendar.addEvent(e));
      }
      updateUpcomingEvents();
      updateStatistics();
    }

    // Próximos eventos
    function updateUpcomingEvents() {
      const container = document.getElementById('upcomingEvents');
      const countEl = document.getElementById('upcomingCount');
      if (!container) return;
      const now = new Date();
      const upcoming = agendaData.events.filter(e => new Date(e.start) >= now).sort((a, b) => new Date(a.start) - new Date(b.start)).slice(0, 5);
      countEl.textContent = upcoming.length;
      if (!upcoming.length) {
        container.innerHTML = '<div class="event-item"><div class="event-content"><div class="event-title">Nenhum evento</div></div></div>';
      } else {
        container.innerHTML = upcoming.map(e => {
          const date = new Date(e.start);
          const typeColors = { meeting: '#6366f1', appointment: '#10b981', task: '#f59e0b', reminder: '#ef4444', other: '#64748b' };
          const typeIcons = { meeting: 'fa-users', appointment: 'fa-calendar-check', task: 'fa-tasks', reminder: 'fa-bell', other: 'fa-calendar-alt' };
          return `<div class="event-item" data-id="${e.id}"><div class="event-icon" style="background: ${typeColors[e.type] || '#6366f1'}"><i class="fa ${typeIcons[e.type] || 'fa-calendar-alt'}"></i></div><div class="event-content"><div class="event-title">${e.title}</div><div class="event-time">${DateTimeUtils.formatDate(date)} às ${DateTimeUtils.formatTimeShort(date)}</div></div></div>`;
        }).join('');
        document.querySelectorAll('.event-item').forEach(item => item.addEventListener('click', () => showEventDetails(item.dataset.id)));
      }
    }

    // Estatísticas
    function updateStatistics() {
      const now = new Date();
      const today = DateTimeUtils.todayISO();
      const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - now.getDay()); startOfWeek.setHours(0,0,0,0);
      const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate() + 6); endOfWeek.setHours(23,59,59,999);

      // Helper seguro para parsing de datas
      const parseSafe = s => { const d = new Date(s); return isNaN(d) ? null : d; };

      const todayEvts = agendaData.events.filter(e => {
        const d = parseSafe(e.start); return d && DateTimeUtils.formatDateISO(d) === today;
      }).length;

      const weekEvts = agendaData.events.filter(e => {
        const d = parseSafe(e.start); return d && d >= startOfWeek && d <= endOfWeek;
      }).length;

      const overdue = agendaData.events.filter(e => {
        const d = parseSafe(e.start); return d && d < now;
      }).length;

      document.getElementById('totalEvents').textContent = agendaData.events.length;
      document.getElementById('todayEvents').textContent = todayEvts;
      document.getElementById('weekEvents').textContent = weekEvts;
      document.getElementById('overdueEvents').textContent = overdue;
    }

    // Detalhes do evento
    function showEventDetails(eventId) {
      const event = agendaData.events.find(e => e.id == eventId);
      if (!event) return;
      agendaData.selectedEvent = event;
      const date = new Date(event.start);
      const typeLabels = { meeting: 'Reunião', appointment: 'Compromisso', task: 'Tarefa', reminder: 'Lembrete', other: 'Outro' };
      document.getElementById('eventDetailsContent').innerHTML = `<h5>${event.title}</h5><p class="text-muted">${event.description || 'Sem descrição'}</p><hr><p><strong>Tipo:</strong> ${typeLabels[event.type] || 'Outro'}</p><p><strong>Data:</strong> ${DateTimeUtils.formatDate(date)}</p><p><strong>Hora:</strong> ${DateTimeUtils.formatTimeShort(date)}</p>`;
      $('#eventDetailsModal').modal('show');
    }

    // Form
    function clearForm() {
      document.getElementById('evtTitle').value = '';
      document.getElementById('evtDate').value = '';
      document.getElementById('evtTime').value = '';
      document.getElementById('evtDesc').value = '';
      document.getElementById('evtType').value = 'meeting';
    }

    // Eventos
    document.addEventListener('DOMContentLoaded', () => {
      initCalendar();
      loadEvents();
      document.getElementById('refreshBtn').addEventListener('click', loadEvents);
      document.getElementById('saveEvt').addEventListener('click', async () => {
        const title = document.getElementById('evtTitle').value.trim();
        const date = document.getElementById('evtDate').value;
        const time = document.getElementById('evtTime').value;
        const desc = document.getElementById('evtDesc').value;
        const type = document.getElementById('evtType').value;
        if (!title || !date) { Toast.warning('Preencha título e data'); return; }
        const start = time ? `${date}T${time}:00` : date;
        const success = await saveEvent({ title, start, description: desc, type });
        if (success) { $('#eventModal').modal('hide'); clearForm(); }
      });
      document.getElementById('deleteEventBtn').addEventListener('click', async () => {
        if (!agendaData.selectedEvent) return;
        const confirmar = await Modal.delete('Excluir este evento?', 'Excluir Evento');
        if (confirmar) {
          const success = await deleteEvent(agendaData.selectedEvent.id);
          if (success) { Toast.success('Evento excluído com sucesso!'); $('#eventDetailsModal').modal('hide'); }
        }
      });
      document.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', function() {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const views = { month: 'dayGridMonth', week: 'timeGridWeek', day: 'timeGridDay' };
        if (agendaData.calendar) agendaData.calendar.changeView(views[this.dataset.view]);
      }));
      $('#eventModal').on('hidden.bs.modal', clearForm);
    });
  </script>
</body>
</html>
