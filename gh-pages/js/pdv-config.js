const API_BASE = '/api';
async function loadPdv(){ try{ const q=document.getElementById('searchPdv').value; const res=await axios.get(`${API_BASE}/pdv-config?search=${encodeURIComponent(q)}`); const items=res.data.data||res.data||[]; const c=document.getElementById('pdvList'); if(!items.length){ c.innerHTML=`<div class="text-center py-5 text-muted"><i class="fa fa-folder-open fa-4x"></i><p>Nenhuma regra cadastrada</p></div>`; return;} c.innerHTML=items.map(it=>`<div class="card list-card"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="font-weight-bold">${it.nome||it.name||'Regra'}</div><div class="text-muted">Exigir CPF: ${it.exigir_cpf||it.requireCpf? 'Sim':'Não'} • Desconto: ${it.limite_desconto_percent||it.discount||'-'}%</div></div><div class="btn-group"><button class="btn btn-sm btn-outline-primary" onclick="editPdv('${it.id}')"><i class="fa fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deletePdv('${it.id}')"><i class="fa fa-trash"></i></button></div></div></div>`).join(''); }catch(e){console.error(e); document.getElementById('pdvList').innerHTML='<div class="alert alert-warning">Erro ao carregar.</div>';} }
function openPdvModal(item=null){ document.getElementById('pdvForm').reset(); document.getElementById('pdvId').value=''; document.getElementById('pdvModalTitle').textContent='Nova Regra de PDV'; if(item){ document.getElementById('pdvId').value=item.id; document.getElementById('pdvRequireCpf').checked=!!(item.exigir_cpf||item.requireCpf); document.getElementById('pdvDiscount').value=item.limite_desconto_percent||item.discount||''; document.getElementById('pdvModalTitle').textContent='Editar Regra de PDV'; } $('#pdvModal').modal('show'); }
async function editPdv(id){ try{ const res=await axios.get(`${API_BASE}/pdv-config/${id}`); openPdvModal(res.data); }catch(e){alert('Erro ao obter');} }
async function savePdv(){ const id=document.getElementById('pdvId').value; const data={ requireCpf:document.getElementById('pdvRequireCpf').checked, discount:parseFloat(document.getElementById('pdvDiscount').value)||0 }; try{ if(id) await axios.put(`${API_BASE}/pdv-config/${id}`, data); else await axios.post(`${API_BASE}/pdv-config`, data); $('#pdvModal').modal('hide'); loadPdv(); }catch(e){alert('Erro ao salvar');} }
async function deletePdv(id){ if(!confirm('Excluir?')) return; try{ await axios.delete(`${API_BASE}/pdv-config/${id}`); loadPdv(); }catch(e){alert('Erro ao excluir');} }

document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('searchPdv').addEventListener('input', debounce(loadPdv,300)); loadPdv(); }); function debounce(fn,t){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a), t); }; }
