<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administração - Sistema de Gestão Comercial</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/vendor/fontawesome/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <!-- Auth Guard - Proteção de acesso -->
  <script src="js/auth-guard.js"></script>
  <script src="js/branding.js"></script>
  <script src="js/datetime-utils.js"></script>
  <style>
    .admin-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .admin-card h4 {
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .admin-card h4 i {
      color: var(--brand);
    }
    
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
      border-radius: 12px;
      padding: 20px;
      color: #fff;
    }
    
    .stat-card.green {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .stat-card.orange {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .stat-card .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .stat-card .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .table-admin {
      border-radius: 12px;
      overflow: hidden;
    }
    
    .table-admin thead th {
      background: var(--gray-100);
      border: none;
      padding: 14px 16px;
      font-size: 12px;
      font-weight: 700;
      color: var(--gray-500);
      text-transform: uppercase;
    }
    
    .table-admin tbody td {
      padding: 14px 16px;
      vertical-align: middle;
    }
    
    .badge-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-active { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .badge-inactive { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .badge-admin { background: rgba(99, 102, 241, 0.15); color: #6366f1; }
    .badge-user { background: rgba(100, 116, 139, 0.15); color: #64748b; }
    
    .btn-admin {
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="fas fa-store sidebar-logo"></i>
        <h1 class="sidebar-title">Gestão</h1>
      </div>
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="sidebar-link"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
        <a href="pdv.html" class="sidebar-link"><i class="fas fa-cash-register"></i><span>PDV</span></a>
        <div class="sidebar-divider"></div>
        <a href="admin-sistema.html" class="sidebar-link active"><i class="fas fa-cogs"></i><span>Administração</span></a>
        <a href="usuarios.html" class="sidebar-link"><i class="fas fa-users-cog"></i><span>Usuários</span></a>
      </nav>
      <div class="sidebar-footer">
        <button class="btn btn-sm btn-outline-light w-100" onclick="logout()">
          <i class="fas fa-sign-out-alt mr-2"></i>Sair
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="main-header">
        <h3>Administração do Sistema</h3>
        <div class="header-info">
          <span id="currentUser">Carregando...</span>
          <span class="badge badge-info" id="currentRole">-</span>
        </div>
      </div>

      <div class="container-fluid p-4">
        <!-- Stats -->
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="totalTenants">0</div>
            <div class="stat-label">Empresas Cadastradas</div>
          </div>
          <div class="stat-card green">
            <div class="stat-value" id="totalUsers">0</div>
            <div class="stat-label">Usuários Ativos</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-value" id="activeNow">1</div>
            <div class="stat-label">Online Agora</div>
          </div>
        </div>

        <!-- Empresas/Tenants -->
        <div class="admin-card">
          <h4><i class="fas fa-building"></i> Empresas (Lojas)</h4>
          <div class="mb-3 d-flex justify-content-between align-items-center">
            <input type="text" class="form-control" style="max-width: 300px;" placeholder="Buscar empresa..." id="searchTenant">
            <button class="btn btn-primary btn-admin" onclick="openTenantModal()">
              <i class="fas fa-plus mr-2"></i>Nova Empresa
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-admin mb-0">
              <thead>
                <tr>
                  <th>Empresa</th>
                  <th>CNPJ</th>
                  <th>Contato</th>
                  <th>Plano</th>
                  <th>Status</th>
                  <th>Criado em</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="tenantsTableBody">
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">Carregando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Usuários -->
        <div class="admin-card">
          <h4><i class="fas fa-users"></i> Usuários do Sistema</h4>
          <div class="mb-3 d-flex justify-content-between align-items-center">
            <input type="text" class="form-control" style="max-width: 300px;" placeholder="Buscar usuário..." id="searchUser">
            <button class="btn btn-primary btn-admin" onclick="openUserModal()">
              <i class="fas fa-user-plus mr-2"></i>Novo Usuário
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-admin mb-0">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Usuário</th>
                  <th>Email</th>
                  <th>Perfil</th>
                  <th>Status</th>
                  <th>Último Acesso</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">Carregando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Nova Empresa -->
  <div class="modal fade" id="tenantModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-building mr-2"></i>Nova Empresa</h5>
          <button class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <form id="tenantForm">
            <div class="form-group">
              <label>Nome da Empresa *</label>
              <input type="text" class="form-control" id="tenantName" required>
            </div>
            <div class="form-group">
              <label>CNPJ</label>
              <input type="text" class="form-control" id="tenantCnpj" placeholder="00.000.000/0000-00">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" id="tenantEmail">
            </div>
            <div class="form-group">
              <label>Telefone</label>
              <input type="text" class="form-control" id="tenantPhone">
            </div>
            <div class="form-group">
              <label>Plano</label>
              <select class="form-control" id="tenantPlan">
                <option value="basic">Básico</option>
                <option value="professional">Profissional</option>
                <option value="enterprise">Enterprise</option>
              </select>
            </div>
            <hr>
            <h6>Usuário Administrador</h6>
            <div class="form-group">
              <label>Nome do Admin *</label>
              <input type="text" class="form-control" id="adminName" required>
            </div>
            <div class="form-group">
              <label>Usuário de Login *</label>
              <input type="text" class="form-control" id="adminUsername" required>
            </div>
            <div class="form-group">
              <label>Senha Inicial *</label>
              <input type="password" class="form-control" id="adminPassword" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" onclick="saveTenant()">
            <i class="fas fa-save mr-2"></i>Criar Empresa
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Novo Usuário -->
  <div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-user-plus mr-2"></i>Novo Usuário</h5>
          <button class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <div class="form-group">
              <label>Nome Completo *</label>
              <input type="text" class="form-control" id="userName" required>
            </div>
            <div class="form-group">
              <label>Usuário de Login *</label>
              <input type="text" class="form-control" id="userUsername" required>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" id="userEmail">
            </div>
            <div class="form-group">
              <label>Senha *</label>
              <input type="password" class="form-control" id="userPassword" required>
            </div>
            <div class="form-group">
              <label>Perfil</label>
              <select class="form-control" id="userRole">
                <option value="user">Operador</option>
                <option value="manager">Gerente</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" onclick="saveUser()">
            <i class="fas fa-save mr-2"></i>Criar Usuário
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="/vendor/axios/axios.min.js"></script>
  <!-- Sistema de Toasts Elegantes -->
  <script src="js/toast.js"></script>
  <script>
    const API_BASE = '/api';
    let currentTenantId = null;
    
    // Verificar autenticação
    document.addEventListener('DOMContentLoaded', async function() {
      const token = localStorage.getItem('authToken');
      const role = localStorage.getItem('userRole');
      
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Verificar se é admin
      if (role !== 'admin') {
        Toast.warning('Acesso restrito a administradores.');
        window.location.href = '/dashboard.html';
        return;
      }
      
      currentTenantId = localStorage.getItem('tenantId');
      
      // Mostrar info do usuário
      document.getElementById('currentUser').textContent = localStorage.getItem('userName') || 'Usuário';
      document.getElementById('currentRole').textContent = role === 'admin' ? 'Administrador' : 'Usuário';
      
      // Carregar dados
      await loadTenants();
      await loadUsers();
    });
    
    async function loadTenants() {
      try {
        const token = localStorage.getItem('authToken');
        const resp = await axios.get(`${API_BASE}/auth/tenants`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const tenants = Array.isArray(resp.data) ? resp.data : [];
        document.getElementById('totalTenants').textContent = tenants.length;
        
        const tbody = document.getElementById('tenantsTableBody');
        
        if (tenants.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Nenhuma empresa cadastrada</td></tr>';
          return;
        }
        
        tbody.innerHTML = tenants.map(t => `
          <tr>
            <td><strong>${t.name}</strong></td>
            <td>${t.cnpj || '-'}</td>
            <td>${t.email || '-'}<br><small class="text-muted">${t.phone || ''}</small></td>
            <td><span class="badge badge-info">${t.plan || 'basic'}</span></td>
            <td><span class="badge-status ${t.status === 'active' ? 'badge-active' : 'badge-inactive'}">${t.status === 'active' ? 'Ativo' : 'Inativo'}</span></td>
            <td><small>${DateTimeUtils.formatDate(t.created_at)}</small></td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editTenant('${t.id}')" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar empresas:', error);
      }
    }
    
    async function loadUsers() {
      try {
        const token = localStorage.getItem('authToken');
        const tenantId = localStorage.getItem('tenantId');
        
        const resp = await axios.get(`${API_BASE}/auth/users`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'X-Tenant-ID': tenantId
          }
        });
        
        const users = Array.isArray(resp.data) ? resp.data : [];
        document.getElementById('totalUsers').textContent = users.filter(u => u.active).length;
        
        const tbody = document.getElementById('usersTableBody');
        
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Nenhum usuário cadastrado</td></tr>';
          return;
        }
        
        tbody.innerHTML = users.map(u => `
          <tr>
            <td><strong>${u.name}</strong></td>
            <td>${u.username}</td>
            <td>${u.email || '-'}</td>
            <td><span class="badge-status ${u.role === 'admin' ? 'badge-admin' : 'badge-user'}">${getRoleLabel(u.role)}</span></td>
            <td><span class="badge-status ${u.active ? 'badge-active' : 'badge-inactive'}">${u.active ? 'Ativo' : 'Inativo'}</span></td>
            <td><small>${u.last_login ? DateTimeUtils.formatDateTime(u.last_login) : 'Nunca'}</small></td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editUser('${u.id}')" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-warning" onclick="resetPassword('${u.id}')" title="Resetar Senha">
                <i class="fas fa-key"></i>
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar usuários:', error);
      }
    }
    
    function getRoleLabel(role) {
      const labels = {
        'admin': 'Administrador',
        'manager': 'Gerente',
        'user': 'Operador'
      };
      return labels[role] || role;
    }
    
    function openTenantModal() {
      document.getElementById('tenantForm').reset();
      $('#tenantModal').modal('show');
    }
    
    function openUserModal() {
      document.getElementById('userForm').reset();
      $('#userModal').modal('show');
    }
    
    async function saveTenant() {
      const data = {
        name: document.getElementById('tenantName').value,
        cnpj: document.getElementById('tenantCnpj').value,
        email: document.getElementById('tenantEmail').value,
        phone: document.getElementById('tenantPhone').value,
        plan: document.getElementById('tenantPlan').value,
        adminName: document.getElementById('adminName').value,
        adminUsername: document.getElementById('adminUsername').value,
        adminPassword: document.getElementById('adminPassword').value
      };
      
      if (!data.name || !data.adminName || !data.adminUsername || !data.adminPassword) {
        Toast.warning('Preencha todos os campos obrigatórios.');
        return;
      }
      
      try {
        const token = localStorage.getItem('authToken');
        const resp = await axios.post(`${API_BASE}/auth/tenants`, data, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        await Modal.success(`Empresa criada com sucesso!\n\nUsuário: ${data.adminUsername}\nSenha: ${data.adminPassword}`, 'Empresa Criada');
        $('#tenantModal').modal('hide');
        await loadTenants();
      } catch (error) {
        Toast.error('Erro ao criar empresa: ' + (error.response?.data?.error || error.message));
      }
    }
    
    async function saveUser() {
      const data = {
        name: document.getElementById('userName').value,
        username: document.getElementById('userUsername').value,
        email: document.getElementById('userEmail').value,
        password: document.getElementById('userPassword').value,
        role: document.getElementById('userRole').value
      };
      
      if (!data.name || !data.username || !data.password) {
        Toast.warning('Preencha todos os campos obrigatórios.');
        return;
      }
      
      try {
        const token = localStorage.getItem('authToken');
        const tenantId = localStorage.getItem('tenantId');
        
        const resp = await axios.post(`${API_BASE}/auth/users`, data, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'X-Tenant-ID': tenantId
          }
        });
        
        Toast.success('Usuário criado com sucesso!');
        $('#userModal').modal('hide');
        await loadUsers();
      } catch (error) {
        Toast.error('Erro ao criar usuário: ' + (error.response?.data?.error || error.message));
      }
    }
    
    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('tenantId');
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      localStorage.removeItem('userRole');
      window.location.href = '/login.html';
    }
    
    async function editTenant(id) {
      try {
        const token = localStorage.getItem('authToken');
        const resp = await axios.get(`${API_BASE}/auth/tenants/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const tenant = resp.data;
        
        // Criar modal de edição dinâmico
        let modalEl = document.getElementById('editTenantModal');
        if (!modalEl) {
          modalEl = document.createElement('div');
          modalEl.id = 'editTenantModal';
          modalEl.className = 'modal fade';
          modalEl.innerHTML = `
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="fa fa-building mr-2"></i>Editar Empresa</h5>
                  <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                  <input type="hidden" id="editTenantId">
                  <div class="form-group">
                    <label>Nome da Empresa *</label>
                    <input type="text" class="form-control" id="editTenantName">
                  </div>
                  <div class="form-group">
                    <label>CNPJ</label>
                    <input type="text" class="form-control" id="editTenantCnpj">
                  </div>
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" id="editTenantEmail">
                  </div>
                  <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" class="form-control" id="editTenantPhone">
                  </div>
                  <div class="form-group">
                    <label>Plano</label>
                    <select class="form-control" id="editTenantPlan">
                      <option value="basic">Básico</option>
                      <option value="standard">Standard</option>
                      <option value="premium">Premium</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="editTenantActive">
                      <option value="1">Ativo</option>
                      <option value="0">Inativo</option>
                    </select>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" onclick="updateTenant()"><i class="fa fa-save"></i> Salvar</button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modalEl);
        }
        
        document.getElementById('editTenantId').value = id;
        document.getElementById('editTenantName').value = tenant.name || '';
        document.getElementById('editTenantCnpj').value = tenant.cnpj || '';
        document.getElementById('editTenantEmail').value = tenant.email || '';
        document.getElementById('editTenantPhone').value = tenant.phone || '';
        document.getElementById('editTenantPlan').value = tenant.plan || 'basic';
        document.getElementById('editTenantActive').value = tenant.active ? '1' : '0';
        
        $('#editTenantModal').modal('show');
      } catch (error) {
        Toast.error('Erro ao carregar empresa: ' + (error.response?.data?.error || error.message));
      }
    }
    
    async function updateTenant() {
      const id = document.getElementById('editTenantId').value;
      const data = {
        name: document.getElementById('editTenantName').value,
        cnpj: document.getElementById('editTenantCnpj').value,
        email: document.getElementById('editTenantEmail').value,
        phone: document.getElementById('editTenantPhone').value,
        plan: document.getElementById('editTenantPlan').value,
        active: document.getElementById('editTenantActive').value === '1'
      };
      
      try {
        const token = localStorage.getItem('authToken');
        await axios.put(`${API_BASE}/auth/tenants/${id}`, data, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        Toast.success('Empresa atualizada com sucesso!');
        $('#editTenantModal').modal('hide');
        await loadTenants();
      } catch (error) {
        Toast.error('Erro ao atualizar empresa: ' + (error.response?.data?.error || error.message));
      }
    }
    
    async function editUser(id) {
      try {
        const token = localStorage.getItem('authToken');
        const tenantId = localStorage.getItem('tenantId');
        
        const resp = await axios.get(`${API_BASE}/auth/users/${id}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'X-Tenant-ID': tenantId
          }
        });
        
        const user = resp.data;
        
        // Criar modal de edição dinâmico
        let modalEl = document.getElementById('editUserModal');
        if (!modalEl) {
          modalEl = document.createElement('div');
          modalEl.id = 'editUserModal';
          modalEl.className = 'modal fade';
          modalEl.innerHTML = `
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="fa fa-user mr-2"></i>Editar Usuário</h5>
                  <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                  <input type="hidden" id="editUserId">
                  <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" class="form-control" id="editUserName">
                  </div>
                  <div class="form-group">
                    <label>Username *</label>
                    <input type="text" class="form-control" id="editUserUsername" readonly>
                  </div>
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" id="editUserEmail">
                  </div>
                  <div class="form-group">
                    <label>Nova Senha (deixe em branco para manter)</label>
                    <input type="password" class="form-control" id="editUserPassword">
                  </div>
                  <div class="form-group">
                    <label>Perfil</label>
                    <select class="form-control" id="editUserRole">
                      <option value="admin">Administrador</option>
                      <option value="manager">Gerente</option>
                      <option value="user">Operador</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="editUserActive">
                      <option value="1">Ativo</option>
                      <option value="0">Inativo</option>
                    </select>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" onclick="updateUser()"><i class="fa fa-save"></i> Salvar</button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modalEl);
        }
        
        document.getElementById('editUserId').value = id;
        document.getElementById('editUserName').value = user.name || '';
        document.getElementById('editUserUsername').value = user.username || '';
        document.getElementById('editUserEmail').value = user.email || '';
        document.getElementById('editUserPassword').value = '';
        document.getElementById('editUserRole').value = user.role || 'user';
        document.getElementById('editUserActive').value = user.active ? '1' : '0';
        
        $('#editUserModal').modal('show');
      } catch (error) {
        Toast.error('Erro ao carregar usuário: ' + (error.response?.data?.error || error.message));
      }
    }
    
    async function updateUser() {
      const id = document.getElementById('editUserId').value;
      const data = {
        name: document.getElementById('editUserName').value,
        email: document.getElementById('editUserEmail').value,
        role: document.getElementById('editUserRole').value,
        active: document.getElementById('editUserActive').value === '1'
      };
      
      const newPassword = document.getElementById('editUserPassword').value;
      if (newPassword) {
        data.password = newPassword;
      }
      
      try {
        const token = localStorage.getItem('authToken');
        const tenantId = localStorage.getItem('tenantId');
        
        await axios.put(`${API_BASE}/auth/users/${id}`, data, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'X-Tenant-ID': tenantId
          }
        });
        
        Toast.success('Usuário atualizado com sucesso!');
        $('#editUserModal').modal('hide');
        await loadUsers();
      } catch (error) {
        Toast.error('Erro ao atualizar usuário: ' + (error.response?.data?.error || error.message));
      }
    }
    
    async function resetPassword(id) {
      const confirmar = await Modal.confirm('Deseja resetar a senha deste usuário para "mudar123"?', 'Resetar Senha');
      if (confirmar) {
        try {
          const token = localStorage.getItem('authToken');
          const tenantId = localStorage.getItem('tenantId');
          
          await axios.put(`${API_BASE}/auth/users/${id}`, { password: 'mudar123' }, {
            headers: { 
              'Authorization': `Bearer ${token}`,
              'X-Tenant-ID': tenantId
            }
          });
          
          Toast.success('Senha resetada com sucesso! Nova senha: mudar123');
        } catch (error) {
          Toast.error('Erro ao resetar senha: ' + (error.response?.data?.error || error.message));
        }
      }
    }
  </script>
</body>
</html>
