<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Início - Sistema</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <!-- Auth Guard - Proteção de acesso -->
  <script src="js/auth-guard.js"></script>
  <script src="js/branding.js"></script>
  <script src="js/sidebar.js"></script>
  <style>
    /* Estilos específicos da página inicial */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .stat-card { cursor: pointer; }
    .stat-card .stat-icon { background: var(--brand-gradient); }
    .stat-card .stat-icon.success { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card .stat-icon.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .stat-card .stat-icon.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-card .stat-icon.info { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
    .stat-trend { font-size: 12px; margin-top: 8px; display: flex; align-items: center; gap: 4px; }
    .stat-trend.positive { color: var(--success); }
    .stat-trend.negative { color: var(--danger); }
    .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; }
    .quick-action { background: #fff; border: 2px solid var(--gray-200); border-radius: 16px; padding: 24px 16px; text-align: center; cursor: pointer; transition: all 0.3s; text-decoration: none; color: var(--gray-700); display: block; }
    .quick-action:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--brand); color: var(--brand); text-decoration: none; }
    .quick-action i { font-size: 28px; margin-bottom: 10px; display: block; color: var(--brand); }
    .quick-action-title { font-weight: 700; font-size: 14px; }
    .quick-action-desc { font-size: 11px; color: var(--gray-500); margin-top: 4px; }
    .refresh-btn { background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); color: var(--brand); }
    .refresh-btn:hover { background: var(--brand); color: #fff; }
    @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr 1fr; } .quick-actions { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } .quick-actions { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="sidebar">
      <h4>SISTEMA</h4>
      <ul class="sidebar-menu">
        <li><a href="index.html" class="active"><span class="menu-icon"><i class="fa fa-home"></i></span><span class="menu-label">Início</span></a></li>
        <li><a href="pdv.html"><span class="menu-icon"><i class="fa fa-cash-register"></i></span><span class="menu-label">PDV</span></a></li>
        <li><a href="dashboard.html"><span class="menu-icon"><i class="fa fa-chart-pie"></i></span><span class="menu-label">Painel</span></a></li>
        <li><a href="nfe-emissao.html"><span class="menu-icon"><i class="fa fa-file-invoice"></i></span><span class="menu-label">Notas Fiscais</span></a></li>
        <li><a href="movimentos.html"><span class="menu-icon"><i class="fa fa-exchange-alt"></i></span><span class="menu-label">Movimentos</span></a></li>
        <li><a href="relatorios.html"><span class="menu-icon"><i class="fa fa-chart-bar"></i></span><span class="menu-label">Relatórios</span></a></li>
        <li><a href="pessoas.html"><span class="menu-icon"><i class="fa fa-users"></i></span><span class="menu-label">Clientes</span></a></li>
        <li><a href="produtos.html"><span class="menu-icon"><i class="fa fa-boxes"></i></span><span class="menu-label">Produtos</span></a></li>
        <li><a href="agenda.html"><span class="menu-icon"><i class="fa fa-calendar"></i></span><span class="menu-label">Agenda</span></a></li>
        <li><a href="admin.html"><span class="menu-icon"><i class="fa fa-cogs"></i></span><span class="menu-label">Admin</span></a></li>
      </ul>
    </div>

    <div class="main-content">
      <div class="main-header">
        <h3><i class="fa fa-home"></i> Página Inicial</h3>
        <div class="header-info">
          <span><i class="fa fa-user-circle mr-2"></i><span id="userName">Admin</span></span>
          <span><i class="fa fa-clock mr-2"></i><span id="currentTime">--:--:--</span></span>
          <button id="refreshBtn" class="refresh-btn"><i class="fa fa-sync-alt"></i> Atualizar</button>
          <button class="btn-logout" data-logout style="background:#dc3545;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px;margin-left:8px;">
            <i class="fa fa-sign-out-alt"></i> Sair
          </button>
        </div>
      </div>

      <div class="dashboard-container">
        <!-- Seção de Boas-vindas -->
        <div class="welcome-section">
          <h1 class="welcome-title">Bem-vindo ao Sistema</h1>
          <p class="welcome-subtitle">
            Sistema completo de gestão empresarial com PDV, controle financeiro, 
            cadastro de clientes e produtos, relatórios avançados e muito mais.
          </p>
          <a href="pdv.html" class="btn btn-primary btn-lg">
            <i class="fa fa-cash-register"></i> Iniciar Nova Venda
          </a>
        </div>

        <!-- Cards de Estatísticas -->
        <div class="stats-grid">
          <div class="stat-card" data-action="to-receive">
            <div class="stat-icon success">
              <i class="fa fa-money-bill-wave"></i>
            </div>
            <div class="stat-value" id="to-receive">R$ 0,00</div>
            <div class="stat-label">A Receber Hoje</div>
            <div class="stat-trend" id="receive-trend">
              <i class="fa fa-arrow-up"></i> <span>0%</span>
            </div>
          </div>
          
          <div class="stat-card" data-action="overdue">
            <div class="stat-icon danger">
              <i class="fa fa-exclamation-triangle"></i>
            </div>
            <div class="stat-value" id="overdue">R$ 0,00</div>
            <div class="stat-label">Receb. em Atraso</div>
            <div class="stat-trend" id="overdue-trend">
              <i class="fa fa-arrow-up"></i> <span>0%</span>
            </div>
          </div>
          
          <div class="stat-card" data-action="to-pay">
            <div class="stat-icon warning">
              <i class="fa fa-credit-card"></i>
            </div>
            <div class="stat-value" id="to-pay">R$ 0,00</div>
            <div class="stat-label">A Pagar Hoje</div>
            <div class="stat-trend" id="pay-trend">
              <i class="fa fa-minus"></i> <span>0%</span>
            </div>
          </div>
          
          <div class="stat-card" data-action="paid-overdue">
            <div class="stat-icon info">
              <i class="fa fa-history"></i>
            </div>
            <div class="stat-value" id="paid-overdue">R$ 0,00</div>
            <div class="stat-label">Pagos em Atraso</div>
            <div class="stat-trend" id="paid-trend">
              <i class="fa fa-minus"></i> <span>0%</span>
            </div>
          </div>
        </div>

        <!-- Recursos Principais -->
        <div class="card">
          <div class="card-header">
            <i class="fa fa-star"></i> Recursos Principais
          </div>
          <div class="card-body">
            <div class="feature-grid">
              <div class="feature-card">
                <div class="feature-icon">
                  <i class="fa fa-cash-register"></i>
                </div>
                <h3 class="feature-title">PDV Completo</h3>
                <p class="feature-desc">
                  Sistema de ponto de venda com emissão de notas, 
                  múltiplas formas de pagamento e controle de estoque.
                </p>
              </div>
              
              <div class="feature-card">
                <div class="feature-icon">
                  <i class="fa fa-chart-line"></i>
                </div>
                <h3 class="feature-title">Relatórios Avançados</h3>
                <p class="feature-desc">
                  Relatórios detalhados de vendas, finanças, estoque 
                  e clientes com gráficos interativos.
                </p>
              </div>
              
              <div class="feature-card">
                <div class="feature-icon">
                  <i class="fa fa-users"></i>
                </div>
                <h3 class="feature-title">Gestão de Clientes</h3>
                <p class="feature-desc">
                  Cadastro completo de clientes com histórico de compras, 
                  crédito e comunicação integrada.
                </p>
              </div>
              
              <div class="feature-card">
                <div class="feature-icon">
                  <i class="fa fa-box-open"></i>
                </div>
                <h3 class="feature-title">Controle de Estoque</h3>
                <p class="feature-desc">
                  Controle completo de produtos, categorias, 
                  estoque mínimo e alertas de reposição.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Movimentos Recentes -->
        <div class="card">
          <div class="card-header">
            <i class="fa fa-list"></i> Movimentos Recentes
            <button id="newTransaction" class="btn btn-sm btn-light">
              <i class="fa fa-plus"></i> Novo Lançamento
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th>Vencimento</th>
                    <th>Valor</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="recent-transactions">
                  <!-- Transações serão carregadas aqui -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="card">
          <div class="card-header">
            <i class="fa fa-bolt"></i> Ações Rápidas
          </div>
          <div class="card-body">
            <div class="quick-actions">
              <a href="pdv.html" class="quick-action">
                <i class="fa fa-cash-register"></i>
                <div class="quick-action-title">Abrir PDV</div>
                <div class="quick-action-desc">Iniciar nova venda</div>
              </a>
              
              <a href="produtos.html" class="quick-action">
                <i class="fa fa-plus-circle"></i>
                <div class="quick-action-title">Novo Produto</div>
                <div class="quick-action-desc">Cadastrar produto</div>
              </a>
              
              <a href="pessoas.html" class="quick-action">
                <i class="fa fa-user-plus"></i>
                <div class="quick-action-title">Novo Cliente</div>
                <div class="quick-action-desc">Cadastrar cliente</div>
              </a>
              
              <a href="relatorios.html" class="quick-action">
                <i class="fa fa-file-alt"></i>
                <div class="quick-action-title">Relatórios</div>
                <div class="quick-action-desc">Ver relatórios</div>
              </a>

              <a href="movimentos.html" class="quick-action">
                <i class="fa fa-search"></i>
                <div class="quick-action-title">Consultar Vendas</div>
                <div class="quick-action-desc">Histórico de vendas</div>
              </a>
              
              <a href="agenda.html" class="quick-action">
                <i class="fa fa-calendar-check"></i>
                <div class="quick-action-title">Agenda</div>
                <div class="quick-action-desc">Compromissos</div>
              </a>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer-shortcuts">
        <div class="shortcut-item"><span><kbd>F1</kbd> Ajuda</span></div>
        <div class="shortcut-item"><span><kbd>F2</kbd> Atualizar</span></div>
        <div class="shortcut-item"><span><kbd>F3</kbd> Vendas Hoje</span></div>
        <div class="shortcut-item"><span><kbd>F4</kbd> Abrir PDV</span></div>
        <div class="shortcut-item"><span><kbd>F5</kbd> Relatórios</span></div>
        <div class="shortcut-item"><span><kbd>F6</kbd> Produtos</span></div>
        <div class="shortcut-item"><span><kbd>F9</kbd> Clientes</span></div>
      </footer>
    </div>
  </div>

  <!-- Modal de Novo Lançamento -->
  <div class="modal fade" id="newTransactionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-plus-circle"></i> Novo Lançamento</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <div class="form-group">
              <label for="category">Categoria</label>
              <select class="form-control" id="category" required>
                <option value="">Selecione uma categoria</option>
                <option value="Vendas">Vendas</option>
                <option value="Serviços">Serviços</option>
                <option value="Aluguel">Aluguel</option>
                <option value="Pró labore">Pró labore</option>
                <option value="Produtos">Produtos</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
            <div class="form-group">
              <label for="description">Descrição</label>
              <input type="text" class="form-control" id="description" required>
            </div>
            <div class="form-group">
              <label for="person">Pessoa/Cliente</label>
              <input type="text" class="form-control" id="person" required>
            </div>
            <div class="form-group">
              <label for="value">Valor (R$)</label>
              <input type="number" step="0.01" class="form-control" id="value" required>
            </div>
            <div class="form-group">
              <label for="dueDate">Data de Vencimento</label>
              <input type="date" class="form-control" id="dueDate" required>
            </div>
            <div class="form-group">
              <label for="type">Tipo</label>
              <select class="form-control" id="type" required>
                <option value="receivable">A Receber</option>
                <option value="payable">A Pagar</option>
              </select>
              <small id="typeHelp" class="form-text text-muted">Selecione 'A Receber' para registrar entrada no caixa, ou 'A Pagar' para registrar saída.</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="saveTransaction">
            <i class="fa fa-save"></i> Salvar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Módulo centralizado de data/hora (Brasília) -->
  <script src="/js/datetime-utils.js"></script>
  <!-- Sistema de Toasts Elegantes -->
  <script src="js/toast.js"></script>
  <script>
    const API_BASE = '/api';
    
    let homeData = {
      toReceive: 0,
      overdue: 0,
      toPay: 0,
      paidOverdue: 0,
      recentTransactions: [],
      previousToReceive: 0,
      previousOverdue: 0,
      previousToPay: 0,
      previousPaidOverdue: 0
    };
    
    async function loadHomeData() {
      try {
        showLoading(true);
        
        const transactionsResponse = await axios.get(`${API_BASE}/transactions`);
        const transactions = transactionsResponse.data.data || transactionsResponse.data || [];
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        homeData.toReceive = 0;
        homeData.overdue = 0;
        homeData.toPay = 0;
        homeData.paidOverdue = 0;
        
        transactions.forEach(transaction => {
          const dueDate = new Date(transaction.dueDate);
          const isOverdue = dueDate < today && !transaction.paid;
          const isToday = dueDate.toDateString() === today.toDateString();
          
          if (transaction.type === 'receivable' || !transaction.type) {
            if (isToday && !transaction.paid) {
              homeData.toReceive += parseFloat(transaction.value) || 0;
            }
            if (isOverdue) {
              homeData.overdue += parseFloat(transaction.value) || 0;
            }
          } else if (transaction.type === 'payable') {
            if (isToday && !transaction.paid) {
              homeData.toPay += parseFloat(transaction.value) || 0;
            }
            if (isOverdue && transaction.paid) {
              homeData.paidOverdue += parseFloat(transaction.value) || 0;
            }
          }
        });
        
        homeData.previousToReceive = Math.max(0, homeData.toReceive * 0.8);
        homeData.previousOverdue = Math.max(0, homeData.overdue * 0.9);
        homeData.previousToPay = Math.max(0, homeData.toPay * 0.85);
        homeData.previousPaidOverdue = Math.max(0, homeData.paidOverdue * 0.75);
        
        homeData.recentTransactions = transactions
          .sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate))
          .slice(0, 10);
        
        updateHomePage();
        showLoading(false);
        
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showLoading(false);
        homeData = {
          toReceive: 0, overdue: 0, toPay: 0, paidOverdue: 0,
          recentTransactions: [],
          previousToReceive: 0, previousOverdue: 0, previousToPay: 0, previousPaidOverdue: 0
        };
        updateHomePage();
      }
    }
    
    function calculateGrowth(current, previous) {
      if (previous === 0) return current > 0 ? 100 : 0;
      return ((current - previous) / previous) * 100;
    }
    
    function updateHomePage() {
      document.getElementById('to-receive').textContent = 
        `R$ ${homeData.toReceive.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('overdue').textContent = 
        `R$ ${homeData.overdue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('to-pay').textContent = 
        `R$ ${homeData.toPay.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('paid-overdue').textContent = 
        `R$ ${homeData.paidOverdue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      
      const receiveGrowth = calculateGrowth(homeData.toReceive, homeData.previousToReceive);
      const overdueGrowth = calculateGrowth(homeData.overdue, homeData.previousOverdue);
      const payGrowth = calculateGrowth(homeData.toPay, homeData.previousToPay);
      const paidGrowth = calculateGrowth(homeData.paidOverdue, homeData.previousPaidOverdue);
      
      updateTrendElement('receive-trend', receiveGrowth);
      updateTrendElement('overdue-trend', overdueGrowth);
      updateTrendElement('pay-trend', payGrowth);
      updateTrendElement('paid-trend', paidGrowth);
      
      updateRecentTransactions();
    }
    
    function updateTrendElement(elementId, growth) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      const icon = element.querySelector('i');
      const span = element.querySelector('span');
      
      if (growth > 0) {
        element.className = 'stat-trend positive';
        icon.className = 'fa fa-arrow-up';
        span.textContent = `${growth.toFixed(1)}%`;
      } else if (growth < 0) {
        element.className = 'stat-trend negative';
        icon.className = 'fa fa-arrow-down';
        span.textContent = `${Math.abs(growth).toFixed(1)}%`;
      } else {
        element.className = 'stat-trend';
        icon.className = 'fa fa-minus';
        span.textContent = '0%';
      }
    }
    
    function updateRecentTransactions() {
      const container = document.getElementById('recent-transactions');
      
      if (homeData.recentTransactions.length === 0) {
        container.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <i class="fa fa-info-circle text-muted mr-2"></i>
              Nenhuma transação encontrada
            </td>
          </tr>
        `;
      } else {
        container.innerHTML = homeData.recentTransactions.map(transaction => {
          const dueDate = new Date(transaction.dueDate);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          let statusText = 'Pendente';
          let statusClass = 'badge-warning';
          
          if (transaction.paid) {
            statusText = 'Pago';
            statusClass = 'badge-success';
          } else if (dueDate < today) {
            statusText = 'Vencido';
            statusClass = 'badge-danger';
          }
          
          return `
            <tr>
              <td>${transaction.description}</td>
              <td>${transaction.category || 'Não categorizado'}</td>
              <td>${DateTimeUtils.formatDate(dueDate)}</td>
              <td>R$ ${(parseFloat(transaction.value) || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
              <td><span class="badge ${statusClass}">${statusText}</span></td>
              <td>
                <button class="btn btn-sm btn-outline-primary mr-1" onclick="togglePaid('${transaction.id}', ${!transaction.paid})">
                  <i class="fa fa-${transaction.paid ? 'undo' : 'check'}"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction.id}')">
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }
    }
    
    async function togglePaid(id, paid) {
      try {
        await axios.put(`${API_BASE}/transactions/${id}`, { paid });
        try { localStorage.setItem('dashboard_refresh', Date.now()); } catch (e) { /* ignore */ }
        loadHomeData();
      } catch (error) {
        console.error('Erro ao atualizar transação:', error);
        Toast.error('Erro ao atualizar transação.');
      }
    }
    
    async function deleteTransaction(id) {
      const confirmar = await Modal.delete('Tem certeza que deseja excluir esta transação?', 'Excluir Transação');
      if (!confirmar) return;
      
      try {
        await axios.delete(`${API_BASE}/transactions/${id}`);
        try { localStorage.setItem('dashboard_refresh', Date.now()); } catch (e) { /* ignore */ }
        Toast.success('Transação excluída com sucesso!');
        loadHomeData();
      } catch (error) {
        console.error('Erro ao excluir transação:', error);
        Toast.error('Erro ao excluir transação.');
      }
    }
    
    async function saveNewTransaction() {
      const form = document.getElementById('transactionForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Normaliza valor de acordo com o tipo: 'payable' => saída (negativo), 'receivable' => entrada (positivo)
      const rawValue = parseFloat(document.getElementById('value').value);
      const typeVal = document.getElementById('type').value;
      const normalizedValue = (typeVal === 'payable') ? -Math.abs(rawValue || 0) : (rawValue || 0);

      const transaction = {
        category: document.getElementById('category').value,
        description: document.getElementById('description').value,
        person: document.getElementById('person').value,
        value: normalizedValue,
        dueDate: document.getElementById('dueDate').value,
        type: typeVal,
        paid: false,
        valueDue: Math.abs(normalizedValue)
      };
      
      try {
        await axios.post(`${API_BASE}/transactions`, transaction);
        // Notifica outras abas sobre a mudança
        try { localStorage.setItem('dashboard_refresh', Date.now()); } catch (e) { /* ignore */ }
        $('#newTransactionModal').modal('hide');
        form.reset();
        Toast.success('Transação salva com sucesso!');
        loadHomeData();
      } catch (error) {
        console.error('Erro ao salvar transação:', error);
        Toast.error('Erro ao salvar transação.');
      }
    }
    
    function showLoading(show) {
      const refreshBtn = document.getElementById('refreshBtn');
      if (show) {
        refreshBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Carregando...';
        refreshBtn.disabled = true;
      } else {
        refreshBtn.innerHTML = '<i class="fa fa-sync-alt"></i> Atualizar';
        refreshBtn.disabled = false;
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      loadHomeData();
      
      document.getElementById('refreshBtn').addEventListener('click', loadHomeData);
      document.getElementById('newTransaction').addEventListener('click', function() {
        document.getElementById('type').value = 'receivable';
        // Atualiza texto de ajuda quando abre o modal
        const evt = new Event('change');
        document.getElementById('type').dispatchEvent(evt);
        $('#newTransactionModal').modal('show');
      });
      document.getElementById('saveTransaction').addEventListener('click', saveNewTransaction);
      
      document.querySelectorAll('.stat-card').forEach(card => {
        card.addEventListener('click', function() {
          window.location.href = 'movimentos.html';
        });
      });
      
      document.getElementById('type').addEventListener('change', function() {
        const help = document.getElementById('typeHelp');
        if (this.value === 'payable') {
          help.textContent = "Ao selecionar 'A Pagar', o valor será registrado como saída (sairá do caixa).";
        } else {
          help.textContent = "Ao selecionar 'A Receber', o valor será registrado como entrada (entrará no caixa).";
        }
      });

      document.addEventListener('keydown', (e) => {
        switch(e.key) {
          case 'F1':
            e.preventDefault();
            Modal.info('F1 - Ajuda\nF2 - Atualizar dados\nF3 - Ver vendas de hoje\nF4 - Abrir PDV\nF5 - Abrir relatórios\nF6 - Ver produtos\nF9 - Ver clientes\nESC - Fechar modais', 'Atalhos de Teclado');
            break;
          case 'F2':
            e.preventDefault();
            loadHomeData();
            break;
          case 'F3':
            e.preventDefault();
            window.location.href = 'dashboard.html';
            break;
          case 'F4':
            e.preventDefault();
            window.location.href = 'pdv.html';
            break;
          case 'F5':
            e.preventDefault();
            window.location.href = 'relatorios.html';
            break;
          case 'F6':
            e.preventDefault();
            window.location.href = 'produtos.html';
            break;
          case 'F9':
            e.preventDefault();
            window.location.href = 'pessoas.html';
            break;
          case 'Escape':
            if ($('#newTransactionModal').hasClass('show')) {
              $('#newTransactionModal').modal('hide');
            }
            break;
        }
      });
      
      setInterval(() => {
        document.getElementById('currentTime').textContent = DateTimeUtils.formatTime(new Date());
      }, 1000);
      
      setInterval(loadHomeData, 5 * 60 * 1000);

      // Atualização via storage (outras abas) — ao escrever 'dashboard_refresh' em outra aba, recarrega automaticamente
      window.addEventListener('storage', function(e) {
        if (e.key === 'dashboard_refresh') {
          loadHomeData();
        }
      });
      
      const today = DateTimeUtils.todayISO();
      document.getElementById('dueDate').min = today;
    });
  </script>
</body>
</html>
