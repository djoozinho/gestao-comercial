<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PDV - Ibraim e Daniel</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Local fallback para Font Awesome (resiliência contra bloqueios/Tracking Prevention) -->
    <link rel="stylesheet" href="/vendor/fontawesome/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="/vendor/fontawesome/all.min.css"></noscript>
    <script>
      (function(){
        function faLoaded(){
          try {
            const i=document.createElement('i'); i.className='fa'; i.style.display='none'; document.documentElement.appendChild(i);
            const fam = window.getComputedStyle(i).getPropertyValue('font-family') || '';
            i.remove();
            return /fontawesome|font\s?awesome/i.test(fam);
          } catch(e){ return false; }
        }
        if (!faLoaded()) {
          // Tenta carregar fallback local se não houver Font Awesome
          var l = document.createElement('link'); l.rel = 'stylesheet'; l.href = '/vendor/fontawesome/all.min.css'; document.head.appendChild(l);
        }
      })();
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <!-- Inline tiny SVG favicon to avoid default /favicon.ico 404s -->
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><rect width='16' height='16' fill='%236366f1'/></svg>">
    <style>
      /* Estilos específicos do PDV */
      /* Layout base: manter o wrapper com altura total e permitir rolagem na área principal */
      .main-wrapper { height: 100vh; display:flex; flex-direction:column; }
      /* Permitir rolagem vertical na área principal para que a página mostre uma barra de rolagem quando necessário */
      .main-content { flex: 1 1 auto; height: auto; overflow-y: auto; -webkit-overflow-scrolling: touch; }
      /* Pequena margem interna para evitar que o conteúdo encoste na borda ao rolar */
      .main-content { padding-bottom: 12px; }
      
      .main-header { padding: 12px 24px; gap: 20px; }
      .main-header h3 { font-size: 20px; white-space: nowrap; }
      .main-header .header-info { display: flex; align-items: center; gap: 16px; font-size: 13px; font-weight: 500; color: var(--gray-500); }

      /* Campo de código de barras */
      .barcode-section { flex: 1; max-width: 500px; display: flex; align-items: center; gap: 10px; }
      .barcode-input-wrapper { flex: 1; position: relative; }
      .barcode-input {
        width: 100%; padding: 12px 16px 12px 50px; font-size: 18px; font-weight: 600;
        border: 3px solid var(--brand); border-radius: 12px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2); transition: all 0.3s ease;
      }
      .barcode-input:focus { outline: none; border-color: var(--brand-dark); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.25); transform: scale(1.01); }
      .barcode-input::placeholder { color: #94a3b8; font-weight: 500; }
      .barcode-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--brand); font-size: 20px; }

      /* Info do operador */
      .operator-info { display: flex; align-items: center; gap: 20px; background: var(--gray-100); padding: 8px 16px; border-radius: 10px; border: 1px solid var(--gray-200); }
      .operator-info .info-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--gray-500); }
      .operator-info .info-item i { color: var(--brand); font-size: 14px; }
      .operator-info .info-item strong { color: var(--gray-800); font-weight: 600; }
      .sale-status { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
      .sale-status.open { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
      .sale-status.pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
      .sale-status i { font-size: 10px; }

      /* Container PDV */
      .pdv-container { display: flex; flex-grow: 1; padding: 15px; gap: 15px; overflow: visible; }
      .pdv-col-products { flex: 1 1 0; display: flex; flex-direction: column; min-width: 0; }
      .pdv-col-cart { flex: 0 0 380px; display: flex; flex-direction: column; }

      /* Categorias */
      .category-scroll { display: flex; overflow-x: auto; gap: 8px; padding: 5px 0; white-space: nowrap; scrollbar-width: thin; }
      .category-scroll::-webkit-scrollbar { height: 4px; }
      .category-scroll::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 10px; }
      .category-btn { padding: 12px 24px; border-radius: 25px; background: #fff; border: 2px solid rgba(99, 102, 241, 0.2); cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 15px; color: var(--gray-800); text-transform: uppercase; box-shadow: var(--shadow-sm); }
      .category-btn:hover { background: var(--gray-100); transform: translateY(-3px); box-shadow: var(--shadow-md); }
      .category-btn.active { background: var(--brand); color: #fff; border-color: var(--brand); }

      /* Grid de produtos */
      .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; overflow-y: auto; padding: 8px; flex-grow: 1; }
      .prod-item { border: 2px solid rgba(99, 102, 241, 0.15); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fff; position: relative; overflow: hidden; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; justify-content: space-between; min-height: 180px; }
      .prod-item:hover { transform: translateY(-4px) scale(1.02); box-shadow: var(--shadow-lg); border-color: var(--brand); }
      .prod-item .prod-image { width: 60px; height: 60px; background: var(--gray-100); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px auto; border: 1px solid var(--gray-200); overflow: hidden; }
      .prod-item .prod-image img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
      .prod-item .prod-image i { font-size: 24px; color: var(--brand); }
      .prod-item .prod-code { font-size: 11px; color: var(--gray-500); font-weight: 500; margin-bottom: 6px; text-transform: uppercase; }
      .prod-item .prod-category { font-size: 10px; background: rgba(99, 102, 241, 0.1); color: var(--brand); padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 8px; font-weight: 600; }
      .prod-item .prod-stock { font-size: 11px; color: var(--success); font-weight: 600; margin-top: 4px; }
      .prod-item .prod-stock.low-stock { color: var(--warning); }
      .prod-item .prod-stock.out-of-stock { color: var(--danger); }
      .prod-item .prod-name { font-weight: 700; font-size: 13px; margin-bottom: 8px; line-height: 1.3; color: var(--gray-800); display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
      .prod-item .prod-price { font-weight: 800; background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 18px; }

      /* Carrinho */
      #cartItems { flex-grow: 1; }
      .cart-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--gray-200); }
      .cart-summary { padding: 15px; background: var(--gray-50); border-top: 1px solid var(--gray-200); }
      .cart-actions { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

      /* Ações rápidas */
      .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px; background: var(--gray-50); border-top: 1px solid var(--gray-200); }
      .quick-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 8px; background: #fff; border: 2px solid var(--gray-200); border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center; min-height: 65px; }
      .quick-btn:hover { background: var(--brand-gradient); border-color: var(--brand); transform: translateY(-2px); box-shadow: var(--shadow-md); }
      .quick-btn:hover i, .quick-btn:hover span, .quick-btn:hover kbd { color: #fff !important; }
      .quick-btn i { font-size: 18px; color: var(--brand); margin-bottom: 4px; transition: all 0.3s; }
      .quick-btn span { font-size: 11px; font-weight: 600; color: var(--gray-800); transition: all 0.3s; }
      .quick-btn kbd { font-size: 9px; background: rgba(99, 102, 241, 0.1); color: var(--brand); padding: 2px 6px; border-radius: 4px; margin-top: 3px; font-weight: 700; transition: all 0.3s; }

      /* Vendas pendentes */
      .pending-sales-section { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; padding: 10px 12px; margin-bottom: 10px; }
      .pending-sales-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
      .pending-sales-header h6 { margin: 0; font-size: 13px; font-weight: 700; color: var(--warning); display: flex; align-items: center; gap: 6px; }
      .pending-sales-count { background: var(--warning); color: #fff; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 12px; }
      .pending-sales-list { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; }
      .pending-sale-item { flex: 0 0 auto; background: #fff; border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 8px 12px; cursor: pointer; transition: all 0.3s; min-width: 120px; }
      .pending-sale-item:hover { background: rgba(245, 158, 11, 0.1); border-color: var(--warning); transform: translateY(-2px); }
      .pending-sale-item .sale-client { font-size: 11px; font-weight: 600; color: var(--gray-800); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .pending-sale-item .sale-value { font-size: 13px; font-weight: 700; color: var(--warning); }
      .pending-sale-item .sale-time { font-size: 10px; color: var(--gray-500); }

      /* Footer shortcuts */
      .footer-shortcuts { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: #fff; padding: 16px 32px; display: flex; gap: 32px; flex-shrink: 0; border-top: 1px solid rgba(148, 163, 184, 0.2); }
      .shortcut-item { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; }
      .shortcut-item kbd { background: linear-gradient(135deg, #475569 0%, #64748b 100%); border: 1px solid #94a3b8; padding: 4px 8px; border-radius: 6px; font-family: inherit; font-size: 12px; font-weight: 600; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); min-width: 28px; text-align: center; }

      /* Estilos de botões PDV */
      .btn-primary { background: linear-gradient(135deg, var(--success) 0%, #047857 100%); border: 2px solid rgba(16, 185, 129, 0.3); color: #fff; font-weight: 700; font-size: 15px; padding: 12px 24px; border-radius: 10px; text-transform: uppercase; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); }
      .btn-primary:hover { background: var(--success); border-color: var(--success); }
      .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%); border: 2px solid rgba(239, 68, 68, 0.3); color: #fff; font-weight: 700; font-size: 15px; padding: 12px 24px; border-radius: 10px; text-transform: uppercase; box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4); }
      .btn-danger:hover { background: var(--danger); border-color: var(--danger); }
      .btn-outline-secondary { background: #fff !important; border: 2px solid #6c757d !important; color: #6c757d !important; }
      .btn-outline-secondary:hover { background: var(--brand-light) !important; border-color: var(--brand-light) !important; color: #fff !important; }
      .btn-outline-secondary.active, .btn-outline-secondary:active { background: var(--brand) !important; border-color: var(--brand) !important; color: #fff !important; }

      /* Floating action button (FAB) for Contas a Prazo */
      .fab {
        position: fixed;
        right: 20px;
        bottom: 100px;
        z-index: 1060;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 20px rgba(217, 119, 6, 0.35);
        border: none;
        cursor: pointer;
        font-size: 18px;
      }
      .fab:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(217, 119, 6, 0.45); }
      .fab { transition: bottom 180ms ease, transform 120ms ease; }
      .fab i { font-size: 20px; line-height: 1; }
      .fab svg.fab-icon { width: 20px; height: 20px; display: block; fill: currentColor; }
      .fab:focus { outline: none; box-shadow: 0 0 0 4px rgba(245,158,11,0.15); }
      /* Responsivo e pequenas melhorias para não sobrepor conteúdo */
      @media (max-width: 768px) {
        .fab { width: 48px; height: 48px; font-size: 16px; right: 14px; }
        .fab i { font-size: 18px; }
      }

      /* Accounts modal styles */
      .accounts-modal .list-group-item { cursor: pointer; }
      .accounts-modal .list-group-item.active { background: rgba(245,158,11,0.08); border-color: rgba(245,158,11,0.18); }
      .accounts-modal .account-client { font-weight:700; }
      .accounts-modal .account-desc { color: var(--muted); font-size: 13px; }
      .accounts-modal .account-amount { font-weight:700; color: var(--warning); }
      .accounts-modal .account-details { padding: 12px; background: linear-gradient(180deg, #fff 0%, #fafafa 100%); border-radius: 8px; border: 1px solid var(--gray-100); }
      .accounts-modal .detail-row { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
      .accounts-modal .detail-actions { display:flex; gap:8px; flex-wrap:wrap; }
      .accounts-modal .small-muted { color: var(--muted); font-size:13px; }

      @media (max-width: 576px) {
        .accounts-modal .modal-dialog { max-width: 95%; }
      }

      /* Modal de pagamento */
      #payModal .modal-dialog { max-width: 900px; }
      #payModal .modal-body { overflow: visible !important; min-height: 450px; padding-bottom: 100px; }

      .list-group-item { cursor: pointer; }
      .list-group-item.active { background: var(--brand-gradient); border-color: var(--brand); color: #fff; font-weight: 800; box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3); transform: translateX(5px); }

      /* Responsivo */
      @media (max-width: 992px) { .pdv-col-cart { flex: 0 0 320px; } }
      @media (max-width: 768px) {
        .pdv-container { flex-direction: column; }
        .pdv-col-cart { flex: none; }
        .footer-shortcuts { flex-wrap: wrap; gap: 16px; padding: 12px 16px; }
      }
    </style>
  </head>
  <body>
    <div class="main-wrapper">
      <div class="sidebar">
        <h4>IBRAIM E DANIEL</h4>
        <ul class="sidebar-menu">
          <li><a href="index.html"><span class="menu-icon"><i class="fa fa-home"></i></span><span class="menu-label">Início</span></a></li>
          <li><a href="pdv.html" class="active"><span class="menu-icon"><i class="fa fa-cash-register"></i></span><span class="menu-label">PDV</span></a></li>
          <li><a href="dashboard.html"><span class="menu-icon"><i class="fa fa-tachometer-alt"></i></span><span class="menu-label">Painel</span></a></li>
          <li><a href="movimentos.html"><span class="menu-icon"><i class="fa fa-list"></i></span><span class="menu-label">Movimentos</span></a></li>
          <li><a href="relatorios.html"><span class="menu-icon"><i class="fa fa-chart-line"></i></span><span class="menu-label">Relatórios</span></a></li>
          <li><a href="pessoas.html"><span class="menu-icon"><i class="fa fa-user"></i></span><span class="menu-label">Clientes</span></a></li>
          <li><a href="produtos.html"><span class="menu-icon"><i class="fa fa-box-open"></i></span><span class="menu-label">Produtos</span></a></li>
          <li><a href="agenda.html"><span class="menu-icon"><i class="fa fa-calendar-alt"></i></span><span class="menu-label">Agenda</span></a></li>
          <li><a href="admin.html"><span class="menu-icon"><i class="fa fa-cog"></i></span><span class="menu-label">Admin</span></a></li>
        </ul>
      </div>

      <div class="main-content">
        <header class="main-header">
          <h3><i class="fa fa-cash-register text-success mr-2"></i>PDV</h3>
          
          <!-- Campo de código de barras destacado -->
          <div class="barcode-section">
            <div class="barcode-input-wrapper">
              <i class="fa fa-barcode barcode-icon"></i>
              <input type="text" id="barcodeInput" class="barcode-input" placeholder="Leia o código de barras ou digite... (F7)" autocomplete="off" autofocus />
            </div>
          </div>

          <!-- Info do operador e status -->
          <div class="operator-info">
            <div class="info-item">
              <i class="fa fa-desktop"></i>
              <span>PDV:</span>
              <strong id="pdvNumber">001</strong>
            </div>
            <div class="info-item">
              <i class="fa fa-user-circle"></i>
              <span>Operador:</span>
              <strong id="operatorName">Sistema</strong>
            </div>
            <div class="sale-status open" id="saleStatus">
              <i class="fa fa-circle"></i>
              <span>Venda Aberta</span>
            </div>
          </div>

          <div class="header-info">
            <span><i class="fa fa-clock mr-2"></i><span id="currentTime">--:--:--</span></span>
            <span><i class="fa fa-calendar mr-2"></i><span id="currentDate">--/--/----</span></span>
          </div>
        </header>

        <div class="pdv-container">

          <!-- Coluna de Produtos e Busca/Categorias -->
          <div class="pdv-col-products">
            <!-- Barra Superior: Busca e Categorias -->
            <div class="card mb-3" style="height: auto; flex-grow: 0;">
              <div class="card-body p-2">
                <div class="row no-gutters align-items-center">
                  <div class="col-md-3 pr-2 border-right">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text bg-white border-0"><i class="fa fa-search text-muted"></i></span>
                      </div>
                      <input id="searchProd" class="form-control border-0" placeholder="Buscar (F3)..." autocomplete="off" />
                    </div>
                  </div>
                  <div class="col-md-9 pl-3">
                    <div id="category-list" class="category-scroll">
                      <!-- Categorias horizontais via JS -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Produtos</span>
                <small><span id="prodCount">0</span> encontrados</small>
              </div>
              <div class="product-grid" id="productList">
                <!-- Produtos -->
              </div>
            </div>
          </div>

          <!-- Coluna do Carrinho -->
          <div class="pdv-col-cart">
            <!-- Seção de Vendas em Espera -->
            <div class="pending-sales-section" id="pendingSalesSection" style="display: none;">
              <div class="pending-sales-header">
                <h6><i class="fa fa-pause-circle"></i> Vendas em Espera</h6>
                <span class="pending-sales-count" id="pendingSalesCount">0</span>
              </div>
              <div class="pending-sales-list" id="pendingSalesList">
                <!-- Vendas em espera serão renderizadas aqui -->
              </div>
            </div>

            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <i class="fa fa-shopping-cart"></i> Itens da Venda
                </div>
                <div style="font-size: 14px; font-weight: 600;">
                  <span id="itemCount">0</span> item(ns)
                </div>
              </div>
              
              <!-- Grid de itens da venda -->
              <div class="card-body p-0" id="cartItems" style="max-height: 250px; overflow-y: auto;">
                <table class="table table-sm mb-0" id="cartTable" style="display: none;">
                  <thead style="background: #f8fafc; position: sticky; top: 0; z-index: 1;">
                    <tr>
                      <th style="width: 40px; padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted);">#</th>
                      <th style="padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted);">PRODUTO</th>
                      <th style="width: 60px; padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted); text-align: center;">QTD</th>
                      <th style="width: 90px; padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted); text-align: right;">UNIT.</th>
                      <th style="width: 90px; padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted); text-align: right;">TOTAL</th>
                      <th style="width: 40px; padding: 8px;"></th>
                    </tr>
                  </thead>
                  <tbody id="cartTableBody">
                    <!-- Itens do carrinho serão renderizados aqui -->
                  </tbody>
                </table>
                <div class="text-muted text-center py-5" id="emptyCartMessage">
                  <i class="fa fa-shopping-cart fa-3x mb-3" style="color: #e2e8f0;"></i>
                  <p class="mb-0">Carrinho vazio</p>
                  <small>Leia um código de barras ou selecione um produto</small>
                </div>
              </div>

              <!-- Painel de totais aprimorado -->
              <div class="cart-summary" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                <div class="d-flex justify-content-between mb-2">
                  <span style="font-size: 13px; color: var(--muted);">Subtotal (<span id="totalQty">0</span> itens):</span>
                  <strong id="subtotalVal" style="font-size: 14px;">R$ 0,00</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span style="font-size: 13px; color: var(--muted);">Desconto (F5):</span>
                  <strong id="discountVal" style="font-size: 14px; color: var(--warning);">R$ 0,00</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span style="font-size: 13px; color: var(--muted);">Acréscimo:</span>
                  <strong id="additionVal" style="font-size: 14px; color: var(--info);">R$ 0,00</strong>
                </div>
                <hr style="margin: 10px 0;">
                <div class="d-flex justify-content-between align-items-center">
                  <strong style="font-size: 16px; color: var(--text-color);">TOTAL A PAGAR:</strong>
                  <strong id="totalVal" style="font-size: 28px; color: var(--brand); letter-spacing: -1px;">R$ 0,00</strong>
                </div>
              </div>

              <!-- Botões de ação principais -->
              <div class="cart-actions">
                <button id="btnHold" class="btn btn-warning" style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%); border: none; font-size: 13px;">
                  <i class="fa fa-pause-circle mr-1"></i>Espera (F8)
                </button>
                <button id="btnCancel" class="btn btn-danger" style="font-size: 13px;">
                  <i class="fa fa-times-circle mr-1"></i>Cancelar (F9)
                </button>
              </div>
              <div style="padding: 0 15px 15px 15px;">
                <button id="btnCheckout" class="btn btn-primary btn-block btn-lg" style="font-size: 16px; padding: 15px;">
                  <i class="fa fa-check-circle mr-2"></i>FINALIZAR VENDA (F4)
                </button>
              </div>

              <!-- Botões de funções rápidas -->
              <div class="quick-actions">
                <div class="quick-btn" id="btnHelp" title="Ajuda">
                  <i class="fa fa-question-circle"></i>
                  <span>Ajuda</span>
                  <kbd>F1</kbd>
                </div>
                <div class="quick-btn" id="btnClient" title="Selecionar Cliente">
                  <i class="fa fa-user-plus"></i>
                  <span>Cliente</span>
                  <kbd>F2</kbd>
                </div>
                <div class="quick-btn" id="btnSearch" title="Buscar Produto">
                  <i class="fa fa-search"></i>
                  <span>Buscar</span>
                  <kbd>F3</kbd>
                </div>
                <div class="quick-btn" id="btnDiscount" title="Aplicar Desconto">
                  <i class="fa fa-percent"></i>
                  <span>Desconto</span>
                  <kbd>F5</kbd>
                </div>
              </div>
            </div>
          </div>
        </div>

        <footer class="footer-shortcuts">
            <div class="shortcut-item"><span><kbd>F1</kbd> Ajuda</span></div>
            <div class="shortcut-item"><span><kbd>F2</kbd> Cliente</span></div>
            <div class="shortcut-item"><span><kbd>F3</kbd> Buscar</span></div>
            <div class="shortcut-item"><span><kbd>F4</kbd> Finalizar</span></div>
            <div class="shortcut-item"><span><kbd>F5</kbd> Desconto</span></div>
            <div class="shortcut-item"><span><kbd>F7</kbd> Código</span></div>
            <div class="shortcut-item"><span><kbd>F8</kbd> Espera</span></div>
            <div class="shortcut-item"><span><kbd>F9</kbd> Cancelar</span></div>
            <div class="shortcut-item"><span><kbd>F10</kbd> PIX</span></div>
            <div class="shortcut-item"><span><kbd>F11</kbd> Dinheiro</span></div>
            <div class="shortcut-item"><span><kbd>ESC</kbd> Sair</span></div>
        </footer>
      </div>
    </div>

    <!-- Floating button: Contas a Prazo -->
    <button id="btnAccountsPrazo" class="fab" title="Contas a Prazo" aria-label="Contas a Prazo">
      <!-- Inline SVG (receipt) to avoid relying on icon fonts -->
      <svg class="fab-icon" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
        <title>Contas a Prazo</title>
        <path d="M21 2H7a1 1 0 0 0-1 1v17.586l2.293-2.293a1 1 0 0 1 .707-.293H14a1 1 0 0 1 1 1v1h5a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1zM9 6h8v2H9V6zm0 4h8v2H9v-2zm0 4h5v2H9v-2z" />
      </svg>
    </button>

    <!-- Modal: Contas a Prazo (expandido) -->
    <div class="modal fade accounts-modal" id="accountsPrazoModal" tabindex="-1" role="dialog" data-backdrop="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <div style="display:flex; align-items:center; gap:12px; width:100%;">
              <h5 class="modal-title" style="flex:0 0 auto;"><svg style="width:18px;height:18px;margin-right:8px;vertical-align:middle;" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 2H7a1 1 0 0 0-1 1v17.586l2.293-2.293a1 1 0 0 1 .707-.293H14a1 1 0 0 1 1 1v1h5a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1zM9 6h8v2H9V6zm0 4h8v2H9v-2zm0 4h5v2H9v-2z"/></svg> Contas a Prazo</h5>
              <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                <label style="display:flex;align-items:center;gap:8px;margin-right:6px;">
                  <input type="checkbox" id="accountsSelectAll" /> <small style="margin-left:4px;">Selecionar tudo</small>
                </label>
                <button id="btnBulkReceive" class="btn btn-success btn-sm" title="Receber selecionadas" style="margin-right:6px;" disabled>Receber selecionadas</button>
                <input id="accountsPrazoSearch" class="form-control form-control-sm" placeholder="Buscar por cliente, descrição ou código..." style="width:260px;" />
                <button id="btnRefreshAccounts" class="btn btn-outline-secondary btn-sm" title="Atualizar"><i class="fa fa-sync"></i></button>
              </div>
            </div>
            <button class="close" data-dismiss="modal" aria-label="Fechar"><span>&times;</span></button>
          </div>

          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div id="accountsPrazoList" class="list-group" style="max-height:420px; overflow-y:auto;">
                  <div class="text-muted text-center p-3">Carregando...</div>
                </div>
              </div>
              <div class="col-md-6">
                <div id="accountDetail" style="min-height:240px;">
                  <div class="text-muted p-4 text-center">Selecione uma conta para ver detalhes e ações.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal pagamento -->

    <!-- Modal: Recebimento em Lote -->
    <div class="modal fade" id="bulkReceiveModal" tabindex="-1" role="dialog" data-backdrop="true">
      <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Receber contas selecionadas <small id="bulkReceiveCount" style="margin-left:8px;"></small></h5>
            <button class="close" data-dismiss="modal" aria-label="Fechar"><span>&times;</span></button>
          </div>
          <div class="modal-body" id="bulkReceiveModalBody" style="max-height:420px; overflow-y:auto;">
            <!-- Rows inserted dynamically -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnConfirmBulkReceive">Confirmar recebimentos</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="payModal" tabindex="-1" role="dialog" data-backdrop="static">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content" style="min-height: 600px;">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fa fa-cash-register mr-2"></i>Finalizar Venda</h5>
            <button class="close" data-dismiss="modal" style="opacity:1"><span>&times;</span></button>
          </div>
          <div class="modal-body" style="overflow: visible; min-height: 400px; padding-bottom: 80px;">
            <div class="row">
              <div class="col-md-7">
                <div class="form-group">
                  <label><i class="fa fa-user mr-2"></i>Cliente (F2)</label>
                  <input id="payClient" list="clientsList" class="form-control" placeholder="Buscar ou cadastrar cliente..." autocomplete="off" />
                  <datalist id="clientsList"></datalist>
                </div>
                
                <div class="form-group">
                  <label><i class="fa fa-money-bill-wave mr-2"></i>Método de pagamento</label>
                  <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                    <label class="btn btn-outline-secondary active flex-fill"><input type="radio" name="payMethod" value="cash" checked> Dinheiro</label>
                    <label class="btn btn-outline-secondary flex-fill"><input type="radio" name="payMethod" value="pix"> PIX</label>
                    <label class="btn btn-outline-secondary flex-fill"><input type="radio" name="payMethod" value="card"> Crédito</label>
                    <label class="btn btn-outline-secondary flex-fill"><input type="radio" name="payMethod" value="debit"> Débito</label>
                    <label class="btn btn-outline-secondary flex-fill"><input type="radio" name="payMethod" value="prazo"> A Prazo</label>
                  </div>
                </div>
                
                <div class="form-group" id="installmentsGroup" style="display: none; margin-bottom: 2rem;">
                  <label><i class="fa fa-credit-card mr-2"></i>Número de parcelas</label>
                  <select id="installments" class="form-control" style="height: 50px; font-size: 16px;">
                    <option value="1">1x sem juros</option>
                    <option value="2">2x sem juros</option>
                    <option value="3">3x sem juros</option>
                    <option value="4">4x sem juros</option>
                    <option value="5">5x sem juros</option>
                    <option value="6">6x sem juros</option>
                    <option value="7">7x sem juros</option>
                    <option value="8">8x sem juros</option>
                    <option value="9">9x sem juros</option>
                    <option value="10">10x sem juros</option>
                  </select>
                  <small class="text-muted mt-3 d-block" id="installmentInfo">Selecione o número de parcelas</small>
                </div>
                
                <div class="form-group">
                  <label><i class="fa fa-dollar-sign mr-2"></i>Valor recebido</label>
                  <input id="payAmount" type="number" step="0.01" class="form-control form-control-lg" />
                </div>
              </div>
              
              <div class="col-md-5">
                <div class="bg-light p-3 rounded h-100">
                  <h6 class="mb-3">Resumo</h6>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <strong id="modalSubtotal">R$ 0,00</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Desconto:</span>
                    <strong id="modalDiscount">R$ 0,00</strong>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <strong>Total:</strong>
                    <strong id="modalTotal" style="font-size: 1.5rem; color: var(--brand);">R$ 0,00</strong>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between align-items-center">
                    <small>Troco:</small>
                    <div id="changeVal" style="font-size: 1.5rem; font-weight: 700; color: var(--success);">R$ 0,00</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-dismiss="modal"><i class="fa fa-arrow-left mr-2"></i>Voltar</button>
            <button id="confirmPay" class="btn btn-primary btn-lg"><i class="fa fa-check-circle mr-2"></i>Confirmar Venda</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      if (window.axios) axios.defaults.baseURL = 'http://localhost:3000';
    </script>

    <!-- Robust loader: jQuery (full) + Bootstrap bundle (contains Popper) with local fallbacks -->
    <script>
      function loadScriptWithFallback(src, fallback, cb) {
        const s = document.createElement('script'); s.src = src; s.async = false;
        s.onload = () => cb && cb(null);
        s.onerror = () => {
          if (fallback) {
            const f = document.createElement('script'); f.src = fallback; f.async = false; f.onload = () => cb && cb(null); f.onerror = () => cb && cb(new Error('both failed'));
            document.head.appendChild(f);
          } else cb && cb(new Error('failed'));
        };
        document.head.appendChild(s);
      }

      // Load jQuery (full, not slim) then Bootstrap bundle (includes Popper). Use local fallbacks when CDN blocked.
      loadScriptWithFallback('https://code.jquery.com/jquery-3.5.1.min.js', '/vendor/jquery/jquery.min.js', (err) => {
        if (err) console.warn('jQuery CDN failed, fallback attempted:', err);
        loadScriptWithFallback('https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js', '/vendor/bootstrap/bootstrap.bundle.min.js', (err2) => {
          if (err2) console.warn('Bootstrap bundle CDN failed, fallback attempted:', err2);

          // Provide a small jQuery-style .modal(action) wrapper if jQuery is present and Bootstrap's Modal API exists
          try {
            if (window.jQuery && (typeof window.jQuery.fn.modal === 'undefined') && window.bootstrap && window.bootstrap.Modal) {
              window.jQuery.fn.modal = function(action) {
                if (!action) return this;
                return this.each(function() {
                  try {
                    const el = this;
                    const inst = window.bootstrap.Modal.getInstance(el) || new window.bootstrap.Modal(el);
                    if (action === 'show') inst.show();
                    if (action === 'hide') inst.hide();
                  } catch(e) { console.warn('modal wrapper error', e); }
                });
              };
            }
          } catch (e) { console.warn('Error installing modal wrapper:', e); }
        });
      });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const state = {
          products: [],
          cart: [],
          categories: [],
          allProducts: [],
          activeCategory: 'Todos',
          discount: 0,
          addition: 0,
          pendingSales: [],
          currentClient: null,
          saleNumber: 1,
        };

        const currency = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatMoney = (v) => currency.format(Number(v || 0));

        // Simple sound helper using Web Audio API
        let _audioCtx = null;
        function getAudioCtx() {
          try { if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return _audioCtx; } catch(e){ console.warn('AudioContext not available', e); return null; }
        }
        function playSound(type='click') {
          const ctx = getAudioCtx();
          if (!ctx) return;
          try {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            const now = ctx.currentTime;
            // frequency mapping per event
            const map = { add: 880, remove: 440, success: 960, error: 220, hold: 660, low: 560 };
            o.type = 'sine';
            o.frequency.value = map[type] || 600;
            g.gain.setValueAtTime(0.0001, now);
            g.gain.exponentialRampToValueAtTime(0.25, now + 0.01);
            o.start(now);
            g.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
            o.stop(now + 0.19);
          } catch (err) { console.warn('sound error', err); }
        }

        // Normalize user-provided payment method (aceita termos em PT-BR)
        function normalizePaymentMethod(input) {
          try {
            if (!input) return 'cash';
            let s = String(input).toLowerCase();
            s = s.normalize && s.normalize('NFD').replace(/\p{Diacritic}/gu, '') || s.replace(/[\u0300-\u036f]/g, '');
            s = s.trim();
            const map = {
              'dinheiro': 'cash', 'cash': 'cash', 'money': 'cash',
              'pix': 'pix',
              'credito': 'card', 'credit': 'card', 'cartao': 'card', 'cartão': 'card', 'card': 'card',
              'debito': 'debit', 'debito': 'debit', 'debit': 'debit',
              'prazo': 'prazo', 'manual': 'manual'
            };
            if (map[s]) return map[s];
            if (['cash','pix','card','debit','prazo','manual'].includes(s)) return s;
            return 'cash';
          } catch(e) { return 'cash'; }
        }

        // Abre recibo em nova aba com verificação (PDF ou HTML)
        async function openReceiptPdf(id) {
          const win = window.open('about:blank', '_blank');
          if (!win) { showToast('Popup bloqueado. Permita popups para abrir recibo.', 'warning'); return; }
          try {
            const resp = await fetch('/api/receipts/' + id + '/pdf', { method: 'GET', headers: { 'Accept': 'application/pdf, text/html' } });
            if (!resp.ok) {
              const text = await resp.text().catch(()=>'<p>Erro ao recuperar recibo</p>');
              win.document.open(); win.document.write(text); win.document.close();
              return;
            }
            const ct = (resp.headers.get('content-type') || '').toLowerCase();
            const blob = await resp.blob();
            if (ct.includes('pdf')) {
              const url = URL.createObjectURL(blob);
              win.location.href = url;
              setTimeout(() => URL.revokeObjectURL(url), 1000 * 60);
            } else {
              const text = await (new Response(blob)).text();
              win.document.open(); win.document.write(text); win.document.close();
            }
          } catch (err) {
            console.error('Erro ao abrir recibo:', err);
            win.document.open(); win.document.write('<h3>Erro ao abrir recibo</h3><pre>' + (err && err.message ? err.message : String(err)) + '</pre>'); win.document.close();
            showToast('Falha ao abrir recibo.', 'danger');
          }
        }

        // --- Elementos da UI ---
        const productListEl = document.getElementById('productList');
        const categoryListEl = document.getElementById('category-list');
        const cartItemsEl = document.getElementById('cartItems');
        const cartTableEl = document.getElementById('cartTable');
        const cartTableBodyEl = document.getElementById('cartTableBody');
        const emptyCartMessageEl = document.getElementById('emptyCartMessage');
        const searchInput = document.getElementById('searchProd');
        const barcodeInput = document.getElementById('barcodeInput');
        const prodCountEl = document.getElementById('prodCount');
        const subtotalEl = document.getElementById('subtotalVal');
        const discountEl = document.getElementById('discountVal');
        const additionEl = document.getElementById('additionVal');
        const totalEl = document.getElementById('totalVal');
        const totalQtyEl = document.getElementById('totalQty');
        const itemCountEl = document.getElementById('itemCount');
        const btnCheckout = document.getElementById('btnCheckout');
        const btnCancel = document.getElementById('btnCancel');
        const btnHold = document.getElementById('btnHold');
        // Robust payModal wrapper: support jQuery object when available, otherwise provide minimal API over Bootstrap Modal
        const payModalEl = document.getElementById('payModal');
        let payModalInstance = null;
        function ensurePayModalInstance() {
          try {
            if (window.bootstrap && payModalEl) {
              payModalInstance = window.bootstrap.Modal.getOrCreateInstance(payModalEl);
              // flush pending actions
              if (payModal._pending && payModal._pending.length) {
                payModal._pending.forEach(a => { try { payModal.modal(a); } catch(e){} });
                payModal._pending.length = 0;
              }
            }
          } catch(e) { /* ignore */ }
        }
        const payModal = (function(){
          if (window.jQuery) return window.jQuery('#payModal');
          const obj = {
            el: payModalEl,
            _pending: [],
            modal(action){
              ensurePayModalInstance();
              if (!payModalInstance) { obj._pending.push(action); return; }
              if (action === 'show') payModalInstance.show();
              if (action === 'hide') payModalInstance.hide();
            },
            one(eventName, handler){ if (!payModalEl) return; const wrapper = function(e){ handler(e); payModalEl.removeEventListener(eventName, wrapper); }; payModalEl.addEventListener(eventName, wrapper); },
            hasClass(cls){ return payModalEl && payModalEl.classList.contains(cls); }
          };
          return obj;
        })();

        const modalTotalEl = document.getElementById('modalTotal');
        const payAmountInput = document.getElementById('payAmount');
        const changeValEl = document.getElementById('changeVal');
        const confirmPayBtn = document.getElementById('confirmPay');
        const pendingSalesSection = document.getElementById('pendingSalesSection');
        const pendingSalesList = document.getElementById('pendingSalesList');
        const pendingSalesCount = document.getElementById('pendingSalesCount');
        const saleStatusEl = document.getElementById('saleStatus');

        // Contas a Prazo (FAB + modal)
        const btnAccountsPrazo = document.getElementById('btnAccountsPrazo');
        const accountsPrazoModalEl = document.getElementById('accountsPrazoModal');
        const accountsPrazoListEl = document.getElementById('accountsPrazoList');

        // Ajusta posição do FAB para não sobrepor footer/quick-actions
        function adjustFabPosition() {
          if (!btnAccountsPrazo) return;
          const footer = document.querySelector('.footer-shortcuts');
          const quickActions = document.querySelector('.quick-actions');

          const footerH = footer ? footer.offsetHeight : 0;
          // Distância mínima da parte inferior (em px)
          const baseOffset = 16;

          // Calcula distância do topo do elemento quickActions até a janela
          let qaGap = 0;
          if (quickActions) {
            const qaRect = quickActions.getBoundingClientRect();
            // quanto o quickActions ocupa acima do fim da viewport
            qaGap = Math.max(0, window.innerHeight - qaRect.top);
          }

          // Queremos o botão acima do maior dos dois (footer ou quickActions) + folga
          const bottomOffset = Math.max(footerH + baseOffset, qaGap + baseOffset);

          btnAccountsPrazo.style.bottom = bottomOffset + 'px';
        }

        // Recalcula ao redimensionar/rolar para evitar sobreposição dinâmica
        window.addEventListener('resize', () => adjustFabPosition());
        window.addEventListener('scroll', () => adjustFabPosition());
        // Chamar após renderizações dinâmicas (inicial e quando pending sales mudar)
        setTimeout(adjustFabPosition, 50);


        // --- Funções de Renderização ---
        function renderProducts() {
          productListEl.innerHTML = '';
          const query = searchInput.value.toLowerCase();
          
          const filteredProducts = state.allProducts.filter(p => {
            const inCategory = state.activeCategory === 'Todos' || p.category === state.activeCategory;
            const matchesQuery = !query || p.name.toLowerCase().includes(query) || (p.sku || '').toLowerCase().includes(query) || (p.code || '').toString().includes(query);
            return inCategory && matchesQuery;
          });

          prodCountEl.textContent = filteredProducts.length;

          if (filteredProducts.length === 0) {
            productListEl.innerHTML = '<div class="text-muted p-3 text-center">Nenhum produto encontrado.</div>';
            return;
          }

          filteredProducts.forEach(p => {
            const item = document.createElement('div');
            item.className = 'prod-item';
            
            // Gerar imagem ou ícone baseado na categoria
            const getProductIcon = (category) => {
              const icons = {
                'Bebidas': 'fa-wine-bottle',
                'Comidas': 'fa-utensils',
                'Eletrônicos': 'fa-mobile-alt',
                'Roupas': 'fa-tshirt',
                'Livros': 'fa-book',
                'Casa': 'fa-home',
                'Esportes': 'fa-dumbbell',
                'Beleza': 'fa-spa',
                'Farmácia': 'fa-pills'
              };
              return icons[category] || 'fa-box';
            };
            
            const stockStatus = (stock) => {
              if (stock <= 0) return 'out-of-stock';
              if (stock <= 5) return 'low-stock';
              return '';
            };
            
            const stockText = (stock) => {
              if (stock <= 0) return 'Sem estoque';
              if (stock <= 5) return `Baixo: ${stock} un`;
              return `Estoque: ${stock} un`;
            };
            
            const stockVal = (typeof p.stock === 'number') ? p.stock : 0;
            item.innerHTML = `
              <div class="prod-image">
                ${p.image ? `<img src="${p.image}" alt="${p.name}">` : `<i class="fas ${getProductIcon(p.category || 'Outros')}"></i>`}
              </div>
              <div class="prod-code">#${p.code || p.id}</div>
              <div class="prod-category">${p.category || 'Produto'}</div>
              <div class="prod-name">${p.name}</div>
              <div class="prod-price">${formatMoney(p.price)}</div>
              <div class="prod-stock ${stockStatus(stockVal)}">${stockText(stockVal)}</div>
            `;
            item.onclick = () => addToCart(p.id);
            productListEl.appendChild(item);
          });
        }

        function renderCategories() {
          categoryListEl.innerHTML = '';
          const categories = ['Todos', ...new Set(state.allProducts.map(p => p.category || 'Outros'))];
          state.categories = categories;

          categories.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'category-btn' + (cat === state.activeCategory ? ' active' : '');
            btn.textContent = cat;
            btn.onclick = () => {
              state.activeCategory = cat;
              document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              renderProducts();
            };
            categoryListEl.appendChild(btn);
          });
        }

        function renderCart() {
          const totalQty = state.cart.reduce((s, it) => s + it.qty, 0);
          itemCountEl.textContent = totalQty;
          totalQtyEl.textContent = totalQty;

          if (state.cart.length === 0) {
            cartTableEl.style.display = 'none';
            emptyCartMessageEl.style.display = 'block';
            updateSaleStatus('open');
          } else {
            cartTableEl.style.display = 'table';
            emptyCartMessageEl.style.display = 'none';
            updateSaleStatus('pending');
            
            cartTableBodyEl.innerHTML = '';
            state.cart.forEach((item, index) => {
              const row = document.createElement('tr');
              row.style.cssText = 'transition: all 0.2s ease;';
              row.innerHTML = `
                <td style="padding: 10px 8px; font-size: 12px; font-weight: 600; color: var(--muted);">${String(index + 1).padStart(2, '0')}</td>
                <td style="padding: 10px 8px;">
                  <div style="font-size: 13px; font-weight: 600; color: var(--text-color);">${item.name}</div>
                  <div style="font-size: 11px; color: var(--muted);">#${item.code || item.id}</div>
                </td>
                <td style="padding: 10px 8px; text-align: center;">
                  <div class="d-flex align-items-center justify-content-center" style="gap: 4px;">
                    <button class="btn btn-sm btn-outline-secondary qty-btn" data-act="dec" data-id="${item.id}" style="width: 24px; height: 24px; padding: 0; font-size: 12px; border-radius: 6px;">-</button>
                    <span style="font-weight: 700; min-width: 24px; text-align: center;">${item.qty}</span>
                    <button class="btn btn-sm btn-outline-secondary qty-btn" data-act="inc" data-id="${item.id}" style="width: 24px; height: 24px; padding: 0; font-size: 12px; border-radius: 6px;">+</button>
                  </div>
                </td>
                <td style="padding: 10px 8px; text-align: right; font-size: 12px; color: var(--muted);">${formatMoney(item.price)}</td>
                <td style="padding: 10px 8px; text-align: right; font-size: 13px; font-weight: 700; color: var(--brand);">${formatMoney(item.price * item.qty)}</td>
                <td style="padding: 10px 8px; text-align: center;">
                  <button class="btn btn-sm btn-link text-danger p-0" data-act="rem" data-id="${item.id}" style="font-size: 14px;"><i class="fa fa-trash"></i></button>
                </td>
              `;
              row.onmouseenter = () => row.style.background = 'rgba(37, 99, 235, 0.05)';
              row.onmouseleave = () => row.style.background = '';
              cartTableBodyEl.appendChild(row);
            });
          }
          updateTotals();
        }

        function updateSaleStatus(status) {
          if (status === 'open') {
            saleStatusEl.className = 'sale-status open';
            saleStatusEl.innerHTML = '<i class="fa fa-circle"></i><span>Venda Aberta</span>';
          } else if (status === 'pending') {
            saleStatusEl.className = 'sale-status pending';
            saleStatusEl.innerHTML = '<i class="fa fa-circle"></i><span>Em Andamento</span>';
          }
        }

        function updateTotals() {
          const subtotal = state.cart.reduce((s, it) => s + (it.price * it.qty), 0);
          const total = subtotal - state.discount + state.addition;
          subtotalEl.textContent = formatMoney(subtotal);
          discountEl.textContent = formatMoney(state.discount);
          additionEl.textContent = formatMoney(state.addition);
          totalEl.textContent = formatMoney(total);
        }

        function renderPendingSales() {
          if (state.pendingSales.length === 0) {
            pendingSalesSection.style.display = 'none';
            return;
          }

          pendingSalesSection.style.display = 'block';
          pendingSalesCount.textContent = state.pendingSales.length;
          pendingSalesList.innerHTML = '';

          state.pendingSales.forEach((sale, index) => {
            const item = document.createElement('div');
            item.className = 'pending-sale-item';
            item.innerHTML = `
              <div class="sale-client">${sale.client || 'Cliente não informado'}</div>
              <div class="sale-value">${formatMoney(sale.total)}</div>
              <div class="sale-time">${sale.time}</div>
            `;
            item.onclick = () => restorePendingSale(index);
            pendingSalesList.appendChild(item);
          });
        }
        // Garantir que o FAB seja reposicionado quando a lista de vendas pendentes muda
        try { if (typeof adjustFabPosition === 'function') adjustFabPosition(); } catch(e) { /* ignore */ }

        // Busca e renderização de contas a prazo
        // State for accounts modal
        state.accountsPrazo = { items: [], selectedId: null };

        async function loadAccountsPrazo(search = '') {
          if (!accountsPrazoListEl) return;
          accountsPrazoListEl.innerHTML = '<div class="text-muted text-center p-3">Carregando...</div>';
          try {
            const q = search ? ('&search=' + encodeURIComponent(search)) : '';
            const res = await axios.get('/api/transactions?status=pendente&pageSize=1000' + q);
            const items = (res.data.data || []).filter(t => t.status === 'pendente' && (t.paymentMethod === 'prazo' || t.type === 'venda' || /prazo/i.test(t.description || '')));
            state.accountsPrazo.items = items.sort((a,b)=> new Date(a.dueDate) - new Date(b.dueDate));

            renderAccountsList();
          } catch (err) {
            console.error('Erro ao carregar contas a prazo:', err);
            accountsPrazoListEl.innerHTML = '<div class="text-danger p-3">Falha ao carregar. Veja o console.</div>';
          }
        }

        function renderAccountsList() {
          accountsPrazoListEl.innerHTML = '';
          const items = state.accountsPrazo.items;
          if (!items || items.length === 0) {
            accountsPrazoListEl.innerHTML = '<div class="text-muted text-center p-3">Nenhuma conta a prazo encontrada.</div>';
            state.accountsPrazo.selectedIds = [];
            updateBulkState();
            return;
          }

          items.forEach(tx => {
            const a = document.createElement('a');
            a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center' + (state.accountsPrazo.selectedId === tx.id ? ' active' : '');
            a.href = '#';
            a.dataset.id = tx.id;
            const checked = (state.accountsPrazo.selectedIds || []).includes(tx.id) ? 'checked' : '';
            a.innerHTML = `
              <div style="display:flex;align-items:center;gap:12px;width:100%;">
                <input class="account-select" type="checkbox" data-id="${tx.id}" ${checked} />
                <div style="flex:1;">
                  <div class="account-client">${tx.person || 'Cliente'}</div>
                  <div class="account-desc">${tx.description || ''}</div>
                </div>
                <div style="text-align:right;min-width:120px">
                  <div class="account-amount">${formatMoney(tx.valueDue)}</div>
                  <div class="text-muted small">${tx.dueDate}</div>
                </div>
              </div>`;

            a.addEventListener('click', (e) => { if (e.target && e.target.classList && e.target.classList.contains('account-select')) return; e.preventDefault(); selectAccount(tx.id); });

            accountsPrazoListEl.appendChild(a);

            // Attach checkbox handler
            const cb = a.querySelector('.account-select');
            cb.addEventListener('change', (e) => {
              e.stopPropagation();
              toggleSelect(tx.id, e.target.checked);
            });
          });

          updateBulkState();
          if (state.accountsPrazo.selectedId) selectAccount(state.accountsPrazo.selectedId);
        }

        function selectAccount(id) {
          state.accountsPrazo.selectedId = id;
          document.querySelectorAll('#accountsPrazoList .list-group-item').forEach(el => el.classList.toggle('active', el.dataset.id === id));
          const tx = state.accountsPrazo.items.find(t => t.id === id);
          const detailEl = document.getElementById('accountDetail');
          if (!tx || !detailEl) { if (detailEl) detailEl.innerHTML = '<div class="text-muted p-4 text-center">Selecione uma conta para ver detalhes e ações.</div>'; return; }

          detailEl.innerHTML = `
            <div class="account-details">
              <div class="detail-row"><div><div class="account-client">${tx.person || 'Cliente'}</div><div class="small-muted">${tx.description || ''}</div></div><div><div class="account-amount">${formatMoney(tx.valueDue)}</div><div class="small-muted">Venc.: ${tx.dueDate || '-'}</div></div></div>
              <div class="detail-row"><div class="small-muted">Status: <strong>${tx.status || '-'}</strong></div><div class="small-muted">Método: <strong>${tx.paymentMethod || '-'}</strong></div></div>
              <div style="margin-bottom:8px;"><label class="small-muted">Notas</label><textarea id="accountNotes" class="form-control" rows="3">${(tx.notes || '').replace(/"/g,'&quot;')}</textarea></div>
              <div class="detail-actions">
                <button id="btnReceive" class="btn btn-success btn-sm">Receber</button>
                <button id="btnMarkPaid" class="btn btn-primary btn-sm">Marcar como pago</button>
                <button id="btnPartialPay" class="btn btn-outline-secondary btn-sm">Registrar pagamento parcial</button>
                <button id="btnSaveNote" class="btn btn-outline-secondary btn-sm">Salvar nota</button>
                <a href="movimentos.html?search=${encodeURIComponent(tx.person || '')}" class="btn btn-outline-secondary btn-sm">Abrir movimentos</a>
              </div>
            </div>`;

          // Attach action handlers
          document.getElementById('btnMarkPaid')?.addEventListener('click', () => markAsPaid(id));
          document.getElementById('btnPartialPay')?.addEventListener('click', () => registerPartialPayment(id));

          document.getElementById('btnSaveNote')?.addEventListener('click', () => saveAccountNote(id));
        }

        async function markAsPaid(id) {
          if (!confirm('Marcar esta conta como PAGA?')) return;
          const tx = state.accountsPrazo.items.find(t => t.id === id);
          if (!tx) return;
          try {
            const amount = parseFloat(tx.valueDue || tx.value);
            const resp = await receivePayment(id, amount, 'manual', 'Pagamento por PDV (marcar como pago)');
            if (resp && resp.id) {
              showToast('Conta marcada como paga e recibo gerado.', 'success');
              try {
                const originalDue = parseFloat(tx.valueDue || tx.value || 0);
                const paidAmount = parseFloat(tx.valueDue || tx.value || 0);
                if (paidAmount >= originalDue) {
                  const sale = { items: [{ name: tx.description || 'Pagamento', qty:1, price: originalDue }], total: originalDue, received: originalDue, method: resp.receipt && resp.receipt.method ? resp.receipt.method : (tx.paymentMethod || '-'), client: tx.person || '-', date: new Date().toISOString(), note: tx.notes || '' };
                  openElginModal(sale);
                  try { const auto = localStorage.getItem('elgin_auto_print') === '1'; const useEsc = localStorage.getItem('elgin_use_escpos') === '1'; if (auto) { const payload = { coupon: document.getElementById('elginCouponPreview').textContent, sale, device: useEsc ? 'elgin-i8' : 'elgin-i8', escpos: useEsc, autoPrint: true }; const pr = await axios.post('/api/print/elgin', payload); if (pr && pr.data) showToast('Impressão enviada (automático).', 'success'); } } catch(e) { console.warn('Falha ao enviar impressão automática:', e); }
                }
              } catch(e) { console.error('Erro ao decidir impressão de cupom:', e); }
              await loadAccountsPrazo(document.getElementById('accountsPrazoSearch')?.value || '');
            }
          } catch (err) {
            console.error('Erro ao marcar como pago:', err);
            showToast('Falha ao marcar como paga.', 'danger');
          }
        }

        async function registerPartialPayment(id) {
          const tx = state.accountsPrazo.items.find(t => t.id === id);
          if (!tx) return;
          const amt = parseFloat(prompt('Valor recebido:', (tx.valueDue || 0).toString()));
          if (isNaN(amt) || amt <= 0) return;
          const methodInput = prompt('Método de pagamento (ex: dinheiro, pix, cartão):', 'dinheiro') || 'dinheiro';
          const method = normalizePaymentMethod(methodInput);
          try {
            const resp = await receivePayment(id, amt, method, 'Pagamento parcial via PDV');
            if (resp && resp.id) {
              showToast('Pagamento registrado e recibo gerado.', 'success');
              await loadAccountsPrazo(document.getElementById('accountsPrazoSearch')?.value || '');
            }
          } catch (err) {
            console.error('Erro ao registrar pagamento parcial:', err);
            showToast('Falha ao registrar pagamento.', 'danger');
          }
        }

        async function receivePayment(id, amountArg = null, methodArg = null, noteArg = '') {
          const tx = state.accountsPrazo.items.find(t => t.id === id);
          if (!tx) return null;
          const amount = amountArg !== null ? parseFloat(amountArg) : parseFloat(tx.valueDue || tx.value);
          if (isNaN(amount) || amount <= 0) return null;
          const methodInput = methodArg || prompt('Método de pagamento (ex: dinheiro, pix, cartão):', 'dinheiro') || 'dinheiro';
          const method = normalizePaymentMethod(methodInput);
          const note = noteArg || prompt('Observações (opcional):', '') || '';
          const res = await axios.post(`/api/transactions/${id}/receive`, { amount, method, note });
          return res.data;
        }

        async function saveAccountNote(id) {
          const notes = document.getElementById('accountNotes')?.value || '';
          try {
            await axios.put('/api/transactions/' + id, { notes });
            showToast('Nota salva.', 'success');
            await loadAccountsPrazo(document.getElementById('accountsPrazoSearch')?.value || '');
          } catch (err) {
            console.error('Erro ao salvar nota:', err);
            showToast('Falha ao salvar nota.', 'danger');
          }
        }





        // Attach listener for the new receive button when selecting account (ensure exists)
        const originalSelectAccount = selectAccount;
        function selectAccountWithReceive(id) {
          originalSelectAccount(id);
          setTimeout(() => {
            document.getElementById('btnReceive')?.addEventListener('click', async () => {
              try {
                const tx = state.accountsPrazo.items.find(t => t.id === id);
                if (!tx) return;
                const amt = parseFloat(prompt('Valor recebido:', (tx.valueDue || 0).toString()));
                if (isNaN(amt) || amt <= 0) return;
                const method = prompt('Método de pagamento (ex: cash, pix, card):', 'cash');
                const resp = await receivePayment(id, amt, method || 'cash', 'Recebimento via PDV');
                if (resp && resp.id) {
                  showToast('Recebimento registrado e recibo gerado.', 'success');
                  openReceiptPdf(resp.id);
                  await loadAccountsPrazo(document.getElementById('accountsPrazoSearch')?.value || '');
                }
              } catch (e) {
                console.error('Erro ao processar recebimento:', e);
                showToast('Falha ao processar recebimento.', 'danger');
              }
            });
          }, 40);
        }
        // Replace original selectAccount references
        try { window.selectAccount = selectAccountWithReceive; } catch(e) { /* ignore - used when not in window scope */ }
        // Also ensure internal calls use the new wrapper
        selectAccount = selectAccountWithReceive;

        // Selection helpers for bulk receiving
        function toggleSelect(id, checked) {
          if (!state.accountsPrazo.selectedIds) state.accountsPrazo.selectedIds = [];
          if (checked) {
            if (!state.accountsPrazo.selectedIds.includes(id)) state.accountsPrazo.selectedIds.push(id);
          } else {
            state.accountsPrazo.selectedIds = state.accountsPrazo.selectedIds.filter(x => x !== id);
          }
          updateBulkState();
          // update selectAll checkbox
          const sa = document.getElementById('accountsSelectAll');
          if (sa) {
            const total = (state.accountsPrazo.items || []).length;
            sa.checked = state.accountsPrazo.selectedIds.length === total && total > 0;
          }
        }

        function toggleSelectAll(check) {
          const items = state.accountsPrazo.items || [];
          state.accountsPrazo.selectedIds = check ? items.map(i => i.id) : [];
          document.querySelectorAll('#accountsPrazoList .account-select').forEach(cb => cb.checked = check);
          updateBulkState();
        }

        function updateBulkState() {
          const n = (state.accountsPrazo.selectedIds || []).length;
          const btn = document.getElementById('btnBulkReceive');
          if (btn) {
            btn.disabled = n === 0;
            btn.textContent = 'Receber selecionadas' + (n ? ' (' + n + ')' : '');
          }
        }

        async function bulkReceiveSelected() {
          // Open a modal to review amounts for selected items
          const ids = state.accountsPrazo.selectedIds || [];
          if (!ids.length) return;
          // Build modal rows
          const modalBody = document.getElementById('bulkReceiveModalBody');
          if (!modalBody) return alert('Modal de recebimento não encontrado');
          modalBody.innerHTML = '';
          const items = ids.map(id => {
            const tx = state.accountsPrazo.items.find(t => t.id === id);
            return Object.assign({}, tx, { receiveAmount: parseFloat(tx.valueDue || tx.value) });
          });
          const table = document.createElement('div');
          table.innerHTML = `
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
              <div style="flex:1;font-weight:700">Cliente / Descrição</div>
              <div style="width:140px;font-weight:700">Valor a Receber</div>
              <div style="width:140px;font-weight:700">Método</div>
            </div>
          `;
          items.forEach((it, idx) => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.gap = '8px';
            row.style.alignItems = 'center';
            row.style.marginBottom = '6px';
            row.innerHTML = `
              <div style="flex:1">${it.person || 'Cliente'} • <small class="text-muted">${it.description || ''}</small></div>
              <div style="width:140px"><input class="form-control form-control-sm bulk-amt" data-id="${it.id}" value="${it.receiveAmount.toFixed(2)}" /></div>
              <div style="width:140px"><input class="form-control form-control-sm bulk-method" data-id="${it.id}" value="dinheiro" placeholder="Ex: dinheiro, pix, cartão" /></div> 
            `;
            table.appendChild(row);
          });
          modalBody.appendChild(table);
          document.getElementById('bulkReceiveCount')?.textContent = ids.length;
          // Show modal
          if (window.jQuery) window.jQuery('#bulkReceiveModal').modal('show');
          else {
            const modalEl = document.getElementById('bulkReceiveModal');
            try { const inst = window.bootstrap.Modal.getOrCreateInstance(modalEl); inst.show(); } catch(e) { modalEl.classList.add('show'); }
          }
        }

        // Wire up select-all and bulk button handlers
        setTimeout(() => {
          try {
            document.getElementById('accountsSelectAll')?.addEventListener('change', (e) => toggleSelectAll(e.target.checked));
            document.getElementById('btnBulkReceive')?.addEventListener('click', bulkReceiveSelected);
            updateBulkState();

            // Confirm bulk handler
            document.getElementById('btnConfirmBulkReceive')?.addEventListener('click', async () => {
              const rows = Array.from(document.querySelectorAll('#bulkReceiveModalBody .bulk-amt'));
              const items = rows.map(inp => {
                const id = inp.dataset.id;
                const amount = parseFloat(inp.value.replace(',', '.')) || 0;
                const method = (document.querySelector('#bulkReceiveModalBody .bulk-method[data-id="' + id + '"]') || {}).value || 'cash';
                return { id, amount, method, note: 'Recebimento em lote via PDV' };
              }).filter(it => it.amount > 0);
              if (!items.length) return alert('Nenhum valor válido informado');
              try {
                const res = await axios.post('/api/transactions/bulk-receive', { items });
                if (res.data && res.data.receipts) {
                  showToast('Recebimentos processados.', 'success');
                  (res.data.receipts || []).slice(0,10).forEach(r => window.open('/api/receipts/' + r.id + '/pdf', '_blank'));
                  if (window.jQuery) window.jQuery('#bulkReceiveModal').modal('hide');
                  await loadAccountsPrazo(document.getElementById('accountsPrazoSearch')?.value || '');
                  state.accountsPrazo.selectedIds = [];
                  toggleSelectAll(false);
                  updateBulkState();
                }
              } catch (err) {
                console.error('Erro no recebimento em lote (confirm):', err);
                showToast('Falha ao processar recebimentos.', 'danger');
              }
            });
          } catch(e) { /* ignore */ }
        }, 20);

        // --- Lógica do Carrinho ---
        function addToCart(productId) {
          const product = state.allProducts.find(p => p.id === productId);
          if (!product) return;

          const available = (typeof product.stock === 'number') ? product.stock : 0;
          const cartItem = state.cart.find(item => item.id === productId);
          const currentQty = cartItem ? cartItem.qty : 0;

          if (available <= currentQty) {
            showToast(`Estoque insuficiente para ${product.name}. Disponível: ${available}`, 'warning');
            playSound('low');
            return;
          }

          if (cartItem) {
            cartItem.qty++;
          } else {
            state.cart.push({ ...product, qty: 1 });
          }
          renderCart();
          
          // Feedback visual
          showToast(`${product.name} adicionado`, 'success');
          // Sound feedback
          playSound('add');
        }

        function addToCartByBarcode(code) {
          const product = state.allProducts.find(p => 
            (p.code && p.code.toString() === code) || 
            (p.sku && p.sku === code) ||
            (p.barcode && p.barcode === code) ||
            (p.id && p.id.toString() === code)
          );
          
          if (product) {
            addToCart(product.id);
            barcodeInput.value = '';
            barcodeInput.focus();
          } else {
            showToast('Produto não encontrado!', 'danger');
            playSound('error');
            barcodeInput.select();
          }
        }

        function updateCartItem(productId, action) {
          const cartItem = state.cart.find(item => String(item.id) === String(productId));
          if (!cartItem) return;

          if (action === 'inc') {
            const prod = state.allProducts.find(p => String(p.id) === String(productId));
            const available = (prod && typeof prod.stock === 'number') ? prod.stock : 0;
            if (cartItem.qty + 1 > available) {
              showToast(`Estoque insuficiente para ${cartItem.name}. Disponível: ${available}`, 'warning');
              playSound('low');
            } else {
              cartItem.qty++;
            }
          } else if (action === 'dec') {
            cartItem.qty--;
            if (cartItem.qty <= 0) {
              state.cart = state.cart.filter(item => String(item.id) !== String(productId));
              playSound('remove');
            }
          } else if (action === 'rem') {
            state.cart = state.cart.filter(item => String(item.id) !== String(productId));
            playSound('remove');
          }
          renderCart();
        }
        
        function clearCart() {
            state.cart = [];
            state.discount = 0;
            state.addition = 0;
            state.currentClient = null;
            renderCart();
        }

        // --- Vendas em Espera ---
        function holdSale() {
          if (state.cart.length === 0) {
            showToast('Carrinho vazio!', 'warning');
            return;
          }

          const subtotal = state.cart.reduce((s, it) => s + (it.price * it.qty), 0);
          const total = subtotal - state.discount + state.addition;

          const pendingSale = {
            cart: [...state.cart],
            discount: state.discount,
            addition: state.addition,
            client: state.currentClient,
            total: total,
            time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
          };

          state.pendingSales.push(pendingSale);
          clearCart();
          renderPendingSales();
          showToast('Venda colocada em espera!', 'info');
          playSound('hold');
        }

        function restorePendingSale(index) {
          const sale = state.pendingSales[index];
          if (!sale) return;

          // Se há itens no carrinho atual, perguntar
          if (state.cart.length > 0) {
            if (!confirm('Há itens no carrinho atual. Deseja substituir pela venda em espera?')) {
              return;
            }
          }

          state.cart = [...sale.cart];
          state.discount = sale.discount;
          state.addition = sale.addition;
          state.currentClient = sale.client;
          state.pendingSales.splice(index, 1);
          
          renderCart();
          renderPendingSales();
          showToast('Venda restaurada!', 'success');
        }

        // --- Toast notifications ---
        function showToast(message, type = 'info') {
          const colors = {
            success: 'var(--success)',
            danger: 'var(--danger)',
            warning: 'var(--warning)',
            info: 'var(--brand)'
          };

          const toast = document.createElement('div');
          toast.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: ${colors[type]};
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            z-index: 9999;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
          `;
          toast.textContent = message;
          document.body.appendChild(toast);

          setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
          }, 2000);
        }

        // CSS para animações
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);

        // --- Lógica de Pagamento ---
        function openCheckout() {
            if (state.cart.length === 0) {
                alert('O carrinho está vazio.');
                return;
            }
            const subtotal = state.cart.reduce((s, it) => s + (it.price * it.qty), 0);
            const total = subtotal - state.discount + state.addition;
            
            // Atualizar valores no modal
            document.getElementById('modalSubtotal').textContent = formatMoney(subtotal);
            document.getElementById('modalDiscount').textContent = formatMoney(state.discount);
            modalTotalEl.textContent = formatMoney(total);
            payAmountInput.value = total.toFixed(2);
            calculateChange();
            
            // Reset para dinheiro e esconder parcelas
            const cashRadio = document.querySelector('input[name="payMethod"][value="cash"]');
            if (cashRadio) {
                cashRadio.checked = true;
                
                // Remover active de todos os labels
                document.querySelectorAll('.btn-group-toggle label').forEach(label => {
                    label.classList.remove('active');
                });
                
                // Adicionar active no label do dinheiro
                cashRadio.parentElement.classList.add('active');
            }
            
            document.getElementById('installmentsGroup').style.display = 'none';
            
            // Resetar seletor de parcelas
            document.getElementById('installments').value = '1';
            updateInstallmentInfo();
            
            payModal.modal('show');
        }

        function calculateChange() {
            const total = state.cart.reduce((s, it) => s + (it.price * it.qty), 0) - state.discount + state.addition;
            const received = parseFloat(payAmountInput.value) || 0;
            const change = received - total;
            changeValEl.textContent = formatMoney(Math.max(0, change));
        }

        function updateInstallmentInfo() {
            const total = state.cart.reduce((s, it) => s + (it.price * it.qty), 0) - state.discount + state.addition;
            const installments = parseInt(document.getElementById('installments').value) || 1;
            const payMethod = document.querySelector('input[name="payMethod"]:checked')?.value;
            const installmentInfo = document.getElementById('installmentInfo');
            
            if (installments > 1) {
                const valuePerInstallment = total / installments;
                const methodText = payMethod === 'card' ? 'crédito' : 'a prazo';
                const dueDateInfo = payMethod === 'prazo' ? ' (1ª parcela em 30 dias)' : '';
                installmentInfo.innerHTML = `<i class="fa fa-calculator mr-1"></i>${installments}x de ${formatMoney(valuePerInstallment)} ${methodText}${dueDateInfo}`;
                installmentInfo.className = 'text-info mt-2 font-weight-bold';
            } else {
                installmentInfo.textContent = 'Pagamento à vista';
                installmentInfo.className = 'text-muted mt-2';
            }
        }

        async function finalizeSale() {
            // Validações básicas
            const subtotal = state.cart.reduce((s, it) => s + (it.price * it.qty), 0);
            const total = subtotal - state.discount + state.addition;
            const payMethod = document.querySelector('input[name="payMethod"]:checked')?.value;
            const client = document.getElementById('payClient').value || 'Cliente Padrão';
            const receivedAmount = parseFloat(payAmountInput.value) || 0;
            const installments = parseInt(document.getElementById('installments').value) || 1;
            
            if (!payMethod) {
                alert('Selecione um método de pagamento.');
                return;
            }
            
            if (payMethod === 'cash' && receivedAmount < total) {
                alert('Valor recebido é menor que o total da venda.');
                return;
            }
            
            const now = new Date();
            const itemsDescription = `Itens: ${state.cart.map(item => `${item.name} (${item.qty}x)`).join(', ')}`;
            
            try {
                // Evita envios duplicados
                if (confirmPayBtn) confirmPayBtn.disabled = true;

                // Se for parcelado (crédito ou a prazo com mais de 1x)
                if ((payMethod === 'card' || payMethod === 'prazo') && installments > 1) {
                    const valuePerInstallment = total / installments;
                    
                    // Criar uma transação para cada parcela
                    for (let i = 1; i <= installments; i++) {
                        const dueDate = new Date(now);
                        
                        if (payMethod === 'card') {
                            // Crédito: todas as parcelas são consideradas pagas (já debitadas do cartão)
                            dueDate.setDate(now.getDate() + (i * 30)); // Parcelas mensais
                        } else {
                            // A prazo: primeira parcela 30 dias, demais mensais
                            dueDate.setDate(now.getDate() + (i * 30));
                        }
                        
                        // sanitize cart to avoid large payloads (strip images and large fields)
                        const cartForNotes = state.cart.map(item => ({ id: item.id, code: item.code, name: item.name, price: item.price, qty: item.qty }));
                        const itemsJson = JSON.stringify(cartForNotes);
                        const itemsJsonLimited = itemsJson.length > 2000 ? itemsJson.slice(0, 2000) + '...' : itemsJson;

                        const transaction = {
                            category: 'Vendas',
                            dueDate: dueDate.toISOString().split('T')[0],
                            description: `Venda PDV - Parcela ${i}/${installments} - ${payMethod === 'card' ? 'Crédito' : 'A Prazo'}`,
                            person: client,
                            value: valuePerInstallment,
                            amount: valuePerInstallment,
                            type: 'venda',
                            valueDue: payMethod === 'card' ? 0 : valuePerInstallment, // Crédito já está pago
                            paid: payMethod === 'card', // Crédito já está pago
                            status: payMethod === 'card' ? 'pago' : 'pendente',
                            paymentDate: payMethod === 'card' ? now.toISOString() : null,
                            paymentMethod: payMethod,
                            installments: installments,
                            installmentNumber: i,
                            notes: `ITEMS_JSON:${itemsJsonLimited} | ${itemsDescription} - Parcela ${i} de ${installments}`
                        };

                        await axios.post('/api/transactions', transaction);
                    }
                } else {
                    // Pagamento à vista ou única parcela
                    // sanitize cart to avoid large payloads (strip images and large fields)
                    const cartForNotes = state.cart.map(item => ({ id: item.id, code: item.code, name: item.name, price: item.price, qty: item.qty }));
                    const itemsJson = JSON.stringify(cartForNotes);
                    const itemsJsonLimited = itemsJson.length > 2000 ? itemsJson.slice(0, 2000) + '...' : itemsJson;

                    const transaction = {
                        category: 'Vendas',
                        dueDate: now.toISOString().split('T')[0],
                        description: `Venda PDV - ${state.cart.length} item(ns) - ${payMethod}`,
                        person: client,
                        value: total,
                        amount: total,
                        type: 'venda',
                        // Se for 'a prazo' (única parcela), registrar como pendente/fiado; caso contrário marcar como pago
                        valueDue: (payMethod === 'prazo') ? total : 0,
                        paid: (payMethod === 'prazo') ? false : true,
                        status: (payMethod === 'prazo') ? 'pendente' : 'pago',
                        paymentDate: (payMethod === 'prazo') ? null : now.toISOString(),
                        paymentMethod: payMethod,
                        installments: 1,
                        notes: `ITEMS_JSON:${itemsJsonLimited} | ${itemsDescription}`
                    };

                    await axios.post('/api/transactions', transaction);
                }
                
                // Atualizar estoque dos produtos
                for (const item of state.cart) {
                    try {
                        const product = state.allProducts.find(p => p.id === item.id);
                        if (product && product.stock !== undefined) {
                            const newStock = Math.max(0, (product.stock || 0) - item.qty);
                            // Send only the minimal payload (stock) to avoid large requests (images)
                            await axios.put(`/api/products/${item.id}`, { stock: newStock });
                            console.log(`Estoque atualizado: ${product.name} - ${product.stock} -> ${newStock}`);
                        }
                    } catch (stockError) {
                        console.error('Erro ao atualizar estoque do produto:', item.name, stockError);
                    }
                }
                
                // Sucesso
                const successMessage = installments > 1 ? 
                    `Venda parcelada em ${installments}x de ${formatMoney(total/installments)} realizada com sucesso!` :
                    'Venda finalizada com sucesso!';
                    
                // Sinaliza para outras abas/páginas que o dashboard deve ser recarregado
                try { localStorage.setItem('dashboard_refresh', Date.now()); } catch(e) { /* ignore */ }

                alert(successMessage);
                playSound('success');
                clearCart();
                payModal.modal('hide');
                
                // Recarregar produtos para atualizar estoque na tela
                init();
                
            } catch (error) {
                console.error('Erro ao salvar venda:', error);
                playSound('error');
                alert('Falha ao salvar a venda. Verifique o console para mais detalhes.');
            } finally {
                if (confirmPayBtn) confirmPayBtn.disabled = false;
            }
        }

        // --- Inicialização e Eventos ---
        async function init() {
          try {
            // Carregar produtos
            const response = await axios.get('/api/products');
            // Mapear field 'photo' do backend para 'image' usado no frontend
            state.allProducts = (response.data.data || []).map(p => (Object.assign({}, p, { image: p.photo || p.image || null })));
            renderCategories();
            renderProducts();
            renderPendingSales();
            
            // Carregar clientes para o datalist
            try {
              const clientsResponse = await axios.get('/api/people');
              const clients = clientsResponse.data.data || [];
              const clientsList = document.getElementById('clientsList');
              clientsList.innerHTML = '';
              clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = `${client.name} - ${client.phone || 'Sem telefone'}`;
                clientsList.appendChild(option);
              });
            } catch (clientError) {
              console.warn('Erro ao carregar clientes:', clientError);
            }
            
          } catch (error) {
            console.error("Erro ao carregar produtos:", error);
            productListEl.innerHTML = '<div class="alert alert-danger">Não foi possível carregar os produtos. Verifique a conexão com o servidor.</div>';
          }

          // Event Listeners
          searchInput.addEventListener('input', renderProducts);
          btnCheckout.addEventListener('click', openCheckout);
          btnCancel.addEventListener('click', () => {
            if (state.cart.length > 0 && confirm('Deseja cancelar a venda atual?')) {
              clearCart();
              showToast('Venda cancelada!', 'danger');
            }
          });
          btnHold.addEventListener('click', holdSale);
          payAmountInput.addEventListener('input', calculateChange);
          confirmPayBtn.addEventListener('click', finalizeSale);

          // Código de barras - Enter para adicionar
          barcodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              const code = barcodeInput.value.trim();
              if (code) {
                addToCartByBarcode(code);
              }
            }
          });

          // Botões rápidos
          document.getElementById('btnHelp')?.addEventListener('click', () => showHelp());
          document.getElementById('btnClient')?.addEventListener('click', () => {
            openCheckout();
            payModal.one('shown.bs.modal', () => document.getElementById('payClient')?.focus());
          });
          document.getElementById('btnSearch')?.addEventListener('click', () => searchInput.focus());
          document.getElementById('btnDiscount')?.addEventListener('click', () => applyDiscount());

          // Abrir modal de Contas a Prazo (FAB)
          btnAccountsPrazo?.addEventListener('click', () => {
            loadAccountsPrazo();
            if (window.jQuery) window.jQuery('#accountsPrazoModal').modal('show');
            else {
              try { const inst = window.bootstrap.Modal.getOrCreateInstance(accountsPrazoModalEl); inst.show(); } catch(e) { accountsPrazoModalEl.classList.add('show'); }
            }
          });

          // Search and refresh handlers inside the modal
          const accountsSearchEl = document.getElementById('accountsPrazoSearch');
          const btnRefreshAccounts = document.getElementById('btnRefreshAccounts');
          let accountsSearchTimer = null;
          if (accountsSearchEl) {
            accountsSearchEl.addEventListener('input', (e) => {
              clearTimeout(accountsSearchTimer);
              accountsSearchTimer = setTimeout(() => loadAccountsPrazo(e.target.value.trim()), 300);
            });
          }
          btnRefreshAccounts?.addEventListener('click', () => loadAccountsPrazo(accountsSearchEl?.value || ''));

          // Focus automático no campo de busca quando o modal abrir
          if (accountsPrazoModalEl) {
            try {
              if (window.jQuery) {
                window.jQuery('#accountsPrazoModal').on('shown.bs.modal', () => { accountsSearchEl?.focus(); accountsSearchEl?.select(); });
              } else {
                accountsPrazoModalEl.addEventListener('shown.bs.modal', () => { accountsSearchEl?.focus(); accountsSearchEl?.select(); });
              }
            } catch(e) { /* ignore */ }
          }
          document.getElementById('btnPix')?.addEventListener('click', () => {
            openCheckout();
            payModal.one('shown.bs.modal', () => {
              const pixRadio = document.querySelector('input[name="payMethod"][value="pix"]');
              if (pixRadio) {
                pixRadio.checked = true;
                pixRadio.dispatchEvent(new Event('change', { bubbles: true }));
              }
            });
          });
          document.getElementById('btnCash')?.addEventListener('click', () => {
            openCheckout();
            payModal.one('shown.bs.modal', () => {
              const cashRadio = document.querySelector('input[name="payMethod"][value="cash"]');
              if (cashRadio) {
                cashRadio.checked = true;
                cashRadio.dispatchEvent(new Event('change', { bubbles: true }));
              }
            });
          });

          // Event listener para formas de pagamento e parcelas
          document.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'payMethod') {
              const installmentsGroup = document.getElementById('installmentsGroup');
              
              // Remover classe active de todos os labels
              document.querySelectorAll('.btn-group-toggle label').forEach(label => {
                label.classList.remove('active');
              });
              
              // Adicionar classe active no label do radio selecionado
              if (e.target.checked) {
                e.target.parentElement.classList.add('active');
              }
              
              // Mostrar/esconder campo de parcelas para Crédito e A Prazo
              if (e.target.value === 'card' || e.target.value === 'prazo') {
                installmentsGroup.style.display = 'block';
                updateInstallmentInfo();
              } else {
                installmentsGroup.style.display = 'none';
              }
            }
            
            // Atualizar info das parcelas quando mudar o número
            if (e.target && e.target.id === 'installments') {
              updateInstallmentInfo();
            }
          });

          // Event listener para clicks nos labels dos botões
          document.addEventListener('click', function(e) {
            if (e.target.closest('.btn-group-toggle label')) {
              const label = e.target.closest('label');
              const radio = label.querySelector('input[type="radio"]');
              
              if (radio) {
                // Disparar evento change manualmente
                radio.checked = true;
                radio.dispatchEvent(new Event('change', { bubbles: true }));
              }
            }
          });

          // Global handler para elementos com data-dismiss="modal" (suporta jQuery e Bootstrap)
          document.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-dismiss="modal"]');
            if (!btn) return;
            const modalEl = btn.closest('.modal');
            if (!modalEl) return;

            // Se jQuery estiver disponível, tente usar a API da jQuery (mapeada para o Modal)
            try {
              if (window.jQuery && window.jQuery(modalEl).modal) {
                window.jQuery(modalEl).modal('hide');
                return;
              }
            } catch (err) { /* ignore */ }

            // Caso contrário, use a API nativa do Bootstrap 5
            try {
              if (window.bootstrap && window.bootstrap.Modal) {
                const inst = window.bootstrap.Modal.getOrCreateInstance(modalEl);
                inst.hide();
                return;
              }
            } catch (err) { /* ignore */ }

            // Fallback: remover classe 'show' e ocultar
            modalEl.classList.remove('show');
            modalEl.style.display = 'none';
          });

          cartItemsEl.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-act]');
            if (target) {
              const action = target.dataset.act;
              const productId = target.dataset.id;
              updateCartItem(productId, action);
            }
          });

          // Atalhos de teclado
          document.addEventListener('keydown', (e) => {
            const isPayModalOpen = !!(payModal && payModal.hasClass && payModal.hasClass('show'));
            const isInputFocused = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName);

            if (e.key === 'F1') {
              e.preventDefault();
              showHelp();
            }
            if (e.key === 'F2') {
              e.preventDefault();
              if (!isPayModalOpen) {
                openCheckout();
                if (payModal && payModal.one) {
                  payModal.one('shown.bs.modal', () => {
                    document.getElementById('payClient')?.focus();
                  });
                }
              } else {
                document.getElementById('payClient')?.focus();
              }
            }
            if (e.key === 'F3') {
              e.preventDefault();
              searchInput.focus();
            }
            if (e.key === 'F4') {
              e.preventDefault();
              openCheckout();
            }
            if (e.key === 'F5') {
                e.preventDefault();
                applyDiscount();
            }
            if (e.key === 'F7') {
              e.preventDefault();
              barcodeInput.focus();
              barcodeInput.select();
            }
            if (e.key === 'F8') {
              e.preventDefault();
              holdSale();
            }
            if (e.key === 'F9') {
              e.preventDefault();
              if (state.cart.length > 0 && confirm('Deseja cancelar a venda atual?')) {
                clearCart();
                showToast('Venda cancelada!', 'danger');
              }
            }
            if (e.key === 'F10') {
              e.preventDefault();
              const selectPix = () => {
                const pixRadio = document.querySelector('input[name="payMethod"][value="pix"]');
                if (!pixRadio) return;
                pixRadio.checked = true;
                pixRadio.dispatchEvent(new Event('change', { bubbles: true }));
              };

              if (!isPayModalOpen) {
                openCheckout();
                if (payModal && payModal.one) {
                  payModal.one('shown.bs.modal', () => {
                    selectPix();
                  });
                }
              } else {
                selectPix();
              }
            }
            if (e.key === 'F11') {
              e.preventDefault();
              const selectCash = () => {
                const cashRadio = document.querySelector('input[name="payMethod"][value="cash"]');
                if (!cashRadio) return;
                cashRadio.checked = true;
                cashRadio.dispatchEvent(new Event('change', { bubbles: true }));
              };

              if (!isPayModalOpen) {
                openCheckout();
                if (payModal && payModal.one) {
                  payModal.one('shown.bs.modal', () => {
                    selectCash();
                    document.getElementById('payAmount')?.focus();
                  });
                }
              } else {
                selectCash();
                document.getElementById('payAmount')?.focus();
              }
            }
            if (e.key === 'Escape') {
              e.preventDefault();
              if (isPayModalOpen) {
                payModal.modal('hide');
              } else if (confirm('Deseja sair do PDV?')) {
                window.location.href = 'dashboard.html';
              }
            }
          });

          // Relógio e data
          function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-BR');
            document.getElementById('currentDate').textContent = now.toLocaleDateString('pt-BR');
          }
          updateDateTime();
          setInterval(updateDateTime, 1000);

          // Focar no campo de código de barras ao carregar
          setTimeout(() => barcodeInput.focus(), 100);

          // Recalcular posição do FAB após layout inicializado
          setTimeout(() => { try { if (typeof adjustFabPosition === 'function') adjustFabPosition(); } catch(e){} }, 120);
        }

        function showHelp() {
          alert(
            [
              '═══════════════════════════════════',
              '        ATALHOS DO PDV',
              '═══════════════════════════════════',
              '',
              'F1  - Ajuda (esta tela)',
              'F2  - Selecionar cliente',
              'F3  - Buscar produto',
              'F4  - Finalizar venda',
              'F5  - Aplicar desconto',
              'F7  - Foco no código de barras',
              'F8  - Colocar venda em espera',
              'F9  - Cancelar venda',
              'F10 - Pagamento PIX',
              'F11 - Pagamento em dinheiro',
              'ESC - Sair do PDV',
              '',
              '═══════════════════════════════════'
            ].join('\n')
          );
        }

        function applyDiscount() {
          const discountValue = parseFloat(prompt("Digite o valor do desconto:", state.discount.toString()));
          if (!isNaN(discountValue) && discountValue >= 0) {
            state.discount = discountValue;
            updateTotals();
            showToast(`Desconto de ${formatMoney(discountValue)} aplicado!`, 'success');
          }
        }

        // (debug utilities removed)

        init();
      });
    </script>
  </body>
</html>
