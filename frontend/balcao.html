<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Balcão - Orçamentos</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <script src="js/auth-guard.js"></script>
  <script src="js/branding.js"></script>
  <script src="js/datetime-utils.js"></script>
  <style>
    .balcao-container { display: grid; grid-template-columns: 1fr 320px; gap: 16px; height: calc(100vh - 140px); padding: 20px; overflow: hidden; }
    
    /* ÁREA PRINCIPAL - Itens do Orçamento (GRANDE - para cliente ver) */
    .orcamento-section { background: #fff; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
    .orcamento-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 3px solid #6366f1; flex-shrink: 0; }
    .orcamento-header h4 { margin: 0; font-weight: 700; color: #1f2937; font-size: 20px; display: flex; align-items: center; gap: 10px; }
    .orcamento-header .badge { font-size: 14px; padding: 8px 16px; }
    
    /* Cliente destaque */
    .cliente-destaque { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .cliente-destaque i { font-size: 20px; color: #92400e; }
    .cliente-destaque input { flex: 1; border: 2px solid #fcd34d; border-radius: 8px; padding: 8px 12px; font-size: 15px; background: #fff; }
    .cliente-destaque input:focus { border-color: #f59e0b; outline: none; box-shadow: 0 0 0 3px rgba(245,158,11,0.2); }
    
    /* Tabela de itens do orçamento - DESTAQUE VISUAL */
    .itens-table-header { display: grid; grid-template-columns: 40px 1fr 100px 110px 110px 40px; gap: 8px; padding: 12px 16px; background: #1f2937; border-radius: 10px 10px 0 0; font-weight: 700; font-size: 12px; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; }
    .itens-lista { flex: 1; overflow-y: auto; background: #f8fafc; border-radius: 0 0 10px 10px; }
    .itens-lista::-webkit-scrollbar { width: 10px; }
    .itens-lista::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 5px; }
    .itens-lista::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 5px; }
    .itens-lista::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    .item-row { display: grid; grid-template-columns: 40px 1fr 100px 110px 110px 40px; gap: 8px; align-items: center; padding: 14px 16px; background: #fff; border-bottom: 1px solid #e5e7eb; font-size: 14px; transition: background 0.15s; }
    .item-row:hover { background: #f0f9ff; }
    .item-row:nth-child(even) { background: #f9fafb; }
    .item-row:nth-child(even):hover { background: #f0f9ff; }
    .item-row .item-num { font-weight: 700; color: #6366f1; font-size: 15px; text-align: center; }
    .item-row .item-nome { font-weight: 600; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-row .item-preco { color: #6b7280; text-align: right; font-size: 13px; }
    .item-row .item-qtd { display: flex; align-items: center; justify-content: center; gap: 6px; }
    .item-row .item-qtd button { width: 28px; height: 28px; border: none; border-radius: 6px; background: #e5e7eb; color: #374151; cursor: pointer; font-size: 14px; font-weight: 700; }
    .item-row .item-qtd button:hover { background: #6366f1; color: #fff; }
    .item-row .item-qtd span { min-width: 28px; text-align: center; font-weight: 700; font-size: 15px; }
    .item-row .item-subtotal { font-weight: 700; color: #059669; font-size: 15px; text-align: right; }
    .item-row .item-remove { background: none; border: none; color: #dc2626; cursor: pointer; font-size: 16px; padding: 6px; border-radius: 6px; }
    .item-row .item-remove:hover { background: #fee2e2; }
    
    .empty-orcamento { text-align: center; padding: 60px 40px; color: #9ca3af; }
    .empty-orcamento i { font-size: 60px; margin-bottom: 16px; color: #d1d5db; }
    .empty-orcamento h5 { font-size: 18px; color: #6b7280; margin-bottom: 8px; }
    .empty-orcamento p { font-size: 13px; }
    
    /* Rodapé com totais - BEM VISÍVEL */
    .orcamento-footer { display: grid; grid-template-columns: 1fr auto; gap: 16px; margin-top: 16px; flex-shrink: 0; }
    .totais-box { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #22c55e; border-radius: 12px; padding: 16px 20px; }
    .totais-box .linha { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 15px; color: #374151; }
    .totais-box .linha.total { font-size: 24px; font-weight: 800; color: #059669; border-top: 2px solid #22c55e; padding-top: 10px; margin-top: 6px; margin-bottom: 0; }
    .acoes-box { display: flex; flex-direction: column; gap: 8px; }
    .acoes-box .btn { padding: 12px 20px; font-weight: 600; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
    .btn-enviar-pdv { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; color: #fff; }
    .btn-enviar-pdv:hover { background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); color: #fff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99,102,241,0.4); }
    .btn-salvar-orc { background: #10b981; border: none; color: #fff; }
    .btn-salvar-orc:hover { background: #059669; color: #fff; }
    .btn-limpar { background: #f3f4f6; border: 2px solid #d1d5db; color: #374151; }
    .btn-limpar:hover { background: #e5e7eb; color: #374151; }
    
    /* PAINEL LATERAL - Busca de Produtos (compacto) */
    .busca-section { background: #fff; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 16px; display: flex; flex-direction: column; overflow: hidden; }
    .busca-section h5 { margin: 0 0 12px 0; font-weight: 700; color: #1f2937; font-size: 15px; display: flex; align-items: center; gap: 8px; }
    .search-box { position: relative; margin-bottom: 10px; flex-shrink: 0; }
    .search-box input { padding-left: 40px; border-radius: 10px; border: 2px solid #e5e7eb; height: 44px; font-size: 14px; width: 100%; }
    .search-box input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
    .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 14px; }
    
    .resultados-busca { flex: 1; overflow-y: auto; }
    .resultados-busca::-webkit-scrollbar { width: 6px; }
    .resultados-busca::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    .resultados-busca::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    
    .produto-resultado { display: flex; flex-direction: column; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: all 0.15s; border: 2px solid transparent; }
    .produto-resultado:hover { background: #eef2ff; border-color: #6366f1; transform: translateX(4px); }
    .produto-resultado .nome { font-weight: 600; color: #1f2937; font-size: 13px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .produto-resultado .info { display: flex; justify-content: space-between; align-items: center; }
    .produto-resultado .codigo { font-size: 11px; color: #6b7280; }
    .produto-resultado .preco { font-weight: 700; color: #059669; font-size: 14px; }
    
    .busca-vazia { text-align: center; padding: 30px 16px; color: #9ca3af; }
    .busca-vazia i { font-size: 32px; margin-bottom: 10px; color: #d1d5db; }
    .busca-vazia p { font-size: 12px; margin: 0; }
    
    .desconto-section { margin-top: auto; padding-top: 12px; border-top: 1px solid #e5e7eb; flex-shrink: 0; }
    .desconto-section label { font-weight: 600; font-size: 12px; color: #374151; margin-bottom: 6px; display: block; }
    .desconto-row { display: flex; gap: 6px; }
    .desconto-row input { flex: 1; border-radius: 6px; font-size: 13px; }
    .desconto-row select { width: 60px; border-radius: 6px; font-size: 13px; }
    
    @media (max-width: 992px) { 
      .balcao-container { grid-template-columns: 1fr; height: auto; overflow: visible; } 
      .busca-section { order: -1; min-height: 250px; }
      .itens-table-header, .item-row { grid-template-columns: 35px 1fr 80px 90px 90px 35px; font-size: 12px; padding: 10px 12px; }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <!-- Sidebar -->
    <div class="sidebar">
      <h4>SISTEMA</h4>
      <ul class="sidebar-menu">
        <li><a href="index.html"><span class="menu-icon"><i class="fa fa-home"></i></span><span class="menu-label">Início</span></a></li>
        <li><a href="pdv.html"><span class="menu-icon"><i class="fa fa-cash-register"></i></span><span class="menu-label">PDV</span></a></li>
        <li><a href="dashboard.html"><span class="menu-icon"><i class="fa fa-chart-pie"></i></span><span class="menu-label">Painel</span></a></li>
        <li><a href="nfe-emissao.html"><span class="menu-icon"><i class="fa fa-file-invoice"></i></span><span class="menu-label">Notas Fiscais</span></a></li>
        <li><a href="movimentos.html"><span class="menu-icon"><i class="fa fa-exchange-alt"></i></span><span class="menu-label">Movimentos</span></a></li>
        <li><a href="relatorios.html"><span class="menu-icon"><i class="fa fa-chart-bar"></i></span><span class="menu-label">Relatórios</span></a></li>
        <li><a href="pessoas.html"><span class="menu-icon"><i class="fa fa-users"></i></span><span class="menu-label">Clientes</span></a></li>
        <li><a href="produtos.html"><span class="menu-icon"><i class="fa fa-boxes"></i></span><span class="menu-label">Produtos</span></a></li>
        <li><a href="agenda.html"><span class="menu-icon"><i class="fa fa-calendar"></i></span><span class="menu-label">Agenda</span></a></li>
        <li><a href="admin.html"><span class="menu-icon"><i class="fa fa-cogs"></i></span><span class="menu-label">Admin</span></a></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="main-header">
        <h3><i class="fa fa-clipboard-list"></i> Balcão - Orçamentos</h3>
        <div class="header-info">
          <span><i class="fa fa-user-circle mr-2"></i><span id="userName">Usuário</span></span>
          <span><i class="fa fa-clock mr-2"></i><span id="currentTime">--:--</span></span>
          <button class="btn btn-sm btn-outline-secondary ml-2" onclick="loadOrcamentosSalvos()">
            <i class="fa fa-folder-open"></i> Orçamentos Salvos
          </button>
        </div>
      </div>

      <div class="balcao-container">
        <!-- ÁREA PRINCIPAL - Itens do Orçamento (para o cliente ver) -->
        <div class="orcamento-section">
          <div class="orcamento-header">
            <h4><i class="fa fa-clipboard-list"></i> Orçamento</h4>
            <span id="itemCount" class="badge badge-primary">0 itens</span>
          </div>

          <div class="cliente-destaque">
            <i class="fa fa-user-circle"></i>
            <input type="text" id="clienteNome" class="form-control" placeholder="Nome do cliente (opcional)...">
          </div>

          <div class="itens-table-header">
            <div>#</div>
            <div>Produto</div>
            <div style="text-align: right;">Preço Unit.</div>
            <div style="text-align: center;">Qtd</div>
            <div style="text-align: right;">Subtotal</div>
            <div></div>
          </div>

          <div class="itens-lista" id="carrinhoItems">
            <div class="empty-orcamento">
              <i class="fa fa-shopping-basket"></i>
              <h5>Orçamento Vazio</h5>
              <p>Pesquise produtos no painel ao lado e clique para adicionar</p>
            </div>
          </div>

          <div class="orcamento-footer">
            <div class="totais-box">
              <div class="linha">
                <span>Subtotal:</span>
                <span id="subtotalValor">R$ 0,00</span>
              </div>
              <div class="linha">
                <span>Desconto:</span>
                <span id="descontoDisplay">R$ 0,00</span>
              </div>
              <div class="linha total">
                <span>TOTAL:</span>
                <span id="totalValor">R$ 0,00</span>
              </div>
            </div>
            <div class="acoes-box">
              <button class="btn btn-enviar-pdv" onclick="enviarParaPDV()">
                <i class="fa fa-cash-register"></i> Enviar para PDV
              </button>
              <button class="btn btn-salvar-orc" onclick="salvarOrcamento()">
                <i class="fa fa-save"></i> Salvar
              </button>
              <button class="btn btn-limpar" onclick="limparCarrinho()">
                <i class="fa fa-trash"></i> Limpar
              </button>
            </div>
          </div>
        </div>

        <!-- PAINEL LATERAL - Busca de Produtos -->
        <div class="busca-section">
          <h5><i class="fa fa-search"></i> Buscar Produtos</h5>
          
          <div class="search-box">
            <i class="fa fa-search"></i>
            <input type="text" id="searchProduto" class="form-control" placeholder="Digite nome, código ou código de barras..." autofocus>
          </div>
          
          <div class="resultados-busca" id="produtosGrid">
            <div class="busca-vazia">
              <i class="fa fa-box-open"></i>
              <p>Digite no campo acima para buscar produtos</p>
            </div>
          </div>

          <div class="desconto-section">
            <label><i class="fa fa-percent mr-1"></i> Desconto no Orçamento</label>
            <div class="desconto-row">
              <input type="number" id="descontoValor" class="form-control form-control-sm" placeholder="0" min="0" step="0.01">
              <select id="descontoTipo" class="form-control form-control-sm">
                <option value="percent">%</option>
                <option value="fixed">R$</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Orçamentos Salvos -->
  <div class="modal fade" id="orcamentosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-folder-open mr-2"></i> Orçamentos Salvos</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <div id="orcamentosLista">
            <div class="text-center py-4 text-muted">
              <i class="fa fa-spinner fa-spin"></i> Carregando...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Quantidade -->
  <div class="modal fade" id="quantidadeModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-calculator mr-2"></i> Quantidade</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <p id="produtoSelecionadoNome" class="font-weight-bold mb-3"></p>
          <div class="form-group">
            <label>Quantidade:</label>
            <input type="number" id="quantidadeInput" class="form-control form-control-lg text-center" value="1" min="1" step="1">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" onclick="confirmarQuantidade()">
            <i class="fa fa-plus"></i> Adicionar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Sistema de Toasts Elegantes -->
  <script src="js/toast.js"></script>
  <script>
    const API_BASE = '/api';
    let produtos = [];
    let carrinho = [];
    let produtoParaAdicionar = null;

    // Interceptor para incluir token
    axios.interceptors.request.use(config => {
      const token = localStorage.getItem('authToken');
      if (token) config.headers.Authorization = `Bearer ${token}`;
      return config;
    });

    // Atualizar relógio
    function updateClock() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Carregar produtos
    async function loadProdutos() {
      try {
        const res = await axios.get(`${API_BASE}/products`);
        produtos = res.data.data || res.data || [];
        
        // Mostrar mensagem inicial na busca
        renderProdutos('');
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        document.getElementById('produtosGrid').innerHTML = `
          <div class="busca-vazia">
            <i class="fa fa-exclamation-triangle" style="color: #dc2626;"></i>
            <p>Erro ao carregar produtos</p>
          </div>
        `;
      }
    }

    // Renderizar produtos na busca
    function renderProdutos(search = '') {
      const grid = document.getElementById('produtosGrid');
      
      // Se não há busca, mostrar mensagem inicial
      if (!search || search.length < 2) {
        grid.innerHTML = `
          <div class="busca-vazia">
            <i class="fa fa-box-open"></i>
            <p>Digite no campo acima para buscar produtos</p>
          </div>
        `;
        return;
      }
      
      const s = search.toLowerCase();
      let filtrados = produtos.filter(p => 
        (p.name && p.name.toLowerCase().includes(s)) ||
        (p.code && p.code.toLowerCase().includes(s)) ||
        (p.barcode && p.barcode.includes(s))
      );
      
      // Limitar a 20 resultados para performance
      filtrados = filtrados.slice(0, 20);
      
      if (!filtrados.length) {
        grid.innerHTML = `
          <div class="busca-vazia">
            <i class="fa fa-search"></i>
            <p>Nenhum produto encontrado para "${search}"</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = filtrados.map(p => `
        <div class="produto-resultado" onclick="selecionarProduto('${p.id}')">
          <div class="nome">${p.name || 'Sem nome'}</div>
          <div class="info">
            <span class="codigo">${p.code || p.barcode || '-'}</span>
            <span class="preco">R$ ${(parseFloat(p.price) || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
          </div>
        </div>
      `).join('');
    }

    // Selecionar produto para adicionar
    function selecionarProduto(id) {
      const produto = produtos.find(p => p.id === id);
      if (!produto) return;
      
      produtoParaAdicionar = produto;
      document.getElementById('produtoSelecionadoNome').textContent = produto.name;
      document.getElementById('quantidadeInput').value = 1;
      $('#quantidadeModal').modal('show');
      
      setTimeout(() => {
        document.getElementById('quantidadeInput').focus();
        document.getElementById('quantidadeInput').select();
      }, 300);
    }

    // Confirmar quantidade e adicionar ao carrinho
    function confirmarQuantidade() {
      const qtd = parseInt(document.getElementById('quantidadeInput').value) || 1;
      if (produtoParaAdicionar) {
        adicionarAoCarrinho(produtoParaAdicionar, qtd);
        $('#quantidadeModal').modal('hide');
        produtoParaAdicionar = null;
      }
    }

    // Adicionar ao carrinho
    function adicionarAoCarrinho(produto, quantidade = 1) {
      const existente = carrinho.find(item => item.id === produto.id);
      
      if (existente) {
        existente.quantidade += quantidade;
      } else {
        carrinho.push({
          id: produto.id,
          nome: produto.name,
          codigo: produto.code || produto.barcode,
          preco: parseFloat(produto.price) || 0,
          quantidade: quantidade
        });
      }
      
      renderCarrinho();
    }

    // Alterar quantidade no carrinho
    function alterarQuantidade(id, delta) {
      const item = carrinho.find(i => i.id === id);
      if (!item) return;
      
      item.quantidade += delta;
      if (item.quantidade <= 0) {
        carrinho = carrinho.filter(i => i.id !== id);
      }
      
      renderCarrinho();
    }

    // Remover do carrinho
    function removerDoCarrinho(id) {
      carrinho = carrinho.filter(i => i.id !== id);
      renderCarrinho();
    }

    // Renderizar carrinho
    function renderCarrinho() {
      const container = document.getElementById('carrinhoItems');
      const countEl = document.getElementById('itemCount');
      
      if (!carrinho.length) {
        container.innerHTML = `
          <div class="empty-orcamento">
            <i class="fa fa-shopping-basket"></i>
            <h5>Orçamento Vazio</h5>
            <p>Pesquise produtos no painel ao lado e clique para adicionar</p>
          </div>
        `;
        countEl.textContent = '0 itens';
        calcularTotais();
        return;
      }
      
      const totalItens = carrinho.reduce((sum, i) => sum + i.quantidade, 0);
      countEl.textContent = `${totalItens} ${totalItens === 1 ? 'item' : 'itens'}`;
      
      container.innerHTML = carrinho.map((item, index) => `
        <div class="item-row">
          <div class="item-num">${index + 1}</div>
          <div class="item-nome">${item.nome}</div>
          <div class="item-preco">R$ ${item.preco.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
          <div class="item-qtd">
            <button onclick="alterarQuantidade('${item.id}', -1)">−</button>
            <span>${item.quantidade}</span>
            <button onclick="alterarQuantidade('${item.id}', 1)">+</button>
          </div>
          <div class="item-subtotal">R$ ${(item.preco * item.quantidade).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
          <button class="item-remove" onclick="removerDoCarrinho('${item.id}')" title="Remover">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      `).join('');
      
      calcularTotais();
    }

    // Calcular totais
    function calcularTotais() {
      const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
      
      const descontoValor = parseFloat(document.getElementById('descontoValor').value) || 0;
      const descontoTipo = document.getElementById('descontoTipo').value;
      
      let desconto = 0;
      if (descontoTipo === 'percent') {
        desconto = subtotal * (descontoValor / 100);
      } else {
        desconto = descontoValor;
      }
      
      const total = Math.max(0, subtotal - desconto);
      
      document.getElementById('subtotalValor').textContent = `R$ ${subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
      document.getElementById('descontoDisplay').textContent = `R$ ${desconto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
      document.getElementById('totalValor').textContent = `R$ ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
    }

    // Limpar carrinho
    async function limparCarrinho() {
      if (carrinho.length) {
        const confirmar = await Modal.confirm('Limpar todos os itens do orçamento?', 'Limpar Carrinho');
        if (!confirmar) return;
      }
      carrinho = [];
      document.getElementById('clienteNome').value = '';
      document.getElementById('descontoValor').value = '';
      renderCarrinho();
    }

    // Salvar orçamento
    async function salvarOrcamento() {
      if (!carrinho.length) {
        Toast.warning('Adicione itens ao orçamento antes de salvar.');
        return;
      }
      
      const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
      const descontoValor = parseFloat(document.getElementById('descontoValor').value) || 0;
      const descontoTipo = document.getElementById('descontoTipo').value;
      let desconto = descontoTipo === 'percent' ? subtotal * (descontoValor / 100) : descontoValor;
      const total = Math.max(0, subtotal - desconto);
      
      const orcamento = {
        client: document.getElementById('clienteNome').value || 'Cliente não informado',
        total: total,
        obs: JSON.stringify({
          itens: carrinho,
          subtotal: subtotal,
          desconto: desconto,
          descontoTipo: descontoTipo,
          descontoValor: descontoValor
        })
      };
      
      try {
        await axios.post(`${API_BASE}/orcamentos`, orcamento);
        Toast.success('Orçamento salvo com sucesso!');
        carrinho = [];
        document.getElementById('clienteNome').value = '';
        document.getElementById('descontoValor').value = '';
        renderCarrinho();
      } catch (error) {
        console.error('Erro ao salvar orçamento:', error);
        Toast.error('Erro ao salvar orçamento.');
      }
    }

    // Enviar para PDV
    function enviarParaPDV() {
      if (!carrinho.length) {
        Toast.warning('Adicione itens ao orçamento antes de enviar para o PDV.');
        return;
      }
      
      const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
      const descontoValor = parseFloat(document.getElementById('descontoValor').value) || 0;
      const descontoTipo = document.getElementById('descontoTipo').value;
      let desconto = descontoTipo === 'percent' ? subtotal * (descontoValor / 100) : descontoValor;
      
      // Salvar no localStorage para o PDV recuperar
      const pdvData = {
        items: carrinho.map(item => ({
          productId: item.id,
          productName: item.nome,
          productSku: item.codigo,
          quantity: item.quantidade,
          unitPrice: item.preco,
          totalPrice: item.preco * item.quantidade
        })),
        clientName: document.getElementById('clienteNome').value || '',
        discount: desconto,
        discountType: descontoTipo,
        discountValue: descontoValor,
        fromBalcao: true,
        timestamp: new Date().toISOString()
      };
      
      localStorage.setItem('pdvFromBalcao', JSON.stringify(pdvData));
      
      // Redirecionar para o PDV
      window.location.href = 'pdv.html?from=balcao';
    }

    // Carregar orçamentos salvos
    async function loadOrcamentosSalvos() {
      $('#orcamentosModal').modal('show');
      const container = document.getElementById('orcamentosLista');
      
      try {
        const res = await axios.get(`${API_BASE}/orcamentos`);
        const orcamentos = res.data.data || res.data || [];
        
        if (!orcamentos.length) {
          container.innerHTML = `
            <div class="text-center py-4 text-muted">
              <i class="fa fa-folder-open fa-2x"></i>
              <p class="mt-2">Nenhum orçamento salvo</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = orcamentos.map(orc => {
          let itensCount = 0;
          try {
            const obs = JSON.parse(orc.obs || '{}');
            itensCount = obs.itens?.length || 0;
          } catch(e) {}
          
          return `
            <div class="card mb-2">
              <div class="card-body d-flex justify-content-between align-items-center py-3">
                <div>
                  <div class="font-weight-bold">${orc.client || 'Cliente não informado'}</div>
                  <div class="text-muted small">${itensCount} itens • R$ ${(parseFloat(orc.total) || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                </div>
                <div class="btn-group">
                  <button class="btn btn-sm btn-primary" onclick="carregarOrcamento('${orc.id}')" title="Carregar">
                    <i class="fa fa-folder-open"></i>
                  </button>
                  <button class="btn btn-sm btn-success" onclick="enviarOrcamentoParaPDV('${orc.id}')" title="Enviar para PDV">
                    <i class="fa fa-cash-register"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="excluirOrcamento('${orc.id}')" title="Excluir">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Erro ao carregar orçamentos:', error);
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar orçamentos</div>';
      }
    }

    // Carregar orçamento no balcão
    async function carregarOrcamento(id) {
      try {
        const res = await axios.get(`${API_BASE}/orcamentos/${id}`);
        const orc = res.data;
        
        if (!orc) return;
        
        // Limpar carrinho atual
        carrinho = [];
        
        // Tentar parsear os itens do obs
        try {
          const obs = JSON.parse(orc.obs || '{}');
          if (obs.itens && Array.isArray(obs.itens)) {
            carrinho = obs.itens;
          }
          
          if (obs.descontoValor) {
            document.getElementById('descontoValor').value = obs.descontoValor;
            document.getElementById('descontoTipo').value = obs.descontoTipo || 'percent';
          }
        } catch(e) {
          console.warn('Não foi possível parsear itens do orçamento');
        }
        
        document.getElementById('clienteNome').value = orc.client || '';
        
        $('#orcamentosModal').modal('hide');
        renderCarrinho();
      } catch (error) {
        console.error('Erro ao carregar orçamento:', error);
        Toast.error('Erro ao carregar orçamento');
      }
    }

    // Enviar orçamento salvo direto para PDV
    async function enviarOrcamentoParaPDV(id) {
      await carregarOrcamento(id);
      setTimeout(() => enviarParaPDV(), 300);
    }

    // Excluir orçamento
    async function excluirOrcamento(id) {
      const confirmar = await Modal.delete('Excluir este orçamento?', 'Excluir Orçamento');
      if (!confirmar) return;
      
      try {
        await axios.delete(`${API_BASE}/orcamentos/${id}`);
        Toast.success('Orçamento excluído com sucesso!');
        loadOrcamentosSalvos();
      } catch (error) {
        console.error('Erro ao excluir orçamento:', error);
        Toast.error('Erro ao excluir orçamento');
      }
    }

    // Event listeners
    document.getElementById('searchProduto').addEventListener('input', (e) => {
      renderProdutos(e.target.value);
    });

    document.getElementById('descontoValor').addEventListener('input', calcularTotais);
    document.getElementById('descontoTipo').addEventListener('change', calcularTotais);

    // Enter no modal de quantidade
    document.getElementById('quantidadeInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        confirmarQuantidade();
      }
    });

    // Enter na busca adiciona primeiro produto
    document.getElementById('searchProduto').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const primeiroProduto = document.querySelector('.produto-resultado');
        if (primeiroProduto) primeiroProduto.click();
      }
    });

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
      loadProdutos();
    });
  </script>
</body>
</html>
