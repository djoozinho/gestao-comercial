<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PDV - Sistema</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Prefer local Font Awesome to avoid CDN network calls (Tracking Prevention) -->
    <link rel="stylesheet" href="/vendor/fontawesome/all.min.css">
    <!-- If you want to optionally load CDN in very permissive environments, uncomment the next line -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> -->

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <!-- Improved inline SVG favicon: brand gradient + cart icon -->
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%236366f1'/><stop offset='1' stop-color='%23a855f7'/></linearGradient></defs><rect rx='12' width='64' height='64' fill='url(%23g)'/><path d='M18 22h34l-6 18H26z' fill='none' stroke='%23ffffff' stroke-width='3' stroke-linejoin='round' stroke-linecap='round'/><circle cx='28' cy='46' r='3' fill='%23ffffff'/><circle cx='46' cy='46' r='3' fill='%23ffffff'/></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g2' x1='0' x2='1'><stop offset='0' stop-color='%236366f1'/><stop offset='1' stop-color='%23a855f7'/></linearGradient></defs><rect rx='12' width='64' height='64' fill='url(%23g2)'/><path d='M18 22h34l-6 18H26z' fill='none' stroke='%23ffffff' stroke-width='3' stroke-linejoin='round' stroke-linecap='round'/><circle cx='28' cy='46' r='3' fill='%23ffffff'/><circle cx='46' cy='46' r='3' fill='%23ffffff'/></svg>">
    <style>
      /* Estilos específicos do PDV */
      /* Layout base: manter o wrapper com altura total e permitir rolagem na área principal */
      .main-wrapper { height: 100vh; display:flex; flex-direction:column; }
      /* Permitir rolagem vertical na área principal para que a página mostre uma barra de rolagem quando necessário */
      .main-content { flex: 1 1 auto; height: auto; overflow-y: auto; -webkit-overflow-scrolling: touch; }
      /* Pequena margem interna para evitar que o conteúdo encoste na borda ao rolar */
      .main-content { padding-bottom: 12px; }
      
      .main-header { padding: 8px 24px; gap: 16px; }
      .main-header h3 { font-size: 18px; white-space: nowrap; margin: 0; }
      .main-header .header-info { display: flex; align-items: center; gap: 12px; font-size: 12px; font-weight: 500; color: var(--gray-500); }

      /* Campo de código de barras - compacto */
      .barcode-section { flex: 1; max-width: 550px; display: flex; align-items: center; gap: 8px; }
      .barcode-input-wrapper { flex: 1; position: relative; }
      .barcode-input {
        width: 100%; padding: 8px 14px 8px 40px; font-size: 15px; font-weight: 600;
        border: 2px solid var(--brand); border-radius: 10px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15); transition: all 0.2s ease;
      }
      .barcode-input:focus { outline: none; border-color: var(--brand-dark); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
      .barcode-input::placeholder { color: #94a3b8; font-weight: 500; font-size: 14px; }
      .barcode-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--brand); font-size: 16px; }

      /* Info do operador */
      .operator-info { display: flex; align-items: center; gap: 20px; background: var(--gray-100); padding: 8px 16px; border-radius: 10px; border: 1px solid var(--gray-200); }
      .operator-info .info-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--gray-500); }
      .operator-info .info-item i { color: var(--brand); font-size: 14px; }
      .operator-info .info-item strong { color: var(--gray-800); font-weight: 600; }
      .sale-status { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
      .sale-status.open { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
      .sale-status.pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
      .sale-status i { font-size: 10px; }

      /* Container PDV */
      .pdv-container { display: flex; flex-grow: 1; padding: 15px; gap: 15px; overflow: visible; }
      .pdv-col-products { flex: 1 1 0; display: flex; flex-direction: column; min-width: 0; }
      .pdv-col-cart { flex: 0 0 380px; display: flex; flex-direction: column; }

      /* Categorias */
      .category-scroll { display: flex; overflow-x: auto; gap: 8px; padding: 5px 0; white-space: nowrap; scrollbar-width: thin; }
      .category-scroll::-webkit-scrollbar { height: 4px; }
      .category-scroll::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 10px; }
      .category-btn { padding: 12px 24px; border-radius: 25px; background: #fff; border: 2px solid rgba(99, 102, 241, 0.2); cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 15px; color: var(--gray-800); text-transform: uppercase; box-shadow: var(--shadow-sm); }
      .category-btn:hover { background: var(--gray-100); transform: translateY(-3px); box-shadow: var(--shadow-md); }
      .category-btn.active { background: var(--brand); color: #fff; border-color: var(--brand); }

      /* Grid de produtos */
      .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; overflow-y: auto; padding: 8px; flex-grow: 1; }
      .prod-item { border: 2px solid rgba(99, 102, 241, 0.15); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fff; position: relative; overflow: hidden; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; justify-content: space-between; min-height: 180px; }
      .prod-item:hover { transform: translateY(-4px) scale(1.02); box-shadow: var(--shadow-lg); border-color: var(--brand); }
      .prod-item .prod-image { width: 60px; height: 60px; background: var(--gray-100); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px auto; border: 1px solid var(--gray-200); overflow: hidden; }
      .prod-item .prod-image img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
      .prod-item .prod-image i { font-size: 24px; color: var(--brand); }
      .prod-item .prod-code { font-size: 11px; color: var(--gray-500); font-weight: 500; margin-bottom: 6px; text-transform: uppercase; }
      .prod-item .prod-category { font-size: 10px; background: rgba(99, 102, 241, 0.1); color: var(--brand); padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 8px; font-weight: 600; }
      .prod-item .prod-stock { font-size: 11px; color: var(--success); font-weight: 600; margin-top: 4px; }
      .prod-item .prod-stock.low-stock { color: var(--warning); }
      .prod-item .prod-stock.out-of-stock { color: var(--danger); }
      .prod-item .prod-name { font-weight: 700; font-size: 13px; margin-bottom: 8px; line-height: 1.3; color: var(--gray-800); display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
      .prod-item .prod-price { font-weight: 800; background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 18px; }

      /* Carrinho */
      #cartItems { flex-grow: 1; }
      .cart-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--gray-200); }
      .cart-summary { padding: 15px; background: var(--gray-50); border-top: 1px solid var(--gray-200); }
      .cart-actions { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

      /* Ações rápidas */
      .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px; background: var(--gray-50); border-top: 1px solid var(--gray-200); }
      .quick-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 8px; background: #fff; border: 2px solid var(--gray-200); border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center; min-height: 65px; }
      .quick-btn:hover { background: var(--brand-gradient); border-color: var(--brand); transform: translateY(-2px); box-shadow: var(--shadow-md); }
      .quick-btn:hover i, .quick-btn:hover span, .quick-btn:hover kbd { color: #fff !important; }
      .quick-btn i { font-size: 18px; color: var(--brand); margin-bottom: 4px; transition: all 0.3s; }
      .quick-btn span { font-size: 11px; font-weight: 600; color: var(--gray-800); transition: all 0.3s; }
      .quick-btn kbd { font-size: 9px; background: rgba(99, 102, 241, 0.1); color: var(--brand); padding: 2px 6px; border-radius: 4px; margin-top: 3px; font-weight: 700; transition: all 0.3s; }

      /* Vendas pendentes */
      .pending-sales-section { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; padding: 10px 12px; margin-bottom: 10px; }
      .pending-sales-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
      .pending-sales-header h6 { margin: 0; font-size: 13px; font-weight: 700; color: var(--warning); display: flex; align-items: center; gap: 6px; }
      .pending-sales-count { background: var(--warning); color: #fff; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 12px; }
      .pending-sales-list { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; }
      .pending-sale-item { flex: 0 0 auto; background: #fff; border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 8px 12px; cursor: pointer; transition: all 0.3s; min-width: 120px; }
      .pending-sale-item:hover { background: rgba(245, 158, 11, 0.1); border-color: var(--warning); transform: translateY(-2px); }
      .pending-sale-item .sale-client { font-size: 11px; font-weight: 600; color: var(--gray-800); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .pending-sale-item .sale-value { font-size: 13px; font-weight: 700; color: var(--warning); }
      .pending-sale-item .sale-time { font-size: 10px; color: var(--gray-500); }

      /* Footer shortcuts */
      .footer-shortcuts { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: #fff; padding: 16px 32px; display: flex; gap: 32px; flex-shrink: 0; border-top: 1px solid rgba(148, 163, 184, 0.2); }
      .shortcut-item { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; }
      .shortcut-item kbd { background: linear-gradient(135deg, #475569 0%, #64748b 100%); border: 1px solid #94a3b8; padding: 4px 8px; border-radius: 6px; font-family: inherit; font-size: 12px; font-weight: 600; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); min-width: 28px; text-align: center; }

      /* Estilos de botões PDV */
      .btn-primary { background: linear-gradient(135deg, var(--success) 0%, #047857 100%); border: 2px solid rgba(16, 185, 129, 0.3); color: #fff; font-weight: 700; font-size: 15px; padding: 12px 24px; border-radius: 10px; text-transform: uppercase; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); }
      .btn-primary:hover { background: var(--success); border-color: var(--success); }
      .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%); border: 2px solid rgba(239, 68, 68, 0.3); color: #fff; font-weight: 700; font-size: 15px; padding: 12px 24px; border-radius: 10px; text-transform: uppercase; box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4); }
      .btn-danger:hover { background: var(--danger); border-color: var(--danger); }
      .btn-outline-secondary { background: #fff !important; border: 2px solid #6c757d !important; color: #6c757d !important; }
      .btn-outline-secondary:hover { background: var(--brand-light) !important; border-color: var(--brand-light) !important; color: #fff !important; }
      .btn-outline-secondary.active, .btn-outline-secondary:active { background: var(--brand) !important; border-color: var(--brand) !important; color: #fff !important; }

      /* Floating action button (FAB) for Contas a Prazo */
      .fab {
        position: fixed;
        right: 20px;
        bottom: 100px;
        z-index: 1060;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 20px rgba(217, 119, 6, 0.35);
        border: none;
        cursor: pointer;
        font-size: 18px;
      }
      .fab:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(217, 119, 6, 0.45); }
      .fab { transition: bottom 180ms ease, transform 120ms ease; }
      .fab i { font-size: 20px; line-height: 1; }
      .fab svg.fab-icon { width: 20px; height: 20px; display: block; fill: currentColor; }
      .fab:focus { outline: none; box-shadow: 0 0 0 4px rgba(245,158,11,0.15); }
      /* Responsivo e pequenas melhorias para não sobrepor conteúdo */
      @media (max-width: 768px) {
        .fab { width: 48px; height: 48px; font-size: 16px; right: 14px; }
        .fab i { font-size: 18px; }
      }

      /* Accounts modal styles (improved) */
      .accounts-modal .list-group-item { cursor: pointer; padding: 12px 14px; border-radius: 8px; margin-bottom: 8px; }
      .accounts-modal .list-group-item:hover { background: rgba(99,102,241,0.03); }
      .accounts-modal .list-group-item.active { background: rgba(245,158,11,0.08); border-color: rgba(245,158,11,0.18); }
      .accounts-modal .account-client { font-weight:700; color: var(--gray-800); font-size: 14px; line-height:1.1; }
      .accounts-modal .account-desc { color: var(--muted); font-size: 13px; margin-top:4px; }
      .accounts-modal .account-meta { color: var(--muted); font-size:12px; margin-top:6px; }
      .accounts-modal .account-amount { font-weight:700; color: var(--warning); font-size:14px; }
      .accounts-modal .account-details { padding: 14px; background: linear-gradient(180deg, #fff 0%, #fafafa 100%); border-radius: 8px; border: 1px solid var(--gray-100); }

      .accounts-modal .account-badge { display:inline-block; padding:4px 8px; border-radius:12px; font-size:12px; color:#fff; font-weight:600; }
      .accounts-modal .badge-danger { background: var(--danger); }
      .accounts-modal .badge-warning { background: var(--warning); color:#fff; }
      .accounts-modal .badge-info { background: var(--info); }
      .accounts-modal .badge-muted { background: #e6e9ee; color: var(--gray-700); }

      /* Improve contrast and readability for header controls inside the accounts modal */
      .accounts-modal .modal-header .btn,
      .accounts-modal .modal-header .form-control,
      .accounts-modal .modal-header input[type="text"],
      .accounts-modal .modal-header input[type="search"] {
        background: #fff;
        color: var(--gray-800) !important;
        border: 1px solid rgba(0,0,0,0.08);
      }

      .accounts-modal .modal-header .btn {
        border-radius: 8px;
        padding: 6px 10px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .accounts-modal .modal-header .btn i { color: var(--gray-700) !important; }

      .accounts-modal .modal-header .form-control::placeholder { color: #94a3b8 !important; opacity: 1; }
      .accounts-modal .modal-header label small { color: var(--gray-700) !important; }

      .accounts-modal .modal-header .btn:focus,
      .accounts-modal .modal-header .form-control:focus {
        outline: none;
        box-shadow: 0 0 0 4px rgba(99,102,241,0.08);
      }
      .accounts-modal .detail-row { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
      .accounts-modal .detail-actions { display:flex; gap:8px; flex-wrap:wrap; }
      .accounts-modal .small-muted { color: var(--muted); font-size:13px; }

      /* Detail panel specifics */
      .accounts-modal .detail-left { min-width: 0; }
      .accounts-modal .detail-right { text-align:right; min-width:140px; }
      .accounts-modal .account-contact { margin-top:8px; font-size:13px; color:var(--muted); }
      .accounts-modal .amount-row { display:flex; justify-content:space-between; gap:10px; margin-top:8px; }
      .accounts-modal .amount-row .label { color:var(--muted); }

      @media (max-width: 768px) {
        .accounts-modal .detail-right { min-width:120px; }
      }

      @media (max-width: 576px) {
        .accounts-modal .modal-dialog { max-width: 95%; }
        .accounts-modal .list-group-item { padding: 10px; }
      }

      /* Modal de pagamento */
      #payModal .modal-dialog { max-width: 900px; }
      #payModal .modal-body { overflow: visible !important; min-height: 450px; padding-bottom: 100px; }

      .list-group-item { cursor: pointer; }
      .list-group-item.active { background: var(--brand-gradient); border-color: var(--brand); color: #fff; font-weight: 800; box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3); transform: translateX(5px); }

      /* Responsivo */
      @media (max-width: 992px) { .pdv-col-cart { flex: 0 0 320px; } }
      @media (max-width: 768px) {
        .pdv-container { flex-direction: column; }
        .pdv-col-cart { flex: none; }
        .footer-shortcuts { flex-wrap: wrap; gap: 16px; padding: 12px 16px; }
      }
    </style>
    <!-- Auth Guard - Proteção de acesso -->
  <script src="js/auth-guard.js"></script>
  <script src="js/branding.js"></script>
  <script src="js/sidebar.js"></script>
  <script src="js/toast.js"></script>
</head>
  <body>
    <div class="main-wrapper">
      <div class="sidebar">
        <h4>SISTEMA</h4>
        <ul class="sidebar-menu">
          <li><a href="index.html"><span class="menu-icon"><i class="fa fa-home"></i></span><span class="menu-label">Início</span></a></li>
          <li><a href="pdv.html" class="active"><span class="menu-icon"><i class="fa fa-cash-register"></i></span><span class="menu-label">PDV</span></a></li>
          <li><a href="dashboard.html"><span class="menu-icon"><i class="fa fa-chart-pie"></i></span><span class="menu-label">Painel</span></a></li>
          <li><a href="nfe-emissao.html"><span class="menu-icon"><i class="fa fa-file-invoice"></i></span><span class="menu-label">Notas Fiscais</span></a></li>
          <li><a href="movimentos.html"><span class="menu-icon"><i class="fa fa-exchange-alt"></i></span><span class="menu-label">Movimentos</span></a></li>
          <li><a href="relatorios.html"><span class="menu-icon"><i class="fa fa-chart-bar"></i></span><span class="menu-label">Relatórios</span></a></li>
          <li><a href="pessoas.html"><span class="menu-icon"><i class="fa fa-users"></i></span><span class="menu-label">Clientes</span></a></li>
          <li><a href="produtos.html"><span class="menu-icon"><i class="fa fa-boxes"></i></span><span class="menu-label">Produtos</span></a></li>
          <li><a href="agenda.html"><span class="menu-icon"><i class="fa fa-calendar"></i></span><span class="menu-label">Agenda</span></a></li>
          <li><a href="admin.html"><span class="menu-icon"><i class="fa fa-cogs"></i></span><span class="menu-label">Admin</span></a></li>
        </ul>
      </div>

      <div class="main-content">
        <header class="main-header">
          <h3><i class="fa fa-cash-register text-success mr-2"></i>PDV</h3>
          
          <!-- Campo de código de barras destacado -->
          <div class="barcode-section">
            <div class="barcode-input-wrapper">
              <i class="fa fa-barcode barcode-icon"></i>
              <input type="text" id="barcodeInput" class="barcode-input" placeholder="Leia o código de barras ou digite... (F7)" autocomplete="off" autofocus />
            </div>
          </div>

          <!-- Info do operador e status -->
          <div class="operator-info">
            <div class="info-item">
              <i class="fa fa-desktop"></i>
              <span>PDV:</span>
              <strong id="pdvNumber">001</strong>
            </div>
            <div class="info-item">
              <i class="fa fa-user-circle"></i>
              <span>Operador:</span>
              <strong id="operatorName">Sistema</strong>
            </div>
            <div class="sale-status open" id="saleStatus">
              <i class="fa fa-circle"></i>
              <span>Venda Aberta</span>
            </div>
          </div>

          <div class="header-info">
            <span><i class="fa fa-clock mr-2"></i><span id="currentTime">--:--:--</span></span>
            <span><i class="fa fa-calendar mr-2"></i><span id="currentDate">--/--/----</span></span>
          </div>
        </header>

        <div class="pdv-container">

          <!-- Coluna de Produtos e Busca/Categorias -->
          <div class="pdv-col-products">
            <!-- Barra Superior: Busca e Categorias -->
            <div class="card mb-3" style="height: auto; flex-grow: 0;">
              <div class="card-body p-2">
                <div class="row no-gutters align-items-center">
                  <div class="col-md-3 pr-2 border-right">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text bg-white border-0"><i class="fa fa-search text-muted"></i></span>
                      </div>
                      <input id="searchProd" class="form-control border-0" placeholder="Buscar (F3)..." autocomplete="off" />
                    </div>
                  </div>
                  <div class="col-md-9 pl-3">
                    <div id="category-list" class="category-scroll">
                      <!-- Categorias horizontais via JS -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Produtos</span>
                <small><span id="prodCount">0</span> encontrados</small>
              </div>
              <div class="product-grid" id="productList">
                <!-- Produtos -->
              </div>
            </div>
          </div>

          <!-- Coluna do Carrinho -->
          <div class="pdv-col-cart">
            <!-- Seção de Vendas em Espera -->
            <div class="pending-sales-section" id="pendingSalesSection" style="display: none;">
              <div class="pending-sales-header">
                <h6><i class="fa fa-pause-circle"></i> Vendas em Espera</h6>
                <span class="pending-sales-count" id="pendingSalesCount">0</span>
              </div>
              <div class="pending-sales-list" id="pendingSalesList">
                <!-- Vendas em espera serão renderizadas aqui -->
              </div>
            </div>

            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <i class="fa fa-shopping-cart"></i> Itens da Venda
                </div>
                <div style="font-size: 14px; font-weight: 600;">
                  <span id="itemCount">0</span> item(ns)
                </div>
              </div>
              
              <!-- Grid de itens da venda -->
              <div class="card-body p-0" id="cartItems" style="max-height: 250px; overflow-y: auto;">
                <table class="table table-sm mb-0" id="cartTable" style="display: none;">
                  <thead style="background: #f8fafc; position: sticky; top: 0; z-index: 1;">
                    <tr>
                      <th style="width: 40px; padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted);">#</th>
                      <th style="padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted);">PRODUTO</th>
                      <th style="width: 60px; padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted); text-align: center;">QTD</th>
                      <th style="width: 90px; padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted); text-align: right;">UNIT.</th>
                      <th style="width: 90px; padding: 8px; font-size: 11px; font-weight: 700; color: var(--muted); text-align: right;">TOTAL</th>
                      <th style="width: 40px; padding: 8px;"></th>
                    </tr>
                  </thead>
                  <tbody id="cartTableBody">
                    <!-- Itens do carrinho serão renderizados aqui -->
                  </tbody>
                </table>
                <div class="text-muted text-center py-5" id="emptyCartMessage">
                  <i class="fa fa-shopping-cart fa-3x mb-3" style="color: #e2e8f0;"></i>
                  <p class="mb-0">Carrinho vazio</p>
                  <small>Leia um código de barras ou selecione um produto</small>
                </div>
              </div>

              <!-- Painel de totais aprimorado -->
              <div class="cart-summary" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                <div class="d-flex justify-content-between mb-2">
                  <span style="font-size: 13px; color: var(--muted);">Subtotal (<span id="totalQty">0</span> itens):</span>
                  <strong id="subtotalVal" style="font-size: 14px;">R$ 0,00</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span style="font-size: 13px; color: var(--muted);">Desconto (F5):</span>
                  <strong id="discountVal" style="font-size: 14px; color: var(--warning);">R$ 0,00</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span style="font-size: 13px; color: var(--muted);">Acréscimo:</span>
                  <strong id="additionVal" style="font-size: 14px; color: var(--info);">R$ 0,00</strong>
                </div>
                <hr style="margin: 10px 0;">
                <div class="d-flex justify-content-between align-items-center">
                  <strong style="font-size: 16px; color: var(--text-color);">TOTAL A PAGAR:</strong>
                  <strong id="totalVal" style="font-size: 28px; color: var(--brand); letter-spacing: -1px;">R$ 0,00</strong>
                </div>
              </div>

              <!-- Botões de ação principais -->
              <div class="cart-actions">
                <button id="btnHold" class="btn btn-warning" style="background: linear-gradient(135deg, #d97706 0%, #b45309 100%); border: none; font-size: 13px;">
                  <i class="fa fa-pause-circle mr-1"></i>Espera (F8)
                </button>
                <button id="btnCancel" class="btn btn-danger" style="font-size: 13px;">
                  <i class="fa fa-times-circle mr-1"></i>Cancelar (F9)
                </button>
              </div>
              <div style="padding: 0 15px 15px 15px;">
                <button id="btnCheckout" class="btn btn-primary btn-block btn-lg" style="font-size: 16px; padding: 15px;">
                  <i class="fa fa-check-circle mr-2"></i>FINALIZAR VENDA (F4)
                </button>
              </div>

              <!-- Botões de funções rápidas -->
              <div class="quick-actions">
                <div class="quick-btn" id="btnHelp" title="Ajuda">
                  <i class="fa fa-question-circle"></i>
                  <span>Ajuda</span>
                  <kbd>F1</kbd>
                </div>
                <div class="quick-btn" id="btnClient" title="Selecionar Cliente">
                  <i class="fa fa-user-plus"></i>
                  <span>Cliente</span>
                  <kbd>F2</kbd>
                </div>
                <div class="quick-btn" id="btnSearch" title="Buscar Produto">
                  <i class="fa fa-search"></i>
                  <span>Buscar</span>
                  <kbd>F3</kbd>
                </div>
                <div class="quick-btn" id="btnDiscount" title="Aplicar Desconto">
                  <i class="fa fa-percent"></i>
                  <span>Desconto</span>
                  <kbd>F5</kbd>
                </div>
                <div class="quick-btn" id="btnPixDirect" title="Pagar com PIX" style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: #fff;">
                  <i class="fa fa-qrcode"></i>
                  <span>PIX</span>
                  <kbd>F10</kbd>
                </div>
              </div>
            </div>
          </div>
        </div>

        <footer class="footer-shortcuts">
            <div class="shortcut-item"><span><kbd>F1</kbd> Ajuda</span></div>
            <div class="shortcut-item"><span><kbd>F2</kbd> Cliente</span></div>
            <div class="shortcut-item"><span><kbd>F3</kbd> Buscar</span></div>
            <div class="shortcut-item"><span><kbd>F4</kbd> Finalizar</span></div>
            <div class="shortcut-item"><span><kbd>F5</kbd> Desconto</span></div>
            <div class="shortcut-item"><span><kbd>F7</kbd> Código</span></div>
            <div class="shortcut-item"><span><kbd>F8</kbd> Espera</span></div>
            <div class="shortcut-item"><span><kbd>F9</kbd> Cancelar</span></div>
            <div class="shortcut-item"><span><kbd>F10</kbd> PIX</span></div>
            <div class="shortcut-item"><span><kbd>F11</kbd> Dinheiro</span></div>
            <div class="shortcut-item"><span><kbd>ESC</kbd> Sair</span></div>
        </footer>
      </div>
    </div>

    <!-- Floating button: Contas a Prazo -->
    <button id="btnAccountsPrazo" class="fab" title="Contas a Prazo" aria-label="Contas a Prazo">
      <!-- Inline SVG (receipt) to avoid relying on icon fonts -->
      <svg class="fab-icon" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
        <title>Contas a Prazo</title>
        <path d="M21 2H7a1 1 0 0 0-1 1v17.586l2.293-2.293a1 1 0 0 1 .707-.293H14a1 1 0 0 1 1 1v1h5a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1zM9 6h8v2H9V6zm0 4h8v2H9v-2zm0 4h5v2H9v-2z" />
      </svg>
    </button>

    <!-- Modal: Contas a Prazo (Redesenhado - Enterprise) -->
    <div class="modal fade" id="accountsPrazoModal" tabindex="-1" role="dialog" data-backdrop="true">
      <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 1100px;">
        <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.25);">
          
          <!-- Header Premium -->
          <div class="modal-header" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 0; border: none;">
            <div style="width: 100%; padding: 20px 28px;">
              <!-- Top row: Title + Close -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(245,158,11,0.4);">
                    <i class="fa fa-file-invoice-dollar" style="font-size: 22px; color: #fff;"></i>
                  </div>
                  <div>
                    <h4 style="margin: 0; color: #fff; font-weight: 700; font-size: 20px;">Contas a Prazo</h4>
                    <p style="margin: 0; color: #94a3b8; font-size: 13px;">Gerencie vendas fiado e recebimentos</p>
                  </div>
                </div>
                <button class="close" data-dismiss="modal" style="color: #fff; opacity: 0.7; font-size: 28px; text-shadow: none; padding: 0; margin: 0; line-height: 1;">
                  <span>&times;</span>
                </button>
              </div>
              
              <!-- Stats Cards -->
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 14px 16px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total em Aberto</div>
                  <div id="statsTotalAberto" style="color: #f59e0b; font-size: 20px; font-weight: 800;">R$ 0,00</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 14px 16px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Contas Ativas</div>
                  <div id="statsContasAtivas" style="color: #fff; font-size: 20px; font-weight: 800;">0</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 14px 16px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Vencidas</div>
                  <div id="statsVencidas" style="color: #ef4444; font-size: 20px; font-weight: 800;">0</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 14px 16px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Recebido (Mês)</div>
                  <div id="statsRecebidoMes" style="color: #10b981; font-size: 20px; font-weight: 800;">R$ 0,00</div>
                </div>
              </div>
              
              <!-- Search & Actions Bar -->
              <div style="display: flex; gap: 12px; align-items: center;">
                <div style="flex: 1; position: relative;">
                  <i class="fa fa-search" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #64748b; font-size: 14px;"></i>
                  <input id="accountsPrazoSearch" class="form-control" placeholder="Buscar por cliente, código da venda ou descrição..." 
                    style="padding-left: 42px; height: 44px; border-radius: 10px; border: 2px solid #475569; background: #1e293b; color: #fff; font-size: 14px;">
                </div>
                <select id="accountsFilterStatus" class="form-control" style="width: 160px; height: 44px; border-radius: 10px; border: 2px solid #475569; background: #1e293b; color: #fff; font-size: 13px;">
                  <option value="">Todas</option>
                  <option value="pendente">Pendentes</option>
                  <option value="vencida">Vencidas</option>
                  <option value="parcial">Parciais</option>
                </select>
                <button id="btnRefreshAccounts" class="btn" style="height: 44px; width: 44px; border-radius: 10px; background: #475569; border: none; color: #fff; display: flex; align-items: center; justify-content: center;">
                  <i class="fa fa-sync"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Body -->
          <div class="modal-body" style="padding: 0; background: #f8fafc; height: 500px; overflow: hidden;">
            <div style="display: grid; grid-template-columns: 1fr 380px; height: 100%;">
              
              <!-- Lista de Contas -->
              <div style="border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; height: 100%;">
                <!-- Toolbar -->
                <div style="padding: 12px 16px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: #475569;">
                    <input type="checkbox" id="accountsSelectAll" style="width: 18px; height: 18px; cursor: pointer;"> 
                    <span>Selecionar tudo</span>
                  </label>
                  <button id="btnBulkReceive" class="btn btn-sm" disabled
                    style="margin-left: auto; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: #fff; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                    <i class="fa fa-hand-holding-usd"></i> Receber Selecionadas
                  </button>
                </div>
                
                <!-- Lista -->
                <div id="accountsPrazoList" style="flex: 1; overflow-y: auto; padding: 12px; min-height: 0;">
                  <div style="text-align: center; padding: 60px 20px; color: #94a3b8;">
                    <i class="fa fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top: 12px;">Carregando contas...</p>
                  </div>
                </div>
              </div>
              
              <!-- Painel de Detalhes -->
              <div id="accountDetail" style="background: #fff; display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; color: #94a3b8;">
                  <div style="width: 80px; height: 80px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                    <i class="fa fa-hand-pointer" style="font-size: 32px; color: #cbd5e1;"></i>
                  </div>
                  <h5 style="color: #64748b; margin-bottom: 8px;">Nenhuma conta selecionada</h5>
                  <p style="font-size: 13px; margin: 0;">Clique em uma conta ao lado para ver detalhes e realizar ações</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="modal-footer" style="background: #fff; border-top: 1px solid #e2e8f0; padding: 16px 24px; display: flex; justify-content: space-between;">
            <div style="font-size: 12px; color: #64748b;">
              <span id="accountsCountInfo">0 contas encontradas</span>
            </div>
            <button class="btn" data-dismiss="modal" style="background: #e2e8f0; border: none; color: #475569; padding: 10px 24px; border-radius: 10px; font-weight: 600;">
              <i class="fa fa-times mr-2"></i>Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal pagamento -->

    <!-- Modal: Recebimento em Lote -->
    <div class="modal fade" id="bulkReceiveModal" tabindex="-1" role="dialog" data-backdrop="true">
      <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Receber contas selecionadas <small id="bulkReceiveCount" style="margin-left:8px;"></small></h5>
            <button class="close" data-dismiss="modal" aria-label="Fechar"><span>&times;</span></button>
          </div>
          <div class="modal-body" id="bulkReceiveModalBody" style="max-height:420px; overflow-y:auto;">
            <!-- Rows inserted dynamically -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnConfirmBulkReceive">Confirmar recebimentos</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Recebimento de Pagamento (Bonito) -->
    <div class="modal fade" id="paymentInputModal" tabindex="-1" role="dialog" data-backdrop="static" style="z-index: 1060;">
      <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 420px;">
        <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.3);">
          
          <!-- Header com gradiente -->
          <div id="paymentInputHeader" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); padding: 24px; text-align: center;">
            <div style="width: 64px; height: 64px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
              <i id="paymentInputIcon" class="fa fa-hand-holding-dollar" style="font-size: 28px; color: #fff;"></i>
            </div>
            <h4 id="paymentInputTitle" style="margin: 0; color: #fff; font-weight: 700; font-size: 20px;">Receber Pagamento</h4>
            <p id="paymentInputSubtitle" style="margin: 8px 0 0; color: rgba(255,255,255,0.85); font-size: 14px;">Cliente: João Silva</p>
          </div>
          
          <!-- Body -->
          <div class="modal-body" style="padding: 24px; background: #fff;">
            <!-- Valor Devido Info -->
            <div id="paymentDueInfo" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
              <div style="color: #64748b; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Valor Devido</div>
              <div id="paymentDueValue" style="color: #1e293b; font-size: 28px; font-weight: 800; margin-top: 4px;">R$ 150,00</div>
            </div>
            
            <!-- Campo Valor -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; color: #475569; font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                <i class="fa fa-dollar-sign" style="margin-right: 6px; color: #10b981;"></i>Valor a Receber
              </label>
              <div style="position: relative;">
                <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #64748b; font-size: 18px; font-weight: 600;">R$</span>
                <input type="text" id="paymentInputAmount" 
                  style="width: 100%; padding: 16px 16px 16px 50px; font-size: 24px; font-weight: 700; border: 2px solid #e2e8f0; border-radius: 12px; text-align: right; color: #1e293b; transition: all 0.2s;"
                  placeholder="0,00"
                  onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 4px rgba(16,185,129,0.15)'"
                  onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
              </div>
            </div>
            
            <!-- Preview do Saldo Restante -->
            <div id="paymentBalancePreview" style="display: none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 14px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="color: #92400e; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                    <i class="fa fa-info-circle" style="margin-right: 4px;"></i>Saldo Restante
                  </div>
                  <div style="color: #78350f; font-size: 12px; margin-top: 4px;">Ficará como haver para o cliente</div>
                </div>
                <div id="paymentRemainingValue" style="color: #b45309; font-size: 22px; font-weight: 800;">R$ 0,00</div>
              </div>
            </div>
            
            <!-- Preview Pagamento Total -->
            <div id="paymentFullPreview" style="display: none; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 2px solid #10b981; border-radius: 12px; padding: 14px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="color: #065f46; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                    <i class="fa fa-check-circle" style="margin-right: 4px;"></i>Pagamento Total
                  </div>
                  <div style="color: #047857; font-size: 12px; margin-top: 4px;">A conta será quitada completamente</div>
                </div>
                <div style="color: #059669; font-size: 22px; font-weight: 800;"><i class="fa fa-check"></i></div>
              </div>
            </div>
            
            <!-- Método de Pagamento -->
            <div id="paymentMethodSection" style="margin-bottom: 20px;">
              <label style="display: block; color: #475569; font-size: 13px; font-weight: 600; margin-bottom: 10px;">
                <i class="fa fa-credit-card" style="margin-right: 6px; color: #6366f1;"></i>Método de Pagamento
              </label>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                <button type="button" class="payment-method-btn" data-method="dinheiro" style="padding: 12px 8px; border: 2px solid #e2e8f0; border-radius: 10px; background: #fff; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                  <i class="fa fa-money-bill-wave" style="font-size: 18px; color: #10b981;"></i>
                  <span style="font-size: 11px; font-weight: 600; color: #475569;">Dinheiro</span>
                </button>
                <button type="button" class="payment-method-btn" data-method="pix" style="padding: 12px 8px; border: 2px solid #e2e8f0; border-radius: 10px; background: #fff; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                  <i class="fa fa-qrcode" style="font-size: 18px; color: #00b4a0;"></i>
                  <span style="font-size: 11px; font-weight: 600; color: #475569;">PIX</span>
                </button>
                <button type="button" class="payment-method-btn" data-method="credito" style="padding: 12px 8px; border: 2px solid #e2e8f0; border-radius: 10px; background: #fff; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                  <i class="fa fa-credit-card" style="font-size: 18px; color: #6366f1;"></i>
                  <span style="font-size: 11px; font-weight: 600; color: #475569;">Crédito</span>
                </button>
                <button type="button" class="payment-method-btn" data-method="debito" style="padding: 12px 8px; border: 2px solid #e2e8f0; border-radius: 10px; background: #fff; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                  <i class="fa fa-credit-card" style="font-size: 18px; color: #f59e0b;"></i>
                  <span style="font-size: 11px; font-weight: 600; color: #475569;">Débito</span>
                </button>
              </div>
              <input type="hidden" id="paymentInputMethod" value="dinheiro">
            </div>
            
            <!-- Observações (opcional) -->
            <div id="paymentNotesSection" style="display: none;">
              <label style="display: block; color: #475569; font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                <i class="fa fa-sticky-note" style="margin-right: 6px; color: #94a3b8;"></i>Observações (opcional)
              </label>
              <textarea id="paymentInputNote" rows="2" 
                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px; resize: none; transition: all 0.2s;"
                placeholder="Adicione uma observação..."
                onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.15)'"
                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'"></textarea>
            </div>
          </div>
          
          <!-- Footer -->
          <div class="modal-footer" style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; gap: 12px;">
            <button type="button" id="paymentInputCancel" class="btn" data-dismiss="modal" 
              style="flex: 1; padding: 14px; border-radius: 12px; background: #fff; border: 2px solid #e2e8f0; color: #64748b; font-weight: 600; font-size: 14px; transition: all 0.2s;"
              onmouseover="this.style.background='#f1f5f9'"
              onmouseout="this.style.background='#fff'">
              <i class="fa fa-times" style="margin-right: 8px;"></i>Cancelar
            </button>
            <button type="button" id="paymentInputConfirm" class="btn" 
              style="flex: 1; padding: 14px; border-radius: 12px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: none; color: #fff; font-weight: 600; font-size: 14px; box-shadow: 0 4px 15px rgba(16,185,129,0.3); transition: all 0.2s;"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16,185,129,0.4)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(16,185,129,0.3)'">
              <i class="fa fa-check" style="margin-right: 8px;"></i>Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <style>
      .payment-method-btn.active {
        border-color: #10b981 !important;
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
        box-shadow: 0 2px 8px rgba(16,185,129,0.2);
      }
      .payment-method-btn:hover:not(.active) {
        border-color: #cbd5e1;
        background: #f8fafc;
      }
      #paymentInputAmount::-webkit-outer-spin-button,
      #paymentInputAmount::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      #paymentInputAmount[type=number] {
        -moz-appearance: textfield;
      }
    </style>
    <div class="modal fade" id="payModal" tabindex="-1" role="dialog" data-backdrop="static">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content" style="min-height: 600px;">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fa fa-cash-register mr-2"></i>Finalizar Venda - Pagamento Inteligente</h5>
            <button class="close" data-dismiss="modal" style="opacity:1"><span>&times;</span></button>
          </div>
          <div class="modal-body" style="overflow: visible; min-height: 400px; padding-bottom: 80px;">
            <div class="row">
              <div class="col-md-7">
                <div class="form-group">
                  <label><i class="fa fa-user mr-2"></i>Cliente (F2)</label>
                  <input id="payClient" list="clientsList" class="form-control" placeholder="Buscar ou cadastrar cliente..." autocomplete="off" />
                  <datalist id="clientsList"></datalist>
                </div>
                
                <!-- Sistema de Pagamento Misto Inteligente -->
                <div class="payment-methods-section" style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <label class="mb-0" style="font-weight: 600; color: #1e293b;">
                      <i class="fa fa-money-bill-wave mr-2" style="color: var(--brand);"></i>Formas de Pagamento
                    </label>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPaymentMethod()" title="Adicionar outra forma de pagamento">
                      <i class="fa fa-plus mr-1"></i>Adicionar
                    </button>
                  </div>
                  
                  <div id="paymentMethodsList">
                    <!-- Pagamentos serão adicionados aqui dinamicamente -->
                  </div>
                  
                  <!-- Resumo de pagamentos -->
                  <div id="paymentsSummary" style="background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); border-radius: 8px; padding: 12px; margin-top: 12px; display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                      <span style="font-size: 13px; color: #0369a1;">Total já informado:</span>
                      <strong id="totalPaidSoFar" style="font-size: 16px; color: #0369a1;">R$ 0,00</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                      <span style="font-size: 13px; color: #dc2626;" id="remainingLabel">Falta pagar:</span>
                      <strong id="remainingToPay" style="font-size: 16px; color: #dc2626;">R$ 0,00</strong>
                    </div>
                  </div>
                </div>
                
                <!-- Informações de Parcelamento (aparece quando "A Prazo" está selecionado) -->
                <div class="form-group" id="installmentsGroup" style="display: none; margin-bottom: 2rem;">
                  <label><i class="fa fa-credit-card mr-2"></i>Número de parcelas do valor restante</label>
                  <select id="installments" class="form-control" style="height: 50px; font-size: 16px;">
                    <option value="1">1x sem juros</option>
                    <option value="2">2x sem juros</option>
                    <option value="3">3x sem juros</option>
                    <option value="4">4x sem juros</option>
                    <option value="5">5x sem juros</option>
                    <option value="6">6x sem juros</option>
                    <option value="7">7x sem juros</option>
                    <option value="8">8x sem juros</option>
                    <option value="9">9x sem juros</option>
                    <option value="10">10x sem juros</option>
                    <option value="12">12x sem juros</option>
                  </select>
                  <small class="text-muted mt-3 d-block" id="installmentInfo">Selecione o número de parcelas</small>
                </div>
              </div>
              
              <div class="col-md-5">
                <div class="bg-light p-3 rounded h-100">
                  <h6 class="mb-3"><i class="fa fa-receipt mr-2"></i>Resumo da Venda</h6>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <strong id="modalSubtotal">R$ 0,00</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Desconto:</span>
                    <strong id="modalDiscount" style="color: var(--success);">R$ 0,00</strong>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <strong style="font-size: 1.1rem;">TOTAL DA VENDA:</strong>
                    <strong id="modalTotal" style="font-size: 1.8rem; color: var(--brand);">R$ 0,00</strong>
                  </div>
                  
                  <!-- Seção de parcelamento (aparece só em vendas a prazo) -->
                  <div id="installmentSummary" style="display: none; background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%); border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid #86efac;">
                    <h6 style="font-size: 13px; color: #166534; margin-bottom: 10px;"><i class="fa fa-calculator mr-1"></i>Detalhamento do Pagamento</h6>
                    <div class="d-flex justify-content-between mb-1">
                      <small class="text-muted">Entrada (pago agora):</small>
                      <strong id="entryAmount" style="color: var(--success);">R$ 0,00</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                      <small class="text-muted">Restante a parcelar:</small>
                      <strong id="remainingAmount" style="color: var(--brand);">R$ 0,00</strong>
                    </div>
                    <hr style="margin: 8px 0;">
                    <div class="d-flex justify-content-between align-items-center">
                      <strong style="font-size: 0.9rem;">Parcelas:</strong>
                      <strong id="installmentDisplay" style="font-size: 1.1rem; color: var(--brand);">2x R$ 0,00</strong>
                    </div>
                  </div>
                  
                  <hr>
                  <div class="d-flex justify-content-between align-items-center">
                    <small>Troco:</small>
                    <div id="changeVal" style="font-size: 1.5rem; font-weight: 700; color: var(--success);">R$ 0,00</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-dismiss="modal"><i class="fa fa-arrow-left mr-2"></i>Voltar</button>
            <button id="confirmPay" class="btn btn-primary btn-lg"><i class="fa fa-check-circle mr-2"></i>Confirmar Venda</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Cupom Fiscal (Elgin i8) -->
    <div class="modal fade" id="elginCouponModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cupom Fiscal - Elgin i8</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="small-muted">Versão / Modelo:</label>
              <div>Elgin i8 (pré-regulado)</div>
            </div>
            <div style="display:flex;gap:12px;">
              <div style="flex:1;min-width:0">
                <div class="form-group">
                  <label class="small-muted">Pré-visualização do cupom (48 colunas)</label>
                  <pre id="elginCouponPreview" style="background:#f8f9fa;border:1px solid var(--gray-200);padding:12px;white-space:pre-wrap;font-family:monospace;font-size:13px;max-height:420px;overflow:auto;"></pre>
                </div>
              </div>
              <div style="width:260px;">
                <div class="form-group">
                  <label class="small-muted">Dispositivo</label>
                  <select id="elginDeviceSelect" class="form-control"><option value="elgin-i8" selected>Elgin i8</option></select>
                </div>
                <div class="form-group">
                  <label class="small-muted">Opções</label>
                  <div class="form-check"><input id="elginUseEscpos" class="form-check-input" type="checkbox"><label class="form-check-label">Usar ESC/POS (Elgin i8)</label></div>
                  <div class="form-check"><input id="elginAutoSend" class="form-check-input" type="checkbox"><label class="form-check-label">Imprimir automaticamente</label></div>
                  <small class="text-muted d-block mt-2">As preferências são salvas localmente no navegador.</small>
                </div>
                <div style="display:flex;gap:8px;margin-top:12px;">
                  <button id="btnSendElgin" class="btn btn-primary btn-block">Enviar para Elgin i8</button>
                  <button id="btnPrintPreview" class="btn btn-outline-secondary btn-block">Visualizar Impressão</button>
                </div>
                <div class="mt-3 small-muted">Após enviar, verifique o painel da impressora ou o log de impressão do servidor.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: PIX QR Code - Mercado Pago -->
    <div class="modal fade" id="pixModal" tabindex="-1" role="dialog" data-backdrop="static">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
          <div class="modal-header" style="background: linear-gradient(135deg, #00b4d8, #0096c7); color: #fff; border: none;">
            <h5 class="modal-title"><i class="fa fa-qrcode mr-2"></i>Pagamento PIX</h5>
            <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
          </div>
          <div class="modal-body text-center" style="padding: 24px;">
            <div id="pixLoading" style="display: none;">
              <div class="spinner-border text-primary" style="width: 48px; height: 48px;"></div>
              <p class="mt-3">Gerando QR Code PIX...</p>
            </div>
            <div id="pixError" style="display: none;" class="alert alert-danger">
              <i class="fa fa-exclamation-triangle mr-2"></i>
              <span id="pixErrorMsg">Erro ao gerar PIX</span>
            </div>
            <div id="pixContent" style="display: none;">
              <div style="background: #f0f9ff; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                <div style="font-size: 14px; color: #64748b;">Valor a pagar</div>
                <div id="pixValor" style="font-size: 32px; font-weight: 800; color: #0ea5e9;">R$ 0,00</div>
              </div>
              <div id="pixQrContainer" style="background: #fff; padding: 16px; border-radius: 12px; border: 2px solid #e2e8f0; display: inline-block;">
                <img id="pixQrImage" src="" alt="QR Code PIX" style="width: 200px; height: 200px;" />
              </div>
              <div style="margin-top: 16px;">
                <small class="text-muted">Escaneie o QR Code com o app do seu banco</small>
              </div>
              <div style="margin-top: 12px;">
                <button class="btn btn-outline-primary btn-sm" onclick="copyPixCode()">
                  <i class="fa fa-copy mr-1"></i>Copiar código PIX
                </button>
              </div>
              <input type="hidden" id="pixCodeCopy" value="" />
              <input type="hidden" id="pixPaymentId" value="" />
              <div id="pixStatusArea" style="margin-top: 20px; padding: 12px; background: #fef3c7; border-radius: 8px;">
                <i class="fa fa-clock mr-2" style="color: #f59e0b;"></i>
                <span id="pixStatusText">Aguardando pagamento...</span>
              </div>
            </div>
          </div>
          <div class="modal-footer" style="border-top: 1px solid #e2e8f0;">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="cancelPixCheck()">Cancelar</button>
            <button type="button" class="btn btn-success" id="btnConfirmPixManual" onclick="confirmPixManual()" style="display: none;">
              <i class="fa fa-check mr-1"></i>Confirmar Recebimento
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Prefer local axios to avoid CDN requests and Tracking Prevention messages -->
    <script src="/vendor/axios/axios.min.js"></script>
    <!-- Módulo centralizado de data/hora (Brasília) -->
    <script src="/js/datetime-utils.js"></script>
    <script>
      if (window.axios) axios.defaults.baseURL = 'http://localhost:3000';
    </script>

    <!-- Robust loader: jQuery (full) + Bootstrap bundle (contains Popper) with local fallbacks -->
    <script>
      function loadScriptWithFallback(src, fallback, cb) {
        const s = document.createElement('script'); s.src = src; s.async = false;
        s.onload = () => cb && cb(null);
        s.onerror = () => {
          if (fallback) {
            const f = document.createElement('script'); f.src = fallback; f.async = false; f.onload = () => cb && cb(null); f.onerror = () => cb && cb(new Error('both failed'));
            document.head.appendChild(f);
          } else cb && cb(new Error('failed'));
        };
        document.head.appendChild(s);
      }

      // Load jQuery (full, not slim) then Bootstrap bundle (includes Popper). Use local fallbacks when CDN blocked.
      // Prefer local assets first to avoid CDN requests (reduces Tracking Prevention logs)
      loadScriptWithFallback('/vendor/jquery/jquery.min.js', 'https://code.jquery.com/jquery-3.5.1.min.js', (err) => {
        if (err) console.warn('jQuery local failed, CDN attempted as fallback:', err);
        loadScriptWithFallback('/vendor/bootstrap/bootstrap.bundle.min.js', 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js', (err2) => {
          if (err2) console.warn('Bootstrap local failed, CDN attempted as fallback:', err2);

          // Provide a small jQuery-style .modal(action) wrapper if jQuery is present and Bootstrap's Modal API exists
          try {
            if (window.jQuery && (typeof window.jQuery.fn.modal === 'undefined') && window.bootstrap && window.bootstrap.Modal) {
              window.jQuery.fn.modal = function(action) {
                if (!action) return this;
                return this.each(function() {
                  try {
                    const el = this;
                    const inst = window.bootstrap.Modal.getInstance(el) || new window.bootstrap.Modal(el);
                    if (action === 'show') inst.show();
                    if (action === 'hide') inst.hide();
                  } catch(e) { console.warn('modal wrapper error', e); }
                });
              };
            }
          } catch (e) { console.warn('Error installing modal wrapper:', e); }
        });
      });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const state = {
          products: [],
          cart: [],
          categories: [],
          allProducts: [],
          activeCategory: 'Todos',
          discount: 0,
          addition: 0,
          pendingSales: [],
          currentClient: null,
          saleNumber: 1,
        };

        const currency = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatMoney = (v) => currency.format(Number(v || 0));

        // Date helpers usando módulo centralizado (Brasília)
        function formatDateBR(dateInput) {
          if (!dateInput) return '';
          return DateTimeUtils.formatDate(dateInput);
        }

        function parseDateBR(ddmmyyyy) {
          if (!ddmmyyyy) return null;
          const m = String(ddmmyyyy).match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
          if (m) return `${m[3]}-${m[2]}-${m[1]}`; // YYYY-MM-DD
          // Accept YYYY-MM-DD already
          const m2 = String(ddmmyyyy).match(/^(\d{4})-(\d{2})-(\d{2})$/);
          if (m2) return ddmmyyyy;
          return null;
        }

        // Simple sound helper using Web Audio API
        let _audioCtx = null;
        function getAudioCtx() {
          try { if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return _audioCtx; } catch(e){ console.warn('AudioContext not available', e); return null; }
        }
        function playSound(type='click') {
          const ctx = getAudioCtx();
          if (!ctx) return;
          try {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            const now = ctx.currentTime;
            // frequency mapping per event
            const map = { add: 880, remove: 440, success: 960, error: 220, hold: 660, low: 560 };
            o.type = 'sine';
            o.frequency.value = map[type] || 600;
            g.gain.setValueAtTime(0.0001, now);
            g.gain.exponentialRampToValueAtTime(0.25, now + 0.01);
            o.start(now);
            g.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
            o.stop(now + 0.19);
          } catch (err) { console.warn('sound error', err); }
        }

        // Normalize user-provided payment method (accept Portuguese terms and map to API codes)
        function normalizePaymentMethod(input) {
          try {
            if (!input) return 'cash';
            let s = String(input).toLowerCase();
            // remove accents
            s = s.normalize && s.normalize('NFD').replace(/\p{Diacritic}/gu, '') || s.replace(/[\u0300-\u036f]/g, '');
            s = s.trim();
            const map = {
              'dinheiro': 'cash', 'cash': 'cash', 'money': 'cash',
              'pix': 'pix',
              'credito': 'card', 'credit': 'card', 'cartao': 'card', 'cartão': 'card', 'card': 'card',
              'debito': 'debit', 'debito': 'debit', 'debit': 'debit', 'debito': 'debit',
              'prazo': 'prazo', 'manual': 'manual'
            };
            if (map[s]) return map[s];
            // If already a known API code
            if (['cash','pix','card','debit','prazo','manual'].includes(s)) return s;
            return 'cash';
          } catch(e) { return 'cash'; }
        }

        // --- Modal de Pagamento Bonito ---
        function showPaymentInputModal(options = {}) {
          return new Promise((resolve, reject) => {
            const {
              title = 'Receber Pagamento',
              subtitle = '',
              icon = 'fa-hand-holding-dollar',
              headerGradient = 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
              buttonGradient = 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
              buttonShadow = 'rgba(16,185,129,0.3)',
              dueValue = 0,
              defaultValue = null,
              showMethod = true,
              showNotes = false,
              defaultMethod = 'dinheiro',
              confirmText = 'Confirmar'
            } = options;

            const modal = document.getElementById('paymentInputModal');
            const headerEl = document.getElementById('paymentInputHeader');
            const iconEl = document.getElementById('paymentInputIcon');
            const titleEl = document.getElementById('paymentInputTitle');
            const subtitleEl = document.getElementById('paymentInputSubtitle');
            const dueInfoEl = document.getElementById('paymentDueInfo');
            const dueValueEl = document.getElementById('paymentDueValue');
            const amountInput = document.getElementById('paymentInputAmount');
            const balancePreview = document.getElementById('paymentBalancePreview');
            const remainingValueEl = document.getElementById('paymentRemainingValue');
            const fullPreview = document.getElementById('paymentFullPreview');
            const methodSection = document.getElementById('paymentMethodSection');
            const methodInput = document.getElementById('paymentInputMethod');
            const notesSection = document.getElementById('paymentNotesSection');
            const noteInput = document.getElementById('paymentInputNote');
            const confirmBtn = document.getElementById('paymentInputConfirm');
            const cancelBtn = document.getElementById('paymentInputCancel');

            // Configurar visual
            headerEl.style.background = headerGradient;
            iconEl.className = 'fa ' + icon;
            titleEl.textContent = title;
            subtitleEl.textContent = subtitle;
            subtitleEl.style.display = subtitle ? 'block' : 'none';
            
            // Valor devido
            if (dueValue > 0) {
              dueInfoEl.style.display = 'block';
              dueValueEl.textContent = formatMoney(dueValue);
            } else {
              dueInfoEl.style.display = 'none';
            }
            
            // Função para atualizar preview do saldo
            const updateBalancePreview = () => {
              if (dueValue <= 0) {
                balancePreview.style.display = 'none';
                fullPreview.style.display = 'none';
                return;
              }
              
              const rawValue = amountInput.value.replace(/[^\d,.-]/g, '').replace(',', '.');
              const inputAmount = parseFloat(rawValue) || 0;
              const remaining = dueValue - inputAmount;
              
              if (inputAmount <= 0 || inputAmount === dueValue) {
                balancePreview.style.display = 'none';
                fullPreview.style.display = inputAmount >= dueValue ? 'block' : 'none';
              } else if (inputAmount < dueValue) {
                // Pagamento parcial - mostrar saldo restante
                balancePreview.style.display = 'block';
                fullPreview.style.display = 'none';
                remainingValueEl.textContent = formatMoney(remaining);
              } else {
                // Pagamento maior ou igual - quitado
                balancePreview.style.display = 'none';
                fullPreview.style.display = 'block';
              }
            };
            
            // Valor padrão
            const valorPadrao = defaultValue !== null ? defaultValue : dueValue;
            amountInput.value = valorPadrao > 0 ? valorPadrao.toFixed(2).replace('.', ',') : '';
            
            // Adicionar listener de input para preview em tempo real
            const newAmountInput = amountInput.cloneNode(true);
            amountInput.parentNode.replaceChild(newAmountInput, amountInput);
            newAmountInput.addEventListener('input', updateBalancePreview);
            newAmountInput.addEventListener('keyup', updateBalancePreview);
            
            // Atualizar referência
            const finalAmountInput = newAmountInput;
            
            // Inicializar preview
            setTimeout(updateBalancePreview, 50);
            
            // Método de pagamento
            methodSection.style.display = showMethod ? 'block' : 'none';
            methodInput.value = defaultMethod;
            
            // Marcar botão ativo do método
            const methodBtns = methodSection.querySelectorAll('.payment-method-btn');
            methodBtns.forEach(btn => {
              btn.classList.remove('active');
              if (btn.dataset.method === defaultMethod) btn.classList.add('active');
              
              // Remover listeners antigos e adicionar novos
              const newBtn = btn.cloneNode(true);
              btn.parentNode.replaceChild(newBtn, btn);
              newBtn.addEventListener('click', () => {
                methodSection.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('active'));
                newBtn.classList.add('active');
                methodInput.value = newBtn.dataset.method;
              });
            });
            
            // Notas
            notesSection.style.display = showNotes ? 'block' : 'none';
            noteInput.value = '';
            
            // Botão confirmar
            confirmBtn.innerHTML = `<i class="fa fa-check" style="margin-right: 8px;"></i>${confirmText}`;
            confirmBtn.style.background = buttonGradient;
            confirmBtn.style.boxShadow = `0 4px 15px ${buttonShadow}`;

            // Handlers
            let resolved = false;
            
            const cleanup = () => {
              confirmBtn.removeEventListener('click', onConfirm);
              cancelBtn.removeEventListener('click', onCancel);
              modal.removeEventListener('hidden.bs.modal', onHidden);
              if (window.jQuery) window.jQuery(modal).off('hidden.bs.modal', onHidden);
            };
            
            const onConfirm = () => {
              const rawValue = finalAmountInput.value.replace(/[^\d,.-]/g, '').replace(',', '.');
              const amount = parseFloat(rawValue);
              
              if (isNaN(amount) || amount <= 0) {
                finalAmountInput.style.borderColor = '#ef4444';
                finalAmountInput.style.boxShadow = '0 0 0 4px rgba(239,68,68,0.15)';
                finalAmountInput.focus();
                setTimeout(() => {
                  finalAmountInput.style.borderColor = '#e2e8f0';
                  finalAmountInput.style.boxShadow = 'none';
                }, 1500);
                return;
              }
              
              resolved = true;
              const result = {
                amount,
                method: methodInput.value,
                note: noteInput.value.trim()
              };
              
              // Fechar modal
              if (window.jQuery) {
                window.jQuery(modal).modal('hide');
              } else {
                try {
                  const inst = window.bootstrap.Modal.getInstance(modal);
                  if (inst) inst.hide();
                } catch(e) {
                  modal.classList.remove('show');
                  modal.style.display = 'none';
                }
              }
              
              cleanup();
              resolve(result);
            };
            
            const onCancel = () => {
              resolved = true;
              cleanup();
              resolve(null);
            };
            
            const onHidden = () => {
              if (!resolved) {
                cleanup();
                resolve(null);
              }
            };

            confirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', onCancel);
            
            if (window.jQuery) {
              window.jQuery(modal).on('hidden.bs.modal', onHidden);
            } else {
              modal.addEventListener('hidden.bs.modal', onHidden);
            }

            // Abrir modal
            if (window.jQuery) {
              window.jQuery(modal).modal('show');
            } else {
              try {
                const inst = window.bootstrap.Modal.getOrCreateInstance(modal);
                inst.show();
              } catch(e) {
                modal.classList.add('show');
                modal.style.display = 'block';
              }
            }

            // Focar no input após abrir
            setTimeout(() => {
              finalAmountInput.focus();
              finalAmountInput.select();
            }, 300);
          });
        }

        // --- Elementos da UI ---
        const productListEl = document.getElementById('productList');
        const categoryListEl = document.getElementById('category-list');
        const cartItemsEl = document.getElementById('cartItems');
        const cartTableEl = document.getElementById('cartTable');
        const cartTableBodyEl = document.getElementById('cartTableBody');
        const emptyCartMessageEl = document.getElementById('emptyCartMessage');
        const searchInput = document.getElementById('searchProd');
        const barcodeInput = document.getElementById('barcodeInput');
        const prodCountEl = document.getElementById('prodCount');
        const subtotalEl = document.getElementById('subtotalVal');
        const discountEl = document.getElementById('discountVal');
        const additionEl = document.getElementById('additionVal');
        const totalEl = document.getElementById('totalVal');
        const totalQtyEl = document.getElementById('totalQty');
        const itemCountEl = document.getElementById('itemCount');
        const btnCheckout = document.getElementById('btnCheckout');
        const btnCancel = document.getElementById('btnCancel');
        const btnHold = document.getElementById('btnHold');
        // Robust payModal wrapper: support jQuery object when available, otherwise provide minimal API over Bootstrap Modal
        const payModalEl = document.getElementById('payModal');
        let payModalInstance = null;
        function ensurePayModalInstance() {
          try {
            if (window.bootstrap && payModalEl) {
              payModalInstance = window.bootstrap.Modal.getOrCreateInstance(payModalEl);
              // flush pending actions
              if (payModal._pending && payModal._pending.length) {
                payModal._pending.forEach(a => { try { payModal.modal(a); } catch(e){} });
                payModal._pending.length = 0;
              }
            }
          } catch(e) { /* ignore */ }
        }
        const payModal = (function(){
          if (window.jQuery) return window.jQuery('#payModal');
          const obj = {
            el: payModalEl,
            _pending: [],
            modal(action){
              ensurePayModalInstance();
              if (!payModalInstance) { obj._pending.push(action); return; }
              if (action === 'show') payModalInstance.show();
              if (action === 'hide') payModalInstance.hide();
            },
            one(eventName, handler){ if (!payModalEl) return; const wrapper = function(e){ handler(e); payModalEl.removeEventListener(eventName, wrapper); }; payModalEl.addEventListener(eventName, wrapper); },
            hasClass(cls){ return payModalEl && payModalEl.classList.contains(cls); }
          };
          return obj;
        })();

        const modalTotalEl = document.getElementById('modalTotal');
        const payAmountInput = document.getElementById('payAmount');
        const changeValEl = document.getElementById('changeVal');
        const confirmPayBtn = document.getElementById('confirmPay');
        const pendingSalesSection = document.getElementById('pendingSalesSection');
        const pendingSalesList = document.getElementById('pendingSalesList');
        const pendingSalesCount = document.getElementById('pendingSalesCount');
        const saleStatusEl = document.getElementById('saleStatus');

        // Contas a Prazo (FAB + modal)
        const btnAccountsPrazo = document.getElementById('btnAccountsPrazo');
        const accountsPrazoModalEl = document.getElementById('accountsPrazoModal');
        const accountsPrazoListEl = document.getElementById('accountsPrazoList');

        // Ajusta posição do FAB para não sobrepor footer/quick-actions
        function adjustFabPosition() {
          if (!btnAccountsPrazo) return;
          const footer = document.querySelector('.footer-shortcuts');
          const quickActions = document.querySelector('.quick-actions');

          const footerH = footer ? footer.offsetHeight : 0;
          // Distância mínima da parte inferior (em px)
          const baseOffset = 16;

          // Calcula distância do topo do elemento quickActions até a janela
          let qaGap = 0;
          if (quickActions) {
            const qaRect = quickActions.getBoundingClientRect();
            // quanto o quickActions ocupa acima do fim da viewport
            qaGap = Math.max(0, window.innerHeight - qaRect.top);
          }

          // Queremos o botão acima do maior dos dois (footer ou quickActions) + folga
          const bottomOffset = Math.max(footerH + baseOffset, qaGap + baseOffset);

          btnAccountsPrazo.style.bottom = bottomOffset + 'px';
        }

        // Recalcula ao redimensionar/rolar para evitar sobreposição dinâmica
        window.addEventListener('resize', () => adjustFabPosition());
        window.addEventListener('scroll', () => adjustFabPosition());
        // Chamar após renderizações dinâmicas (inicial e quando pending sales mudar)
        setTimeout(adjustFabPosition, 50);


        // --- Funções de Renderização ---
        function renderProducts() {
          productListEl.innerHTML = '';
          const query = searchInput.value.toLowerCase();
          
          const filteredProducts = state.allProducts.filter(p => {
            const inCategory = state.activeCategory === 'Todos' || p.category === state.activeCategory;
            const matchesQuery = !query || p.name.toLowerCase().includes(query) || (p.sku || '').toLowerCase().includes(query) || (p.code || '').toString().includes(query);
            return inCategory && matchesQuery;
          });

          prodCountEl.textContent = filteredProducts.length;

          if (filteredProducts.length === 0) {
            productListEl.innerHTML = '<div class="text-muted p-3 text-center">Nenhum produto encontrado.</div>';
            return;
          }

          filteredProducts.forEach(p => {
            const item = document.createElement('div');
            item.className = 'prod-item';
            
            // Gerar imagem ou ícone baseado na categoria
            const getProductIcon = (category) => {
              const icons = {
                'Bebidas': 'fa-wine-bottle',
                'Comidas': 'fa-utensils',
                'Eletrônicos': 'fa-mobile-alt',
                'Roupas': 'fa-tshirt',
                'Livros': 'fa-book',
                'Casa': 'fa-home',
                'Esportes': 'fa-dumbbell',
                'Beleza': 'fa-spa',
                'Farmácia': 'fa-pills'
              };
              return icons[category] || 'fa-box';
            };
            
            const stockStatus = (stock) => {
              if (stock <= 0) return 'out-of-stock';
              if (stock <= 5) return 'low-stock';
              return '';
            };
            
            const stockText = (stock) => {
              if (stock <= 0) return 'Sem estoque';
              if (stock <= 5) return `Baixo: ${stock} un`;
              return `Estoque: ${stock} un`;
            };

            const stockVal = (typeof p.stock === 'number') ? p.stock : 0;
            
            item.innerHTML = `
              <div class="prod-image">
                ${p.image ? `<img src="${p.image}" alt="${p.name}">` : `<i class="fas ${getProductIcon(p.category || 'Outros')}"></i>`}
              </div>
              <div class="prod-code">#${p.code || p.id}</div>
              <div class="prod-category">${p.category || 'Produto'}</div>
              <div class="prod-name">${p.name}</div>
              <div class="prod-price">${formatMoney(p.price)}</div>
              <div class="prod-stock ${stockStatus(stockVal)}">${stockText(stockVal)}</div>
            `;
            item.onclick = () => addToCart(p.id);
            productListEl.appendChild(item);
          });
        }

        function renderCategories() {
          categoryListEl.innerHTML = '';
          const categories = ['Todos', ...new Set(state.allProducts.map(p => p.category || 'Outros'))];
          state.categories = categories;

          categories.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'category-btn' + (cat === state.activeCategory ? ' active' : '');
            btn.textContent = cat;
            btn.onclick = () => {
              state.activeCategory = cat;
              document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              renderProducts();
            };
            categoryListEl.appendChild(btn);
          });
        }

        function renderCart() {
          const totalQty = state.cart.reduce((s, it) => s + it.qty, 0);
          itemCountEl.textContent = totalQty;
          totalQtyEl.textContent = totalQty;

          if (state.cart.length === 0) {
            cartTableEl.style.display = 'none';
            emptyCartMessageEl.style.display = 'block';
            updateSaleStatus('open');
          } else {
            cartTableEl.style.display = 'table';
            emptyCartMessageEl.style.display = 'none';
            updateSaleStatus('pending');
            
            cartTableBodyEl.innerHTML = '';
            state.cart.forEach((item, index) => {
              const row = document.createElement('tr');
              row.style.cssText = 'transition: all 0.2s ease;';
              row.innerHTML = `
                <td style="padding: 10px 8px; font-size: 12px; font-weight: 600; color: var(--muted);">${String(index + 1).padStart(2, '0')}</td>
                <td style="padding: 10px 8px;">
                  <div style="font-size: 13px; font-weight: 600; color: var(--text-color);">${item.name}</div>
                  <div style="font-size: 11px; color: var(--muted);">#${item.code || item.id}</div>
                </td>
                <td style="padding: 10px 8px; text-align: center;">
                  <div class="d-flex align-items-center justify-content-center" style="gap: 4px;">
                    <button class="btn btn-sm btn-outline-secondary qty-btn" data-act="dec" data-id="${item.id}" style="width: 24px; height: 24px; padding: 0; font-size: 12px; border-radius: 6px;">-</button>
                    <span style="font-weight: 700; min-width: 24px; text-align: center;">${item.qty}</span>
                    <button class="btn btn-sm btn-outline-secondary qty-btn" data-act="inc" data-id="${item.id}" style="width: 24px; height: 24px; padding: 0; font-size: 12px; border-radius: 6px;">+</button>
                  </div>
                </td>
                <td style="padding: 10px 8px; text-align: right; font-size: 12px; color: var(--muted);">${formatMoney(item.price)}</td>
                <td style="padding: 10px 8px; text-align: right; font-size: 13px; font-weight: 700; color: var(--brand);">${formatMoney(item.price * item.qty)}</td>
                <td style="padding: 10px 8px; text-align: center;">
                  <button class="btn btn-sm btn-link text-danger p-0" data-act="rem" data-id="${item.id}" style="font-size: 14px;"><i class="fa fa-trash"></i></button>
                </td>
              `;
              row.onmouseenter = () => row.style.background = 'rgba(37, 99, 235, 0.05)';
              row.onmouseleave = () => row.style.background = '';
              cartTableBodyEl.appendChild(row);
            });
          }
          updateTotals();
        }

        function updateSaleStatus(status) {
          if (status === 'open') {
            saleStatusEl.className = 'sale-status open';
            saleStatusEl.innerHTML = '<i class="fa fa-circle"></i><span>Venda Aberta</span>';
          } else if (status === 'pending') {
            saleStatusEl.className = 'sale-status pending';
            saleStatusEl.innerHTML = '<i class="fa fa-circle"></i><span>Em Andamento</span>';
          }
        }

        function updateTotals() {
          const subtotal = state.cart.reduce((s, it) => s + (it.price * it.qty), 0);
          const total = subtotal - state.discount + state.addition;
          subtotalEl.textContent = formatMoney(subtotal);
          discountEl.textContent = formatMoney(state.discount);
          additionEl.textContent = formatMoney(state.addition);
          totalEl.textContent = formatMoney(total);
        }

        function renderPendingSales() {
          if (state.pendingSales.length === 0) {
            pendingSalesSection.style.display = 'none';
            return;
          }

          pendingSalesSection.style.display = 'block';
          pendingSalesCount.textContent = state.pendingSales.length;
          pendingSalesList.innerHTML = '';

          state.pendingSales.forEach((sale, index) => {
            const item = document.createElement('div');
            item.className = 'pending-sale-item';
            item.innerHTML = `
              <div class="sale-client">${sale.client || 'Cliente não informado'}</div>
              <div class="sale-value">${formatMoney(sale.total)}</div>
              <div class="sale-time">${sale.time}</div>
            `;
            item.onclick = () => restorePendingSale(index);
            pendingSalesList.appendChild(item);
          });
        }
        // Garantir que o FAB seja reposicionado quando a lista de vendas pendentes muda
        try { if (typeof adjustFabPosition === 'function') adjustFabPosition(); } catch(e) { /* ignore */ }

        // Busca e renderização de contas a prazo
        // State for accounts modal
        state.accountsPrazo = { items: [], selectedId: null, selectedPerson: null };

        async function loadAccountsPrazo(search = '') {
          console.log('[Contas a Prazo] Iniciando carregamento...', { accountsPrazoListEl });
          if (!accountsPrazoListEl) {
            console.error('[Contas a Prazo] accountsPrazoListEl não encontrado!');
            return;
          }
          accountsPrazoListEl.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
              <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px;"></i>
              <div>Carregando contas...</div>
            </div>`;
          try {
            const q = search ? ('&search=' + encodeURIComponent(search)) : '';
            console.log('[Contas a Prazo] Buscando dados da API...');
            // Buscar pendentes E parciais (contas com pagamento parcial/haver)
            const res = await axios.get('/api/transactions?pageSize=1000' + q);
            console.log('[Contas a Prazo] Dados recebidos:', res.data);
            // Incluir status 'pendente' E 'parcial' (contas com haver/pagamento parcial)
            let items = (res.data.data || []).filter(t => (t.status === 'pendente' || t.status === 'parcial') && (t.paymentMethod === 'prazo' || t.type === 'venda' || /prazo/i.test(t.description || '')));
            console.log('[Contas a Prazo] Items filtrados:', items.length);
            
            // Aplicar filtro de status (vencidas, a vencer, todas)
            const filterEl = document.getElementById('accountsFilterStatus');
            const filterValue = filterEl ? filterEl.value : 'todas';
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            
            if (filterValue === 'vencidas') {
              items = items.filter(t => {
                if (!t.dueDate) return false;
                const due = new Date(t.dueDate);
                due.setHours(0,0,0,0);
                return due < hoje;
              });
            } else if (filterValue === 'avencer') {
              items = items.filter(t => {
                if (!t.dueDate) return true;
                const due = new Date(t.dueDate);
                due.setHours(0,0,0,0);
                return due >= hoje;
              });
            }
            
            state.accountsPrazo.items = items.sort((a,b)=> new Date(a.dueDate) - new Date(b.dueDate));

            renderAccountsList();
          } catch (err) {
            console.error('Erro ao carregar contas a prazo:', err);
            accountsPrazoListEl.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #ef4444;">
                <i class="fa fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                <div>Falha ao carregar. Veja o console.</div>
              </div>`;
          }
        }

        function renderAccountsList() {
          accountsPrazoListEl.innerHTML = '';
          const items = state.accountsPrazo.items;
          
          // Atualizar estatísticas
          let totalAberto = 0;
          let contasAtivas = 0;
          let vencidas = 0;
          const hoje = new Date();
          hoje.setHours(0,0,0,0);
          
          items.forEach(tx => {
            totalAberto += parseFloat(tx.valueDue || tx.value || 0);
            contasAtivas++;
            if (tx.dueDate) {
              const due = new Date(tx.dueDate);
              due.setHours(0,0,0,0);
              if (due < hoje) vencidas++;
            }
          });
          
          document.getElementById('statsTotalAberto').textContent = formatMoney(totalAberto);
          document.getElementById('statsContasAtivas').textContent = contasAtivas;
          document.getElementById('statsVencidas').textContent = vencidas;
          document.getElementById('accountsCountInfo').textContent = contasAtivas + ' contas encontradas';
          
          if (!items || items.length === 0) {
            accountsPrazoListEl.innerHTML = `
              <div style="text-align: center; padding: 60px 20px; color: #94a3b8;">
                <div style="width: 70px; height: 70px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                  <i class="fa fa-inbox" style="font-size: 28px; color: #cbd5e1;"></i>
                </div>
                <h5 style="color: #64748b; margin-bottom: 8px;">Nenhuma conta encontrada</h5>
                <p style="font-size: 13px; margin: 0;">Não há contas a prazo em aberto</p>
              </div>`;
            state.accountsPrazo.selectedIds = [];
            updateBulkState();
            return;
          }

          // Group by person
          const groups = {};
          items.forEach(tx => {
            const person = (tx.person || 'Cliente').trim();
            if (!groups[person]) groups[person] = { person, count: 0, totalDue: 0, earliestDue: null, items: [], hasVencida: false };
            groups[person].count += 1;
            groups[person].totalDue += parseFloat(tx.valueDue || tx.value || 0);
            groups[person].items.push(tx);
            if (tx.dueDate) {
              const d = new Date(tx.dueDate);
              d.setHours(0,0,0,0);
              if (!groups[person].earliestDue || new Date(groups[person].earliestDue) > d) groups[person].earliestDue = tx.dueDate;
              if (d < hoje) groups[person].hasVencida = true;
            }
          });

          const groupArr = Object.values(groups).sort((a,b) => a.person.localeCompare(b.person));
          if (state.accountsPrazo.selectedPerson && !groups[state.accountsPrazo.selectedPerson]) state.accountsPrazo.selectedPerson = null;

          groupArr.forEach(g => {
            const isSelected = state.accountsPrazo.selectedPerson === g.person;
            const isVencida = g.hasVencida;
            
            const card = document.createElement('div');
            card.className = 'account-card';
            card.dataset.person = g.person;
            card.style.cssText = `
              background: ${isSelected ? '#eef2ff' : '#fff'}; 
              border: 2px solid ${isSelected ? '#6366f1' : (isVencida ? '#fecaca' : '#e2e8f0')}; 
              border-radius: 12px; 
              padding: 14px 16px; 
              margin-bottom: 10px; 
              cursor: pointer; 
              transition: all 0.15s;
              ${isVencida && !isSelected ? 'background: #fef2f2;' : ''}
            `;

            const badgeColor = isVencida ? '#ef4444' : '#6366f1';
            const badgeBg = isVencida ? '#fee2e2' : '#eef2ff';

            card.innerHTML = `
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                  <span style="color: #fff; font-weight: 700; font-size: 16px;">${g.person.charAt(0).toUpperCase()}</span>
                </div>
                <div style="flex: 1; min-width: 0;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                    <div style="min-width: 0;">
                      <div style="font-weight: 600; color: #1e293b; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${g.person}</div>
                      <div style="font-size: 12px; color: #64748b; margin-top: 2px;">${g.count} conta${g.count > 1 ? 's' : ''} em aberto</div>
                    </div>
                    <div style="text-align: right; flex-shrink: 0;">
                      <div style="font-weight: 700; color: #059669; font-size: 15px;">${formatMoney(g.totalDue)}</div>
                      ${g.earliestDue ? `<div style="font-size: 11px; color: ${badgeColor}; background: ${badgeBg}; padding: 2px 8px; border-radius: 10px; margin-top: 4px; display: inline-block;">Venc: ${formatDateBR(g.earliestDue)}</div>` : ''}
                    </div>
                  </div>
                </div>
              </div>
            `;

            card.addEventListener('click', () => selectPerson(g.person));
            card.addEventListener('mouseenter', () => { if (!isSelected) card.style.borderColor = '#6366f1'; });
            card.addEventListener('mouseleave', () => { if (!isSelected) card.style.borderColor = isVencida ? '#fecaca' : '#e2e8f0'; });

            accountsPrazoListEl.appendChild(card);
          });

          if (state.accountsPrazo.selectedPerson) {
            renderPersonAccountsInDetail(state.accountsPrazo.selectedPerson);
          } else {
            const detailEl = document.getElementById('accountDetail');
            if (detailEl && !state.accountsPrazo.selectedId) {
              detailEl.innerHTML = `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; color: #94a3b8;">
                  <div style="width: 80px; height: 80px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                    <i class="fa fa-hand-pointer" style="font-size: 32px; color: #cbd5e1;"></i>
                  </div>
                  <h5 style="color: #64748b; margin-bottom: 8px;">Nenhuma conta selecionada</h5>
                  <p style="font-size: 13px; margin: 0;">Clique em um cliente ao lado para ver suas contas em aberto</p>
                </div>`;
            }
          }

          state.accountsPrazo.selectedIds = [];
          updateBulkState();
        }

        function selectAccount(id) {
          state.accountsPrazo.selectedId = id;
          state.accountsPrazo.selectedPerson = null;
          const tx = state.accountsPrazo.items.find(t => t.id === id);
          const personName = tx ? (tx.person || '') : '';
          document.querySelectorAll('#accountsPrazoList .account-card').forEach(el => {
            el.style.background = el.dataset.person === personName ? '#eef2ff' : '#fff';
            el.style.borderColor = el.dataset.person === personName ? '#6366f1' : '#e2e8f0';
          });
          const detailEl = document.getElementById('accountDetail');
          if (!tx || !detailEl) { 
            if (detailEl) detailEl.innerHTML = `
              <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; color: #94a3b8;">
                <div style="width: 70px; height: 70px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                  <i class="fa fa-file-invoice" style="font-size: 28px; color: #cbd5e1;"></i>
                </div>
                <h5 style="color: #64748b; margin-bottom: 8px;">Selecione uma conta</h5>
                <p style="font-size: 13px; margin: 0;">Clique em uma conta para ver detalhes e ações</p>
              </div>`; 
            return; 
          }

          const hoje = new Date();
          hoje.setHours(0,0,0,0);
          const dueDate = tx.dueDate ? new Date(tx.dueDate) : null;
          if (dueDate) dueDate.setHours(0,0,0,0);
          const isVencida = dueDate && dueDate < hoje;
          const diasRestantes = dueDate ? Math.ceil((dueDate - hoje) / (1000 * 60 * 60 * 24)) : null;
          
          const shortId = (tx.id || '').slice(0,8);
          const valorPago = parseFloat(tx.paidAmount || 0);
          const valorOriginal = parseFloat(tx.value || tx.total || 0);
          const percentPago = valorOriginal > 0 ? Math.round((valorPago / valorOriginal) * 100) : 0;

          detailEl.innerHTML = `
            <div style="height: 100%; display: flex; flex-direction: column; overflow: hidden; padding: 16px;">
              <!-- Área Scrollável -->
              <div style="flex: 1; overflow-y: auto; min-height: 0; padding-right: 4px;">
                <!-- Header da Conta -->
                <div style="background: ${isVencida ? 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)' : 'linear-gradient(135deg, #059669 0%, #10b981 100%)'}; padding: 14px; border-radius: 10px; margin-bottom: 12px;">
                  <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
                    <div style="flex: 1; min-width: 0;">
                      <div style="color: rgba(255,255,255,0.8); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Cliente</div>
                      <div style="color: #fff; font-weight: 700; font-size: 14px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${tx.person || 'Cliente'}</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 11px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${tx.description || ''}</div>
                    </div>
                    <div style="text-align: right; flex-shrink: 0;">
                      <div style="color: rgba(255,255,255,0.8); font-size: 10px; text-transform: uppercase;">Devido</div>
                      <div style="color: #fff; font-weight: 700; font-size: 18px;">${formatMoney(tx.valueDue)}</div>
                      <div style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; margin-top: 4px; display: inline-block;">
                        <span style="color: #fff; font-size: 10px; font-weight: 600;">
                          ${isVencida ? '<i class="fa fa-exclamation-circle"></i> Vencida ' + Math.abs(diasRestantes) + 'd' : 
                            (diasRestantes === 0 ? 'Vence hoje' : 
                             (diasRestantes > 0 ? 'Vence em ' + diasRestantes + 'd' : formatDateBR(tx.dueDate)))}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Botão Voltar -->
                  <div style="margin-top: 10px;">
                    <button id="btnBackFromAccount" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 4px;">
                      <i class="fa fa-arrow-left"></i> Voltar
                    </button>
                  </div>
                </div>
                
                <!-- Info Cards -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                  <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="color: #64748b; font-size: 9px; text-transform: uppercase;">Original</div>
                    <div style="color: #1e293b; font-weight: 700; font-size: 13px; margin-top: 2px;">${formatMoney(valorOriginal)}</div>
                  </div>
                  <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="color: #64748b; font-size: 9px; text-transform: uppercase;">Pago</div>
                    <div style="color: #059669; font-weight: 700; font-size: 13px; margin-top: 2px;">${formatMoney(valorPago)}</div>
                  </div>
                  <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="color: #64748b; font-size: 9px; text-transform: uppercase;">Método</div>
                    <div style="color: #1e293b; font-weight: 600; font-size: 11px; margin-top: 2px;">${tx.paymentMethod || '-'}</div>
                  </div>
                </div>

                <!-- Botões de Ação - MOVIDOS PARA CIMA -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                  <button id="btnReceive" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: #fff; border: none; padding: 10px 8px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px;">
                    <i class="fa fa-hand-holding-dollar"></i> Receber
                  </button>
                  <button id="btnPixAccount" style="background: linear-gradient(135deg, #00b4a0 0%, #32cbbc 100%); color: #fff; border: none; padding: 10px 8px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px;">
                    <i class="fa fa-qrcode"></i> PIX
                  </button>
                  <button id="btnMarkPaid" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; border: none; padding: 10px 8px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px;">
                    <i class="fa fa-check"></i> Pago
                  </button>
                  <button id="btnPartialPay" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff; border: none; padding: 10px 8px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px;">
                    <i class="fa fa-coins"></i> Haver
                  </button>
                  <button id="btnPrintElginFromAccount" style="background: #fff; color: #64748b; border: 2px solid #e2e8f0; padding: 10px 8px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px; grid-column: span 2;">
                    <i class="fa fa-print"></i> Imprimir Cupom
                  </button>
                </div>
                
                <!-- Meta Info Compacto -->
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                  <div style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 11px;">
                    <div><span style="color: #64748b;">ID:</span> <span style="color: #1e293b; font-weight: 500;">${shortId}</span></div>
                    ${tx.type ? `<div><span style="color: #64748b;">Tipo:</span> <span style="color: #1e293b; font-weight: 500;">${tx.type}</span></div>` : ''}
                    <div><span style="color: #64748b;">Status:</span> <span style="color: #1e293b; font-weight: 500;">${tx.status || '-'}</span></div>
                  </div>
                </div>

                <!-- Notas -->
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                    <label style="color: #64748b; font-size: 11px; font-weight: 600;">Notas</label>
                    <button id="btnSaveNote" style="background: none; border: none; color: #6366f1; font-size: 11px; cursor: pointer; padding: 0;">
                      <i class="fa fa-save"></i> Salvar
                    </button>
                  </div>
                  <textarea id="accountNotes" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; resize: none; height: 50px;" placeholder="Adicione notas...">${(tx.notes || '').replace(/"/g,'&quot;')}</textarea>
                </div>

                <!-- Histórico de Recebimentos -->
                <div>
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                    <h6 style="color: #64748b; font-size: 11px; font-weight: 600; margin: 0; text-transform: uppercase;">Histórico</h6>
                    <button id="btnViewClientReceipts" style="background: none; border: none; color: #6366f1; font-size: 10px; cursor: pointer; padding: 0;">Ver tudo</button>
                  </div>
                  <div id="accountReceiptsList" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; max-height: 100px; overflow-y: auto;">
                    <div style="text-align: center; color: #94a3b8; padding: 12px; font-size: 11px;">Carregando...</div>
                  </div>
                </div>
              </div>
            </div>`;

          // Attach action handlers
          const _btnBackFromAccount = document.getElementById('btnBackFromAccount');
          if (_btnBackFromAccount) _btnBackFromAccount.addEventListener('click', () => {
            state.accountsPrazo.selectedId = null;
            state.accountsPrazo.selectedPerson = tx.person;
            renderPersonAccountsInDetail(tx.person);
          });
          
          const _btnMarkPaid = document.getElementById('btnMarkPaid');
          if (_btnMarkPaid) _btnMarkPaid.addEventListener('click', () => markAsPaid(id));
          const _btnPartialPay = document.getElementById('btnPartialPay');
          if (_btnPartialPay) _btnPartialPay.addEventListener('click', () => registerPartialPayment(id));

          const _btnSaveNote = document.getElementById('btnSaveNote');
          if (_btnSaveNote) _btnSaveNote.addEventListener('click', () => saveAccountNote(id));

          // Imprimir cupom fiscal (Elgin) a partir da conta selecionada
          const _btnPrintElginFromAccount = document.getElementById('btnPrintElginFromAccount');
          if (_btnPrintElginFromAccount) _btnPrintElginFromAccount.addEventListener('click', () => {
            try {
              const amount = parseFloat(tx.value_due !== null && tx.value_due !== undefined ? tx.value_due : tx.value) || 0;
              const sale = {
                items: [{ name: tx.description || 'Pagamento', qty: 1, price: amount }],
                total: amount,
                received: amount,
                method: tx.payment_method || '-',
                client: tx.person || '-',
                date: DateTimeUtils.nowForDB(),
                note: tx.notes || ''
              };
              openElginModal(sale);
            } catch (err) { console.error('Erro ao abrir modal do cupom a partir da conta:', err); showToast('Falha ao abrir cupom fiscal', 'danger'); }
          });
        }

        async function markAsPaid(id) {
          if (!confirm('Marcar esta conta como PAGA?')) return;
          const tx = state.accountsPrazo.items.find(t => t.id === id);
          if (!tx) return;
          try {
            const amount = parseFloat(tx.valueDue || tx.value);
            const resp = await receivePayment(id, amount, 'manual', 'Pagamento por PDV (marcar como pago)');
            if (resp && resp.id) {
              showToast('Conta marcada como paga e recibo gerado.', 'success');
              // Não abrir PDF automaticamente. Imprimir cupom apenas para contas quitadas hoje
              try {
                const originalDue = parseFloat(tx.valueDue || tx.value || 0);
                const paidAmount = parseFloat(tx.valueDue || tx.value || 0);
                if (paidAmount >= originalDue) {
                  const sale = { items: [{ name: tx.description || 'Pagamento', qty: 1, price: originalDue }], total: originalDue, received: originalDue, method: resp.receipt && resp.receipt.method ? resp.receipt.method : (tx.payment_method || '-'), client: tx.person || '-', date: DateTimeUtils.nowForDB(), note: tx.notes || '' };
                  openElginModal(sale);
                  try { const auto = localStorage.getItem('elgin_auto_print') === '1'; const useEsc = localStorage.getItem('elgin_use_escpos') === '1'; if (auto) { const payload = { coupon: document.getElementById('elginCouponPreview').textContent, sale, device: useEsc ? 'elgin-i8' : 'elgin-i8', escpos: useEsc, autoPrint: true }; const pr = await axios.post('/api/print/elgin', payload); if (pr && pr.data) showToast('Impressão enviada (automático).', 'success'); } } catch(e) { console.warn('Falha ao enviar impressão automática:', e); }
                }
              } catch(e) { console.error('Erro ao decidir impressão de cupom:', e); }
              await loadAccountsPrazo((document.getElementById('accountsPrazoSearch') || {}).value || '');
              try { await loadReceiptHistoryForTransaction(id); } catch(e) { /* ignore */ }
            }
          } catch (err) {
            console.error('Erro ao marcar como pago:', err);
            showToast('Falha ao marcar como paga.', 'danger');
          }
        }

        async function registerPartialPayment(id) {
          const tx = state.accountsPrazo.items.find(t => t.id === id);
          if (!tx) return;
          
          const result = await showPaymentInputModal({
            title: 'Dar Haver / Entrada',
            subtitle: tx.person || 'Cliente',
            icon: 'fa-coins',
            headerGradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
            buttonGradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
            buttonShadow: 'rgba(245,158,11,0.3)',
            dueValue: parseFloat(tx.valueDue || 0),
            defaultValue: null, // deixar vazio para parcial
            showMethod: true,
            showNotes: false,
            defaultMethod: 'dinheiro',
            confirmText: 'Registrar Haver'
          });
          
          if (!result) return; // Cancelou
          
          const { amount: amt, method: methodInput } = result;
          const method = normalizePaymentMethod(methodInput);
          const valorDevido = parseFloat(tx.valueDue || 0);
          const saldoRestante = Math.max(0, valorDevido - amt);
          
          try {
            const resp = await receivePayment(id, amt, method, 'Pagamento parcial via PDV');
            if (resp && resp.id) {
              // Mensagem personalizada com saldo restante
              if (saldoRestante > 0) {
                showToast(`Pagamento de ${formatMoney(amt)} registrado! Saldo restante: ${formatMoney(saldoRestante)}`, 'success');
              } else {
                showToast('Conta quitada com sucesso!', 'success');
              }
              // Pagamento parcial: não abrir recibo automaticamente
              await loadAccountsPrazo((document.getElementById('accountsPrazoSearch') || {}).value || '');
              try { await loadReceiptHistoryForTransaction(id); } catch(e) { /* ignore */ }
            }
          } catch (err) {
            console.error('Erro ao registrar pagamento parcial:', err, err && err.response && err.response.data ? err.response.data : 'no response');
            const serverMsg = err && err.response && err.response.data && (err.response.data.detail || err.response.data.error) ? (err.response.data.detail || err.response.data.error) : null;
            showToast(serverMsg ? ('Falha: ' + serverMsg) : 'Falha ao registrar pagamento.', 'danger');
          }
        }

        async function receivePayment(id, amountArg = null, methodArg = null, noteArg = '') {
          const tx = state.accountsPrazo.items.find(t => t.id === id);
          if (!tx) return null;
          const amount = amountArg !== null ? parseFloat(amountArg) : parseFloat(tx.valueDue || tx.value);
          if (isNaN(amount) || amount <= 0) return null;
          // Se não foi passado método, usa 'manual' como padrão (sem prompt)
          const methodInput = methodArg || 'manual';
          const method = normalizePaymentMethod(methodInput);
          // Se não foi passado nota, usa string vazia (sem prompt)
          const note = noteArg || '';
          const res = await axios.post(`/api/transactions/${id}/receive`, { amount, method, note });
          return res.data;
        }

        // Abre recibo em nova aba com verificação do conteúdo (PDF ou HTML) e fallback para HTML gerado no cliente.
        async function openReceiptHtml(id, win) {
          try {
            const resp = await axios.get('/api/receipts/' + id);
            const r = resp.data && (resp.data.data || resp.data) || {};
            const company = (r.company && (r.company.nome_fantasia || r.company.razao_social)) ? (r.company.nome_fantasia || r.company.razao_social) : (r.company && (r.company.name) ? r.company.name : 'Minha Empresa');
            const receiptDate = DateTimeUtils.formatDateTime(r.created_at || r.payment_date || new Date());
            const dueDate = r.tx_due_date || r.due_date ? DateTimeUtils.formatDate(r.tx_due_date || r.due_date) : '-';
            const html = `<!doctype html><html><head><meta charset="utf-8"><title>Recibo ${id}</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#222} .header{display:flex;justify-content:space-between;align-items:center} .company{font-weight:800;font-size:18px} .muted{color:#666;font-size:13px} .box{border:1px solid #e6e6e6;padding:14px;margin-top:12px;border-radius:6px;background:#fff} .row{display:flex;justify-content:space-between;margin-bottom:6px} .label{color:#555;font-weight:700;width:120px}</style></head><body><div class="header"><div class="company">${company}</div><div class="muted">Recibo: ${id}</div></div><div class="box"><div class="row"><div><span class="label">Cliente:</span> ${(r.tx_person||r.person)||'-'}</div><div><span class="label">Valor:</span> ${Number(r.amount||0).toFixed(2)}</div></div><div class="row"><div><span class="label">Descrição:</span> ${r.tx_description||r.description||'-'}</div><div><span class="label">Método:</span> ${r.method||r.payment_method||'-'}</div></div><div class="row"><div><span class="label">Data:</span> ${receiptDate}</div><div><span class="label">Venc.:</span> ${dueDate}</div></div><div style="margin-top:12px"><strong>Observações:</strong><div>${r.note||r.notes||'-'}</div></div></div><div style="margin-top:18px"><button onclick="window.print()">Imprimir</button> <a href="/api/receipts/${id}/pdf" target="_blank" rel="noopener">Baixar PDF</a></div></body></html>`;
            if (!win) win = window.open('about:blank', '_blank');
            win.document.open(); win.document.write(html); win.document.close();
          } catch (err) {
            throw err;
          }
        }

        async function openReceiptPdf(id) {
          // Sempre abrir como HTML (para evitar bloqueios ou problemas com blob/pdf em alguns navegadores)
          let win = window.open('about:blank', '_blank');
          if (!win) { showToast('Popup bloqueado. Permita popups para abrir recibo.', 'warning'); return; }
          try {
            await openReceiptHtml(id, win);
          } catch (err) {
            console.error('Erro ao abrir recibo como HTML:', err);
            try { win.document.open(); win.document.write('<h3>Erro ao abrir recibo</h3><pre>' + (err && err.message ? err.message : String(err)) + '</pre>'); win.document.close(); } catch(e) { /* ignore */ }
            showToast('Falha ao abrir recibo.', 'danger');
          }
        }

        async function saveAccountNote(id) {
          const notes = (document.getElementById('accountNotes') || {}).value || ''; 
          try {
            await axios.put('/api/transactions/' + id, { notes });
            showToast('Nota salva.', 'success');
            await loadAccountsPrazo((document.getElementById('accountsPrazoSearch') || {}).value || '');
            // refresh receipts list for this transaction
            try { await loadReceiptHistoryForTransaction(id); } catch(e) { /* ignore */ }
          } catch (err) {
            console.error('Erro ao salvar nota:', err);
            showToast('Falha ao salvar nota.', 'danger');
          }
        }

        // --- Histórico de recibos (por transação / por cliente) ---
        async function loadReceiptHistoryForTransaction(txId) {
          const listEl = document.getElementById('accountReceiptsList');
          if (!listEl) return [];
          listEl.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;"><i class="fa fa-spinner fa-spin"></i> Carregando...</div>';
          try {
            const resp = await axios.get('/api/receipts', { params: { transactionId: txId, pageSize: 50 } });
            const items = resp.data && resp.data.data ? resp.data.data : [];
            if (!items.length) {
              listEl.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;"><i class="fa fa-receipt" style="font-size: 18px; display: block; margin-bottom: 8px;"></i>Nenhum recebimento registrado</div>';
              return items;
            }
            listEl.innerHTML = items.map(r => `
              <div class="receipt-item" data-id="${r.id}" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s;">
                <div style="min-width: 0;">
                  <div style="font-weight: 600; color: #1e293b; font-size: 13px;">${formatDateBR(r.createdAt)} — ${ (r.txDescription || 'Recebimento').slice(0, 30) }</div>
                  <div style="font-size: 11px; color: #64748b; margin-top: 2px;">${(r.note || '').length > 60 ? (r.note.slice(0,60)+'...') : (r.note || '-')}</div>
                </div>
                <div style="text-align: right; flex-shrink: 0;">
                  <div style="font-weight: 700; color: #059669; font-size: 14px;">${formatMoney(r.amount)}</div>
                  <div style="font-size: 11px; color: #94a3b8;">${r.method || ''}</div>
                </div>
              </div>
            `).join('');
            listEl.querySelectorAll('.receipt-item').forEach(item => {
              item.addEventListener('mouseenter', () => { item.style.borderColor = '#6366f1'; item.style.background = '#f8fafc'; });
              item.addEventListener('mouseleave', () => { item.style.borderColor = '#e2e8f0'; item.style.background = '#fff'; });
              item.addEventListener('click', (e) => { e.preventDefault(); const rid = item.dataset.id; openReceiptHtml(rid); });
            });
            return items;
          } catch (err) {
            console.error('Erro ao carregar recibos:', err);
            listEl.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;"><i class="fa fa-exclamation-triangle" style="display: block; margin-bottom: 8px;"></i>Falha ao carregar</div>';
            return [];
          }
        }

        async function loadClientReceipts(person) {
          try {
            const resp = await axios.get('/api/receipts', { params: { person, pageSize: 200 } });
            return resp.data && resp.data.data ? resp.data.data : [];
          } catch (err) {
            console.error('Erro ao carregar recibos do cliente:', err);
            throw err;
          }
        }

        // Gerar parcela restante: cria nova transação com o saldo e marca a transação atual como paga
        async function createRemainingInstallment(id) {
          const tx = state.accountsPrazo.items.find(t => t.id === id);
          if (!tx) return showToast('Transação não encontrada', 'warning');
          const value = parseFloat(tx.value || tx.amount || 0);
          const due = parseFloat(tx.valueDue || tx.value_due || 0);
          if (isNaN(value) || isNaN(due) || due <= 0) return showToast('Não há saldo para gerar parcela restante', 'warning');
          if (!(due < value)) return showToast('Esta conta não parece ter pagamento parcial. Use Receber para registrar pagamentos.', 'warning');

          const remaining = due; // valueDue already é o saldo remanescente
          // Default due date: usar a mesma data de vencimento da transação original
          const defaultDue = tx.dueDate || DateTimeUtils.todayISO();
          const defaultDueBR = formatDateBR(defaultDue);
          const ndRaw = prompt('Data de vencimento da nova parcela (DD/MM/YYYY):', defaultDueBR);
          if (!ndRaw) return;
          // Parse DD/MM/YYYY to YYYY-MM-DD for server
          const nd = parseDateBR(ndRaw) || ndRaw;
          if (!nd || !/\d{4}-\d{2}-\d{2}/.test(nd)) { Toast.error('Data inválida. Use DD/MM/YYYY ou YYYY-MM-DD.'); return; }
          if (!confirm('Gerar nova transação de ' + formatMoney(remaining) + ' com vencimento em ' + formatDateBR(nd) + ' e marcar a conta atual como PAGA?')) return;
          try {
            // Criar nova transação para o valor restante
            const newTxResp = await axios.post('/api/transactions', {
              category: tx.category || 'Outros',
              dueDate: nd,
              description: (tx.description ? tx.description + ' • Parcela restante' : 'Parcela restante'),
              person: tx.person,
              value: remaining,
              valueDue: remaining,
              paid: false,
              status: 'pendente'
            });

            // Atualizar transação atual: marcar como paga, zerar valueDue
            await axios.put('/api/transactions/' + id, { valueDue: 0, paid: true, status: 'pago', paymentDate: DateTimeUtils.nowForDB() });

            showToast('Parcela restante criada e conta original marcada como paga.', 'success');
            await loadAccountsPrazo((document.getElementById('accountsPrazoSearch') || {}).value || '');

            // Optionally open the created transaction in movimentos (removed)
            if (newTxResp && newTxResp.data && newTxResp.data.id) {
              const newId = newTxResp.data.id;
              // Opening Movimentos has been removed per UI cleanup
            }
          } catch (err) {
            console.error('Erro ao gerar parcela restante:', err, err && err.response && err.response.data ? err.response.data : 'no response');
            const serverMsg = err && err.response && err.response.data && (err.response.data.detail || err.response.data.error) ? (err.response.data.detail || err.response.data.error) : null;
            showToast(serverMsg ? ('Falha: ' + serverMsg) : 'Falha ao gerar parcela restante.', 'danger');
          }
        }

        // Render a person's accounts in the detail panel
        function renderPersonAccountsInDetail(person) {
          const txs = (state.accountsPrazo.items || []).filter(t => (t.person || '').trim() === (person || '').trim());
          const detailEl = document.getElementById('accountDetail');
          if (!detailEl) return;
          if (!txs.length) {
            detailEl.innerHTML = `
              <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; color: #94a3b8;">
                <div style="width: 70px; height: 70px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                  <i class="fa fa-inbox" style="font-size: 28px; color: #cbd5e1;"></i>
                </div>
                <h5 style="color: #64748b; margin-bottom: 8px;">Nenhuma conta encontrada</h5>
                <p style="font-size: 13px; margin: 0;">Este cliente não possui contas em aberto</p>
              </div>`;
            return;
          }

          const total = txs.reduce((s, t) => s + (parseFloat(t.valueDue || t.value || 0)), 0);
          const hoje = new Date();
          hoje.setHours(0,0,0,0);
          
          let html = `
            <div style="height: 100%; display: flex; flex-direction: column; overflow: hidden; padding: 16px;">
              <!-- Header do Cliente -->
              <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 16px; border-radius: 12px; margin-bottom: 12px; flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <span style="color: #fff; font-weight: 700; font-size: 18px;">${person.charAt(0).toUpperCase()}</span>
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <div style="color: #fff; font-weight: 700; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${person}</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 2px;">${txs.length} conta${txs.length > 1 ? 's' : ''} em aberto</div>
                  </div>
                  <div style="text-align: right; flex-shrink: 0;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Total</div>
                    <div style="color: #fff; font-weight: 700; font-size: 18px;">${formatMoney(total)}</div>
                  </div>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                  <button id="btnBackToClients" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                    <i class="fa fa-arrow-left"></i> Voltar
                  </button>
                  <button id="btnReceiveAll" style="background: #fff; border: none; color: #6366f1; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                    <i class="fa fa-check-circle"></i> Receber Tudo
                  </button>
                </div>
              </div>
              
              <!-- Lista de Contas com Scroll -->
              <div style="flex: 1; overflow-y: auto; min-height: 0; padding-right: 4px;">
                ${txs.map(t => {
                  const dueDate = t.dueDate ? new Date(t.dueDate) : null;
                  if (dueDate) dueDate.setHours(0,0,0,0);
                  const isVencida = dueDate && dueDate < hoje;
                  const badgeColor = isVencida ? '#ef4444' : '#6366f1';
                  const badgeBg = isVencida ? '#fef2f2' : '#eef2ff';
                  const borderColor = isVencida ? '#fecaca' : '#e2e8f0';
                  const bgColor = isVencida ? '#fef2f2' : '#fff';
                  
                  return `
                    <div class="account-tx-card" data-id="${t.id}" style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 10px; padding: 12px 14px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s;">
                      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                        <div style="flex: 1; min-width: 0;">
                          <div style="font-weight: 600; color: #1e293b; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${t.description || 'Sem descrição'}</div>
                          <div style="display: flex; align-items: center; gap: 6px; margin-top: 4px; flex-wrap: wrap;">
                            <span style="font-size: 10px; color: ${badgeColor}; background: ${badgeBg}; padding: 2px 6px; border-radius: 8px;">
                              ${isVencida ? '<i class="fa fa-exclamation-circle"></i> ' : ''}Venc: ${formatDateBR(t.dueDate) || '-'}
                            </span>
                            ${t.paymentMethod ? `<span style="font-size: 10px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 8px;">${t.paymentMethod}</span>` : ''}
                          </div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                          <div style="font-weight: 700; color: #059669; font-size: 14px;">${formatMoney(t.valueDue)}</div>
                          <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">Clique para ações</div>
                        </div>
                      </div>
                    </div>`;
                }).join('')}
              </div>
            </div>`;
          detailEl.innerHTML = html;
          
          // Wire handlers
          document.getElementById('btnBackToClients').addEventListener('click', () => { 
            state.accountsPrazo.selectedPerson = null; 
            renderAccountsList(); 
          });
          
          const btnReceiveAll = document.getElementById('btnReceiveAll');
          if (btnReceiveAll) {
            btnReceiveAll.addEventListener('click', async () => {
              const result = await showPaymentInputModal({
                title: 'Receber Todas as Contas',
                subtitle: person + ' (' + txs.length + ' conta' + (txs.length > 1 ? 's' : '') + ')',
                icon: 'fa-layer-group',
                headerGradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                buttonGradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                buttonShadow: 'rgba(245,158,11,0.3)',
                dueValue: total,
                defaultValue: total,
                showMethod: true,
                showNotes: false,
                defaultMethod: 'dinheiro',
                confirmText: 'Receber Todas'
              });
              
              if (!result) return; // Cancelou
              
              const { method: methodInput } = result;
              const method = normalizePaymentMethod(methodInput);
              let successCount = 0;
              for (const tx of txs) {
                try {
                  const resp = await receivePayment(tx.id, parseFloat(tx.valueDue || tx.value || 0), method, 'Recebimento em lote via PDV');
                  if (resp && resp.id) successCount++;
                } catch (e) { console.error('Erro ao receber conta:', tx.id, e); }
              }
              showToast(successCount + ' de ' + txs.length + ' conta(s) recebida(s) com sucesso!', successCount === txs.length ? 'success' : 'warning');
              await loadAccountsPrazo((document.getElementById('accountsPrazoSearch') || {}).value || '');
            });
          }
          
          detailEl.querySelectorAll('.account-tx-card').forEach(card => {
            card.addEventListener('mouseenter', () => card.style.borderColor = '#6366f1');
            card.addEventListener('mouseleave', () => card.style.borderColor = card.querySelector('[style*="fecaca"]') ? '#fecaca' : '#e2e8f0');
            card.addEventListener('click', (e) => { 
              e.preventDefault(); 
              const id = card.dataset.id; 
              selectAccount(id); 
            });
          });
        }

        function selectPerson(person) {
          state.accountsPrazo.selectedPerson = person;
          state.accountsPrazo.selectedId = null;
          document.querySelectorAll('#accountsPrazoList .account-card').forEach(el => {
            const isSelected = el.dataset.person === person;
            el.style.background = isSelected ? '#eef2ff' : '#fff';
            el.style.borderColor = isSelected ? '#6366f1' : '#e2e8f0';
          });
          renderPersonAccountsInDetail(person);
        }

        // Wrapper para selectAccount que adiciona funcionalidades extras
        const originalSelectAccount = selectAccount;
        function selectAccountWithReceive(id) {
          originalSelectAccount(id);
          // load receipts for this transaction right away
          setTimeout(() => {
            try { loadReceiptHistoryForTransaction(id); } catch(e) { console.warn('Falha ao carregar histórico de recibos:', e); }
            
            // Attach btnReceive handler
            const _btnReceive = document.getElementById('btnReceive');
            if (_btnReceive && !_btnReceive._hasListener) {
              _btnReceive._hasListener = true;
              _btnReceive.addEventListener('click', async () => {
                const currentId = state.accountsPrazo.selectedId;
                if (!currentId) return;
                try {
                  const tx = state.accountsPrazo.items.find(t => t.id === currentId);
                  if (!tx) return;
                  
                  const result = await showPaymentInputModal({
                    title: 'Receber Pagamento',
                    subtitle: tx.person || 'Cliente',
                    icon: 'fa-hand-holding-dollar',
                    headerGradient: 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
                    buttonGradient: 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
                    buttonShadow: 'rgba(16,185,129,0.3)',
                    dueValue: parseFloat(tx.valueDue || 0),
                    defaultValue: parseFloat(tx.valueDue || 0),
                    showMethod: true,
                    showNotes: false,
                    defaultMethod: 'dinheiro',
                    confirmText: 'Receber'
                  });
                  
                  if (!result) return; // Cancelou
                  
                  const { amount: amt, method: methodInput } = result;
                  const method = normalizePaymentMethod(methodInput);
                  
                  const resp = await receivePayment(currentId, amt, method, 'Recebimento via PDV');
                  if (resp && resp.id) {
                    showToast('Recebimento registrado e recibo gerado.', 'success');
                    try {
                      const originalDue = parseFloat(tx.valueDue || tx.value || 0);
                      if (amt >= originalDue) {
                        const sale = { items: [{ name: tx.description || 'Pagamento', qty:1, price: originalDue }], total: originalDue, received: amt, method: resp.receipt && resp.receipt.method ? resp.receipt.method : (method || '-'), client: tx.person || '-', date: DateTimeUtils.nowForDB(), note: tx.notes || '' };
                        openElginModal(sale);
                        try { const auto = localStorage.getItem('elgin_auto_print') === '1'; const useEsc = localStorage.getItem('elgin_use_escpos') === '1'; if (auto) { const payload = { coupon: document.getElementById('elginCouponPreview').textContent, sale, device: useEsc ? 'elgin-i8' : 'elgin-i8', escpos: useEsc, autoPrint: true }; const pr = await axios.post('/api/print/elgin', payload); if (pr && pr.data) showToast('Impressão enviada (automático).', 'success'); } } catch(e) { console.warn('Falha ao enviar impressão automática:', e); }
                      }
                    } catch(e) { console.error('Erro ao decidir impressão de cupom:', e); }
                    await loadAccountsPrazo((document.getElementById('accountsPrazoSearch') || {}).value || '');
                    try { await loadReceiptHistoryForTransaction(currentId); } catch(e) { /* ignore */ }
                  }
                } catch (e) {
                  console.error('Erro ao processar recebimento:', e, e && e.response && e.response.data ? e.response.data : 'no response');
                  const serverMsg = e && e.response && e.response.data && (e.response.data.detail || e.response.data.error) ? (e.response.data.detail || e.response.data.error) : null;
                  showToast(serverMsg ? ('Falha: ' + serverMsg) : 'Falha ao processar recebimento.', 'danger');
                }
              });
            }
            
            // Attach btnPixAccount handler (PIX)
            const _btnPixAccount = document.getElementById('btnPixAccount');
            if (_btnPixAccount && !_btnPixAccount._hasListener) {
              _btnPixAccount._hasListener = true;
              _btnPixAccount.addEventListener('click', async () => {
                const currentId = state.accountsPrazo.selectedId;
                if (!currentId) return;
                try {
                  const tx = state.accountsPrazo.items.find(t => t.id === currentId);
                  if (!tx) return;
                  
                  const result = await showPaymentInputModal({
                    title: 'Pagamento via PIX',
                    subtitle: tx.person || 'Cliente',
                    icon: 'fa-qrcode',
                    headerGradient: 'linear-gradient(135deg, #00b4a0 0%, #32cbbc 100%)',
                    buttonGradient: 'linear-gradient(135deg, #00b4a0 0%, #32cbbc 100%)',
                    buttonShadow: 'rgba(0,180,160,0.3)',
                    dueValue: parseFloat(tx.valueDue || 0),
                    defaultValue: parseFloat(tx.valueDue || 0),
                    showMethod: false, // PIX já é o método
                    showNotes: false,
                    defaultMethod: 'pix',
                    confirmText: 'Receber PIX'
                  });
                  
                  if (!result) return; // Cancelou
                  
                  const { amount: amt } = result;
                  const method = 'pix';
                  
                  const resp = await receivePayment(currentId, amt, method, 'Recebimento PIX via PDV');
                  if (resp && resp.id) {
                    showToast('Pagamento PIX registrado!', 'success');
                    try {
                      const originalDue = parseFloat(tx.valueDue || tx.value || 0);
                      if (amt >= originalDue) {
                        const sale = { items: [{ name: tx.description || 'Pagamento', qty:1, price: originalDue }], total: originalDue, received: amt, method: 'PIX', client: tx.person || '-', date: DateTimeUtils.nowForDB(), note: tx.notes || '' };
                        openElginModal(sale);
                      }
                    } catch(e) { console.error('Erro ao decidir impressão de cupom:', e); }
                    await loadAccountsPrazo((document.getElementById('accountsPrazoSearch') || {}).value || '');
                    try { await loadReceiptHistoryForTransaction(currentId); } catch(e) { /* ignore */ }
                  }
                } catch (e) {
                  console.error('Erro ao processar recebimento PIX:', e);
                  showToast('Falha ao processar recebimento PIX.', 'danger');
                }
              });
            }

            // View client receipts button
            const _btnViewClientReceipts = document.getElementById('btnViewClientReceipts');
            if (_btnViewClientReceipts && !_btnViewClientReceipts._hasListener) {
              _btnViewClientReceipts._hasListener = true;
              _btnViewClientReceipts.addEventListener('click', async () => {
                const currentId = state.accountsPrazo.selectedId;
                if (!currentId) return;
                const tx = state.accountsPrazo.items.find(t => t.id === currentId);
                if (!tx || !tx.person) return showToast('Pessoa não identificada para este registro', 'warning');
                try {
                  const list = await loadClientReceipts(tx.person);
                  const modalBody = document.getElementById('bulkReceiveModalBody');
                  if (!modalBody) { console.error('Modal não encontrado'); return showToast('Erro interno: modal não encontrado', 'danger'); }
                  modalBody.innerHTML = `<div style="max-height:60vh; overflow:auto;"><h5>Histórico de recebimentos - ${tx.person}</h5><div style="margin-top:8px">${list.length ? list.map(r => `<div style="padding:8px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center"><div><div><strong>${formatDateBR(r.createdAt)}</strong> - ${r.txDescription || ''}</div><div class="small-muted">${r.note || ''}</div></div><div style="text-align:right"><div>${formatMoney(r.amount)}</div><div class="small-muted">${r.method || ''}</div><div style="margin-top:6px"><a href="#" data-id="${r.id}" class="open-client-receipt">Abrir</a></div></div></div>`).join('') : '<div class="text-muted p-2">Nenhum recebimento encontrado.</div>'}</div></div>`;
                  if (window.jQuery) window.jQuery('#bulkReceiveModal').modal('show'); else { const modalEl = document.getElementById('bulkReceiveModal'); try { const inst = window.bootstrap.Modal.getOrCreateInstance(modalEl); inst.show(); } catch(e) { modalEl.classList.add('show'); } }
                  modalBody.querySelectorAll('.open-client-receipt').forEach(a => a.addEventListener('click', (e) => { e.preventDefault(); const rid = a.getAttribute('data-id'); openReceiptHtml(rid); }));
                } catch(e) { console.error('Erro ao carregar histórico do cliente:', e); showToast('Falha ao carregar histórico do cliente', 'danger'); }
              });
            }
          }, 40);
        }

        // Replace original selectAccount references
        try { window.selectAccount = selectAccountWithReceive; } catch(e) { /* ignore - used when not in window scope */ }
        // Also ensure internal calls use the new wrapper
        selectAccount = selectAccountWithReceive;

        // Selection helpers for bulk receiving
        function toggleSelect(id, checked) {
          if (!state.accountsPrazo.selectedIds) state.accountsPrazo.selectedIds = [];
          if (checked) {
            if (!state.accountsPrazo.selectedIds.includes(id)) state.accountsPrazo.selectedIds.push(id);
          } else {
            state.accountsPrazo.selectedIds = state.accountsPrazo.selectedIds.filter(x => x !== id);
          }
          updateBulkState();
          // update selectAll checkbox
          const sa = document.getElementById('accountsSelectAll');
          if (sa) {
            const total = (state.accountsPrazo.items || []).length;
            sa.checked = state.accountsPrazo.selectedIds.length === total && total > 0;
          }
        }

        function toggleSelectAll(check) {
          const items = state.accountsPrazo.items || [];
          state.accountsPrazo.selectedIds = check ? items.map(i => i.id) : [];
          document.querySelectorAll('#accountsPrazoList .account-select').forEach(cb => cb.checked = check);
          updateBulkState();
        }

        function updateBulkState() {
          const n = (state.accountsPrazo.selectedIds || []).length;
          const btn = document.getElementById('btnBulkReceive');
          if (btn) {
            btn.disabled = n === 0;
            btn.textContent = 'Receber selecionadas' + (n ? ' (' + n + ')' : '');
          }
        }

        async function bulkReceiveSelected() {
          // Open a modal to review amounts for selected items
          const ids = state.accountsPrazo.selectedIds || [];
          if (!ids.length) return;
          // Build modal rows
          const modalBody = document.getElementById('bulkReceiveModalBody');
          if (!modalBody) { console.error('Modal de recebimento não encontrado'); return Toast.error('Erro interno: modal não encontrado'); }
          modalBody.innerHTML = '';
          const items = ids.map(id => {
            const tx = state.accountsPrazo.items.find(t => t.id === id);
            return Object.assign({}, tx, { receiveAmount: parseFloat(tx.valueDue || tx.value) });
          });
          const table = document.createElement('div');
          table.innerHTML = `
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
              <div style="flex:1;font-weight:700">Cliente / Descrição</div>
              <div style="width:140px;font-weight:700">Valor a Receber</div>
              <div style="width:140px;font-weight:700">Método</div>
            </div>
          `;
          items.forEach((it, idx) => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.gap = '8px';
            row.style.alignItems = 'center';
            row.style.marginBottom = '6px';
            row.innerHTML = `
              <div style="flex:1">${it.person || 'Cliente'} • <small class="text-muted">${it.description || ''}</small></div>
              <div style="width:140px"><input class="form-control form-control-sm bulk-amt" data-id="${it.id}" value="${it.receiveAmount.toFixed(2)}" /></div>
              <div style="width:140px"><input class="form-control form-control-sm bulk-method" data-id="${it.id}" value="dinheiro" placeholder="Ex: dinheiro, pix, cartão" /></div>
            `;
            table.appendChild(row);
          });
          modalBody.appendChild(table);
          const _bulkCountEl = document.getElementById('bulkReceiveCount'); if (_bulkCountEl) _bulkCountEl.textContent = ids.length;
          // Show modal
          if (window.jQuery) window.jQuery('#bulkReceiveModal').modal('show');
          else {
            const modalEl = document.getElementById('bulkReceiveModal');
            try { const inst = window.bootstrap.Modal.getOrCreateInstance(modalEl); inst.show(); } catch(e) { modalEl.classList.add('show'); }
          }
        }

        // Wire up select-all and bulk button handlers
        setTimeout(() => {
          try {
            const _accountsSelectAll = document.getElementById('accountsSelectAll'); if (_accountsSelectAll) _accountsSelectAll.addEventListener('change', (e) => toggleSelectAll(e.target.checked));
            const _btnBulkReceive = document.getElementById('btnBulkReceive'); if (_btnBulkReceive) _btnBulkReceive.addEventListener('click', bulkReceiveSelected);
            updateBulkState();

            // Confirm bulk handler
            const _btnConfirmBulkReceive = document.getElementById('btnConfirmBulkReceive'); if (_btnConfirmBulkReceive) _btnConfirmBulkReceive.addEventListener('click', async () => {
              const rows = Array.from(document.querySelectorAll('#bulkReceiveModalBody .bulk-amt'));
              const items = rows.map(inp => {
                const id = inp.dataset.id;
                const amount = parseFloat(inp.value.replace(',', '.')) || 0;
                const methodInput = (document.querySelector('#bulkReceiveModalBody .bulk-method[data-id="' + id + '"]') || {}).value || 'dinheiro';
                const method = normalizePaymentMethod(methodInput);
                return { id, amount, method, note: 'Recebimento em lote via PDV' };
              }).filter(it => it.amount > 0);
              if (!items.length) return Toast.warning('Nenhum valor válido informado', 'Recebimento');
              try {
                const res = await axios.post('/api/transactions/bulk-receive', { items });
                if (res.data && res.data.receipts) {
                  showToast('Recebimentos processados.', 'success');
                  (res.data.receipts || []).slice(0,10).forEach(r => openReceiptHtml(r.id));
                  if (window.jQuery) window.jQuery('#bulkReceiveModal').modal('hide');
                  await loadAccountsPrazo((document.getElementById('accountsPrazoSearch') || {}).value || '');
                  state.accountsPrazo.selectedIds = [];
                  toggleSelectAll(false);
                  updateBulkState();
                }
              } catch (err) {
                console.error('Erro no recebimento em lote (confirm):', err, err && err.response && err.response.data ? err.response.data : 'no response');
                const serverMsg = err && err.response && err.response.data && (err.response.data.detail || err.response.data.error) ? (err.response.data.detail || err.response.data.error) : null;
                showToast(serverMsg ? ('Falha: ' + serverMsg) : 'Falha ao processar recebimentos.', 'danger');
              }
            });
          } catch(e) { /* ignore */ }
        }, 20);

        // --- Lógica do Carrinho ---
        function addToCart(productId) {
          const product = state.allProducts.find(p => p.id === productId);
          if (!product) return;

          const available = (typeof product.stock === 'number') ? product.stock : 0;
          const cartItem = state.cart.find(item => item.id === productId);
          const currentQty = cartItem ? cartItem.qty : 0;

          if (available <= currentQty) {
            showToast(`Estoque insuficiente para ${product.name}. Disponível: ${available}`, 'warning');
            playSound('low');
            return;
          }

          if (cartItem) {
            cartItem.qty++;
          } else {
            state.cart.push({ ...product, qty: 1 });
          }
          renderCart();
          
          // Feedback visual
          showToast(`${product.name} adicionado`, 'success');
          // Sound feedback
          playSound('add');
        }

        function addToCartByBarcode(code) {
          const product = state.allProducts.find(p => 
            (p.code && p.code.toString() === code) || 
            (p.sku && p.sku === code) ||
            (p.barcode && p.barcode === code) ||
            (p.id && p.id.toString() === code)
          );
          
          if (product) {
            // reuse addToCart which includes stock checks
            addToCart(product.id);
            barcodeInput.value = '';
            barcodeInput.focus();
          } else {
            showToast('Produto não encontrado!', 'danger');
            playSound('error');
            barcodeInput.select();
          }
        }

        function updateCartItem(productId, action) {
          const cartItem = state.cart.find(item => String(item.id) === String(productId));
          if (!cartItem) return;

          if (action === 'inc') {
            // Check stock before incrementing
            const prod = state.allProducts.find(p => String(p.id) === String(productId));
            const available = (prod && typeof prod.stock === 'number') ? prod.stock : 0;
            if (cartItem.qty + 1 > available) {
              showToast(`Estoque insuficiente para ${cartItem.name}. Disponível: ${available}`, 'warning');
              playSound('low');
            } else {
              cartItem.qty++;
            }
          } else if (action === 'dec') {
            cartItem.qty--;
            if (cartItem.qty <= 0) {
              state.cart = state.cart.filter(item => String(item.id) !== String(productId));
              playSound('remove');
            }
          } else if (action === 'rem') {
            state.cart = state.cart.filter(item => String(item.id) !== String(productId));
            playSound('remove');
          }
          renderCart();
        }
        
        function clearCart() {
            state.cart = [];
            state.discount = 0;
            state.addition = 0;
            state.currentClient = null;
            renderCart();
        }

        // --- Vendas em Espera ---
        function holdSale() {
          if (state.cart.length === 0) {
            showToast('Carrinho vazio!', 'warning');
            return;
          }

          const subtotal = state.cart.reduce((s, it) => s + (it.price * it.qty), 0);
          const total = subtotal - state.discount + state.addition;

          const pendingSale = {
            cart: [...state.cart],
            discount: state.discount,
            addition: state.addition,
            client: state.currentClient,
            total: total,
            time: DateTimeUtils.formatTime(new Date()).slice(0, 5)
          };

          state.pendingSales.push(pendingSale);
          clearCart();
          renderPendingSales();
          showToast('Venda colocada em espera!', 'info');
          playSound('hold');
        }

        function restorePendingSale(index) {
          const sale = state.pendingSales[index];
          if (!sale) return;

          // Se há itens no carrinho atual, perguntar
          if (state.cart.length > 0) {
            if (!confirm('Há itens no carrinho atual. Deseja substituir pela venda em espera?')) {
              return;
            }
          }

          state.cart = [...sale.cart];
          state.discount = sale.discount;
          state.addition = sale.addition;
          state.currentClient = sale.client;
          state.pendingSales.splice(index, 1);
          
          renderCart();
          renderPendingSales();
          showToast('Venda restaurada!', 'success');
        }

        // --- Toast notifications (usa o sistema elegante global) ---
        function showToast(message, type = 'info') {
          // Mapeia o tipo antigo para o novo sistema
          const typeMap = {
            'success': 'success',
            'danger': 'error',
            'warning': 'warning',
            'info': 'info'
          };
          const mappedType = typeMap[type] || 'info';
          
          // Usa o mini toast para mensagens de sucesso (mais compacto e rápido)
          // Usa o toast completo para erros e avisos (mais visível)
          if (window.Toast) {
            if (mappedType === 'success' && window.Toast.mini) {
              window.Toast.mini(message, mappedType);
            } else if (window.Toast[mappedType]) {
              window.Toast[mappedType](message);
            }
          } else {
            // Fallback caso o toast.js não esteja carregado
            console.log(`[${type}] ${message}`);
          }
        }

        // --- Sistema de Pagamento Misto Inteligente ---
        // Armazena os pagamentos adicionados
        let paymentMethods = [];
        let paymentIdCounter = 0;

        const paymentMethodOptions = [
            { value: 'cash', label: 'Dinheiro', icon: 'fa-money-bill-wave', color: '#10b981' },
            { value: 'pix', label: 'PIX', icon: 'fa-qrcode', color: '#06b6d4' },
            { value: 'card', label: 'Crédito', icon: 'fa-credit-card', color: '#8b5cf6' },
            { value: 'debit', label: 'Débito', icon: 'fa-credit-card', color: '#3b82f6' },
            { value: 'prazo', label: 'A Prazo', icon: 'fa-calendar-alt', color: '#f59e0b' }
        ];

        function getTotal() {
            const subtotal = state.cart.reduce((s, it) => s + (it.price * it.qty), 0);
            return subtotal - state.discount + state.addition;
        }

        function getTotalPaid() {
            return paymentMethods.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
        }

        function getRemainingToPay() {
            return Math.max(0, getTotal() - getTotalPaid());
        }

        function addPaymentMethod(preselectedMethod = null, preselectedAmount = null) {
            const total = getTotal();
            const remaining = getRemainingToPay();
            
            if (remaining <= 0 && paymentMethods.length > 0) {
                showToast('Valor total já foi coberto!', 'warning');
                return;
            }

            const id = ++paymentIdCounter;
            const defaultAmount = preselectedAmount || remaining;
            
            paymentMethods.push({
                id,
                method: preselectedMethod || 'cash',
                amount: defaultAmount
            });

            renderPaymentMethods();
            updatePaymentSummary();
            
            // Se o método pré-selecionado for PIX, gerar QR Code automaticamente
            if (preselectedMethod === 'pix' && defaultAmount > 0) {
                setTimeout(async () => {
                    const configured = await checkPixConfigured();
                    if (!configured) {
                        Modal.warning('PIX não configurado!\n\nAcesse: Admin > Integrações\nE configure as credenciais do Mercado Pago.', 'PIX');
                        return;
                    }
                    payModal.modal('hide');
                    await gerarPixQrCode(defaultAmount, `Venda PDV - ${state.cart.length} item(s)`);
                }, 100);
            }
        }

        function removePaymentMethod(id) {
            paymentMethods = paymentMethods.filter(p => p.id !== id);
            renderPaymentMethods();
            updatePaymentSummary();
            
            // Se não houver mais pagamentos, adicionar um novo
            if (paymentMethods.length === 0) {
                addPaymentMethod();
            }
        }

        function updatePaymentAmount(id, amount) {
            const payment = paymentMethods.find(p => p.id === id);
            if (payment) {
                payment.amount = parseFloat(amount) || 0;
                updatePaymentSummary();
            }
        }

        function updatePaymentMethodType(id, method) {
            const payment = paymentMethods.find(p => p.id === id);
            if (payment) {
                payment.method = method;
                updatePaymentSummary();
                
                // Mostrar/esconder opção de parcelas se for prazo
                const hasPrazo = paymentMethods.some(p => p.method === 'prazo');
                document.getElementById('installmentsGroup').style.display = hasPrazo ? 'block' : 'none';
                
                // Se selecionou PIX, gerar QR Code automaticamente
                if (method === 'pix') {
                    const pixAmount = parseFloat(payment.amount) || 0;
                    if (pixAmount > 0) {
                        // Fechar modal de pagamento e abrir PIX
                        setTimeout(async () => {
                            const configured = await checkPixConfigured();
                            if (!configured) {
                                Modal.warning('PIX não configurado!\n\nAcesse: Admin > Integrações\nE configure as credenciais do Mercado Pago.', 'PIX');
                                return;
                            }
                            // Esconder modal de pagamento temporariamente
                            payModal.modal('hide');
                            // Gerar QR Code
                            await gerarPixQrCode(pixAmount, `Venda PDV - ${state.cart.length} item(s)`);
                        }, 100);
                    }
                }
            }
        }

        function renderPaymentMethods() {
            const container = document.getElementById('paymentMethodsList');
            const total = getTotal();
            
            container.innerHTML = paymentMethods.map((payment, index) => {
                const optionsHtml = paymentMethodOptions.map(opt => 
                    `<option value="${opt.value}" ${payment.method === opt.value ? 'selected' : ''}>${opt.label}</option>`
                ).join('');
                
                const methodInfo = paymentMethodOptions.find(m => m.value === payment.method);
                const isOnlyOne = paymentMethods.length === 1;
                
                return `
                    <div class="payment-method-row" style="display: flex; gap: 10px; align-items: center; padding: 10px; background: #fff; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                        <div style="flex: 0 0 40px; text-align: center;">
                            <i class="fa ${methodInfo?.icon || 'fa-money-bill'}" style="font-size: 20px; color: ${methodInfo?.color || '#6366f1'};"></i>
                        </div>
                        <div style="flex: 1;">
                            <select class="form-control form-control-sm" onchange="updatePaymentMethodType(${payment.id}, this.value)" style="font-weight: 600;">
                                ${optionsHtml}
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" style="background: #f1f5f9; font-weight: 600;">R$</span>
                                </div>
                                <input type="number" step="0.01" min="0" max="${total}" 
                                    class="form-control" style="font-weight: 600; font-size: 16px;" 
                                    value="${payment.amount.toFixed(2)}"
                                    onchange="updatePaymentAmount(${payment.id}, this.value)"
                                    oninput="updatePaymentAmount(${payment.id}, this.value)">
                            </div>
                        </div>
                        <div style="flex: 0 0 40px;">
                            ${!isOnlyOne ? `
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePaymentMethod(${payment.id})" title="Remover">
                                    <i class="fa fa-times"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updatePaymentSummary() {
            const total = getTotal();
            const totalPaid = getTotalPaid();
            const remaining = getRemainingToPay();
            const change = Math.max(0, totalPaid - total);
            
            const summaryEl = document.getElementById('paymentsSummary');
            const totalPaidEl = document.getElementById('totalPaidSoFar');
            const remainingEl = document.getElementById('remainingToPay');
            const remainingLabelEl = document.getElementById('remainingLabel');
            const changeValEl = document.getElementById('changeVal');
            
            // Mostrar resumo se houver mais de um pagamento ou se valor diferir do total
            summaryEl.style.display = (paymentMethods.length > 1 || Math.abs(totalPaid - total) > 0.01) ? 'block' : 'none';
            
            totalPaidEl.textContent = formatMoney(totalPaid);
            
            if (totalPaid >= total) {
                remainingLabelEl.textContent = 'Troco a dar:';
                remainingLabelEl.style.color = '#10b981';
                remainingEl.textContent = formatMoney(change);
                remainingEl.style.color = '#10b981';
            } else {
                remainingLabelEl.textContent = 'Falta pagar:';
                remainingLabelEl.style.color = '#dc2626';
                remainingEl.textContent = formatMoney(remaining);
                remainingEl.style.color = '#dc2626';
            }
            
            // Atualizar troco no resumo
            if (changeValEl) {
                changeValEl.textContent = formatMoney(change);
            }
            
            // Atualizar informações de parcelamento se houver prazo
            updateInstallmentInfo();
        }

        // Expor funções de pagamento no escopo global para onclick
        window.addPaymentMethod = addPaymentMethod;
        window.removePaymentMethod = removePaymentMethod;
        window.updatePaymentAmount = updatePaymentAmount;
        window.updatePaymentMethodType = updatePaymentMethodType;

        function openCheckout() {
            if (state.cart.length === 0) {
                Toast.warning('O carrinho está vazio.', 'Carrinho');
                return;
            }
            const subtotal = state.cart.reduce((s, it) => s + (it.price * it.qty), 0);
            const total = subtotal - state.discount + state.addition;
            
            // Atualizar valores no modal
            document.getElementById('modalSubtotal').textContent = formatMoney(subtotal);
            document.getElementById('modalDiscount').textContent = formatMoney(state.discount);
            modalTotalEl.textContent = formatMoney(total);
            
            // Resetar pagamentos e adicionar o primeiro
            paymentMethods = [];
            paymentIdCounter = 0;
            addPaymentMethod('cash', total);
            
            // Esconder parcelas inicialmente
            document.getElementById('installmentsGroup').style.display = 'none';
            document.getElementById('installments').value = '2';
            
            updatePaymentSummary();
            payModal.modal('show');
        }

        function calculateChange() {
            updatePaymentSummary();
        }

        function updateInstallmentInfo() {
            const total = getTotal();
            const installments = parseInt(document.getElementById('installments').value) || 1;
            const installmentInfo = document.getElementById('installmentInfo');
            
            // Calcular entrada (pagamentos à vista) e valor a parcelar
            const entryPayments = paymentMethods.filter(p => p.method !== 'prazo');
            const prazoPayments = paymentMethods.filter(p => p.method === 'prazo');
            
            const entryValue = entryPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const prazoValue = prazoPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            
            // Elementos do resumo de parcelamento
            const installmentSummary = document.getElementById('installmentSummary');
            const entryAmountEl = document.getElementById('entryAmount');
            const remainingAmountEl = document.getElementById('remainingAmount');
            const installmentDisplayEl = document.getElementById('installmentDisplay');
            
            // Mostrar seção de parcelamento se houver valor a prazo
            const showInstallmentSummary = prazoValue > 0 && installments >= 1;
            if (installmentSummary) {
                installmentSummary.style.display = showInstallmentSummary ? 'block' : 'none';
            }
            
            if (prazoValue > 0) {
                const valuePerInstallment = prazoValue / installments;
                
                installmentInfo.innerHTML = `<i class="fa fa-calculator mr-1"></i>${installments}x de ${formatMoney(valuePerInstallment)} a prazo - 1ª parcela em 30 dias`;
                installmentInfo.className = 'text-info mt-2 font-weight-bold';
                
                if (showInstallmentSummary && entryAmountEl && remainingAmountEl && installmentDisplayEl) {
                    entryAmountEl.textContent = formatMoney(entryValue);
                    remainingAmountEl.textContent = formatMoney(prazoValue);
                    installmentDisplayEl.textContent = `${installments}x ${formatMoney(valuePerInstallment)}`;
                }
            } else {
                installmentInfo.textContent = 'Pagamento à vista';
                installmentInfo.className = 'text-muted mt-2';
            }
        }

        async function finalizeSale() {
            // DEBUG: confirmar que finalizeSale foi chamado
            try { console.debug('[PDV] finalizeSale called', { cart: state.cart.slice(), payments: paymentMethods.slice(), totalPaid: getTotalPaid(), remaining: getRemainingToPay() }); } catch(e){}
            try { if (typeof showToast === 'function') showToast('Iniciando confirmação da venda...', 'info'); } catch(e){}

            // Validações básicas
            const subtotal = state.cart.reduce((s, it) => s + (it.price * it.qty), 0);
            const total = subtotal - state.discount + state.addition;
            const client = document.getElementById('payClient').value || 'Cliente Padrão';
            const installments = parseInt(document.getElementById('installments').value) || 1;
            
            // Usar o novo sistema de pagamento misto
            const totalPaid = getTotalPaid();
            const remaining = getRemainingToPay();

            // Validação: precisa de cliente se tiver valor a prazo
            const prazoPayments = paymentMethods.filter(p => p.method === 'prazo');
            const prazoValue = prazoPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            
            if (prazoValue > 0 && (!client || client === 'Cliente Padrão')) {
                Toast.warning('Para vendas a prazo, é necessário informar o nome do cliente.', 'Cliente Obrigatório');
                document.getElementById('payClient').focus();
                return;
            }

            // Validação: verificar se o valor total foi coberto (pode ter troco se for dinheiro)
            const cashPayments = paymentMethods.filter(p => p.method === 'cash');
            const nonCashPaid = paymentMethods.filter(p => p.method !== 'cash').reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            
            if (remaining > 0.01 && prazoValue === 0) {
                // Só permite falta se tiver prazo
                Toast.warning(`Faltam ${formatMoney(remaining)} para completar o pagamento. Adicione mais uma forma de pagamento ou selecione "A Prazo" para parcelar.`, 'Pagamento Incompleto');
                return;
            }

            // Checar estoque localmente antes de tentar finalizar
            for (const item of state.cart) {
                const product = state.allProducts.find(p => String(p.id) === String(item.id));
                if (product && typeof product.stock === 'number' && item.qty > product.stock) {
                    Toast.error(`Estoque insuficiente para ${product.name}. Disponível: ${product.stock}, solicitado: ${item.qty}`, 'Estoque');
                    return;
                }
            }

            const itemsDescription = `Itens: ${state.cart.map(item => `${item.name} (${item.qty}x)`).join(', ')}`;
            
            // Calcular troco (apenas em pagamentos dinheiro que excedam o necessário)
            const changeAmount = Math.max(0, totalPaid - total);
            
            // Calcular valor efetivamente pago à vista (sem prazo)
            const entryPayments = paymentMethods.filter(p => p.method !== 'prazo');
            const entryValue = entryPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            
            // Método de pagamento principal (o de maior valor ou o primeiro)
            const sortedMethods = [...paymentMethods].sort((a, b) => b.amount - a.amount);
            const primaryMethod = sortedMethods[0]?.method || 'cash';

            try {
                // Evita envios duplicados
                if (confirmPayBtn) confirmPayBtn.disabled = true;

                // Preparar payload da venda com informações de pagamento misto
                const salePayload = {
                    clientName: client,
                    clientPhone: null,
                    clientEmail: null,
                    subtotal: subtotal,
                    discount: state.discount,
                    total: total,
                    // Método principal (para compatibilidade)
                    paymentMethod: primaryMethod,
                    // Novo: lista de todos os pagamentos
                    payments: paymentMethods.map(p => ({
                        method: p.method,
                        amount: parseFloat(p.amount) || 0
                    })),
                    // Valor pago à vista (entrada)
                    amountPaid: Math.min(entryValue, total),
                    // Valor a prazo
                    amountPrazo: prazoValue,
                    changeAmount: changeAmount,
                    installments: prazoValue > 0 ? installments : 1,
                    notes: `PDV sale - ${itemsDescription}`,
                    items: state.cart.map(it => ({
                        productId: it.id,
                        productName: it.name,
                        productSku: it.sku || it.code || null,
                        quantity: it.qty,
                        unitPrice: it.price,
                        totalPrice: it.qty * it.price
                    }))
                };

                // Antes de enviar, buscar estoque atualizado no servidor para cada produto (paralelo)
                try {
                  const ids = salePayload.items.map(i => i.productId).filter(Boolean);
                  const uniqueIds = [...new Set(ids)];
                  const latest = await Promise.all(uniqueIds.map(id => axios.get('/api/products/' + id).then(r => r.data).catch(() => null)));
                  for (const it of salePayload.items) {
                    const latestProd = latest.find(p => p && p.id === it.productId);
                    if (latestProd && typeof latestProd.stock === 'number' && it.quantity > latestProd.stock) {
                      throw new Error(`Estoque insuficiente para ${it.productName}. Disponível: ${latestProd.stock}, solicitado: ${it.quantity}`);
                    }
                  }
                } catch (stockErr) {
                  const msg = (stockErr && stockErr.message) ? stockErr.message : 'Erro ao verificar estoque.';
                  Toast.error(msg, 'Estoque');
                  playSound('error');
                  return;
                }

                // Mostrar indicador de processamento
                const originalBtnText = confirmPayBtn.innerHTML;
                confirmPayBtn.disabled = true;
                confirmPayBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>Processando...';

                // Enviar para servidor
                const resp = await axios.post('/api/sales', salePayload);

                // Restaurar botão
                confirmPayBtn.disabled = false;
                confirmPayBtn.innerHTML = originalBtnText;

                if (resp && resp.data) {
                    const created = resp.data;
                    
                    // Abrir recibos gerados (se houver)
                    if (Array.isArray(created.receipts) && created.receipts.length) {
                        created.receipts.slice(0,10).forEach(r => openReceiptHtml(r));
                    }

                    // Mensagem de sucesso personalizada
                    let successMessage = 'Venda finalizada com sucesso!';
                    if (prazoValue > 0 && installments > 1) {
                        const valuePerInstallment = prazoValue / installments;
                        successMessage = `Venda realizada!\n\nPago agora: ${formatMoney(entryValue)}\nParcelado: ${installments}x de ${formatMoney(valuePerInstallment)}`;
                    } else if (prazoValue > 0) {
                        successMessage = `Venda realizada!\n\nPago agora: ${formatMoney(entryValue)}\nA prazo: ${formatMoney(prazoValue)}`;
                    } else if (changeAmount > 0) {
                        successMessage = `Venda finalizada!\n\nTroco: ${formatMoney(changeAmount)}`;
                    }
                    
                    try { localStorage.setItem('dashboard_refresh', Date.now()); } catch(e){ /* ignore */ }

                    Modal.success(successMessage, 'Venda Finalizada');
                    playSound('success');

                    // Mostrar cupom fiscal
                    const operatorName = localStorage.getItem('userName') || 'Operador';
                    
                    // Calcular info das parcelas
                    const installmentValue = prazoValue > 0 && installments > 0 ? (prazoValue / installments) : 0;
                    
                    const saleSummary = {
                        items: state.cart.map(it => ({ id: it.id, name: it.name, qty: it.qty, price: it.price })),
                        total: total,
                        received: entryValue,
                        change: changeAmount,
                        payments: paymentMethods,
                        method: primaryMethod,
                        client: client,
                        operator: operatorName,
                        date: DateTimeUtils.nowForDB(),
                        transactions: created.transactions || [],
                        // Info das parcelas
                        installments: prazoValue > 0 ? installments : 0,
                        installmentValue: installmentValue,
                        prazoValue: prazoValue
                    };

                    try { openElginModal(saleSummary); } catch(e) { console.error('Erro ao abrir modal do cupom fiscal:', e); }

                    clearCart();
                    payModal.modal('hide');

                    // Recarregar produtos para atualizar estoque na tela
                    init();
                }
            } catch (error) {
                console.error('Erro ao salvar venda:', error);
                playSound('error');
                const msg = (error && error.response && error.response.data && (error.response.data.error || error.response.data.detail)) ? (error.response.data.error || error.response.data.detail) : 'Falha ao salvar a venda. Verifique o console para mais detalhes.';
                Modal.error(msg, 'Erro na Venda');
            } finally {
                if (confirmPayBtn) confirmPayBtn.disabled = false;
            }
        }

        // Helper: formatar cupom para Elgin i8 (48 colunas)
        function padRight(s, w){ s = String(s); if (s.length >= w) return s.slice(0, w); return s + ' '.repeat(w - s.length); }
        function padLeft(s, w){ s = String(s); if (s.length >= w) return s.slice(0, w); return ' '.repeat(w - s.length) + s; }
        function centerText(s, w){ s = String(s); if (s.length >= w) return s.slice(0, w); const pad = Math.floor((w - s.length) / 2); return ' '.repeat(pad) + s + ' '.repeat(w - s.length - pad); }

        // Obter configurações da empresa do localStorage
        function getCompanySettings() {
          try {
            const saved = localStorage.getItem('companySettings');
            if (saved) {
              const data = JSON.parse(saved);
              // Mapear campos para formato usado no cupom
              return {
                name: data.fantasyName || data.companyName || data.name || 'MINHA EMPRESA',
                cnpj: data.cnpj || '',
                ie: data.stateRegistration || data.ie || '',
                phone: data.phone || '',
                whatsapp: data.whatsapp || '',
                address: data.street || data.address || '',
                number: data.number || '',
                complement: data.complement || '',
                neighborhood: data.neighborhood || '',
                city: data.city || '',
                state: data.state || '',
                cep: data.cep || '',
                email: data.email || '',
                receiptMessage: data.receiptFooter || data.receiptMessage || 'Obrigado pela preferência!',
                logo: data.logo || null
              };
            }
          } catch(e) { console.error('Erro ao carregar configurações da empresa:', e); }
          return {
            name: 'MINHA EMPRESA',
            cnpj: '00.000.000/0000-00',
            ie: '',
            phone: '',
            address: '',
            city: '',
            state: '',
            receiptMessage: 'Obrigado pela preferência!'
          };
        }

        function formatElginCoupon(sale){
          const width = 48;
          const lines = [];
          const company = getCompanySettings();
          
          // Usar DateTimeUtils para garantir horário correto de Brasília
          const dateStr = DateTimeUtils.formatDateTime(sale.date || new Date());
          
          // Cabeçalho da empresa
          lines.push(centerText(company.name || 'MINHA EMPRESA', width));
          if (company.cnpj) lines.push(centerText('CNPJ: ' + company.cnpj, width));
          if (company.ie) lines.push(centerText('IE: ' + company.ie, width));
          
          // Endereço completo
          if (company.address) {
            let addr = company.address;
            if (company.number) addr += ', ' + company.number;
            if (company.complement) addr += ' - ' + company.complement;
            lines.push(centerText(addr, width));
          }
          if (company.neighborhood) {
            lines.push(centerText(company.neighborhood, width));
          }
          if (company.city || company.state) {
            let location = company.city || '';
            if (company.state) location += (location ? ' - ' : '') + company.state;
            if (company.cep) location += ' | CEP: ' + company.cep;
            lines.push(centerText(location, width));
          }
          if (company.phone) lines.push(centerText('Tel: ' + company.phone, width));
          if (company.whatsapp && company.whatsapp !== company.phone) {
            lines.push(centerText('WhatsApp: ' + company.whatsapp, width));
          }
          if (company.email) lines.push(centerText(company.email, width));
          
          lines.push('='.repeat(width));
          lines.push(centerText('CUPOM DE VENDA', width));
          lines.push('='.repeat(width));
          lines.push(padRight('Cliente: ' + (sale.client || 'Consumidor'), width));
          lines.push(padRight('Data: ' + dateStr, width));
          
          // Adicionar nome do funcionário/operador
          const operatorName = sale.operator || localStorage.getItem('userName') || 'Operador';
          lines.push(padRight('Atendente: ' + operatorName, width));
          
          lines.push('-'.repeat(width));
          
          // Itens
          for (const it of (sale.items || [])){
            const name = it.name.length > 26 ? it.name.slice(0,26) : it.name;
            const left = `${it.qty}x ${name}`;
            const right = formatMoney(it.price * it.qty).replace('R$', 'R$ ');
            const middleWidth = width - left.length - right.length - 2;
            const middle = middleWidth > 0 ? ' '.repeat(middleWidth) : ' ';
            lines.push(left + middle + right);
            if (it.name.length > 26){
              lines.push(it.name.slice(26));
            }
          }
          
          lines.push('-'.repeat(width));
          lines.push(padLeft('TOTAL: ' + formatMoney(sale.total), width));
          
          // Calcular valor recebido à vista (excluindo prazo)
          const payments = sale.payments || [];
          const receivedCash = payments.filter(p => p.method !== 'prazo').reduce((s, p) => s + (Number(p.amount) || 0), 0);
          const receivedPrazo = payments.filter(p => p.method === 'prazo').reduce((s, p) => s + (Number(p.amount) || 0), 0);
          
          // Se há múltiplas formas de pagamento, mostrar cada uma
          if (payments.length > 1) {
            const methodNames = { 'cash': 'Dinheiro', 'credit': 'Crédito', 'debit': 'Débito', 'pix': 'PIX', 'prazo': 'A Prazo', 'voucher': 'Voucher' };
            for (const p of payments) {
              const mName = methodNames[p.method] || p.method;
              lines.push(padLeft(mName + ': ' + formatMoney(p.amount), width));
            }
          } else if (receivedCash > 0) {
            lines.push(padLeft('Recebido: ' + formatMoney(receivedCash), width));
          }
          
          // Troco só aparece se recebeu mais do que o total à vista
          const troco = receivedCash - sale.total;
          if (troco > 0) {
            lines.push(padLeft('Troco: ' + formatMoney(troco), width));
          }
          
          // Se ficou valor a prazo, mostrar parcelas
          if (receivedPrazo > 0) {
            lines.push(padLeft('Saldo Devedor: ' + formatMoney(receivedPrazo), width));
            
            // Mostrar detalhes das parcelas
            const numParcelas = sale.installments || 1;
            const valorParcela = sale.installmentValue || (receivedPrazo / numParcelas);
            
            if (numParcelas > 1) {
              lines.push('');
              lines.push(centerText('*** PARCELAS ***', width));
              const baseDate = new Date();
              for (let i = 1; i <= numParcelas; i++) {
                const dueDate = new Date(baseDate);
                dueDate.setMonth(dueDate.getMonth() + i);
                const dueDateStr = dueDate.toLocaleDateString('pt-BR');
                lines.push(padRight(`  ${i}/${numParcelas} - Venc: ${dueDateStr}`, width - 12) + padLeft(formatMoney(valorParcela), 12));
              }
            } else {
              // Parcela única
              const dueDate = new Date();
              dueDate.setMonth(dueDate.getMonth() + 1);
              lines.push('');
              lines.push(centerText('*** PARCELA ***', width));
              lines.push(padRight(`  Vencimento: ${dueDate.toLocaleDateString('pt-BR')}`, width - 12) + padLeft(formatMoney(receivedPrazo), 12));
            }
          }
          
          lines.push('-'.repeat(width));
          
          // Forma principal (a de maior valor ou primeira)
          const mainMethod = payments.length > 0 
            ? payments.reduce((a, b) => (b.amount > a.amount) ? b : a).method 
            : (sale.method || '-');
          const methodNames2 = { 'cash': 'Dinheiro', 'credit': 'Crédito', 'debit': 'Débito', 'pix': 'PIX', 'prazo': 'A Prazo', 'voucher': 'Voucher' };
          lines.push('Forma: ' + (methodNames2[mainMethod] || mainMethod));
          
          if (sale.note) lines.push('Obs: ' + sale.note);
          lines.push('='.repeat(width));
          lines.push(centerText(company.receiptMessage || 'Obrigado pela preferência!', width));
          return lines.join('\n');
        }

        // Abre modal do cupom Elgin com os dados da venda
        function openElginModal(sale){
          const preview = document.getElementById('elginCouponPreview');
          const coupon = formatElginCoupon(sale);
          preview.textContent = coupon;
          // store last sale on modal for send
          preview.dataset.lastSale = JSON.stringify(sale);

// Load preferences from localStorage (guarded for Tracking Prevention / restricted contexts)
            try {
              let useEsc = false, autoPrint = false;
              try { useEsc = localStorage.getItem('elgin_use_escpos') === '1'; } catch(e) { useEsc = false; console.warn('localStorage.getItem blocked (elgin_use_escpos)'); }
              try { autoPrint = localStorage.getItem('elgin_auto_print') === '1'; } catch(e) { autoPrint = false; console.warn('localStorage.getItem blocked (elgin_auto_print)'); }
              const elUse = document.getElementById('elginUseEscpos'); if (elUse) elUse.checked = useEsc;
              const elAuto = document.getElementById('elginAutoSend'); if (elAuto) elAuto.checked = autoPrint;
              const devSel = document.getElementById('elginDeviceSelect'); if (devSel && useEsc) devSel.value = 'elgin-i8';
            } catch(e) { /* ignore other errors */ }

          // show modal
          try { if (window.jQuery) window.jQuery('#elginCouponModal').modal('show'); else { const inst = window.bootstrap.Modal.getOrCreateInstance(document.getElementById('elginCouponModal')); inst.show(); } } catch(e){ document.getElementById('elginCouponModal').classList.add('show'); }
        }

        // Send coupon to server (mocked print service)
        document.addEventListener('click', async (e) => {
          if (e.target && e.target.id === 'btnSendElgin'){
            const preview = document.getElementById('elginCouponPreview');
            const sale = JSON.parse(preview.dataset.lastSale || '{}');
            const deviceEl = document.getElementById('elginDeviceSelect');
            const useEscEl = document.getElementById('elginUseEscpos');
            const autoEl = document.getElementById('elginAutoSend');
            const useEsc = !!(useEscEl && useEscEl.checked);
            const autoPrint = !!(autoEl && autoEl.checked);

            // Persist preference
            try { localStorage.setItem('elgin_use_escpos', useEsc ? '1' : '0'); localStorage.setItem('elgin_auto_print', autoPrint ? '1' : '0'); } catch(e) { /* ignore */ }

            const payload = { coupon: preview.textContent, sale, device: useEsc ? 'elgin-i8' : (deviceEl ? deviceEl.value : 'elgin-i8'), escpos: useEsc, autoPrint };
            try{
              const resp = await axios.post('/api/print/elgin', payload);
              if (resp && resp.data) {
                const { status, escposResult, printResult } = resp.data;
                if (escposResult && escposResult.error) showToast('ESC/POS falhou: ' + escposResult.error, 'danger');
                else if (escposResult && escposResult.ok) showToast('ESC/POS: enviado com sucesso', 'success');
                if (printResult && printResult.ok) showToast('Fallback: enviado para impressora', 'success');
                if (status) showToast('Impressão salva: ' + status, 'info');
              } else {
                showToast('Impressão enviada', 'success');
              }
            }catch(err){ console.error('Erro ao enviar para impressora Elgin:', err); showToast('Falha ao enviar impressão', 'danger'); }
          }
          if (e.target && e.target.id === 'btnPrintPreview'){
            const preview = document.getElementById('elginCouponPreview');
            const w = window.open('', '_blank');
            if (w){ w.document.write('<pre style="font-family:monospace; font-size:13px;">' + preview.textContent.replace(/</g,'&lt;') + '</pre>'); w.document.title = 'Preview Cupom Elgin'; w.focus(); } else { Toast.warning('Permita popups para visualizar impressão.', 'Popup'); }
          }
        });

        // Persist checkbox changes to localStorage (guarded)
        document.addEventListener('change', (e) => {
          try {
            if (e.target && e.target.id === 'elginUseEscpos') {
              try { localStorage.setItem('elgin_use_escpos', e.target.checked ? '1' : '0'); } catch(err) { console.warn('localStorage.setItem blocked (elgin_use_escpos)'); }
            }
            if (e.target && e.target.id === 'elginAutoSend') {
              try { localStorage.setItem('elgin_auto_print', e.target.checked ? '1' : '0'); } catch(err) { console.warn('localStorage.setItem blocked (elgin_auto_print)'); }
            }
          } catch(e) { /* ignore */ }
        });

        // --- Inicialização e Eventos ---
        async function init() {
          try {
            // Carregar produtos
            const response = await axios.get('/api/products');
            // Mapear field 'photo' do backend para 'image' usado no frontend
            const newProducts = (response.data.data || []).map(p => (Object.assign({}, p, { image: p.photo || p.image || null })));
            
            // Só atualiza se realmente carregou dados (evita limpar em caso de erro de rede)
            if (newProducts.length > 0 || state.allProducts.length === 0) {
              state.allProducts = newProducts;
            }
            
            renderCategories();
            renderProducts();
            renderPendingSales();
            
            // Carregar clientes para o datalist
            try {
              const clientsResponse = await axios.get('/api/people');
              const clients = clientsResponse.data.data || [];
              const clientsList = document.getElementById('clientsList');
              clientsList.innerHTML = '';
              clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = `${client.name} - ${client.phone || 'Sem telefone'}`;
                clientsList.appendChild(option);
              });
            } catch (clientError) {
              console.warn('Erro ao carregar clientes:', clientError);
            }
            
          } catch (error) {
            console.error("Erro ao carregar produtos:", error);
            // Mantém produtos existentes se já tiver carregado antes
            if (state.allProducts.length === 0) {
              productListEl.innerHTML = '<div class="alert alert-danger">Não foi possível carregar os produtos. Verifique a conexão com o servidor.</div>';
            } else {
              showToast('Erro ao atualizar lista de produtos. Usando dados em cache.', 'warning');
              renderProducts(); // Re-renderizar com dados existentes
            }
          }

          // Event Listeners (proteções para elementos opcionais)
          if (searchInput) searchInput.addEventListener('input', renderProducts);
          if (btnCheckout) btnCheckout.addEventListener('click', openCheckout);
          if (btnCancel) btnCancel.addEventListener('click', () => {
            if (state.cart.length > 0 && confirm('Deseja cancelar a venda atual?')) {
              clearCart();
              showToast('Venda cancelada!', 'danger');
            }
          });
          if (btnHold) btnHold.addEventListener('click', holdSale);
          if (payAmountInput) payAmountInput.addEventListener('input', () => {
            calculateChange();
            updateInstallmentInfo(); // Atualizar info das parcelas quando valor de entrada mudar
          });
          if (confirmPayBtn) confirmPayBtn.addEventListener('click', finalizeSale);

          // Garantir fechamento do modal payModal por botões específicos (fallback)
          try {
            document.querySelectorAll('#payModal [data-dismiss="modal"]').forEach(btn => {
              btn.addEventListener('click', (e) => {
                try { if (payModal && payModal.modal) payModal.modal('hide'); } catch(err) { /* ignore */ }
              });
            });
          } catch(e) { /* ignore */ }

          // Código de barras - Enter para adicionar
          barcodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              const code = barcodeInput.value.trim();
              if (code) {
                addToCartByBarcode(code);
              }
            }
          });

          // Botões rápidos
          const _btnHelp = document.getElementById('btnHelp'); if (_btnHelp) _btnHelp.addEventListener('click', () => showHelp());
          const _btnClient = document.getElementById('btnClient'); if (_btnClient) _btnClient.addEventListener('click', () => {
            openCheckout();
            payModal.one('shown.bs.modal', () => { const _payClient = document.getElementById('payClient'); if (_payClient) _payClient.focus(); });
          });
          const _btnSearch = document.getElementById('btnSearch'); if (_btnSearch) _btnSearch.addEventListener('click', () => searchInput.focus());
          const _btnDiscount = document.getElementById('btnDiscount'); if (_btnDiscount) _btnDiscount.addEventListener('click', () => applyDiscount());
          
          // Botão PIX direto (abre QR Code)
          const _btnPixDirect = document.getElementById('btnPixDirect'); 
          if (_btnPixDirect) _btnPixDirect.addEventListener('click', () => openPixPayment());

          // Abrir modal de Contas a Prazo (FAB)
          if (btnAccountsPrazo) btnAccountsPrazo.addEventListener('click', () => {
            loadAccountsPrazo();
            if (window.jQuery) window.jQuery('#accountsPrazoModal').modal('show');
            else {
              try { const inst = window.bootstrap.Modal.getOrCreateInstance(accountsPrazoModalEl); inst.show(); } catch(e) { accountsPrazoModalEl.classList.add('show'); }
            }
          });

          // Search and refresh handlers inside the modal
          const accountsSearchEl = document.getElementById('accountsPrazoSearch');
          const accountsFilterStatusEl = document.getElementById('accountsFilterStatus');
          const btnRefreshAccounts = document.getElementById('btnRefreshAccounts');
          let accountsSearchTimer = null;
          if (accountsSearchEl) {
            accountsSearchEl.addEventListener('input', (e) => {
              clearTimeout(accountsSearchTimer);
              accountsSearchTimer = setTimeout(() => loadAccountsPrazo(e.target.value.trim()), 300);
            });
          }
          if (accountsFilterStatusEl) {
            accountsFilterStatusEl.addEventListener('change', () => {
              loadAccountsPrazo((accountsSearchEl && accountsSearchEl.value) || '');
            });
          }
          if (btnRefreshAccounts) btnRefreshAccounts.addEventListener('click', () => loadAccountsPrazo((accountsSearchEl && accountsSearchEl.value) || ''));

          // Focus automático no campo de busca quando o modal abrir
          if (accountsPrazoModalEl) {
            try {
              if (window.jQuery) {
                window.jQuery('#accountsPrazoModal').on('shown.bs.modal', () => { if (accountsSearchEl) { accountsSearchEl.focus(); accountsSearchEl.select(); } });
              } else {
                accountsPrazoModalEl.addEventListener('shown.bs.modal', () => { if (accountsSearchEl) { accountsSearchEl.focus(); accountsSearchEl.select(); } });
              }
            } catch(e) { /* ignore */ }
          }
          const _btnPix = document.getElementById('btnPix'); if (_btnPix) _btnPix.addEventListener('click', () => {
            openCheckout();
            payModal.one('shown.bs.modal', () => {
              const pixRadio = document.querySelector('input[name="payMethod"][value="pix"]');
              if (pixRadio) {
                pixRadio.checked = true;
                pixRadio.dispatchEvent(new Event('change', { bubbles: true }));
              }
            });
          });
          const _btnCash = document.getElementById('btnCash'); if (_btnCash) _btnCash.addEventListener('click', () => {
            openCheckout();
            payModal.one('shown.bs.modal', () => {
              const cashRadio = document.querySelector('input[name="payMethod"][value="cash"]');
              if (cashRadio) {
                cashRadio.checked = true;
                cashRadio.dispatchEvent(new Event('change', { bubbles: true }));
              }
            });
          });

          // Event listener para formas de pagamento e parcelas
          document.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'payMethod') {
              const installmentsGroup = document.getElementById('installmentsGroup');
              
              // Remover classe active de todos os labels
              document.querySelectorAll('.btn-group-toggle label').forEach(label => {
                label.classList.remove('active');
              });
              
              // Adicionar classe active no label do radio selecionado
              if (e.target.checked) {
                e.target.parentElement.classList.add('active');
              }
              
              // Mostrar/esconder campo de parcelas para Crédito e A Prazo
              if (e.target.value === 'card' || e.target.value === 'prazo') {
                installmentsGroup.style.display = 'block';
                updateInstallmentInfo();
              } else {
                installmentsGroup.style.display = 'none';
              }
            }
            
            // Atualizar info das parcelas quando mudar o número
            if (e.target && e.target.id === 'installments') {
              updateInstallmentInfo();
            }
          });

          // Event listener para clicks nos labels dos botões
          document.addEventListener('click', function(e) {
            if (e.target.closest('.btn-group-toggle label')) {
              const label = e.target.closest('label');
              const radio = label.querySelector('input[type="radio"]');
              
              if (radio) {
                // Disparar evento change manualmente
                radio.checked = true;
                radio.dispatchEvent(new Event('change', { bubbles: true }));
              }
            }
          });

          // Global handler para elementos com data-dismiss="modal" (suporta jQuery e Bootstrap)
          document.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-dismiss="modal"]');
            if (!btn) return;
            const modalEl = btn.closest('.modal');
            if (!modalEl) return;

            // DEBUG: log para verificar cliques nos botões de fechamento
            try { console.debug('[PDV] data-dismiss clicked', btn, modalEl); } catch(e){}
            try {
              if (window.Toast && window.Toast.compact) {
                // Mensagem curta e discreta ao fechar modal
                Toast.compact('Fechando…', 'info', 'Info');
              } else if (typeof showToast === 'function') {
                showToast('Fechando…', 'info');
              }
            } catch(e){}

            // Se jQuery estiver disponível, tente usar a API da jQuery (mapeada para o Modal)
            try {
              if (window.jQuery && window.jQuery(modalEl).modal) {
                try { console.debug('[PDV] hiding modal via jQuery', modalEl); } catch(e){}
                window.jQuery(modalEl).modal('hide');
                return;
              }
            } catch (err) { /* ignore */ }

            // Caso contrário, use a API nativa do Bootstrap 5
            try {
              if (window.bootstrap && window.bootstrap.Modal) {
                try { console.debug('[PDV] hiding modal via bootstrap', modalEl); } catch(e){}
                const inst = window.bootstrap.Modal.getOrCreateInstance(modalEl);
                inst.hide();
                return;
              }
            } catch (err) { /* ignore */ }

            // Fallback: remover classe 'show' e ocultar
            modalEl.classList.remove('show');
            modalEl.style.display = 'none';
          });

          cartItemsEl.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-act]');
            if (target) {
              const action = target.dataset.act;
              const productId = target.dataset.id;
              updateCartItem(productId, action);
            }
          });

          // Atalhos de teclado
          document.addEventListener('keydown', (e) => {
            const isPayModalOpen = !!(payModal && payModal.hasClass && payModal.hasClass('show'));
            const isInputFocused = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName);

            if (e.key === 'F1') {
              e.preventDefault();
              showHelp();
            }
            if (e.key === 'F2') {
              e.preventDefault();
              if (!isPayModalOpen) {
                openCheckout();
                if (payModal && payModal.one) {
                  payModal.one('shown.bs.modal', () => {
                    const _payClient = document.getElementById('payClient'); if (_payClient) _payClient.focus();
                  });
                }
              } else {
                const _payClient = document.getElementById('payClient'); if (_payClient) _payClient.focus();
              }
            }
            if (e.key === 'F3') {
              e.preventDefault();
              searchInput.focus();
            }
            if (e.key === 'F4') {
              e.preventDefault();
              openCheckout();
            }
            if (e.key === 'F5') {
                e.preventDefault();
                applyDiscount();
            }
            if (e.key === 'F7') {
              e.preventDefault();
              barcodeInput.focus();
              barcodeInput.select();
            }
            if (e.key === 'F8') {
              e.preventDefault();
              holdSale();
            }
            if (e.key === 'F9') {
              e.preventDefault();
              if (state.cart.length > 0 && confirm('Deseja cancelar a venda atual?')) {
                clearCart();
                showToast('Venda cancelada!', 'danger');
              }
            }
            if (e.key === 'F10') {
              e.preventDefault();
              // Abrir pagamento PIX com QR Code
              openPixPayment();
            }
            if (e.key === 'F11') {
              e.preventDefault();
              const selectCash = () => {
                const cashRadio = document.querySelector('input[name="payMethod"][value="cash"]');
                if (!cashRadio) return;
                cashRadio.checked = true;
                cashRadio.dispatchEvent(new Event('change', { bubbles: true }));
              };

              if (!isPayModalOpen) {
                openCheckout();
                if (payModal && payModal.one) {
                  payModal.one('shown.bs.modal', () => {
                    selectCash();
                    const _payAmount = document.getElementById('payAmount'); if (_payAmount) _payAmount.focus();
                  });
                }
              } else {
                selectCash();
                const _payAmount = document.getElementById('payAmount'); if (_payAmount) _payAmount.focus();
              }
            }
            if (e.key === 'Escape') {
              e.preventDefault();
              if (isPayModalOpen) {
                payModal.modal('hide');
              } else if (confirm('Deseja sair do PDV?')) {
                window.location.href = 'dashboard.html';
              }
            }
          });

          // Relógio e data (usando módulo centralizado - Brasília)
          function updateDateTime() {
            document.getElementById('currentTime').textContent = DateTimeUtils.formatTime(new Date());
            document.getElementById('currentDate').textContent = DateTimeUtils.formatDate(new Date());
          }
          updateDateTime();
          setInterval(updateDateTime, 1000);

          // Focar no campo de código de barras ao carregar
          setTimeout(() => barcodeInput.focus(), 100);

          // Recalcular posição do FAB após layout inicializado
          setTimeout(() => { try { if (typeof adjustFabPosition === 'function') adjustFabPosition(); } catch(e){} }, 120);
          
          // Verificar se veio do Balcão com orçamento
          checkBalcaoData();
        }
        
        // Função para carregar dados do Balcão
        function checkBalcaoData() {
          try {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('from') !== 'balcao') return;
            
            const balcaoData = localStorage.getItem('pdvFromBalcao');
            if (!balcaoData) return;
            
            const data = JSON.parse(balcaoData);
            if (!data.items || !data.items.length) return;
            
            // Limpar carrinho atual
            state.cart = [];
            
            // Adicionar itens do balcão ao carrinho
            data.items.forEach(item => {
              const produto = state.allProducts.find(p => p.id === item.productId);
              if (produto) {
                state.cart.push({
                  id: produto.id,
                  name: produto.name,
                  sku: produto.sku || produto.code,
                  price: item.unitPrice,
                  qty: item.quantity,
                  image: produto.image || produto.photo
                });
              } else {
                // Produto não encontrado, usar dados do balcão
                state.cart.push({
                  id: item.productId,
                  name: item.productName,
                  sku: item.productSku,
                  price: item.unitPrice,
                  qty: item.quantity,
                  image: null
                });
              }
            });
            
            // Aplicar desconto se houver
            if (data.discount && data.discount > 0) {
              state.discount = data.discount;
            }
            
            // Definir cliente se houver
            if (data.clientName) {
              state.currentClient = { name: data.clientName };
              const payClientEl = document.getElementById('payClient');
              if (payClientEl) payClientEl.value = data.clientName;
            }
            
            // Atualizar UI
            renderCart();
            updateTotals();
            
            // Limpar dados do localStorage para não carregar novamente
            localStorage.removeItem('pdvFromBalcao');
            
            // Notificar usuário
            showToast('Orçamento carregado do Balcão!', 'success');
            
            // Remover parâmetro da URL
            window.history.replaceState({}, document.title, 'pdv.html');
          } catch (error) {
            console.error('Erro ao carregar dados do Balcão:', error);
          }
        }

        function showHelp() {
          Modal.info(
            [
              'F1  - Ajuda (esta tela)',
              'F2  - Selecionar cliente',
              'F3  - Buscar produto',
              'F4  - Finalizar venda',
              'F5  - Aplicar desconto',
              'F7  - Foco no código de barras',
              'F8  - Colocar venda em espera',
              'F9  - Cancelar venda',
              'F10 - Pagamento PIX',
              'F11 - Pagamento em dinheiro',
              'ESC - Sair do PDV'
            ].join('\n'),
            'Atalhos do PDV'
          );
        }

        function applyDiscount() {
          const discountValue = parseFloat(prompt("Digite o valor do desconto:", state.discount.toString()));
          if (!isNaN(discountValue) && discountValue >= 0) {
            state.discount = discountValue;
            updateTotals();
            showToast(`Desconto de ${formatMoney(discountValue)} aplicado!`, 'success');
          }
        }

        // ============================================
        // INTEGRAÇÃO PIX - MERCADO PAGO
        // ============================================
        let pixCheckInterval = null;
        let currentPixPaymentId = null;

        // Verificar se PIX está configurado
        async function checkPixConfigured() {
          try {
            const res = await axios.get('/api/pix/configurado');
            return res.data && res.data.configurado;
          } catch (e) {
            return false;
          }
        }

        // Gerar QR Code PIX
        async function gerarPixQrCode(amount, description) {
          const pixModal = $('#pixModal');
          const pixLoading = document.getElementById('pixLoading');
          const pixError = document.getElementById('pixError');
          const pixContent = document.getElementById('pixContent');
          const pixErrorMsg = document.getElementById('pixErrorMsg');

          // Reset estado
          pixLoading.style.display = 'block';
          pixError.style.display = 'none';
          pixContent.style.display = 'none';
          currentPixPaymentId = null;

          pixModal.modal('show');

          try {
            const res = await axios.post('/api/pix/gerar', {
              amount: amount,
              description: description || 'Venda PDV',
              externalReference: `PDV-${Date.now()}`
            });

            pixLoading.style.display = 'none';

            if (res.data && res.data.success) {
              currentPixPaymentId = res.data.paymentId;
              document.getElementById('pixPaymentId').value = res.data.paymentId;
              document.getElementById('pixValor').textContent = formatMoney(res.data.amount);
              
              // Mostrar QR Code
              if (res.data.qrCodeBase64) {
                document.getElementById('pixQrImage').src = `data:image/png;base64,${res.data.qrCodeBase64}`;
              } else if (res.data.qrCode) {
                // Gerar QR Code via biblioteca se não vier base64
                document.getElementById('pixQrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(res.data.qrCode)}`;
              }
              
              // Salvar código para cópia
              document.getElementById('pixCodeCopy').value = res.data.qrCode || '';
              
              pixContent.style.display = 'block';
              
              // Iniciar verificação de status
              startPixStatusCheck(res.data.paymentId, amount);
              
              // Mostrar botão de confirmação manual após 10 segundos
              setTimeout(() => {
                document.getElementById('btnConfirmPixManual').style.display = 'inline-block';
              }, 10000);

            } else {
              throw new Error(res.data.error || 'Erro desconhecido');
            }

          } catch (error) {
            pixLoading.style.display = 'none';
            pixError.style.display = 'block';
            pixErrorMsg.textContent = error.response?.data?.error || error.message || 'Erro ao gerar PIX';
            console.error('Erro PIX:', error);
          }
        }

        // Copiar código PIX
        function copyPixCode() {
          const code = document.getElementById('pixCodeCopy').value;
          if (code) {
            navigator.clipboard.writeText(code).then(() => {
              showToast('Código PIX copiado!', 'success');
            }).catch(() => {
              // Fallback
              const input = document.getElementById('pixCodeCopy');
              input.type = 'text';
              input.select();
              document.execCommand('copy');
              input.type = 'hidden';
              showToast('Código PIX copiado!', 'success');
            });
          }
        }
        window.copyPixCode = copyPixCode;

        // Verificar status do pagamento PIX
        function startPixStatusCheck(paymentId, amount) {
          // Limpar intervalo anterior
          if (pixCheckInterval) clearInterval(pixCheckInterval);
          
          const statusText = document.getElementById('pixStatusText');
          const statusArea = document.getElementById('pixStatusArea');
          let checkCount = 0;
          const maxChecks = 60; // 5 minutos (a cada 5 segundos)

          pixCheckInterval = setInterval(async () => {
            checkCount++;
            
            if (checkCount > maxChecks) {
              clearInterval(pixCheckInterval);
              statusArea.style.background = '#fee2e2';
              statusText.innerHTML = '<i class="fa fa-times-circle mr-2" style="color: #ef4444;"></i>Tempo expirado. Gere um novo QR Code.';
              return;
            }

            try {
              const res = await axios.get(`/api/pix/status/${paymentId}`);
              
              if (res.data.status === 'approved') {
                clearInterval(pixCheckInterval);
                statusArea.style.background = '#d1fae5';
                statusText.innerHTML = '<i class="fa fa-check-circle mr-2" style="color: #10b981;"></i>Pagamento confirmado!';
                
                showToast('Pagamento PIX confirmado!', 'success');
                
                // Fechar modal PIX e finalizar venda
                setTimeout(() => {
                  $('#pixModal').modal('hide');
                  // Finalizar com o pagamento PIX confirmado
                  finalizeSaleWithPix(amount);
                }, 1500);
                
              } else if (res.data.status === 'rejected' || res.data.status === 'cancelled') {
                clearInterval(pixCheckInterval);
                statusArea.style.background = '#fee2e2';
                statusText.innerHTML = '<i class="fa fa-times-circle mr-2" style="color: #ef4444;"></i>Pagamento cancelado ou rejeitado.';
              }
              
            } catch (e) {
              console.warn('Erro ao verificar status PIX:', e);
            }
            
          }, 5000); // Verificar a cada 5 segundos
        }

        // Cancelar verificação PIX
        function cancelPixCheck() {
          if (pixCheckInterval) {
            clearInterval(pixCheckInterval);
            pixCheckInterval = null;
          }
          currentPixPaymentId = null;
          document.getElementById('btnConfirmPixManual').style.display = 'none';
        }
        window.cancelPixCheck = cancelPixCheck;

        // Confirmar PIX manualmente (fallback)
        function confirmPixManual() {
          if (confirm('Confirma que o pagamento PIX foi recebido?')) {
            if (pixCheckInterval) clearInterval(pixCheckInterval);
            
            const amount = parseFloat(document.getElementById('pixValor').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            
            $('#pixModal').modal('hide');
            showToast('Pagamento PIX confirmado manualmente!', 'success');
            
            finalizeSaleWithPix(amount);
          }
        }
        window.confirmPixManual = confirmPixManual;

        // Finalizar venda com PIX já confirmado (AUTOMÁTICO)
        async function finalizeSaleWithPix(pixAmount) {
          console.log('[PIX] Finalizando venda automaticamente com valor:', pixAmount);
          
          // Garantir que o método de pagamento seja PIX
          paymentMethods = [{
            id: 1,
            method: 'pix',
            amount: pixAmount
          }];
          
          // Chamar finalizeSale diretamente (sem abrir modal de pagamento)
          try {
            await finalizeSale();
            showToast('✅ Venda finalizada com sucesso via PIX!', 'success');
          } catch (e) {
            console.error('Erro ao finalizar venda PIX:', e);
            showToast('Erro ao finalizar venda: ' + e.message, 'danger');
          }
        }

        // Abrir PIX diretamente (F10 ou botão) - GERA QR CODE AUTOMATICAMENTE
        async function openPixPayment() {
          if (state.cart.length === 0) {
            showToast('Carrinho vazio! Adicione produtos primeiro.', 'warning');
            return;
          }
          
          // Verificar se PIX está configurado
          const configured = await checkPixConfigured();
          if (!configured) {
            Modal.warning('PIX não configurado!\n\nAcesse:\nAdmin > Integrações > Nova Integração\n\nE configure as credenciais do Mercado Pago:\n- Public Key\n- Access Token\n- Client ID\n- Client Secret', 'PIX Não Configurado');
            return;
          }
          
          const total = getTotal();
          
          // Configurar pagamento como PIX
          paymentMethods = [{
            id: 1,
            method: 'pix',
            amount: total
          }];
          
          // Gerar QR Code diretamente (sem abrir modal de pagamento)
          showToast('Gerando QR Code PIX...', 'info');
          await gerarPixQrCode(total, `Venda PDV - ${state.cart.length} item(s)`);
        }
        window.openPixPayment = openPixPayment;

        // Integrar com seleção de PIX no modal de pagamento
        function handlePixSelection() {
          // Quando selecionar PIX no dropdown de pagamento, oferecer gerar QR Code
          const pixPayments = paymentMethods.filter(p => p.method === 'pix');
          if (pixPayments.length > 0) {
            const pixAmount = pixPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            if (pixAmount > 0 && confirm(`Deseja gerar QR Code PIX para R$ ${pixAmount.toFixed(2)}?`)) {
              gerarPixQrCode(pixAmount, `Venda PDV`);
            }
          }
        }

        // (debug utilities removed)

        init();
      });
    </script>
  </body>
</html>
