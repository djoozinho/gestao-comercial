<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Movimentos - Sistema</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <!-- Auth Guard - Proteção de acesso -->
  <script src="js/auth-guard.js"></script>
  <script src="js/branding.js"></script>
  <script src="js/sidebar.js"></script>
  <style>
    .dashboard-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .period-selector { display: flex; align-items: center; gap: 10px; background: #fff; padding: 8px 16px; border-radius: 12px; box-shadow: var(--shadow-sm); }
    .period-btn { padding: 8px 16px; border: none; background: transparent; color: var(--gray-600); border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s; }
    .period-btn:hover { background: var(--gray-100); }
    .period-btn.active { background: var(--brand-gradient); color: #fff; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .dashboard-container { padding: 24px; overflow-y: auto; flex: 1; }
    .table-container { padding: 20px; }
    .refresh-btn { background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); color: var(--brand); padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
    .refresh-btn:hover { background: var(--brand); color: #fff; }
    .gap-2 { gap: 8px; }

    /* Destaque visual para linhas recém-criadas */
    .new-row-highlight {
      animation: newRowFlash 2.8s ease forwards;
    }
    @keyframes newRowFlash {
      0% { background-color: rgba(16,185,129,0.22); }
      50% { background-color: rgba(16,185,129,0.10); }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="sidebar">
      <h4>SISTEMA</h4>
      <ul class="sidebar-menu">
        <li><a href="index.html"><span class="menu-icon"><i class="fa fa-home"></i></span><span class="menu-label">Início</span></a></li>
        <li><a href="pdv.html"><span class="menu-icon"><i class="fa fa-cash-register"></i></span><span class="menu-label">PDV</span></a></li>
        <li><a href="dashboard.html"><span class="menu-icon"><i class="fa fa-chart-pie"></i></span><span class="menu-label">Painel</span></a></li>
        <li><a href="nfe-emissao.html"><span class="menu-icon"><i class="fa fa-file-invoice"></i></span><span class="menu-label">Notas Fiscais</span></a></li>
        <li><a href="movimentos.html" class="active"><span class="menu-icon"><i class="fa fa-exchange-alt"></i></span><span class="menu-label">Movimentos</span></a></li>
        <li><a href="relatorios.html"><span class="menu-icon"><i class="fa fa-chart-bar"></i></span><span class="menu-label">Relatórios</span></a></li>
        <li><a href="pessoas.html"><span class="menu-icon"><i class="fa fa-users"></i></span><span class="menu-label">Clientes</span></a></li>
        <li><a href="produtos.html"><span class="menu-icon"><i class="fa fa-boxes"></i></span><span class="menu-label">Produtos</span></a></li>
        <li><a href="agenda.html"><span class="menu-icon"><i class="fa fa-calendar"></i></span><span class="menu-label">Agenda</span></a></li>
        <li><a href="admin.html"><span class="menu-icon"><i class="fa fa-cogs"></i></span><span class="menu-label">Admin</span></a></li>
      </ul>
    </div>

    <div class="main-content">
      <div class="main-header">
        <h3><i class="fa fa-list"></i> Movimentos de Estoque</h3>
        <div class="header-info">
          <span><i class="fa fa-user-circle mr-2"></i>Admin</span>
          <span><i class="fa fa-clock mr-2"></i><span id="currentTime">--:--:--</span></span>
          <button id="refreshBtn" class="refresh-btn"><i class="fa fa-sync-alt"></i> Atualizar</button>
        </div>
      </div>

      <div class="dashboard-container">
        <div class="dashboard-controls">
          <div class="period-selector">
            <span>Período:</span>
            <button class="period-btn active" data-period="today">Hoje</button>
            <button class="period-btn" data-period="week">Semana</button>
            <button class="period-btn" data-period="month">Mês</button>
            <button class="period-btn" data-period="year">Ano</button>
          </div>
          <input type="date" id="dateFilter" class="form-control" style="width: 180px;">
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #047857)"><i class="fa fa-arrow-up"></i></div>
            <div class="stat-value" id="total-entradas">0</div>
            <div class="stat-label">Suprimentos</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #b91c1c)"><i class="fa fa-arrow-down"></i></div>
            <div class="stat-value" id="total-saidas">0</div>
            <div class="stat-label">Sangria</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #ea580c)"><i class="fa fa-tools"></i></div>
            <div class="stat-value" id="total-ajustes">0</div>
            <div class="stat-label">Ajustes</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #0ea5e9, #0284c7)"><i class="fa fa-chart-bar"></i></div>
            <div class="stat-value" id="total-movimentos">0</div>
            <div class="stat-label">Total</div>
          </div>
        </div>

        <!-- Tipos de Movimento -->
        <div class="card mb-4">
          <div class="card-header"><i class="fa fa-tags"></i> Tipos de Movimentos</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <button class="btn btn-success btn-block mb-2" data-tipo="entrada"><i class="fa fa-truck mr-2"></i>Suprimento</button>
                <button class="btn btn-danger btn-block mb-2" data-tipo="saida"><i class="fa fa-shopping-cart mr-2"></i>Sangria</button>
              </div>
              <div class="col-md-4">
                <button class="btn btn-warning btn-block mb-2" data-tipo="ajuste"><i class="fa fa-tools mr-2"></i>Ajuste</button>
                <button class="btn btn-info btn-block mb-2" data-tipo="transferencia"><i class="fa fa-exchange-alt mr-2"></i>Transferência</button>
              </div>
              <div class="col-md-4">
                <button class="btn btn-secondary btn-block mb-2" data-tipo="devolucao"><i class="fa fa-undo mr-2"></i>Devolução</button>
                <button class="btn btn-dark btn-block mb-2" data-tipo="baixa"><i class="fa fa-trash mr-2"></i>Baixa</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Formulário -->
        <div class="card mb-4" id="formMovimento" style="display: none;">
          <div class="card-header"><i class="fa fa-edit"></i> Lançamento de Movimento <button type="button" class="close" onclick="fecharFormulario()"><span>&times;</span></button></div>
          <div class="card-body">
            <form id="movimentoForm">
              <div class="row">
                <div class="col-md-3">
                  <div class="form-group"><label>Data</label><input type="date" id="dataMovimento" class="form-control" required></div>
                </div>
                <div class="col-md-3">
                  <div class="form-group"><label>Tipo</label>
                    <select id="tipoMovimento" class="form-control" required>
                      <option value="">Selecione...</option>
                      <option value="entrada">Entrada</option>
                      <option value="saida">Saída</option>
                      <option value="ajuste">Ajuste</option>
                      <option value="transferencia">Transferência</option>
                      <option value="devolucao">Devolução</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group"><label>Produto</label><input type="text" id="produtoMovimento" class="form-control" placeholder="Nome ou código" required></div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-2">
                  <div class="form-group"><label>Quantidade</label><input type="number" id="quantidade" class="form-control" step="0.001" required></div>
                </div>
                <div class="col-md-2">
                  <div class="form-group"><label>Valor Unit.</label><input type="number" id="valorUnitario" class="form-control" step="0.01"></div>
                </div>
                <div class="col-md-2">
                  <div class="form-group"><label>Valor Total</label><input type="number" id="valorTotal" class="form-control" step="0.01" readonly></div>
                </div>
                <div class="col-md-6">
                  <div class="form-group"><label>Documento</label><input type="text" id="documento" class="form-control" placeholder="NF, Cupom..."></div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <div class="form-group"><label>Observações</label><textarea id="observacoes" class="form-control" rows="2"></textarea></div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary"><i class="fa fa-save mr-2"></i>Salvar</button>
              <button type="button" class="btn btn-secondary ml-2" onclick="fecharFormulario()"><i class="fa fa-times mr-2"></i>Cancelar</button>
            </form>
          </div>
        </div>

        <!-- Tabela -->
        <div class="card">
          <div class="card-header">
            <i class="fa fa-history"></i> Histórico de Movimentos
            <button id="newMovementBtn" class="btn btn-primary btn-sm ml-auto"><i class="fa fa-plus mr-2"></i>Novo</button>
          </div>
          <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
              <div class="d-flex align-items-center gap-2">
                <input type="text" id="searchInput" class="form-control" placeholder="Pesquisar..." style="width: 200px;">
                <select id="tipoFilter" class="form-control" style="width: 150px;">
                  <option value="">Todos</option>
                  <option value="entrada">Suprimentos</option>
                  <option value="saida">Sangria</option>
                  <option value="ajuste">Ajustes</option>
                </select>
              </div>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary btn-sm" id="exportarExcel"><i class="fa fa-file-excel mr-1"></i>Excel</button>
                <button class="btn btn-outline-secondary btn-sm" id="imprimirKardex"><i class="fa fa-print mr-1"></i>Imprimir</button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table" id="movementsTable">
                <thead>
                  <tr>
                    <th>Data/Hora</th>
                    <th>Tipo</th>
                    <th>Produto</th>
                    <th class="text-right">Suprimento</th>
                    <th class="text-right">Sangria</th>
                    <th class="text-right">Valor</th>
                    <th>Documento</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="movementsTableBody"></tbody>
              </table>
            </div>
            <div class="empty-state" id="emptyState" style="display: none;">
              <i class="fa fa-boxes"></i>
              <h5>Nenhum movimento encontrado</h5>
              <p>Clique em "Novo" para criar</p>
            </div>
            <div class="text-muted mt-3" id="paginationInfo">Mostrando 0 itens</div>
          </div>
        </div>
      </div>

      <footer class="footer-shortcuts">
        <div class="shortcut-item"><kbd>F1</kbd> Ajuda</div>
        <div class="shortcut-item"><kbd>F2</kbd> Atualizar</div>
        <div class="shortcut-item"><kbd>F3</kbd> Novo</div>
        <div class="shortcut-item"><kbd>F5</kbd> Exportar</div>
        <div class="shortcut-item"><kbd>F6</kbd> Imprimir</div>
      </footer>
    </div>
  </div>

  <div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="detailsModalTitle">Detalhes</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body" id="detailsModalContent"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button></div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Módulo centralizado de data/hora (Brasília) -->
  <script src="/js/datetime-utils.js"></script>
  <!-- Sistema de Toasts Elegantes -->
  <script src="js/toast.js"></script>
  <script>
    const API_BASE = '/api';
    
    // Garantir que o interceptor do axios está configurado (auth-guard.js já faz isso, mas reforçamos aqui)
    if (typeof axios !== 'undefined' && !axios._authInterceptorConfigured) {
      axios.interceptors.request.use(function (config) {
        const token = localStorage.getItem('authToken');
        if (token) {
          config.headers = config.headers || {};
          config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
      }, function (error) {
        return Promise.reject(error);
      });
      axios._authInterceptorConfigured = true;
      console.log('✅ [Movimentos] Axios interceptor configurado');
    }
    
    let movementsData = { period: 'today', movements: [] };
    // Conjunto de IDs já vistos para detectar itens novos
    let movementsSeen = new Set();
    // IDs identificados como novos na última carga
    let latestNewIds = new Set();

    function updateClock() { document.getElementById('currentTime').textContent = DateTimeUtils.formatTime(new Date()); }
    setInterval(updateClock, 1000); updateClock();

    function formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); }

    async function loadMovementsData() {
      try {
        // Calcular período
        const today = new Date();
        let from, to;
        const period = movementsData.period;
        
        switch(period) {
          case 'today':
            from = DateTimeUtils.todayISO();
            to = DateTimeUtils.todayISO();
            break;
          case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            from = DateTimeUtils.formatDateISO(weekStart);
            to = DateTimeUtils.todayISO();
            break;
          case 'month':
            from = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;
            to = DateTimeUtils.todayISO();
            break;
          case 'year':
            from = `${today.getFullYear()}-01-01`;
            to = DateTimeUtils.todayISO();
            break;
          default:
            from = DateTimeUtils.todayISO();
            to = DateTimeUtils.todayISO();
        }

        // Buscar apenas transações (movimentos de estoque)
        const transResp = await axios.get(`${API_BASE}/transactions`);
        const transactions = transResp.data.data || transResp.data || [];
        
        // Tipos de movimento de estoque válidos
        const tiposMovimentoEstoque = ['entrada', 'saida', 'ajuste', 'transferencia', 'devolucao', 'baixa', 'suprimento', 'sangria'];
        
        // Filtrar apenas movimentos de estoque (não financeiros)
        const movimentosEstoque = transactions.filter(t => {
          const tipo = (t.type || '').toLowerCase();
          // Incluir se for tipo de movimento de estoque OU se tiver categoria de estoque
          return tiposMovimentoEstoque.includes(tipo) || 
                 t.category === 'Estoque' || 
                 t.category === 'Movimento';
        });
        
        // Filtrar pelo período selecionado
        const filteredTransactions = movimentosEstoque.filter(t => {
          // Pegar a data e extrair apenas a parte YYYY-MM-DD (suporta tanto "T" quanto espaço)
          const rawDate = t.createdAt || t.paymentDate || t.dueDate || '';
          const txDate = rawDate.split('T')[0].split(' ')[0];
          return txDate >= from && txDate <= to;
        });
        
        // Classificar movimentos
        const entradas = filteredTransactions.filter(t => 
          ['entrada', 'suprimento', 'devolucao'].includes((t.type || '').toLowerCase())
        );
        const saidas = filteredTransactions.filter(t => 
          ['saida', 'sangria', 'baixa'].includes((t.type || '').toLowerCase())
        );
        const ajustes = filteredTransactions.filter(t => 
          ['ajuste', 'transferencia'].includes((t.type || '').toLowerCase())
        );
        
        // Atualizar contadores
        document.getElementById('total-entradas').textContent = entradas.length;
        document.getElementById('total-saidas').textContent = saidas.length;
        document.getElementById('total-ajustes').textContent = ajustes.length;
        document.getElementById('total-movimentos').textContent = filteredTransactions.length;
        
        // Usar módulo centralizado para formatar data/hora em Brasília
        function formatBrasiliaDateTime(s) {
          return DateTimeUtils.formatDateTime(s);
        }

        // Mapear movimentos para a tabela
        function getTipoInfo(tipo) {
          tipo = (tipo || '').toLowerCase();
          const tipos = {
            'entrada': { texto: 'Entrada', badge: 'success', isEntrada: true },
            'suprimento': { texto: 'Suprimento', badge: 'success', isEntrada: true },
            'devolucao': { texto: 'Devolução', badge: 'info', isEntrada: true },
            'saida': { texto: 'Saída', badge: 'danger', isEntrada: false },
            'sangria': { texto: 'Sangria', badge: 'danger', isEntrada: false },
            'baixa': { texto: 'Baixa', badge: 'dark', isEntrada: false },
            'ajuste': { texto: 'Ajuste', badge: 'warning', isEntrada: null },
            'transferencia': { texto: 'Transferência', badge: 'secondary', isEntrada: null }
          };
          return tipos[tipo] || { texto: tipo || 'Movimento', badge: 'secondary', isEntrada: null };
        }

        movementsData.movements = filteredTransactions.map(t => {
          const tipoInfo = getTipoInfo(t.type);
          return {
            id: t.id,
            dataHora: formatBrasiliaDateTime(t.createdAt || t.paymentDate || t.dueDate || new Date().toISOString()),
            tipo: t.type,
            tipoTexto: tipoInfo.texto,
            tipoBadge: tipoInfo.badge,
            produto: t.description || 'Movimento',
            qtdEntrada: tipoInfo.isEntrada === true ? (parseFloat(t.quantity) || 1) : '',
            qtdSaida: tipoInfo.isEntrada === false ? (parseFloat(t.quantity) || 1) : '',
            valorTotal: parseFloat(t.amount || t.value) || 0,
            documento: t.paymentMethod || t.notes || '-',
            source: 'transaction'
          };
        }).sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));

        // Detectar IDs novos comparando com o conjunto `movementsSeen`
        const currentIds = new Set(movementsData.movements.map(m => m.id));
        const newlyDetected = [...currentIds].filter(id => !movementsSeen.has(id));
        latestNewIds = new Set(newlyDetected);
        // Atualiza seen para incluir todos os atuais
        movementsSeen = new Set([...movementsSeen, ...currentIds]);
        
        updateTable();
      } catch (e) { console.error('Erro ao carregar movimentos:', e); }
    }

    function updateTable() {
      const tbody = document.getElementById('movementsTableBody');
      const empty = document.getElementById('emptyState');
      const table = document.getElementById('movementsTable');
      
      if (movementsData.movements.length === 0) {
        table.style.display = 'none';
        empty.style.display = 'block';
      } else {
        table.style.display = 'table';
        empty.style.display = 'none';
        tbody.innerHTML = movementsData.movements.map(m => `
          <tr class="${(latestNewIds && latestNewIds.has && latestNewIds.has(m.id)) ? 'new-row-highlight' : ''}">
            <td>${m.dataHora}</td>
            <td><span class="badge badge-${m.tipoBadge}">${m.tipoTexto}</span></td>
            <td>${m.produto}</td>
            <td class="text-right">${m.qtdEntrada}</td>
            <td class="text-right">${m.qtdSaida}</td>
            <td class="text-right">${formatCurrency(m.valorTotal)}</td>
            <td>${m.documento}</td>
            <td><button class="btn btn-sm btn-info" onclick="viewMovement('${m.id}')"><i class="fa fa-eye"></i></button></td>
          </tr>
        `).join('');

        // Remove o destaque depois de 3.5s
        if (latestNewIds && latestNewIds.size > 0) {
          setTimeout(() => {
            document.querySelectorAll('.new-row-highlight').forEach(el => el.classList.remove('new-row-highlight'));
            latestNewIds.clear();
          }, 3500);
        }
      }
      document.getElementById('paginationInfo').textContent = `Mostrando ${movementsData.movements.length} itens`;
    }

    function viewMovement(id) {
      const m = movementsData.movements.find(x => x.id === id);
      if (!m) return;
      document.getElementById('detailsModalTitle').textContent = 'Detalhes do Movimento';
      document.getElementById('detailsModalContent').innerHTML = `
        <table class="table">
          <tr><td><strong>Data:</strong></td><td>${m.dataHora}</td></tr>
          <tr><td><strong>Tipo:</strong></td><td><span class="badge badge-${m.tipoBadge}">${m.tipoTexto}</span></td></tr>
          <tr><td><strong>Produto:</strong></td><td>${m.produto}</td></tr>
          <tr><td><strong>Quantidade:</strong></td><td>${m.qtdEntrada || m.qtdSaida}</td></tr>
          <tr><td><strong>Valor:</strong></td><td>${formatCurrency(m.valorTotal)}</td></tr>
          <tr><td><strong>Documento:</strong></td><td>${m.documento}</td></tr>
        </table>`;
      $('#detailsModal').modal('show');
    }

    function mostrarFormulario(tipo) {
      document.getElementById('formMovimento').style.display = 'block';
      document.getElementById('dataMovimento').value = DateTimeUtils.todayISO();
      if (tipo) document.getElementById('tipoMovimento').value = tipo;
      document.getElementById('formMovimento').scrollIntoView({ behavior: 'smooth' });
    }

    function fecharFormulario() {
      document.getElementById('formMovimento').style.display = 'none';
    }

    // Cálculo automático
    document.getElementById('quantidade').addEventListener('input', calcTotal);
    document.getElementById('valorUnitario').addEventListener('input', calcTotal);
    function calcTotal() {
      const q = parseFloat(document.getElementById('quantidade').value) || 0;
      const u = parseFloat(document.getElementById('valorUnitario').value) || 0;
      document.getElementById('valorTotal').value = (q * u).toFixed(2);
    }

    // Form submit
    document.getElementById('movimentoForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      try {
        const tipo = document.getElementById('tipoMovimento').value;
        const quantidade = parseFloat(document.getElementById('quantidade').value) || 1;
        const valorTotal = parseFloat(document.getElementById('valorTotal').value) || 0;
        const observacoes = document.getElementById('observacoes')?.value || '';
        
        await axios.post(`${API_BASE}/transactions`, {
          description: document.getElementById('produtoMovimento').value,
          type: tipo,
          amount: valorTotal,
          value: valorTotal,
          quantity: quantidade,
          dueDate: document.getElementById('dataMovimento').value,
          paymentMethod: document.getElementById('documento').value,
          notes: observacoes,
          category: 'Estoque'
          // createdAt é gerado pelo servidor com horário de Brasília
        });
        try { localStorage.setItem('dashboard_refresh', Date.now()); } catch (e) { /* ignore */ }
        Toast.success('Movimento salvo com sucesso!');
        fecharFormulario();
        document.getElementById('movimentoForm').reset();
        loadMovementsData();
      } catch (e) { Toast.error('Erro ao salvar: ' + e.message); }
    });

    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', loadMovementsData);
    document.getElementById('newMovementBtn').addEventListener('click', () => mostrarFormulario());
    
    document.querySelectorAll('[data-tipo]').forEach(btn => {
      btn.addEventListener('click', () => mostrarFormulario(btn.dataset.tipo));
    });

    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        movementsData.period = this.dataset.period;
        loadMovementsData();
      });
    });

    document.getElementById('exportarExcel').addEventListener('click', () => {
      // Exportar como CSV organizado (ponto e vírgula como separador)
      const separator = ';';
      const header = ['Data/Hora', 'Tipo', 'Descrição', 'Categoria', 'Valor', 'Status'];
      
      const csvEscape = v => {
        if (v === null || v === undefined) return '""';
        let s = String(v).replace(/[\r\n\t]+/g, ' ').replace(/\s+/g, ' ').trim();
        return '"' + s.replace(/"/g, '""') + '"';
      };
      
      const rows = movementsData.movements.map(m => [
        DateTimeUtils.formatDateTime(m.dataHora || m.createdAt || m.created_at),
        m.type || m.tipo || '-',
        m.description || m.descricao || '-',
        m.category || m.categoria || '-',
        (Number(m.value || m.valor) || 0).toFixed(2).replace('.', ','),
        m.status || '-'
      ]);
      
      const csvContent = header.map(h => '"' + h + '"').join(separator) + '\r\n' + 
                        rows.map(r => r.map(csvEscape).join(separator)).join('\r\n');
      
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `movimentos_${DateTimeUtils.todayISO()}.csv`;
      a.click();
    });

    document.getElementById('imprimirKardex').addEventListener('click', () => window.print());

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F1') { e.preventDefault(); Modal.info('F1 - Ajuda\nF2 - Atualizar\nF3 - Novo movimento\nF5 - Exportar\nF6 - Imprimir\nESC - Fechar', 'Atalhos de Teclado'); }
      if (e.key === 'F2') { e.preventDefault(); loadMovementsData(); }
      if (e.key === 'F3') { e.preventDefault(); mostrarFormulario(); }
      if (e.key === 'F5') { e.preventDefault(); document.getElementById('exportarExcel').click(); }
      if (e.key === 'F6') { e.preventDefault(); window.print(); }
      if (e.key === 'Escape') fecharFormulario();
    });

    // Atualização via storage (outras abas) — ao escrever 'dashboard_refresh' em outra aba, recarrega automaticamente
    window.addEventListener('storage', function(e) {
      if (e.key === 'dashboard_refresh') {
        loadMovementsData();
      }
    });

    loadMovementsData();
  </script>
</body>
</html>
