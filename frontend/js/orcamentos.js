const API_BASE = '/api';
async function loadOrcamentos(){ try{ const q=document.getElementById('searchOrc').value; const res=await axios.get(`${API_BASE}/orcamentos?search=${encodeURIComponent(q)}`); const items=res.data.data||res.data||[]; const c=document.getElementById('orcamentosList'); if(!items.length){ c.innerHTML=`<div class="text-center py-5 text-muted"><i class="fa fa-folder-open fa-4x"></i><p>Nenhum orçamento cadastrado</p></div>`; return;} c.innerHTML=items.map(it=>`<div class="card list-card"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="font-weight-bold">${it.client||'-'}</div><div class="text-muted">Valor: ${it.total||'-'}</div></div><div class="btn-group"><button class="btn btn-sm btn-outline-primary" onclick="editOrcamento('${it.id}')"><i class="fa fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteOrcamento('${it.id}')"><i class="fa fa-trash"></i></button></div></div></div>`).join(''); }catch(e){console.error(e); document.getElementById('orcamentosList').innerHTML='<div class="alert alert-warning">Erro ao carregar.</div>';} }
function openOrcamentoModal(item=null){ document.getElementById('orcamentoForm').reset(); document.getElementById('orcId').value=''; document.getElementById('orcamentoModalTitle').textContent='Novo Orçamento'; if(item){ document.getElementById('orcId').value=item.id; document.getElementById('orcCliente').value=item.client||''; document.getElementById('orcValor').value=item.total||''; document.getElementById('orcObs').value=item.obs||''; document.getElementById('orcamentoModalTitle').textContent='Editar Orçamento'; } $('#orcamentoModal').modal('show'); }
async function editOrcamento(id){ try{ const res=await axios.get(`${API_BASE}/orcamentos/${id}`); openOrcamentoModal(res.data); }catch(e){alert('Erro ao obter');} }
async function saveOrcamento(){ const id=document.getElementById('orcId').value; const data={ client:document.getElementById('orcCliente').value, total:parseFloat(document.getElementById('orcValor').value)||0, obs:document.getElementById('orcObs').value }; try{ if(id) await axios.put(`${API_BASE}/orcamentos/${id}`, data); else await axios.post(`${API_BASE}/orcamentos`, data); $('#orcamentoModal').modal('hide'); loadOrcamentos(); }catch(e){alert('Erro ao salvar');} }
async function deleteOrcamento(id){ if(!confirm('Excluir?')) return; try{ await axios.delete(`${API_BASE}/orcamentos/${id}`); loadOrcamentos(); }catch(e){alert('Erro ao excluir');} }

document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('searchOrc').addEventListener('input', debounce(loadOrcamentos,300)); loadOrcamentos(); }); function debounce(fn,t){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a), t); }; }