const API_BASE = '/api';
async function loadTickets(){ try{ const q=document.getElementById('searchTicket').value; const res=await axios.get(`${API_BASE}/tickets?search=${encodeURIComponent(q)}`); const items=res.data.data||res.data||[]; const c=document.getElementById('ticketsList'); if(!items.length){ c.innerHTML=`<div class="text-center py-5 text-muted"><i class="fa fa-folder-open fa-4x"></i><p>Nenhum ticket</p></div>`; return;} c.innerHTML=items.map(it=>`<div class="card list-card"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="font-weight-bold">${it.subject}</div><div class="text-muted">${it.priority} â€¢ ${it.status||'Aberto'}</div></div><div class="btn-group"><button class="btn btn-sm btn-outline-primary" onclick="editTicket('${it.id}')"><i class="fa fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteTicket('${it.id}')"><i class="fa fa-trash"></i></button></div></div></div>`).join(''); }catch(e){console.error(e); document.getElementById('ticketsList').innerHTML='<div class="alert alert-warning">Erro ao carregar.</div>';} }
function openTicketModal(item=null){ document.getElementById('ticketForm').reset(); document.getElementById('ticketId').value=''; document.getElementById('ticketModalTitle').textContent='Abrir Ticket'; if(item){ document.getElementById('ticketId').value=item.id; document.getElementById('ticketSubject').value=item.subject||''; document.getElementById('ticketPriority').value=item.priority||'Baixa'; document.getElementById('ticketDesc').value=item.desc||''; document.getElementById('ticketModalTitle').textContent='Editar Ticket'; } $('#ticketModal').modal('show'); }
async function editTicket(id){ try{ const res=await axios.get(`${API_BASE}/tickets/${id}`); openTicketModal(res.data); }catch(e){alert('Erro ao obter');} }
async function saveTicket(){ const id=document.getElementById('ticketId').value; const data={ subject:document.getElementById('ticketSubject').value, priority:document.getElementById('ticketPriority').value, desc:document.getElementById('ticketDesc').value }; try{ if(id) await axios.put(`${API_BASE}/tickets/${id}`, data); else await axios.post(`${API_BASE}/tickets`, data); $('#ticketModal').modal('hide'); loadTickets(); }catch(e){alert('Erro ao salvar');} }
async function deleteTicket(id){ if(!confirm('Excluir?')) return; try{ await axios.delete(`${API_BASE}/tickets/${id}`); loadTickets(); }catch(e){alert('Erro ao excluir');} }

document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('searchTicket').addEventListener('input', debounce(loadTickets,300)); loadTickets(); }); function debounce(fn,t){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a), t); }; }